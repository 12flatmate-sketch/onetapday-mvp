# Автоматическая активация демо-версии

## Изменения

### Логика работы демо

1. **Автоматическая активация при первом логине**
   - Демо активируется автоматически при первом входе пользователя
   - Демо работает 24 часа с момента активации
   - После истечения демо пользователь с этим email больше не может использовать демо

2. **Один раз на email**
   - Флаг `demoUsed` устанавливается в `true` при первой активации
   - Повторная активация демо для того же email невозможна

### Изменения в коде

#### server.js

1. **Автоматическая активация при логине** (строки 349-357)
   ```javascript
   // Автоматическая активация демо при первом логине (если еще не использовано)
   if (!user.demoUsed && user.status !== 'active' && user.status !== 'discount_active') {
     user.demoUsed = true;
     user.status = 'active';
     user.startAt = new Date().toISOString();
     user.endAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
     saveUsers();
   }
   ```

2. **Роут `/start-demo`** (строки 410-426)
   - Оставлен для обратной совместимости
   - Теперь возвращает ошибку, если демо уже использовано
   - Демо должно активироваться автоматически при логине

#### public/main.js

1. **Обновлена логика после логина** (строки 335-357)
   - Убрана ручная активация демо через `tryStartDemo()` при регистрации
   - Добавлена синхронизация состояния демо из ответа сервера
   - Демо активируется автоматически на сервере при первом логине

#### public/js/app-main.js

1. **Добавлена функция `syncUserStatus()`** (строки 1962-1985)
   - Синхронизирует статус пользователя с сервером
   - Обновляет локальное состояние демо из серверного ответа
   - Вызывается при загрузке app.html

2. **Обновлена функция `demoLeftMs()`** (строки 1105-1115)
   - Проверяет локальное состояние демо
   - Может быть расширена для проверки серверного состояния

3. **Обновлен обработчик кнопки startDemo** (строки 2368-2378)
   - Теперь синхронизирует статус с сервером вместо ручной активации
   - Демо должно было активироваться автоматически при логине

### Поведение системы

1. **При регистрации нового пользователя:**
   - Пользователь регистрируется
   - При первом логине автоматически активируется демо на 24 часа
   - `demoUsed` устанавливается в `true`

2. **При логине существующего пользователя:**
   - Если демо еще не использовано и статус не активен - активируется демо
   - Если демо уже использовано - демо не активируется
   - Если демо активно и не истекло - статус остается активным
   - Если демо истекло - статус меняется на 'ended' через `expireStatuses()`

3. **При истечении демо:**
   - Функция `expireStatuses()` проверяет срок действия
   - Если `endAt` < текущее время, статус меняется на 'ended'
   - Пользователь больше не имеет доступа к демо

### Проверка работы

1. Зарегистрировать нового пользователя
2. Войти в систему - демо должно активироваться автоматически
3. Проверить, что демо работает 24 часа
4. После истечения демо - статус должен быть 'ended'
5. Попытка повторного входа - демо не должно активироваться

### Важные моменты

- Демо активируется только один раз на email
- Демо активируется автоматически при первом логине
- Ручная активация демо через `/start-demo` больше не нужна (оставлена для обратной совместимости)
- Статус демо синхронизируется с сервером при загрузке app.html

