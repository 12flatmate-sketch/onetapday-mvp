<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay ‚Äì AI Ksiƒôgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
      --pos: #a8e8c7;
      --neg: #ff8a8a;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #cfe6d7;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: var(--accent);
      color: #08110b;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #9aa3a9;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number], select {
      background: #0f1214;
      border: 1px solid #20262b;
      border-radius: 8px;
      color: #e6edf3;
      padding: 9px;
    }
    .right { margin-left: auto; }
    .mic {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2a3136;
      background: #0f1214;
      cursor: pointer;
    }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    .amt-pos { color: var(--pos); font-weight:700; }
    .amt-neg { color: var(--neg); font-weight:700; }
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #20262b;
      background: #0f1214;
      color: #9aa3a9;
      font-size: 12px;
      cursor: pointer;
    }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
    @media (max-width: 1080px) {
      .cards { grid-template-columns: 1fr 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
    @media print {
      .tabs, .btn, .row input, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .card { background: #fff; border: 1px solid #999; }
      .wrap { max-width: 1000px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay ‚Äî AI Ksiƒôgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">–ü—É–ª—å—Ç</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciƒÖg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">–°—á–µ—Ç–∞</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (–Ω–∞–ª)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="pulpit" class="section active">
      <div class="cards">
        <div class="card">
          <div class="muted" data-i="kpi_due_today">–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiDue" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_unmatched">–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
          <div id="kpiUnmatch" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_banks">–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ</div>
          <div id="kpiBank" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_cash">–ö–∞—Å—Å–∞ (–Ω–∞–ª)</div>
          <div id="kpiCash" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_total">–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ</div>
          <div id="kpiAvail" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_gap_today">–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiGap" class="kpi">0</div>
        </div>
      </div>
      <div class="row" style="margin: 10px 0;">
        <button id="syncNow" class="btn" data-i="btn_sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
        <button id="runAI" class="btn secondary" data-i="btn_ai_match">–ò–ò-—Å–≤–µ—Ä–∫–∞</button>
        <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã</button>
        <button id="exportPDF" class="btn secondary" data-i="btn_pdf">PDF –æ—Ç—á—ë—Ç</button>
        <span id="lastSync" class="pill">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ‚Äî</span>
        <span class="right pill" id="modeCash">–†–µ–∂–∏–º: –∞–≤—Ç–æ</span>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="minpay_title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)</div>
          <div id="minPayBox" class="muted">‚Äî</div>
          <div class="row" style="margin-top: 6px;">
            <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_7d">–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast7d_note">–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.</div>
          <div id="forecastBars" class="barwrap"></div>
          <div id="forecastMeta" class="muted" style="margin-top: 6px;">‚Äî</div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_30d">–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast30_note">–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.</div>
          <div id="forecast30Table"></div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="month_summary_title">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</div>
          <div id="monthSummary" class="muted">‚Äî</div>
        </div>
      </div>

      <div class="card" style="margin-top: 14px;">
        <div class="row">
          <div style="font-weight: 700;" data-i="plan_title">–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É</div>
          <div class="right"> 
            <span data-i="filter_label">–§–∏–ª—å—Ç—Ä:</span>
            <select id="planFilter">
              <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
              <option value="all" data-i="filter_all">–í—Å–µ</option>
            </select>
          </div>
          <label style="margin-left: 10px;">
            <input type="checkbox" id="excludeBlacklist" /> <span data-i="exclude_blacklist">–ò—Å–∫–ª—é—á–∞—Ç—å blacklist</span>
          </label>
        </div>
        <div class="row" style="margin: 8px 0;">
          <button id="makePlan" class="btn secondary" data-i="btn_make_plan">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span id="planMeta" class="pill">‚Äî</span>
        </div>
        <table id="planTable">
          <thead>
            <tr>
              <th>#</th>
              <th data-i="plan_th_invoice">–§–∞–∫—Ç—É—Ä–∞</th>
              <th data-i="plan_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th data-i="plan_th_due">–°—Ä–æ–∫</th>
              <th data-i="plan_th_amount">–°—É–º–º–∞</th>
              <th data-i="plan_th_reason">–ü—Ä–∏—á–∏–Ω–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Bank Statement Section (WyciƒÖg) -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_statement">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)</span>
        </label>

        <label class="btn ghost">
          <input id="txImage" type="file" accept="image/*" multiple style="display: none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω –≤—ã–ø–∏—Å–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>

        <img id="txLastThumb" class="thumb" style="display: none;" />

        <input id="txUrl" type="text" placeholder="URL CSV wyciƒÖga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <span class="muted">
          –ö–æ–ª–æ–Ω–∫–∏: Data ksiƒôgowania, ID transakcji, ID konta (–∏–ª–∏ IBAN), Kontrahent, Tytu≈Ç/Opis, Kwota(¬±), Waluta, Status —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, Saldo po operacji?
        </span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">–î–∞—Ç–∞</th>
            <th data-i="th_account">–°—á—ë—Ç</th>
            <th data-i="th_counterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
            <th data-i="th_desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th data-i="th_amount">–°—É–º–º–∞</th>
            <th data-i="th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="th_status">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Invoices Section (Faktury) -->
    <div id="faktury" class="section">
      <div class="row" style="align-items:center; margin-bottom:8px;">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display:none" />
          <span data-i="upload_invoices">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)</span>
        </label>
        <label class="btn ghost">
          <input id="billImage" type="file" accept="image/*" multiple style="display:none" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Ñ–∞–∫—Ç—É—Ä—ã</span>
        </label>
        <span class="muted" style="margin-left:12px;">–ó–¥–µ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –Ω–æ–º–µ—Ä–∞ —Ñ–∞–∫—Ç—É—Ä, —Å—É–º–º—ã –∏ –¥–∞—Ç—ã.</span>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th>–°—Ä–æ–∫</th><th>‚Ññ</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–°—É–º–º–∞</th><th>–í–∞–ª—é—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–∞–Ω–¥–∏–¥–∞—Ç</th><th>Score</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Accounts Section (Konta) -->
    <div id="konta" class="section">
      <div class="card">
        <div style="font-weight:700">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏</div>
        <div class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π –≤–∞–ª—é—Ç—É, —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–∞–ª—å–¥–æ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–∞—Å—á—ë—Ç.</div>
        <table id="autoAcc">
          <thead><tr><th>–°—á—ë—Ç</th><th>–¢–∏–ø</th><th>–í–∞–ª—é—Ç–∞</th><th>–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)</th><th>–°—Ç–∞—Ä—Ç</th><th>–í —Ä–∞—Å—á—ë—Ç</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cash Section (Kasa) -->
    <div id="kasa" class="section">
      <div class="card">
        <div style="font-weight:700">–ö–∞—Å—Å–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
        <div class="muted">–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–∞—Å—Å–∞ + –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏</div>
        <div class="row" style="margin-top:8px; align-items:center;">
          <input id="quickAmt" type="number" step="0.01" placeholder="–°—É–º–º–∞" style="width:120px" />
          <input id="quickNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="width:300px" />
          <button id="addIn" class="btn secondary">+ –ü—Ä–∏—ë–º</button>
          <button id="addOut" class="btn secondary">‚àí –í—ã–¥–∞—á–∞</button>
          <button id="q50" class="btn ghost">+50</button>
          <button id="q100" class="btn ghost">+100</button>
          <button id="q200" class="btn ghost">+200</button>
          <div style="margin-left:12px;">
            <button id="cashClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: 
            <select id="speechLang">
              <option value="pl-PL">PL</option>
              <option value="ru-RU">RU</option>
              <option value="en-US">EN</option>
            </select>
          </label>
          <button id="micBtn" class="mic" title="–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–∞—Å—Å–∞">üé§</button>
          <span id="micStatus" class="muted" style="margin-left:8px;">‚Äî</span>
        </div>

        <div style="margin-top:12px;">
          <input id="cashPhoto" type="file" accept="image/*" style="display:inline-block" />
          <span class="muted">–°–∫–∞–Ω —á–µ–∫–∞/–≤—ã–ø–∏—Å–∫–∏ ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.</span>
        </div>

        <table id="kasaTable" style="margin-top:12px">
          <thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Settings Section (Ustawienia) -->
    <div id="ustawienia" class="section">
      <div class="card">
        <div style="font-weight:700">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px;">
          <div>
            <label>Manual available cash today (PLN): <input id="cashPLN" type="text" /></label><br/>
            <label>–ü–µ–Ω—è, %/–¥–µ–Ω—å: <input id="penaltyPct" type="text" /></label><br/>
            <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω: <input id="intervalMin" type="text" /></label>
          </div>
          <div>
            <label>rateEUR: <input id="rateEUR" type="text" /></label><br/>
            <label>rateUSD: <input id="rateUSD" type="text" /></label><br/>
            <label>Blacklist (comma): <input id="blacklist" type="text" /></label><br/>
            <label><input id="autoCash" type="checkbox" /> –ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞</label>
          </div>
        </div>
        <div style="margin-top:10px;">
          <button id="applySettings" class="btn secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="exportCfg" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <label class="btn ghost">–ò–º–ø–æ—Ä—Ç <input id="importCfg" type="file" style="display:none" /></label>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä
    const $id = (id) => document.getElementById(id);

    // Redirect to portal if not logged in (kept intentionally inert for local testing)
    if (!localStorage.getItem("otd_user")) {
      // —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º ‚Äî –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º.
    }

    // i18n map (unchanged)
    const M = {
      /* (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –≤ —Ç–≤–æ—ë–º —Ñ–∞–π–ª–µ ‚Äî –Ω–µ –º–µ–Ω—è–ª) */
  ru: {
    tab_dashboard: "–ü—É–ª—å—Ç", tab_statement: "–í—ã–ø–∏—Å–∫–∞", tab_invoices: "–§–∞–∫—Ç—É—Ä—ã", tab_accounts: "–°—á–µ—Ç–∞", tab_cash: "–ö–∞—Å–∞", tab_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    kpi_due_today: "–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è", kpi_unmatched: "–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", kpi_banks: "–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ", kpi_cash: "–ö–∞—Å—Å–∞ (–Ω–∞–ª)", kpi_total: "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ", kpi_gap_today: "–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è",
    btn_sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", btn_ai_match: "–ò–ò-—Å–≤–µ—Ä–∫–∞", btn_accept_safe: "–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã", btn_pdf: "PDF –æ—Ç—á—ë—Ç",
    minpay_title: "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)", btn_apply_minpay: "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ",
    forecast_7d: "–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π", forecast7d_note: "–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.",
    forecast_30d: "–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π", forecast30_note: "–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.",
    month_summary_title: "–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞",
    plan_title: "–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É", filter_label: "–§–∏–ª—å—Ç—Ä:", filter_today: "–°–µ–≥–æ–¥–Ω—è", filter_7d: "7 –¥–Ω–µ–π", filter_all: "–í—Å–µ", exclude_blacklist: "–ò—Å–∫–ª—é—á–∞—Ç—å blacklist",
    btn_make_plan: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", btn_apply_plan: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
    plan_th_invoice: "–§–∞–∫—Ç—É—Ä–∞", plan_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", plan_th_due: "–°—Ä–æ–∫", plan_th_amount: "–°—É–º–º–∞", plan_th_reason: "–ü—Ä–∏—á–∏–Ω–∞",
    upload_statement: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)", save_url: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL",
    th_date: "–î–∞—Ç–∞", th_account: "–°—á—ë—Ç", th_counterparty: "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc: "–û–ø–∏—Å–∞–Ω–∏–µ", th_amount: "–°—É–º–º–∞", th_currency: "–í–∞–ª—é—Ç–∞", th_status: "–°—Ç–∞—Ç—É—Å",
    upload_invoices: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)", only_overdue: "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ", show_label: "–ü–æ–∫–∞–∑–∞—Ç—å:",
    inv_th_due: "–°—Ä–æ–∫", inv_th_number: "‚Ññ", inv_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", inv_th_amount: "–°—É–º–º–∞", inv_th_currency: "–í–∞–ª—é—Ç–∞", inv_th_status: "–°—Ç–∞—Ç—É—Å", inv_th_candidate: "–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score: "Score", inv_th_action: "–î–µ–π—Å—Ç–≤–∏–µ",
    auto_accounts_title: "–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)",
    auto_accounts_desc: "–ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.",
    acc_th_account: "–°—á—ë—Ç", acc_th_type: "–¢–∏–ø", acc_th_currency: "–í–∞–ª—é—Ç–∞", acc_th_balance_calc: "–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)", acc_th_start_balance: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å", acc_th_include: "–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞",
    btn_add_in: "+ –ü—Ä–∏—ë–º", btn_add_out: "‚àí –í—ã–¥–∞—á–∞", btn_close_shift: "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É", btn_scan_receipt: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ)",
    speech_lang: "–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", btn_test_voice: "–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥",
    cash_th_date: "–î–∞—Ç–∞", cash_th_type: "–¢–∏–ø", cash_th_amount: "–°—É–º–º–∞", cash_th_source: "–ò—Å—Ç–æ—á–Ω–∏–∫", cash_th_comment: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
    pilot_subscription_title: "–ü–æ–¥–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–∞",
    btn_mark_paid: "–û—Ç–º–µ—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω", btn_start_pilot: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∏–ª–æ—Ç (2 –º–µ—Å.)", btn_activate_discount: "–í–∫–ª—é—á–∏—Ç—å ‚àí50% –Ω–∞ 12 –º–µ—Å.", btn_reset_pilot: "–°–±—Ä–æ—Å",
    start_label: "–ù–∞—á–∞–ª–æ:", end_label: "–û–∫–æ–Ω—á–∞–Ω–∏–µ:", discount_label: "–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:",
    calc_mode: "–†–µ–∂–∏–º —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤", auto_mode_label: "–ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞",
    parameters: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã",
    param_cash: "–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):", param_penalty: "–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval: "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:",
    btn_save_settings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btn_export_settings: "–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫", btn_import_settings: "–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫",
    auto_mode_explain: "–†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑ wyciƒÖg (–∏–ª–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å–∏. –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É + –∫–∞—Å—É."
  },
  en: {/*...*/}, pl: {/*...*/}, uk:{/*...*/}
};
    function applyLang(lang) {
      const dict = (M[lang] || M.ru);
      document.querySelectorAll('[data-i]').forEach(el => {
        const k = el.getAttribute('data-i');
        if (dict[k]) el.textContent = dict[k];
      });
      document.querySelectorAll('#langBarMain button').forEach(btn=>btn.classList.toggle('on', btn.dataset.lang === lang));
      localStorage.setItem('otd_lang', lang);
    }

    // helpers
    const asNum = v => {
      if (v == null) return 0;
      let s = String(v).trim();
      if (!s) return 0;
      s = s.replace(/\u00A0/g,'').replace(/\s/g, '').replace(/,/g, '.');
      s = s.replace(/[^\d\.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    };
    const today = () => new Date().toISOString().slice(0, 10);

    // robust CSV split
    function smartSplit(line, del) {
      let out = [], cur = "", q = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { q = !q; continue; }
        if (ch === del && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      if (!text) return [];
      // strip BOM
      text = text.replace(/^\uFEFF/, '').replace(/\r/g, "");
      const lines = text.split("\n").filter(l => l.trim());
      if (!lines.length) return [];
      const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
      const head = smartSplit(lines.shift(), sep).map(h => h.trim());
      return lines.map(line => {
        const cells = smartSplit(line, sep);
        const obj = {};
        head.forEach((h, i) => {
          let v = (cells[i] || "").trim();
          v = v.replace(/\u00A0/g,' ').trim();
          obj[h] = v;
        });
        return obj;
      });
    }

    // normalize date helpers
    function toISO(d) {
      if (!d) return "";
      const s = String(d).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return m[0];
      m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
      if (m) {
        const dd = m[1].padStart(2, "0"),
              mm = m[2].padStart(2, "0"),
              yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
        return yy + "-" + mm + "-" + dd;
      }
      // try dd MMM yyyy like 03 lis 2025 (polish month maybe) - fallback to parse
      const maybe = Date.parse(s);
      if (!isNaN(maybe)) {
        const D = new Date(maybe);
        return D.toISOString().slice(0,10);
      }
      return "";
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      applyLang(localStorage.getItem('otd_lang') || 'ru');

      document.querySelectorAll('#langBarMain button').forEach(b => b.addEventListener('click', ()=>applyLang(b.dataset.lang)));
      document.querySelectorAll('.tabs .tab').forEach(t => t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        t.classList.add('active');
        const sec = t.dataset.sec;
        const el = sec ? document.getElementById(sec) : null;
        if (el) el.classList.add('active');
        if (typeof render === 'function') try { render(); } catch(e){/*ignore*/ }
      }));

      // init minimal state
      window.tx = window.tx || [];
      window.bills = window.bills || [];
      window.kasa = window.kasa || [];
    });

    // amount formatting
    function fmtAmountRaw(raw) {
      const n = asNum(raw);
      if (!Number.isFinite(n)) return '<span>‚Äî</span>';
      const sign = n < 0 ? '-' : '+';
      const cls = n < 0 ? 'amt-neg' : 'amt-pos';
      const abs = Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
      return `<span class="${cls}">${sign} ${abs}</span>`;
    }

    // --- Core app logic ---
  </script>

  <script>
  (function(){
    // local model
    let tx = [];
    let bills = [];
    let kasa = [];
    let accMeta = {};

    // infer accounts from tx rows
    function inferAccounts() {
      const map = {};
      tx.forEach(r => {
        const id = r["ID konta"] || r["IBAN"] || "UNKNOWN";
        const cur = (r["Waluta"] || r["currency"] || "PLN").toUpperCase();
        if (!map[id]) {
          map[id] = { id, name: String(id).slice(0, 12), currency: cur, include: true, type: "Biznes", start: 0 };
        }
      });
      try {
        const saved = JSON.parse(localStorage.getItem("accMeta") || "{}");
        Object.keys(map).forEach(id => {
          if (saved[id]) map[id] = Object.assign(map[id], saved[id]);
        });
      } catch(e){}
      accMeta = map;
      renderAccounts();
    }

    function computeAccountBalance(accId) {
      const rows = tx.filter(r => (r["ID konta"] || r["IBAN"] || "UNKNOWN") === accId);
      const withSaldo = rows.filter(r => r["Saldo po operacji"]);
      if (withSaldo.length) {
        const last = withSaldo[withSaldo.length - 1];
        return asNum(last["Saldo po operacji"]);
      }
      const start = Number((accMeta[accId] || {}).start || 0);
      const sum = rows.reduce((s, r) => s + asNum(r["Kwota"] || r["Kw–æ—Ç–∞"] || r.amount || 0), 0);
      return start + sum;
    }

    function rate(cur) {
      cur = String(cur || "PLN").toUpperCase();
      if (cur === "PLN") return 1;
      if (cur === "EUR") return asNum(localStorage.getItem("rateEUR") || 4.3);
      if (cur === "USD") return asNum(localStorage.getItem("rateUSD") || 3.95);
      return 1;
    }
    function bankAvailablePLN() {
      let sum = 0;
      Object.values(accMeta).filter(a => a.include).forEach(a => {
        const bal = computeAccountBalance(a.id);
        sum += bal * rate(a.currency);
      });
      return sum;
    }
    function kasaBalance() {
      let bal = 0;
      kasa.forEach(k => {
        if (k.type === "przyjƒôcie") bal += k.amount;
        if (k.type === "wydanie") bal -= k.amount;
        if (k.type === "zamkniƒôcie") bal = k.amount;
      });
      return bal;
    }
    function availableTotal() {
      const auto = localStorage.getItem("autoCash") === "1";
      const manual = asNum(localStorage.getItem("cashPLN") || 0);
      const kas = kasaBalance();
      return auto ? (bankAvailablePLN() + kas) : (manual + kas);
    }

    // scoring helpers (unchanged)
    function normName(s) {
      s = (s || "").toString().toLowerCase().replace(/[.,]/g, " ").replace(/\s+/g, " ").trim();
      const stop = ["sp z oo", "sp. z o.o.", "spolka", "sp√≥≈Çka", "sa", "s.a", "ooo"];
      stop.forEach(t => s = s.replace(t, ""));
      return s.trim();
    }
    function nameSimilar(a, b) {
      a = normName(a); b = normName(b);
      if (!a || !b) return 0;
      if (a === b) return 1;
      if (a.includes(b) || b.includes(a)) return 0.8;
      return 0;
    }
    function scoreMatch(bill, tr) {
      let score = 0;
      const bAmt = asNum(bill["Kwota do zap≈Çaty"] || bill["Kw–∞—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || bill["Kwota"] || bill["Kw–∞—Ç–∞"] || 0);
      const tAmt = Math.abs(asNum(tr["Kwota"] || tr["Kw–æ—Ç–∞"] || tr.amount || 0));
      const bCur = String(bill["Waluta"] || "").toUpperCase();
      const tCur = String(tr["Waluta"] || "").toUpperCase();
      if (bAmt > 0 && tAmt > 0 && Math.abs(bAmt - tAmt) < 0.01 && (bCur === tCur || !bCur || !tCur)) score += 60;
      const inv = String(bill["Numer faktury"] || bill["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase();
      const desc = String(tr["Tytu≈Ç/Opis"] || tr["Opis"] || tr["Tytu≈Ç"] || "").toLowerCase();
      if (inv && desc.includes(inv)) score += 25;
      if (nameSimilar(bill["Dostawca"] || bill["Supplier"], tr["Kontrahent"] || tr["Counterparty"] || "") >= 0.8) score += 10;
      if (asNum(tr["Kw–æ—Ç–∞"] || tr.amount) < 0) score += 5;
      return { score: Math.min(100, score) };
    }

    function runAI() {
      bills.forEach(b => {
        const status = String(b["Status faktury"] || b["Status faktury"] || b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase();
        if (status.includes("op≈Çacone") || status.includes("–æ–ø–ª–∞—á–µ–Ω–æ") || status.includes("paid")) return;
        let best = null;
        tx.forEach(t => {
          if (String(t["Status transakcji"] || t["status"] || "").toLowerCase() === "sparowane") return;
          if (asNum(t["Kw–æ—Ç–∞"] || t.amount) >= 0) return; // expect outgoing negative for payments
          const s = scoreMatch(b, t);
          if (!best || s.score > best.s) best = { t, s: s.score };
        });
        if (best && best.s >= 85) {
          best.t["Status transakcji"] = "Sparowane";
          best.t["PowiƒÖzana faktura (ID)"] = b["Numer faktury"] || b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];
          b["Status faktury"] = "Op≈Çacone";
          b["Data p≈Çatno≈õci"] = today();
        } else if (best && best.s >= 55) {
          b["Kandyd–∞—Ç (AI)"] = best.t["ID transakcji"];
          b["AI score"] = best.s;
        } else {
          b["Kandyd–∞—Ç (AI)"] = "";
          b["AI score"] = "";
        }
      });
      render();
    }
    function acceptSafe() {
      bills
        .filter(b => Number(b["AI score"] || 0) >= 85)
        .forEach(b => {
          const t = tx.find(t => t["ID transakcji"] === b["Kandyd–∞—Ç (AI)"]);
          if (!t) return;
          t["Status transakcji"] = "Sparowane";
          t["PowiƒÖzana fakt—É—Ä–∞ (ID)"] = b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];
          b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
          b["Data p≈Ç–∞—Çno≈õci"] = today();
          b["Kandyd–∞—Ç (AI)"] = b["AI score"] = "";
        });
      render();
    }

    // normalize keys for an imported row
    function normalizeRowKeys(r) {
      const kw = (r["Kwota"] || r["Kw–æ—Ç–∞"] || r["amount"] || r.amount || "");
      const kwNum = asNum(kw);
      return {
        "Data ksiƒôgowania": r["Data ksiƒôgowania"] || r.date || r["–î–∞—Ç–∞"] || today(),
        "ID transakcji": r["ID transakcji"] || r.id || ("IMG-" + Date.now() + "-" + Math.floor(Math.random()*9999)),
        "ID konta": r["ID konta"] || r.account || r["IBAN"] || "UNKNOWN",
        "Kontrahent": r["Kontrahent"] || r.counterparty || r["–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"] || "",
        "Tytu≈Ç/Opis": r["Tytu≈Ç/Opis"] || r.desc || r["–û–ø–∏—Å–∞–Ω–∏–µ"] || (r.title || ""),
        "Kwota": (Number.isFinite(kwNum) ? kwNum.toFixed(2) : (typeof kw === 'number' ? String(kw) : (kw || ""))),
        "Waluta": r["Waluta"] || r.currency || "PLN",
        "Status transakcji": r["Status transakcji"] || r.status || "imported",
        "Saldo po operacji": r["Saldo po operacji"] || r.saldo || ""
      };
    }

    // OCR function (enhanced)
    async function processImageFileFor(targetArrayName, file) {
      if (!file) return;
      const imgURL = URL.createObjectURL(file);
      const thumbId = (targetArrayName === 'tx') ? 'txLastThumb' : ((targetArrayName === 'bills') ? 'billLastThumb' : null);
      if (thumbId) {
        const thumb = document.getElementById(thumbId);
        if (thumb) { thumb.src = imgURL; thumb.style.display = "inline-block"; }
      }

      function parseAmountToken(tok) {
        if (!tok) return null;
        const curMatch = tok.match(/\b(PLN|z≈Ç|zl|zlot|EUR|USD)\b/i);
        const currency = curMatch ? (curMatch[1].toUpperCase().replace('Z≈Å','PLN').replace('ZLOT','PLN')) : 'PLN';
        const numMatch = tok.match(/-?\s*\d{1,3}(?:[ \u00A0]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2}/);
        if (!numMatch) return null;
        let numStr = numMatch[0].replace(/\s/g,'').replace(/\u00A0/g,'').replace(',', '.').replace('‚àí','-');
        const negative = /-/.test(tok) || /^\-/.test(numStr);
        numStr = numStr.replace(/^\-/, '');
        const value = Number(numStr);
        if (isNaN(value)) return null;
        return { value: negative ? -value : value, raw: numMatch[0], currency, negative };
      }
      function detectDateLine(line) {
        line = (line || "").trim();
        if (!line) return null;
        // ISO-like
        let m = line.match(/(\d{4})[.\-/](\d{2})[.\-/](\d{2})/);
        if (m) return `${m[1]}-${m[2]}-${m[3]}`;
        // dd.mm.yyyy or dd-mm-yyyy or dd/mm/yy
        m = line.match(/(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})/);
        if (m) {
          const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0');
          let yy = m[3]; if (yy.length === 2) yy = '20' + yy;
          return `${yy}-${mm}-${dd}`;
        }
        // keywords + date on same line
        m = line.match(/(data wystawienia|data sprzeda≈ºy|termin p≈Çatno≈õci|data:)\s*[:\-]?\s*(\d{1,2}[.\-/]\d{1,2}[.\-/]\d{2,4})/i);
        if (m) return toISO(m[2]);
        // try month names (e.g., 03 lis 2025)
        m = line.match(/(\d{1,2})\s+([a-zA-Z]{3,})\s+(\d{4})/i);
        if (m) {
          const D = Date.parse(`${m[1]} ${m[2]} ${m[3]}`);
          if (!isNaN(D)) return new Date(D).toISOString().slice(0,10);
        }
        return null;
      }

      // search nearby lines for date
      function findNearbyDate(lines, idx) {
        for (let k = idx; k >= Math.max(0, idx - 8); k--) {
          const d = detectDateLine(lines[k]);
          if (d) return d;
        }
        for (let k = idx + 1; k <= Math.min(lines.length - 1, idx + 4); k++) {
          const d = detectDateLine(lines[k]);
          if (d) return d;
        }
        return null;
      }

      try {
        const img = await new Promise((res, rej) => {
          const i = new Image();
          i.onload = () => res(i);
          i.onerror = (e) => rej(e);
          i.src = imgURL;
        });

        const maxDim = 2600;
        const scale = Math.min(3, Math.max(1, maxDim / Math.max(img.width, img.height)));
        const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(img, 0, 0, w, h);

        try {
          const id = ctx.getImageData(0,0,w,h);
          const d = id.data;
          let sum = 0, sum2 = 0, cnt = 0;
          for (let i=0;i<d.length;i+=4) {
            const r = d[i], g = d[i+1], b = d[i+2];
            const l = Math.round(0.299*r + 0.587*g + 0.114*b);
            d[i] = d[i+1] = d[i+2] = l;
            sum += l; sum2 += l*l; cnt++;
          }
          ctx.putImageData(id,0,0);
          const mean = sum / Math.max(1, cnt);
          const std = Math.sqrt(Math.max(0, sum2/cnt - mean*mean));
          if (mean < 120) {
            const id2 = ctx.getImageData(0,0,w,h); const d2 = id2.data;
            for (let i=0;i<d2.length;i+=4) { d2[i] = 255 - d2[i]; d2[i+1] = 255-d2[i+1]; d2[i+2] = 255-d2[i+2]; }
            ctx.putImageData(id2,0,0);
          }
          const final = ctx.getImageData(0,0,w,h);
          const df = final.data;
          const thresh = Math.max(120, Math.round(mean - std * 0.1));
          for (let i=0;i<df.length;i+=4) {
            const v = df[i];
            const val = v < thresh ? 0 : 255;
            df[i] = df[i+1] = df[i+2] = val;
          }
          ctx.putImageData(final, 0, 0);
        } catch(err) {
          console.warn('preprocess fail, continue', err);
        }

        const dataUrl = canvas.toDataURL('image/png', 1.0);

        const worker = await Tesseract.createWorker();
        await worker.load();
        // try sensible languages
        try {
          await worker.loadLanguage('pol+eng+rus');
          await worker.initialize('pol+eng+rus');
        } catch(e) {
          try { await worker.loadLanguage('pol+eng'); await worker.initialize('pol+eng'); }
          catch(e2) { try { await worker.loadLanguage('eng'); await worker.initialize('eng'); } catch(e3) { /* fallback */ } }
        }

        const { data: { text } } = await worker.recognize(dataUrl);
        await worker.terminate();

        const cleaned = String(text || "").replace(/\u00A0/g,' ').replace(/\r/g,' ').trim();
        localStorage.setItem('lastOCR', cleaned);

        const lines = cleaned.split('\n').map(l => l.trim()).filter(Boolean);
        const amountREglobal = /-?\s*\d{1,3}(?:[ \u00A0]\d{3})*(?:[.,]\d{2})\s*(PLN|z≈Ç|zl|zlot|EUR|USD)?/gi;

        let currentDateIso = null;
        let bufferDesc = [];
        const foundTx = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const dIso = detectDateLine(line);
          if (dIso) { currentDateIso = dIso; bufferDesc = []; continue; }

          // Invoice detection: try to capture whole invoice -> create bill entry
          const invoiceMatch = line.match(/(Faktura|FV|Faktura numer|Faktura nr|Invoice)\s*[:\s]*([\w\-\/\d]+)/i);
          if (invoiceMatch) {
            const invoiceNum = invoiceMatch[2] || ("IMG-FV-" + Date.now());
            // try to find "Do zap≈Çaty" or "Razem" amounts nearby
            let invoiceAmount = null;
            let invoiceCurrency = "PLN";
            for (let k = i; k < Math.min(lines.length, i + 30); k++) {
              const l = lines[k];
              const m = l.match(/(Do zap≈Çaty|Razem|Warto≈õƒá brutto|Amount due|Total)\s*[:\s]*([-\d\s.,]+)\s*(PLN|z≈Ç|zl|EUR|USD)?/i);
              if (m) { invoiceAmount = m[2]; invoiceCurrency = (m[3] || invoiceCurrency); break; }
            }
            // if not found forward, scan whole doc for 'Do zap≈Çaty'
            if (!invoiceAmount) {
              for (let k = 0; k < lines.length; k++) {
                const l = lines[k];
                const m = l.match(/(Do zap≈Çaty|Razem|Warto≈õƒá brutto|Amount due|Total)\s*[:\s]*([-\d\s.,]+)\s*(PLN|z≈Ç|zl|EUR|USD)?/i);
                if (m) { invoiceAmount = m[2]; invoiceCurrency = (m[3] || invoiceCurrency); break; }
              }
            }
            if (invoiceAmount) {
              const val = invoiceAmount.replace(/\s/g,'').replace(',', '.');
              const amt = Number(val.replace(/[^\d.\-]/g,''));
              const billRow = {
                "Termin p≈Çatno≈õci": findNearbyDate(lines, i) || currentDateIso || today(),
                "Numer faktury": invoiceNum,
                "Dostawca": lines[0] || "",
                "Kwota do zap≈Çaty": Math.abs(amt || 0).toFixed(2),
                "Waluta": (invoiceCurrency || "PLN").toUpperCase(),
                "Status faktury": cleaned.match(/(zap≈Çacono|paid|op≈Çacone)/i) ? "Op≈Çacone" : "do zap≈Çaty",
                "Kandydat (AI)": "",
                "AI score": "",
                "OCR_text": cleaned.slice(0,800)
              };
              bills.unshift(billRow);
              try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
            }
          }

          const amounts = [...line.matchAll(amountREglobal)];
          if (amounts && amounts.length) {
            const firstAmtIndex = amounts[0].index || 0;
            let leftPart = line.slice(0, firstAmtIndex).trim();
            // improve description: combine previous buffer + leftPart
            let desc = (bufferDesc.length ? bufferDesc.join(' | ') + ' ' : '') + (leftPart ? leftPart : '');
            if (!desc.trim() && i > 0) {
              const prev = lines[i-1].trim();
              if (!detectDateLine(prev) && !prev.match(amountREglobal)) desc = prev;
            }
            // incorporate next line if that contains plausible supplier
            if (!desc.trim() && lines[i+1] && !lines[i+1].match(amountREglobal)) desc = lines[i+1];

            for (let j = 0; j < amounts.length; j++) {
              const aRaw = amounts[j][0];
              const parsed = parseAmountToken(aRaw + (amounts[j][1] ? ' ' + amounts[j][1] : ''));
              if (!parsed) continue;
              const leftNearby = line.slice(Math.max(0, (amounts[j].index || 0) - 40), (amounts[j].index || 0) + aRaw.length + 40);
              const outWords = /(wydatek|wydano|wydat|spend|zap≈Çacono|–æ–ø–ª–∞—á–µ–Ω–æ|p≈Çatn|–ø–ª–∞—Ç–µ–∂|przelew do|to:|transfer to|paid)/i;
              const inWords = /(wp≈Çata|przych√≥d|przychod|otrzymano|received|przyjƒôcie|od:|from:|p≈Çatn|wp≈Ç|przelew od)/i;
              let negative = parsed.value < 0 || /-/.test(aRaw) || outWords.test(leftNearby);
              if (inWords.test(leftNearby)) negative = false;
              const amountVal = negative ? -Math.abs(parsed.value) : Math.abs(parsed.value);

              // find date near this amount
              const nearDate = findNearbyDate(lines, i) || currentDateIso || today();

              const txObj = {
                "ID transakcji": "IMG-" + Date.now() + "-" + Math.floor(Math.random()*9999),
                "Data ksiƒôgowania": nearDate,
                "ID konta": "UNKNOWN",
                "Kontrahent": (desc ? desc.slice(0,200) : (lines[i+1] || "").slice(0,200)),
                "Tytu≈Ç/Opis": (desc + (amounts.length > 1 ? ` (part ${j+1}/${amounts.length})` : '')).slice(0,400),
                "Kwota": (amountVal).toFixed(2),
                "Kwota_raw": aRaw,
                "Waluta": (parsed.currency || "PLN").toUpperCase(),
                "Status transakcji": "imported"
              };
              foundTx.push(txObj);
            }
            bufferDesc = [];
            continue;
          }
          bufferDesc.push(line);
          if (bufferDesc.length > 6) bufferDesc.shift();
        }

        // commit foundTx if any
        if (foundTx.length) {
          for (const r of foundTx) {
            const normalized = normalizeRowKeys ? normalizeRowKeys(r) : r;
            if (targetArrayName === 'tx') { tx.unshift(normalized); }
            else if (targetArrayName === 'bills') {
              const billRow = {
                "Termin p≈Çatno≈õci": normalized["Data ksiƒôgowania"],
                "Numer faktury": "IMG-FV-" + Date.now() + "-" + Math.floor(Math.random()*9999),
                "Dostawca": normalized["Kontrahent"],
                "Kwota do zap≈Çaty": Math.abs(asNum(normalized["Kwota"] || 0)).toFixed(2),
                "Waluta": normalized["Waluta"] || "PLN",
                "Status faktury": "do zap≈Çaty",
                "Kandydat (AI)": "",
                "AI score": ""
              };
              bills.unshift(billRow);
            }
          }
          try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e) {}
          try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e) {}
          inferAccounts();
          render();
          return;
        }

        // final fallback single-row
        const amtMatch = cleaned.replace(",", ".").match(/(-?\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç|zl|EUR|USD)?/i);
        const amtStr = amtMatch ? amtMatch[1].replace(/\s/g,'').replace(/\./g,'').replace(',', '.') : null;
        let fallbackAmt = amtStr ? Number(amtStr) : null;
        const dateMatch = cleaned.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
        const baseObj = {
          "ID transakcji": "IMG-" + Date.now(),
          "Data ksiƒôgowania": dateMatch ? toISO(dateMatch[1]) : (currentDateIso || (new Date().toISOString().slice(0,10))),
          "ID konta": "UNKNOWN",
          "Kontrahent": cleaned.split("\n")[0] || "",
          "Tytu≈Ç/Opis": ("OCR: " + cleaned.split("\n").slice(0,3).join(" ")).slice(0,400),
          "Kwota": (fallbackAmt != null ? fallbackAmt.toFixed(2) : ""),
          "Waluta": amtMatch && amtMatch[2] ? amtMatch[2].toUpperCase() : "PLN",
          "Status transakcji": "imported"
        };
        const normalized = normalizeRowKeys ? normalizeRowKeys(baseObj) : baseObj;
        if (targetArrayName === 'tx') {
          tx.unshift(normalized);
          try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){}
          inferAccounts();
          render();
        } else if (targetArrayName === 'bills') {
          bills.unshift({
            "Termin p≈Çatno≈õci": normalized["Data ksiƒôgowania"],
            "Numer —Ñ–∞–∫—Ç—É—Ä—ã": "IMG-FV-" + Date.now(),
            "Dostawca": normalized["Kontrahent"],
            "Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã": Math.abs(asNum(normalized["Kw–æ—Ç–∞"] || 0)).toFixed(2),
            "Waluta": normalized["Waluta"] || "PLN",
            "Status —Ñ–∞–∫—Ç—É—Ä—ã": "do zap≈Çaty",
            "Kandyd–∞—Ç (AI)": "",
            "AI score": ""
          });
          try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
          render();
        }

      } catch(err) {
        console.error("OCR error (processImageFileFor):", err);
        try { alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–∫—Ä–∏–Ω: " + (err && err.message ? err.message : String(err))); } catch(e) {}
      }
    }

    // wire image inputs safely
    document.addEventListener('DOMContentLoaded', () => {
      const txImage = $id('txImage');
      if (txImage) {
        txImage.addEventListener('change', async e => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          const last = $id("lastSync");
          if (last) last.textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
          for (const f of files) {
            await processImageFileFor('tx', f);
          }
          e.target.value = '';
        });
      }
      // other optional inputs (only wire if exist)
      const billImage = $id('billImage');
      if (billImage) {
        billImage.addEventListener('change', async e => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          for (const f of files) {
            await processImageFileFor('bills', f);
          }
          e.target.value = '';
        });
      }
    });

    // render helpers
    function renderKasa() {
      const tb = document.querySelector("#kasaTable tbody");
      if (!tb) return;
      tb.innerHTML = "";
      kasa.forEach((k, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source || ""}</td><td>${k.comment || ""}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderAccounts() {
      const tb = document.querySelector("#autoAcc tbody");
      if (!tb) return;
      tb.innerHTML = "";
      Object.values(accMeta).forEach(a => {
        const bal = computeAccountBalance(a.id);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td>
          <td>
            <select data-id="${a.id}" class="acc-type">
              <option ${a.type === "Biznes" ? "selected" : ""}>Biznes</option>
              <option ${a.type === "Osobisty" ? "selected" : ""}>Osobisty</option>
            </select>
          </td>
          <td>
            <select data-id="${a.id}" class="acc-cur">
              <option ${a.currency === "PLN" ? "selected" : ""}>PLN</option>
              <option ${a.currency === "EUR" ? "selected" : ""}>EUR</option>
              <option ${a.currency === "USD" ? "selected" : ""}>USD</option>
            </select>
          </td>
          <td>${bal.toFixed(2)}</td>
          <td><input type="number" step="0.01" value="${a.start || 0}" class="acc-start" data-id="${a.id}" /></td>
          <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include ? "checked" : ""} /></td>`;
        tb.appendChild(tr);
      });
      // bind events
      tb.querySelectorAll(".acc-type").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].type = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-cur").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].currency = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-start").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].start = asNum(e.target.value);
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-include").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].include = e.target.checked;
        saveAccMeta();
        render();
      }));
    }
    function saveAccMeta() { try { localStorage.setItem("accMeta", JSON.stringify(accMeta)); } catch(e){} }

    // Kasa CRUD safe
    function loadKasa() {
      try { kasa = JSON.parse(localStorage.getItem("kasa") || "[]"); } catch(e) { kasa = []; }
    }
    function saveKasa() { try { localStorage.setItem("kasa", JSON.stringify(kasa)); } catch(e){} }
    function addKasa(type, amount, comment, source) {
      if (amount == null || isNaN(amount)) return alert("–°—É–º–º–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞");
      kasa.push({ id: Date.now(), date: today(), type, amount: Number(amount), comment: comment || "", source: source || "—Ä—É—á–Ω–æ–π" });
      saveKasa();
      render();
      renderKasa();
    }

    // plan helpers (unchanged logic)
    function toDueList(mode) {
      const t = today();
      const excl = $id("excludeBlacklist") ? document.getElementById("excludeBlacklist").checked : false;
      return bills.filter(r => {
        const s = String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—É—Ä—ã"] || r["Status —Ñ–∞–∫—É—Ä—ã"] || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ", "to pay"].includes(s)) return false;
        const d = toISO(r["Termin p≈Çatno≈õci"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]);
        if (!d) return false;
        if (mode === "today") return d === t;
        if (mode === "7d") {
          const dd = new Date(d), tt = new Date(t);
          return (dd - tt) / (1000 * 3600 * 24) <= 7;
        }
        return true;
      }).filter(r => {
        if (String(r["Waluta"] || r["Wal—É—Ç–∞"] || "").toUpperCase() !== "PLN") return false;
        if (excl) {
          const blist = (localStorage.getItem("blacklist") || "").toLowerCase();
          if (blist && r["Dostawca"] && blist.split(",").some(name => r["Dostawca"].toLowerCase().includes(name.trim()))) {
            return false;
          }
        }
        return true;
      });
    }

    function buildPlan() {
      const planFilter = $id("planFilter");
      const mode = planFilter ? planFilter.value : "7d";
      const cand = toDueList(mode).sort((a, b) => {
        const da = new Date(toISO(a["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || a["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || a["Termin –ø–ª–∞—Ç–µ–∂–∏"] || today()));
        const db = new Date(toISO(b["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || b["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || b["Termin –ø–ª–∞—Ç–µ–∂–∏"] || today()));
        const lateA = da < new Date(today());
        const lateB = db < new Date(today());
        if (lateA !== lateB) return lateB - lateA;
        return asNum(b["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || b["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0) - asNum(a["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || a["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0);
      });
      let left = availableTotal();
      const plan = [];
      for (const r of cand) {
        const amt = asNum(r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kwota do zap≈Çaty"] || r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || 0);
        if (amt <= left) {
          plan.push({
            r,
            amt,
            reason: (toISO(r["Termin p≈Ç–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) < today() ? "–ø—Ä–æ—Å—Ä–æ—á–∫–∞" : "—Å—Ä–æ–∫")
          });
          left -= amt;
        }
      }
      return { plan, left, avail: availableTotal() };
    }

    function renderPlan() {
      const p = buildPlan();
      const tb = document.getElementById("planTable") ? document.getElementById("planTable").querySelector("tbody") : null;
      if (!tb) return;
      tb.innerHTML = "";
      p.plan.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${x.r["Numer faktury"] || x.r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || ""}</td><td>${x.r["Dostawca"] || ""}</td><td>${toISO(x.r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–µ–π"] || x.r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || x.r["Termin –ø–ª–∞—Ç–µ–∂–∏"])}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
        tb.appendChild(tr);
      });
      const metaText = p.plan.length 
        ? `–ü–æ—Ç—Ä–∞—Ç–∏–º ${(p.avail - p.left).toFixed(2)} –∏–∑ ${p.avail.toFixed(2)} PLN. –û—Å—Ç–∞–Ω–µ—Ç—Å—è ${p.left.toFixed(2)} PLN.` 
        : "–ü–ª–∞–Ω –ø—É—Å—Ç –∏–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç.";
      const pm = $id("planMeta");
      if (pm) pm.textContent = metaText;
    }

    function computeMinPay() {
      const t = today();
      const pctVal = asNum(localStorage.getItem("penaltyPct") || 0.05);
      const pct = pctVal / 100.0;
      const cand = bills.filter(r => 
        String((r["Waluta"] || r["Wal—É—Ç–∞"] || "").toUpperCase()) === "PLN" &&
        toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) <= t &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase())
      ).map(r => ({
        r,
        amt: asNum(r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞"] || 0),
        risk: asNum(r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞"] || 0) * pct
      })).sort((a, b) => b.risk - a.risk || b.amt - a.amt);
      return cand[0] || null;
    }
    function renderMinPay() {
      const m = computeMinPay();
      const el = $id("minPayBox");
      if (!el) return;
      if (!m) { el.textContent = "‚Äî"; return; }
      el.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ${m.r["Numer faktury"] || m.r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"]} (${m.r["Dostawca"]}) –Ω–∞ ${m.amt.toFixed(2)} PLN. –®—Ç—Ä–∞—Ñ/–¥–µ–Ω—å ~ ${m.risk.toFixed(2)} PLN.`;    }

    function renderForecast() {
      const t = new Date(today());
      const list = toDueList("7d").map(r => ({ date: new Date(toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"])), amt: asNum(r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ do zap≈Çaty"] || 0) }));
      const days = [...Array(7)].map((_, i) => new Date(t.getTime() + i * 86400000));
      let left = availableTotal();
      const out = days.map(d => ({ d, due: 0, after: 0 }));
      list.forEach(x => {
        const idx = Math.min(6, Math.max(0, Math.floor((x.date - t) / 86400000)));
        out[idx].due += x.amt;
      });
      out.forEach(o => { left -= o.due; o.after = left; });
      const wrap = document.getElementById("forecastBars");
      if (!wrap) return;
      wrap.innerHTML = "";
      out.forEach(o => {
        const div = document.createElement("div");
        div.className = "bar" + (o.after < 0 ? " neg" : "");
        const h = document.createElement("div");
        h.className = "h";
        h.style.height = (Math.min(120, Math.abs(o.after) / 100) * 0.8 + 18) + "px";
        div.innerHTML = "<small>" + o.d.toISOString().slice(5, 10) + "</small>";
        div.appendChild(h);
        const v = document.createElement("div");
        v.textContent = (o.after < 0 ? "-" : "") + Math.abs(o.after).toFixed(0) + " PLN";
        div.appendChild(v);
        wrap.appendChild(div);
      });
      const firstNeg = out.find(x => x.after < 0);
      const meta = $id("forecastMeta");
      if (meta) meta.textContent = firstNeg
        ? `–ì—ç–ø —á–µ—Ä–µ–∑ ${out.indexOf(firstNeg) + 1} –¥–Ω.: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${Math.abs(firstNeg.after).toFixed(2)} PLN.`
        : "–ù–∞ 7 –¥–Ω–µ–π —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞—Å—Å—ã.";
    }

    // full render (safe)
    function render() {
      try {
        tx = (JSON.parse(localStorage.getItem("tx_manual_import") || "[]").concat(tx || [])).slice(0, 5000); // avoid uncontrolled growth
      } catch(e){}
      try { bills = (JSON.parse(localStorage.getItem("bills_manual_import") || "[]").concat(bills || [])).slice(0, 5000); } catch(e){}
      try { accMeta = Object.assign({}, JSON.parse(localStorage.getItem("accMeta") || "{}"), accMeta || {}); } catch(e){}

      const dueToday = (bills || []).filter(r => {
        const s = String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase();
        return ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s) && toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) === today();
      }).length;
      const unmatch = (tx || []).filter(r => String(r["Status transakcji"] || r["status"] || "").toLowerCase() !== "sparowane").length;
      const elDue = $id("kpiDue"), elUn = $id("kpiUnmatch"), elBank = $id("kpiBank"), elCash = $id("kpiCash"), elAvail = $id("kpiAvail"), elGap = $id("kpiGap");
      if (elDue) elDue.textContent = dueToday;
      if (elUn) elUn.textContent = unmatch;
      const bankPLN = bankAvailablePLN();
      if (elBank) elBank.textContent = bankPLN.toFixed(2);
      const kas = kasaBalance();
      if (elCash) elCash.textContent = kas.toFixed(2);
      const avail = availableTotal();
      if (elAvail) elAvail.textContent = avail.toFixed(2);

      // compute sumDueToday and gap
      const sumDueToday = (bills || []).filter(r =>
        String((r["Waluta"] || r["Wal—É—Ç–∞"] || "").toUpperCase()) === "PLN" &&
        toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) <= today() &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase())
      ).reduce((s, r) => s + asNum(r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞"] || 0), 0);
      if (elGap) elGap.textContent = Math.max(0, sumDueToday - avail).toFixed(2);

      // Transactions table
      const txBody = document.getElementById("txTable") ? document.getElementById("txTable").querySelector("tbody") : null;
      if (txBody) {
        txBody.innerHTML = "";
        (tx || []).forEach(r => {
          const tr = document.createElement("tr");
          const amountHtml = fmtAmountRaw(r["Kw–æ—Ç–∞"] || r["Kw–æ—Ç–∞"] || r["amount"] || r["Kw–æ—Ç–∞_raw"] || 0);
          tr.innerHTML = `<td>${toISO(r["Data ksiƒôgowania"])}</td>
                          <td>${(r["ID konta"] || r["IBAN"] || "‚Äî")}</td>
                          <td>${(r["Kontrah–µ–Ω—Ç"] || r["Kontrahent"] || "")}</td>
                          <td>${(r["Tytu≈Ç/Opis"] || r["Opis –æ–ø–µ—Ä–∞—Üi–∏"] || r["–û–ø–∏—Å–∞–Ω–∏–µ"] || "")}</td>
                          <td>${amountHtml}</td>
                          <td>${r["Wal—É—Ç–∞"] || r["Waluta"] || ""}</td>
                          <td>${r["Status transakcji"] || ""}</td>`;
          txBody.appendChild(tr);
        });
      }

      // Invoices table
      const billTable = document.getElementById("billTable") ? document.getElementById("billTable").querySelector("tbody") : null;
      if (billTable) {
        billTable.innerHTML = "";
        (bills || []).forEach(r => {
          const s = String(r["Status faktury"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || "").toLowerCase();
          const cls = (s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä")) ? "overdue" : "due";
          const cand = r["Kandydat (AI)"] || "";
          const score = r["AI score"] || "";
          const tr = document.createElement("tr");
          const d = toISO(r["Termin p≈Ç–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) || "";
          tr.innerHTML = `<td>${d}</td>
                          <td>${r["Numer fakt—É—Ä—ã"] || r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || ""}</td>
                          <td>${r["Dostawca"] || ""}</td>
                          <td>${(r["Kw–æ—Ç–∞ do zap≈Ç–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ do zap≈Çaty"] || r["Kwota do zap≈Çaty"] || "")}</td>
                          <td>${r["Waluta"] || r["Waluta"] || ""}</td>
                          <td><span class="badge ${cls}">${r["Status faktury"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || ""}</span></td>
                          <td>${cand ? ('<span class="badge cand">' + cand + '</span>') : '‚Äî'}</td>
                          <td>${score ? ('<span class="badge ai">' + score + '</span>') : '‚Äî'}</td>
                          <td>${cand ? ('<button class="btn secondary btn-accept" data-id="' + (r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || "") + '">–ü—Ä–∏–Ω—è—Ç—å</button>') : '‚Äî'}</td>`;
          billTable.appendChild(tr);
        });
        document.querySelectorAll(".btn-accept").forEach(b =>
          b.addEventListener("click", () => acceptOne(b.getAttribute("data-id")))
        );
      }

      renderMinPay();
      renderForecast();
      renderAccounts();
      renderKasa();
    }

    function acceptOne(id) {
      const b = (bills || []).find(x => (x["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || x["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || "") === id);
      if (!b) return;
      const t = (tx || []).find(x => (x["ID transak—Ü–∏–∏"] || "") === (b["Kandyd–∞—Ç (AI)"] || ""));
      if (!t) return;
      t["Status transak—Ü–∏–∏"] = "Sparowane";
      t["PowiƒÖzana —Ñ–∞–∫—Ç—É—Ä–∞ (ID)"] = b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];
      b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
      b["Data p≈Ç–∞—Çno≈õci"] = today();
      b["Kandyd–∞—Ç (AI)"] = b["AI score"] = "";
      render();
    }

    // event bindings safely (only if elements exist)
    document.addEventListener('DOMContentLoaded', () => {
      const runAIbtn = $id("runAI"); if (runAIbtn) runAIbtn.addEventListener("click", runAI);
      const acceptSafeBtn = $id("acceptSafe"); if (acceptSafeBtn) acceptSafeBtn.addEventListener("click", acceptSafe);
      const makePlanBtn = $id("makePlan"); if (makePlanBtn) makePlanBtn.addEventListener("click", renderPlan);
      const applyPlanBtn = $id("applyPlan"); if (applyPlanBtn) applyPlanBtn.addEventListener("click", applyPlan);
      const applyMinPayBtn = $id("applyMinPay"); if (applyMinPayBtn) applyMinPayBtn.addEventListener("click", () => {
        const m = computeMinPay();
        if (!m) return alert("–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤");
        m.r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
        m.r["Data p≈Çatno≈õci"] = today();
        render();
      });

      const planFilter = $id("planFilter"); if (planFilter) planFilter.addEventListener("change", renderPlan);
      const billScope = $id("billScope"); if (billScope) billScope.addEventListener("change", render);
      const excludeBlacklist = $id("excludeBlacklist"); if (excludeBlacklist) excludeBlacklist.addEventListener("change", () => { renderPlan(); render(); });
      const billOverdueOnly = $id("billOverdueOnly"); if (billOverdueOnly) billOverdueOnly.addEventListener("change", render);

      const exportPDF = $id("exportPDF"); if (exportPDF) exportPDF.addEventListener("click", () => window.print());
      const syncNow = $id("syncNow"); if (syncNow) syncNow.addEventListener("click", async () => {
        try {
          const u1 = localStorage.getItem("txUrl") || $id("txUrl")?.value || "";
          const u2 = localStorage.getItem("billUrl") || $id("billUrl")?.value || "";
          if (u1) {
            const res = await fetch(u1, { cache: 'no-store' });
            const txt = await res.text();
            tx = parseCSV(txt).map(normalizeRowKeys);
          }
          if (u2) {
            const res2 = await fetch(u2, { cache: 'no-store' });
            const txt2 = await res2.text();
            bills = parseCSV(txt2);
          }
          inferAccounts();
          render();
          const last = $id("lastSync");
          if (last) last.textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
        } catch(e) {
          const last = $id("lastSync");
          if (last) last.textContent = "–û—à–∏–±–∫–∞: " + (e && e.message ? e.message : String(e));
        }
      });

      const txFile = $id("txFile");
      if (txFile) {
        txFile.addEventListener("change", async e => {
          const f = e.target.files[0];
          if (!f) return;
          tx = parseCSV(await f.text()).map(normalizeRowKeys);
          inferAccounts();
          render();
        });
      }
      const billFile = $id("billFile");
      if (billFile) {
        billFile.addEventListener("change", async e => {
          const f = e.target.files[0];
          if (!f) return;
          bills = parseCSV(await f.text());
          render();
        });
      }
      const saveTxUrl = $id("saveTxUrl");
      if (saveTxUrl) saveTxUrl.addEventListener("click", () => {
        const v = $id("txUrl") ? $id("txUrl").value.trim() : "";
        localStorage.setItem("txUrl", v);
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL wyciƒÖga");
      });
      const saveBillUrl = $id("saveBillUrl");
      if (saveBillUrl) saveBillUrl.addEventListener("click", () => {
        const v = $id("billUrl") ? $id("billUrl").value.trim() : "";
        localStorage.setItem("billUrl", v);
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL faktur");
      });

      // cash quick controls
      const addIn = $id("addIn"); if (addIn) addIn.addEventListener("click", () =>
        addKasa("przyjƒôcie", asNum($id("quickAmt")?.value || 0), $id("quickNote")?.value, "—Ä—É—á–Ω–æ–π")
      );
      const addOut = $id("addOut"); if (addOut) addOut.addEventListener("click", () =>
        addKasa("wydanie", asNum($id("quickAmt")?.value || 0), $id("quickNote")?.value, "—Ä—É—á–Ω–æ–π")
      );
      const cashClose = $id("cashClose"); if (cashClose) cashClose.addEventListener("click", () => {
        const a = prompt("–ò—Ç–æ–≥ –≤ –∫–∞—Å—Å–µ (PLN):", kasaBalance().toFixed(2));
        if (a === null) return;
        addKasa("zamkniƒôcie", asNum(a), "close", "—Ä—É—á–Ω–æ–π");
      });
      const q50 = $id("q50"); if (q50) q50.addEventListener("click", () => {
        const el = $id("quickAmt"); if (!el) return;
        el.value = (Number(el.value || 0) + 50).toFixed(2);
      });
      const q100 = $id("q100"); if (q100) q100.addEventListener("click", () => {
        const el = $id("quickAmt"); if (!el) return;
        el.value = (Number(el.value || 0) + 100).toFixed(2);
      });
      const q200 = $id("q200"); if (q200) q200.addEventListener("click", () => {
        const el = $id("quickAmt"); if (!el) return;
        el.value = (Number(el.value || 0) + 200).toFixed(2);
      });

      // speech stuff: only initialise if elements present and browser supports
      const micBtn = $id("micBtn");
      if (micBtn && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.continuous = false;
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.lang = localStorage.getItem("speechLang") || "pl-PL";
        rec.onstart = () => { micBtn.classList.add('on'); $id("micStatus") && ($id("micStatus").textContent = `üéôÔ∏è –°–ª—É—à–∞—é... (${rec.lang})`); };
        rec.onend = () => { micBtn.classList.remove('on'); };
        rec.onresult = (e) => {
          const text = (e.results[0][0].transcript || "").toLowerCase();
          $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: " + text);
          const numMatch = text.match(/(\d+[.,]?\d*)\s*(z≈Ç|pln)?/);
          const num = numMatch ? numMatch[1] : null;
          const isOut = /(wyda|minus|wydat|–≤—ã–¥–∞|–º–∏–Ω—É—Å|—Ä–∞—Å—Ö–æ–¥)/.test(text);
          const note = text.replace(/(\d+[.,]?\d*\s*(z≈Ç|pln)?)/, "").trim();
          if (!num) { $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –°—É–º–º—É –Ω–µ –Ω–∞—à—ë–ª"); return; }
          addKasa(isOut ? "wydanie" : "przyjƒôcie", asNum(num), note || "–≥–æ–ª–æ—Å", "voice");
        };
        micBtn.addEventListener("click", () => {
          try {
            const sel = $id("speechLang");
            if (sel) { rec.lang = sel.value; localStorage.setItem("speechLang", rec.lang); }
            rec.start();
          } catch(e) { $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –ù–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å: " + e.message); }
        });
      }

      // OCR for receipt (if input exists)
      const cashPhoto = $id("cashPhoto");
      if (cashPhoto) cashPhoto.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        await processImageFileFor('tx', f);
      });

      // settings handlers (safe)
      const applySettings = $id("applySettings");
      if (applySettings) applySettings.addEventListener("click", () => {
        localStorage.setItem("cashPLN", $id("cashPLN") ? $id("cashPLN").value : "0");
        localStorage.setItem("penaltyPct", $id("penaltyPct") ? $id("penaltyPct").value : "0.05");
        localStorage.setItem("intervalMin", $id("intervalMin") ? $id("intervalMin").value : "10");
        localStorage.setItem("rateEUR", $id("rateEUR") ? $id("rateEUR").value : "4.30");
        localStorage.setItem("rateUSD", $id("rateUSD") ? $id("rateUSD").value : "3.95");
        localStorage.setItem("blacklist", $id("blacklist") ? $id("blacklist").value : "");
        localStorage.setItem("autoCash", $id("autoCash") && $id("autoCash").checked ? "1" : "0");
        const modeText = (localStorage.getItem("otd_lang") || "ru") === "ru"
          ? "–†–µ–∂–∏–º: " + (($id("autoCash") && $id("autoCash").checked) ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
          : "Mode: " + (($id("autoCash") && $id("autoCash").checked) ? "auto" : "manual");
        if ($id("modeCash")) $id("modeCash").textContent = modeText;
        render();
      });

      const exportCfg = $id("exportCfg");
      if (exportCfg) exportCfg.addEventListener("click", () => {
        const cfg = {
          txUrl: localStorage.getItem("txUrl") || "",
          billUrl: localStorage.getItem("billUrl") || "",
          cashPLN: localStorage.getItem("cashPLN") || "0",
          penaltyPct: localStorage.getItem("penaltyPct") || "0.05",
          intervalMin: localStorage.getItem("intervalMin") || "10",
          rateEUR: localStorage.getItem("rateEUR") || "4.30",
          rateUSD: localStorage.getItem("rateUSD") || "3.95",
          blacklist: localStorage.getItem("blacklist") || "",
          autoCash: localStorage.getItem("autoCash") || "0",
          accMeta: localStorage.getItem("accMeta") || "{}"
        };
        const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "onetapday_settings.json";
        a.click();
      });

      const importCfg = $id("importCfg");
      if (importCfg) importCfg.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        const cfg = JSON.parse(await f.text());
        Object.entries(cfg).forEach(([k, v]) => localStorage.setItem(k, typeof v === "string" ? v : JSON.stringify(v)));
        location.reload();
      });

      // pilot UI (defensive) - left unchanged
      (function pilotUI() {
        function getPilot() { try { return JSON.parse(localStorage.getItem("otd_pilot") || "{}"); } catch(e){ return {}; } }
        function setPilot(s) { try { localStorage.setItem("otd_pilot", JSON.stringify(s)); } catch(e){} }
        function isoDate(d) { const x = new Date(d); return isNaN(x) ? "‚Äî" : x.toISOString().slice(0,10); }
        function daysLeft(endIso) { if (!endIso) return 0; const e = new Date(endIso), n = new Date(); return Math.max(0, Math.ceil((e - n) / 86400000)); }
        function updatePilotUI() {
          const s = getPilot();
          const st = s.status || "none";
          let desc = "‚Äî";
          if (st === "none") desc = "–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞";
          if (st === "deposit_paid") desc = "–¥–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω";
          if (st === "active") desc = "–ø–∏–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω";
          if (st === "ended") desc = "–ø–∏–ª–æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω";
          if (st === "discount_active") desc = "—Å–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
          const mini = $id("pilotMini"); if (mini) mini.textContent = "–°—Ç–∞—Ç—É—Å: " + desc;
          const ps = $id("pilotStart"); if (ps) ps.textContent = s.startAt ? isoDate(s.startAt) : "‚Äî";
          const pe = $id("pilotEnd"); if (pe) pe.textContent = s.endAt ? isoDate(s.endAt) : "‚Äî";
          const pc = $id("pilotCountdown"); if (pc) pc.textContent = (st === "active" && s.endAt) ? (" ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å " + daysLeft(s.endAt) + " –¥–Ω.") : "";
          const du = $id("discountUntil"); if (du) du.textContent = s.discountUntil ? isoDate(s.discountUntil) : "‚Äî";
          const userEmail = localStorage.getItem("otd_user") || "";
          const isAdmin = userEmail && (userEmail === "1tapday@gmail.com");
          const btnMark = $id("btnMarkPaid"), btnStart = $id("btnStartPilot"), btnReset = $id("btnResetPilot"), btnAct = $id("btnActivateDiscount");
          if (btnMark) btnMark.style.display = isAdmin ? "inline-block" : "none";
          if (btnStart) btnStart.style.display = isAdmin ? "inline-block" : "none";
          if (btnReset) btnReset.style.display = isAdmin ? "inline-block" : "none";
          if (btnAct) btnAct.style.display = (st === "ended" && isAdmin) ? "inline-block" : "none";
        }
        document.addEventListener("click", (e) => {
          const id = e.target && e.target.id;
          if (!id) return;
          let s = getPilot();
          if (id === "btnMarkPaid") {
            // best-effort: call endpoint, fallback to local update
            fetch("/mark-paid", { method: "POST" })
              .then(res => res.json()).then(data => {
                s.status = "deposit_paid"; s.paidAt = new Date().toISOString(); setPilot(s); updatePilotUI();
              }).catch(()=>{ s.status = "deposit_paid"; s.paidAt = new Date().toISOString(); setPilot(s); updatePilotUI(); });
          }
          if (id === "btnStartPilot") {
            fetch("/start-pilot", { method: "POST" })
              .then(res => res.json()).then(data => {
                s.status = "active"; s.startAt = new Date().toISOString(); const d = new Date(); d.setMonth(d.getMonth() + 2); s.endAt = d.toISOString(); setPilot(s); updatePilotUI();
              }).catch(()=>{ s.status = "active"; s.startAt = new Date().toISOString(); const d = new Date(); d.setMonth(d.getMonth() + 2); s.endAt = d.toISOString(); setPilot(s); updatePilotUI(); });
          }
          if (id === "btnActivateDiscount") {
            fetch("/activate-discount", { method: "POST" })
              .then(res => res.json()).then(data => {
                s.status = "discount_active"; s.discountSince = new Date().toISOString(); const e2 = new Date(); e2.setMonth(e2.getMonth() + 12); s.discountUntil = e2.toISOString(); setPilot(s); updatePilotUI();
              }).catch(()=>{ s.status = "discount_active"; s.discountSince = new Date().toISOString(); const e2 = new Date(); e2.setMonth(e2.getMonth() + 12); s.discountUntil = e2.toISOString(); setPilot(s); updatePilotUI(); });
          }
          if (id === "btnResetPilot") {
            localStorage.removeItem("otd_pilot");
            updatePilotUI();
          }
        }, false);
        setInterval(() => {
          const s = JSON.parse(localStorage.getItem("otd_pilot") || "{}");
          if ((s.status || "") === "active") updatePilotUI();
        }, 60000);
        updatePilotUI();
      })();

      // init load
      (function init() {
        loadKasa();
        try { accMeta = JSON.parse(localStorage.getItem("accMeta") || "{}"); } catch(e) { accMeta = {}; }
        try { tx = JSON.parse(localStorage.getItem("tx_manual_import") || "[]").concat(tx); } catch(e){}
        try { bills = JSON.parse(localStorage.getItem("bills_manual_import") || "[]").concat(bills); } catch(e){}
        renderKasa();
        if ($id("txUrl")) $id("txUrl").value = localStorage.getItem("txUrl") || "";
        if ($id("billUrl")) $id("billUrl").value = localStorage.getItem("billUrl") || "";
        if ($id("cashPLN")) $id("cashPLN").value = localStorage.getItem("cashPLN") || "5000";
        if ($id("penaltyPct")) $id("penaltyPct").value = localStorage.getItem("penaltyPct") || "0.05";
        if ($id("intervalMin")) $id("intervalMin").value = localStorage.getItem("intervalMin") || "10";
        if ($id("rateEUR")) $id("rateEUR").value = localStorage.getItem("rateEUR") || "4.30";
        if ($id("rateUSD")) $id("rateUSD").value = localStorage.getItem("rateUSD") || "3.95";
        if ($id("blacklist")) $id("blacklist").value = localStorage.getItem("blacklist") || "";
        if ($id("autoCash")) $id("autoCash").checked = localStorage.getItem("autoCash") === "1";
        const saved = localStorage.getItem("speechLang");
        if (saved && $id("speechLang")) $id("speechLang").value = saved;
        if ($id("modeCash")) $id("modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
          ? "–†–µ–∂–∏–º: " + (($id("autoCash") && $id("autoCash").checked) ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
          : "Mode: " + (($id("autoCash") && $id("autoCash").checked) ? "auto" : "manual");
        inferAccounts();
        render();
      })();
    });
  })();
  </script>

  <!-- defensive patch kept (no changes required) -->
  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function safeCall(name, ...args){ try{ if (typeof window[name] === 'function') return window[name](...args); return null;}catch(e){return null;} }
    function initTabs(){ const tabs = $$('.tabs .tab'); if (!tabs.length) return; tabs.forEach(t => { t.removeEventListener('click', t._otd_cb); const cb = () => { $$(' .tabs .tab').forEach(x=>x.classList.remove('active')); $$('.section').forEach(s=>s.classList.remove('active')); t.classList.add('active'); const sec = t.dataset.sec || t.getAttribute('data-sec') || t.getAttribute('data-section') || t.getAttribute('data-tab'); if (sec) { const el = document.getElementById(sec); if (el) el.classList.add('active'); } if (typeof render === 'function') try { render(); } catch(e){} safeCall('renderPlan'); safeCall('renderForecast'); safeCall('renderKasa'); safeCall('renderAccounts'); }; t._otd_cb = cb; t.addEventListener('click', cb); }); }
    function unblackSections(){ $$('.section').forEach(sec=>{ try{ sec.style.display = ''; if (sec.children.length > 0) sec.classList.add('active'); } catch(e){} }); }
    function initLangButtons(){ const langButtons = $$('.lang button, .lang .btn'); if (!langButtons.length) return; langButtons.forEach(b=>{ b.removeEventListener('click', b._otd_cb); const cb = () => { const L = b.dataset.lang || b.getAttribute('data-lang') || b.textContent.trim().slice(0,2).toLowerCase(); if (typeof applyLang === 'function') { try { applyLang(L); } catch(e){} } else if (window.M && window.M[L]) { document.querySelectorAll('[data-i]').forEach(el=>{ const k = el.getAttribute('data-i'); if (window.M[L][k]) el.textContent = window.M[L][k]; }); } langButtons.forEach(x => x.classList.remove('on')); b.classList.add('on'); localStorage.setItem('otd_lang', L); safeCall('render'); }; b._otd_cb = cb; b.addEventListener('click', cb); }); const saved = localStorage.getItem('otd_lang') || 'ru'; const btn = langButtons.find(b=> (b.dataset.lang||'').toLowerCase()===saved); if (btn) btn._otd_cb(); }
    function ensureForecasts(){ if (typeof renderForecast === 'function') { try { renderForecast(); } catch(e){} return; } const allTx = (window.tx && window.tx.slice()) || (() => { try { return JSON.parse(localStorage.getItem('tx_manual_import')||'[]'); } catch(e){ return []; } })(); const now = new Date(); const sumDays = (days) => { const cutoff = new Date(now.getTime() + days*86400000); return allTx.reduce((s, r) => { const date = (r['Data ksiƒôgowania'] || r['–î–∞—Ç–∞'] || r['date'] || r['Date']); const d = new Date(toISO(date)); if (isNaN(d)) return s; if (d <= cutoff) return s + Math.abs(Number(r['Kw–æ—Ç–∞']||r['Kw–æ—Ç–∞']||r['amount']||0)); return s; }, 0); }; const s7 = sumDays(7), s30 = sumDays(30); if ( $('#forecastBars') ) { $('#forecastBars').innerHTML = '<div class="muted">7d forecast (sum amounts): ' + s7.toFixed(2) + ' PLN</div>'; } if ( $('#forecast30Table') ) { $('#forecast30Table').innerHTML = '<div class="muted">30d forecast (sum amounts): ' + s30.toFixed(2) + ' PLN</div>'; } }
    function initStripeButtons(){ const btnIds = ['pay99','payNow','payAfterDemo','payNowBtn','payNowBtn2']; const btns = btnIds.map(id=>document.getElementById(id)).filter(Boolean); const more = Array.from(new Set([].concat(Array.from(document.querySelectorAll('button.pay-btn, button.btn.pay, button.pay, .pay-btn'))))); const unique = Array.from(new Set([].concat(btns, more))); if (!unique.length) return; unique.forEach(b=>{ b.removeEventListener('click', b._otd_cb); const cb = async (e) => { e.preventDefault(); const fallbackLink = localStorage.getItem('stripe_link') || localStorage.getItem('stripePaymentLink'); if (fallbackLink) { window.location.href = fallbackLink; return; } try { const resp = await fetch('/create-checkout-session', { method: 'POST', headers: {'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify({demo: true}) }); if (!resp.ok) { const txt = await resp.text().catch(()=>null); alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏: ' + (txt || resp.status)); return; } const json = await resp.json().catch(()=>null); if (json && json.url) { window.location.href = json.url; return; } if (json && json.session && json.session.url) { window.location.href = json.session.url; return; } alert('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.'); } catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º /create-checkout-session. –ú–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ localStorage.stripe_link'); } }; b._otd_cb = cb; b.addEventListener('click', cb); }); }
    function ensureRenderers(){ if (typeof renderInvoices === 'function') try { renderInvoices(); } catch(e) {} if (typeof render === 'function') try { render(); } catch(e) {} if (typeof renderAccounts === 'function') try { renderAccounts(); } catch(e) {} if (typeof renderKasa === 'function') try { renderKasa(); } catch(e) {} }
    function initAll(){ try { initTabs(); } catch(e){} try { unblackSections(); } catch(e){} try { initLangButtons(); } catch(e){} try { ensureForecasts(); } catch(e){} try { initStripeButtons(); } catch(e){} try { ensureRenderers(); } catch(e){} safeCall('render'); safeCall('renderPlan'); safeCall('renderKasa'); safeCall('renderAccounts'); safeCall('renderForecast'); }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initAll); else initAll();
    window.OTD_PATCH = { init: initAll, report: function(){ return { sections: Array.from(document.querySelectorAll('.section')).map(s => ({id:s.id, classes: s.className, children: s.children.length })), langButtons: Array.from(document.querySelectorAll('.lang button')).map(b=>({text:b.textContent, data: b.dataset})), stripeButtons: Array.from(new Set(['pay99','payNow','payAfterDemo','payNowBtn','payNowBtn2'].map(id=>document.getElementById(id)).filter(Boolean))).length }; } };
  })();
  </script>
</body>
</html>
