<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay ‚Äì AI Ksiƒôgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #cfe6d7;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: var(--accent);
      color: #08110b;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #9aa3a9;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number] {
      background: #0f1214;
      border: 1px solid #20262b;
      border-radius: 8px;
      color: #e6edf3;
      padding: 9px;
    }
    .right { margin-left: auto; }
    .mic {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2a3136;
      background: #0f1214;
      cursor: pointer;
    }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    @media (max-width: 1080px) {
      .cards { grid-template-columns: 1fr 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
    @media print {
      .tabs, .btn, .row input, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .card { background: #fff; border: 1px solid #999; }
      .wrap { max-width: 1000px; }
    }
    /* Language toggle (reuse same style as portal) */
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #20262b;
      background: #0f1214;
      color: #9aa3a9;
      font-size: 12px;
      cursor: pointer;
    }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay ‚Äî AI Ksiƒôgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">–ü—É–ª—å—Ç</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciƒÖg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">–°—á–µ—Ç–∞</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (–Ω–∞–ª)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="pulpit" class="section active">
      <div class="cards">
        <div class="card">
          <div class="muted" data-i="kpi_due_today">–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiDue" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_unmatched">–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
          <div id="kpiUnmatch" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_banks">–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ</div>
          <div id="kpiBank" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_cash">–ö–∞—Å—Å–∞ (–Ω–∞–ª)</div>
          <div id="kpiCash" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_total">–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ</div>
          <div id="kpiAvail" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_gap_today">–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiGap" class="kpi">0</div>
        </div>
      </div>
      <div class="row" style="margin: 10px 0;">
        <button id="syncNow" class="btn" data-i="btn_sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
        <button id="runAI" class="btn secondary" data-i="btn_ai_match">–ò–ò-—Å–≤–µ—Ä–∫–∞</button>
        <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã</button>
        <button id="exportPDF" class="btn secondary" data-i="btn_pdf">PDF –æ—Ç—á—ë—Ç</button>
        <span id="lastSync" class="pill">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ‚Äî</span>
        <span class="right pill" id="modeCash">–†–µ–∂–∏–º: –∞–≤—Ç–æ</span>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="minpay_title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)</div>
          <div id="minPayBox" class="muted">‚Äî</div>
          <div class="row" style="margin-top: 6px;">
            <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_7d">–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast7d_note">–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.</div>
          <div id="forecastBars" class="barwrap"></div>
          <div id="forecastMeta" class="muted" style="margin-top: 6px;">‚Äî</div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_30d">–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast30_note">–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.</div>
          <div id="forecast30Table"></div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="month_summary_title">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</div>
          <div id="monthSummary" class="muted">‚Äî</div>
        </div>
      </div>
      <div class="card" style="margin-top: 14px;">
        <div class="row">
          <div style="font-weight: 700;" data-i="plan_title">–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É</div>
          <div class="right"> 
            <span data-i="filter_label">–§–∏–ª—å—Ç—Ä:</span>
            <select id="planFilter">
              <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
              <option value="all" data-i="filter_all">–í—Å–µ</option>
            </select>
          </div>
          <label style="margin-left: 10px;">
            <input type="checkbox" id="excludeBlacklist" /> <span data-i="exclude_blacklist">–ò—Å–∫–ª—é—á–∞—Ç—å blacklist</span>
          </label>
        </div>
        <div class="row" style="margin: 8px 0;">
          <button id="makePlan" class="btn secondary" data-i="btn_make_plan">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span id="planMeta" class="pill">‚Äî</span>
        </div>
        <table id="planTable">
          <thead>
            <tr>
              <th>#</th>
              <th data-i="plan_th_invoice">–§–∞–∫—Ç—É—Ä–∞</th>
              <th data-i="plan_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th data-i="plan_th_due">–°—Ä–æ–∫</th>
              <th data-i="plan_th_amount">–°—É–º–º–∞</th>
              <th data-i="plan_th_reason">–ü—Ä–∏—á–∏–Ω–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Bank Statement Section (WyciƒÖg) -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_statement">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)</span>
        </label>

        <!-- NEW: gallery/screenshots upload for wyciag -->
        <label class="btn ghost">
          <input id="txImage" type="file" accept="image/*" multiple style="display: none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω –≤—ã–ø–∏—Å–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>

        <!-- preview for wyciag (separate from kasa thumb) -->
        <img id="txLastThumb" class="thumb" style="display: none;" />

        <input id="txUrl" type="text" placeholder="URL CSV wyciƒÖga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <span class="muted">
          –ö–æ–ª–æ–Ω–∫–∏: Data ksiƒôgowania, ID transakcji, ID konta (–∏–ª–∏ IBAN), Kontrahent, Tytu≈Ç/Opis, Kwota(¬±), Waluta, Status —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, Saldo po operacji?
        </span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">–î–∞—Ç–∞</th>
            <th data-i="th_account">–°—á—ë—Ç</th>
            <th data-i="th_counterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
            <th data-i="th_desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th data-i="th_amount">–°—É–º–º–∞</th>
            <th data-i="th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="th_status">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Invoices Section (Faktury) -->
    <div id="faktury" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_invoices">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)</span>
        </label>

        <!-- NEW: gallery/screenshots upload for faktury -->
        <label class="btn ghost">
          <input id="billImage" type="file" accept="image/*" multiple style="display: none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω —Ñ–∞–∫—Ç—É—Ä—ã (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>

        <!-- preview for faktury -->
        <img id="billLastThumb" class="thumb" style="display: none;" />

        <input id="billUrl" type="text" placeholder="URL CSV faktur" />
        <button id="saveBillUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <label style="margin-left: 10px;">
          <input type="checkbox" id="billOverdueOnly" /> <span data-i="only_overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</span>
        </label>
        <div class="right">
          <span data-i="show_label">–ü–æ–∫–∞–∑–∞—Ç—å:</span>
          <select id="billScope">
            <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
            <option value="all" data-i="filter_all">–í—Å–µ</option>
          </select>
        </div>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th data-i="inv_th_due">–°—Ä–æ–∫</th>
            <th data-i="inv_th_number">‚Ññ</th>
            <th data-i="inv_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
            <th data-i="inv_th_amount">–°—É–º–º–∞</th>
            <th data-i="inv_th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="inv_th_status">–°—Ç–∞—Ç—É—Å</th>
            <th data-i="inv_th_candidate">–ö–∞–Ω–¥–∏–¥–∞—Ç</th>
            <th data-i="inv_th_score">Score</th>
            <th data-i="inv_th_action">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Accounts Section (Konta) -->
    <div id="konta" class="section">
      <div class="card">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="auto_accounts_title">–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)</div>
        <div class="muted" data-i="auto_accounts_desc">
          –ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.
        </div>
        <table id="autoAcc">
          <thead>
            <tr>
              <th data-i="acc_th_account">–°—á—ë—Ç</th>
              <th data-i="acc_th_type">–¢–∏–ø</th>
              <th data-i="acc_th_currency">–í–∞–ª—é—Ç–∞</th>
              <th data-i="acc_th_balance_calc">–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)</th>
              <th data-i="acc_th_start_balance">–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</th>
              <th data-i="acc_th_include">–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cash Section (Kasa) -->
    <div id="kasa" class="section">
      <div class="row">
        <input id="quickAmt" type="number" placeholder="–°—É–º–º–∞ PLN" step="0.01" />
        <input id="quickNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
        <button class="btn" id="addIn" data-i="btn_add_in">+ –ü—Ä–∏—ë–º</button>
        <button class="btn secondary" id="addOut" data-i="btn_add_out">‚àí –í—ã–¥–∞—á–∞</button>
        <button class="btn secondary" id="cashClose" data-i="btn_close_shift">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
        <button class="btn ghost" id="q50">+50</button>
        <button class="btn ghost" id="q100">+100</button>
        <button class="btn ghost" id="q200">+200</button>

        <!-- keep cash photo but clarify (so people don't upload bank screens here) -->
        <label class="btn ghost">
          <input id="cashPhoto" type="file" accept="image/*" capture="environment" style="display: none;" />
          <span>–°–∫–∞–Ω —á–µ–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∫–∞—Å—Å—É</span>
        </label>

        <button id="micBtn" class="mic" title="–°–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">üéôÔ∏è</button>
        <span class="hint">
          –ü—Ä–∏–º–µ—Ä: ¬´–ø—Ä–∏–Ω—è—Ç—å 120 –Ω–∞ –∫–∞—Å—Å—É –æ—Ç –ø—Ä–æ–¥–∞–∂¬ª, ¬´–≤—ã–¥–∞—Ç—å 50 –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É¬ª
        </span>
        <!-- thumb for kasa stays here -->
        <img id="lastThumb" class="thumb" style="display: none;" />
        <span id="micStatus" class="pill">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≥–æ—Ç–æ–≤</span>
      </div>
      <div class="row" style="margin-top: 8px;">
        <label>
          <span data-i="speech_lang">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</span>
          <select id="speechLang">
            <option value="pl-PL">pl-PL</option>
            <option value="ru-RU">ru-RU</option>
            <option value="uk-UA">uk-UA</option>
            <option value="en-US">en-US</option>
          </select>
        </label>
        <button id="micTest" class="btn secondary" data-i="btn_test_voice">–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥</button>
      </div>
      <table id="kasaTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">–î–∞—Ç–∞</th>
            <th data-i="cash_th_type">–¢–∏–ø</th>
            <th data-i="cash_th_amount">–°—É–º–º–∞</th>
            <th data-i="cash_th_source">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th data-i="cash_th_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Settings Section (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) -->
    <div id="ustawienia" class="section">
      <div class="card" id="otdSubCard">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="pilot_subscription_title">–ü–æ–¥–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–∞</div>
        <div class="row" style="margin: 6px 0;">
          <span id="pilotMini" class="pill">–°—Ç–∞—Ç—É—Å: ‚Äî</span>
        </div>
        <div class="row" style="gap: 8px; margin-top: 6px;">
          <button id="btnMarkPaid" class="btn secondary" data-i="btn_mark_paid">–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
          <button id="btnStartPilot" class="btn secondary" data-i="btn_start_pilot">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∏–ª–æ—Ç (2 –º–µ—Å.)</button>
          <button id="btnActivateDiscount" class="btn secondary" data-i="btn_activate_discount">–í–∫–ª—é—á–∏—Ç—å ‚àí50% –Ω–∞ 12 –º–µ—Å.</button>
          <button id="btnResetPilot" class="btn ghost" data-i="btn_reset_pilot">–°–±—Ä–æ—Å</button>
        </div>
        <div class="muted" style="margin-top: 6px;">
          <span data-i="start_label">–ù–∞—á–∞–ª–æ:</span> <b id="pilotStart">‚Äî</b> ¬∑ 
          <span data-i="end_label">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> <b id="pilotEnd">‚Äî</b> 
          <span id="pilotCountdown"></span><br/>
          <span data-i="discount_label">–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:</span> <b id="discountUntil">‚Äî</b>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="calc_mode">–†–µ–∂–∏–º —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</div>
        <div class="row" style="margin-top: 6px;">
          <label><input type="checkbox" id="autoCash" /> <span data-i="auto_mode_label">–ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞</span></label>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="parameters">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        <div class="row" style="margin-top: 6px;">
          <label><span data-i="param_cash">–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):</span> <input id="cashPLN" type="number" step="0.01" value="5000" /></label>
          <label><span data-i="param_penalty">–ü–µ–Ω—è, %/–¥–µ–Ω—å:</span> <input id="penaltyPct" type="number" step="0.01" value="0.05" /></label>
          <label><span data-i="param_interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:</span> <input id="intervalMin" type="number" min="1" value="10" /></label>
        </div>
        <div class="row" style="margin-top: 6px;">
          <label>EUR‚ÜíPLN: <input id="rateEUR" type="number" step="0.0001" value="4.30" /></label>
          <label>USD‚ÜíPLN: <input id="rateUSD" type="number" step="0.0001" value="3.95" /></label>
          <label>Blacklist: <input id="blacklist" type="text" placeholder="Firma X, BadVendor" /></label>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button id="applySettings" class="btn" data-i="btn_save_settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="exportCfg" class="btn secondary" data-i="btn_export_settings">–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
          <label class="btn ghost">
            <input id="importCfg" type="file" accept="application/json" style="display: none;" />
            <span data-i="btn_import_settings">–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</span>
          </label>
        </div>
        <div class="muted" style="margin-top: 6px;" data-i="auto_mode_explain">
          –†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑ wyciƒÖg (–∏–ª–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã. 
          –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É + –∫–∞—Å—Å—É.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Redirect to portal if not logged in
    if (!localStorage.getItem("otd_user")) {
      window.location.href = "/";
    }

    // Internationalization strings for main app
    const M = {
      ru: {
        tab_dashboard: "–ü—É–ª—å—Ç", tab_statement: "–í—ã–ø–∏—Å–∫–∞", tab_invoices: "–§–∞–∫—Ç—É—Ä—ã", tab_accounts: "–°—á–µ—Ç–∞", tab_cash: "–ö–∞—Å—Å–∞", tab_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        kpi_due_today: "–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è", kpi_unmatched: "–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", kpi_banks: "–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ", kpi_cash: "–ö–∞—Å—Å–∞ (–Ω–∞–ª)", kpi_total: "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ", kpi_gap_today: "–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è",
        btn_sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", btn_ai_match: "–ò–ò-—Å–≤–µ—Ä–∫–∞", btn_accept_safe: "–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã", btn_pdf: "PDF –æ—Ç—á—ë—Ç",
        minpay_title: "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)", btn_apply_minpay: "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ",
        forecast_7d: "–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π", forecast7d_note: "–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.",
        forecast_30d: "–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π", forecast30_note: "–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.",
        month_summary_title: "–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞",
        plan_title: "–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É", filter_label: "–§–∏–ª—å—Ç—Ä:", filter_today: "–°–µ–≥–æ–¥–Ω—è", filter_7d: "7 –¥–Ω–µ–π", filter_all: "–í—Å–µ", exclude_blacklist: "–ò—Å–∫–ª—é—á–∞—Ç—å blacklist",
        btn_make_plan: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", btn_apply_plan: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
        plan_th_invoice: "–§–∞–∫—Ç—É—Ä–∞", plan_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", plan_th_due: "–°—Ä–æ–∫", plan_th_amount: "–°—É–º–º–∞", plan_th_reason: "–ü—Ä–∏—á–∏–Ω–∞",
        upload_statement: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)", save_url: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL",
        th_date: "–î–∞—Ç–∞", th_account: "–°—á—ë—Ç", th_counterparty: "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc: "–û–ø–∏—Å–∞–Ω–∏–µ", th_amount: "–°—É–º–º–∞", th_currency: "–í–∞–ª—é—Ç–∞", th_status: "–°—Ç–∞—Ç—É—Å",
        upload_invoices: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)", only_overdue: "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ", show_label: "–ü–æ–∫–∞–∑–∞—Ç—å:",
        inv_th_due: "–°—Ä–æ–∫", inv_th_number: "‚Ññ", inv_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", inv_th_amount: "–°—É–º–º–∞", inv_th_currency: "–í–∞–ª—é—Ç–∞", inv_th_status: "–°—Ç–∞—Ç—É—Å", inv_th_candidate: "–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score: "Score", inv_th_action: "–î–µ–π—Å—Ç–≤–∏–µ",
        auto_accounts_title: "–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)",
        auto_accounts_desc: "–ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.",
        acc_th_account: "–°—á—ë—Ç", acc_th_type: "–¢–∏–ø", acc_th_currency: "–í–∞–ª—é—Ç–∞", acc_th_balance_calc: "–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)", acc_th_start_balance: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å", acc_th_include: "–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞",
        btn_add_in: "+ –ü—Ä–∏—ë–º", btn_add_out: "‚àí –í—ã–¥–∞—á–∞", btn_close_shift: "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É", btn_scan_receipt: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ)",
        speech_lang: "–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", btn_test_voice: "–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥",
        cash_th_date: "–î–∞—Ç–∞", cash_th_type: "–¢–∏–ø", cash_th_amount: "–°—É–º–º–∞", cash_th_source: "–ò—Å—Ç–æ—á–Ω–∏–∫", cash_th_comment: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        pilot_subscription_title: "–ü–æ–¥–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–∞", // pilot subscription section
        btn_mark_paid: "–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É", btn_start_pilot: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∏–ª–æ—Ç (2 –º–µ—Å.)", btn_activate_discount: "–í–∫–ª—é—á–∏—Ç—å ‚àí50% –Ω–∞ 12 –º–µ—Å.", btn_reset_pilot: "–°–±—Ä–æ—Å",
        start_label: "–ù–∞—á–∞–ª–æ:", end_label: "–û–∫–æ–Ω—á–∞–Ω–∏–µ:", discount_label: "–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:",
        calc_mode: "–†–µ–∂–∏–º —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤", auto_mode_label: "–ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞",
        parameters: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã",
        param_cash: "–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):", param_penalty: "–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval: "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:",
        btn_save_settings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btn_export_settings: "–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫", btn_import_settings: "–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫",
        auto_mode_explain: "–†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑ wyciƒÖg (–∏–ª–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã. –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É + –∫–∞—Å—Å—É."
      },
      en: { /* omitted for brevity ‚Äî unchanged from previous file */ },
      pl: { /* omitted for brevity ‚Äî unchanged */ },
      uk: { /* omitted for brevity ‚Äî unchanged */ }
    };

    const $ = id => document.getElementById(id);

    // --- per-user localStorage helpers (kept) ---
    function _currentUserEmail() {
      const e = localStorage.getItem('otd_user') || '';
      return (e && typeof e === 'string') ? e.toLowerCase() : '';
    }
    function _localKeyForUser(email) {
      if (!email) return 'otd_app_state_guest';
      return 'otd_app_state_' + email.replace(/[^a-z0-9@.]/g,'_');
    }

    // simple GET wrapper
    async function getJSON(path){
      try {
        const r = await fetch(path, { credentials:'include' });
        let parsed;
        try { parsed = await r.json(); } catch(e) { parsed = { _raw: await r.text().catch(()=>'') }; }
        return { ok: r.ok, status: r.status, body: parsed };
      } catch(e){ return { ok:false, status:0, body: String(e) }; }
    }

    // Universal POST wrapper (cookies included)
    async function postJSON(path, body = {}) {
      try {
        const r = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body || {})
        });
        let parsed;
        try { parsed = await r.json(); } catch(e) { parsed = { _raw: await r.text().catch(()=>'') }; }
        return { ok: r.ok, status: r.status, body: parsed };
      } catch (err) {
        return { ok: false, status: 0, body: { error: String(err) } };
      }
    }

    // Internationalization small helper
    function applyLang(lang) {
      const dict = (M[lang] || M.ru);
      document.querySelectorAll('[data-i]').forEach(el => {
        const k = el.getAttribute('data-i');
        if (dict[k]) el.textContent = dict[k];
      });
      document.querySelectorAll('#langBarMain button').forEach(btn=>btn.classList.toggle('on', btn.dataset.lang === lang));
      localStorage.setItem('otd_lang', lang);
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      applyLang(localStorage.getItem('otd_lang') || 'ru');

      document.querySelectorAll('#langBarMain button').forEach(b => b.addEventListener('click', ()=>applyLang(b.dataset.lang)));
      document.querySelectorAll('.tabs .tab').forEach(t => t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.sec).classList.add('active');
      }));

      // following variables represent client-side model
      window.tx = window.tx || [];
      window.bills = window.bills || [];
      window.kasa = window.kasa || [];
    });

    // --- now the big app logic (kept structure, but fixes applied) ---
  </script>

  <script>
  (function(){
    // small utilities
    function toISO(d) {
      if (!d) return "";
      const s = String(d).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return m[0];
      m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
      if (m) {
        const dd = m[1].padStart(2, "0"),
              mm = m[2].padStart(2, "0"),
              yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
        return yy + "-" + mm + "-" + dd;
      }
      return "";
    }
    const asNum = v => Number(String(v || "").replace(/\s/g, "").replace(",", "."));
    const today = () => new Date().toISOString().slice(0, 10);

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      const txt = await res.text();
      return parseCSV(txt);
    }
    function smartSplit(line, del) {
      let out = [], cur = "", q = false;
      for (let ch of line) {
        if (ch === '"') { q = !q; continue; }
        if (ch === del && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      text = text.replace(/\r/g, "");
      const lines = text.split("\n").filter(l => l.trim());
      if (!lines.length) return [];
      const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
      const head = smartSplit(lines.shift(), sep).map(h => h.trim());
      return lines.map(line => {
        const cells = smartSplit(line, sep);
        const obj = {};
        head.forEach((h, i) => obj[h] = (cells[i] || "").trim());
        return obj;
      });
    }

    function normName(s) {
      s = (s || "").toLowerCase().replace(/[.,]/g, " ").replace(/\s+/g, " ").trim();
      const stop = ["sp z oo", "sp. z o.o.", "spolka", "sp√≥≈Çka", "sa", "s.a", "ooo"];
      stop.forEach(t => s = s.replace(t, ""));
      return s.trim();
    }
    function nameSimilar(a, b) {
      a = normName(a); b = normName(b);
      if (!a || !b) return 0;
      if (a === b) return 1;
      if (a.includes(b) || b.includes(a)) return 0.8;
      return 0;
    }

    // account inference + balances
    let tx = [], bills = [], kasa = [];
    let accMeta = {};

    function inferAccounts() {
      const map = {};
      tx.forEach(r => {
        const id = r["ID konta"] || r["IBAN"] || "UNKNOWN";
        const cur = (r["Waluta"] || "PLN").toUpperCase();
        if (!map[id]) {
          map[id] = { id, name: id.slice(0, 12), currency: cur, include: true, type: "Biznes", start: 0 };
        }
      });
      try {
        const saved = JSON.parse(localStorage.getItem("accMeta") || "{}");
        Object.keys(map).forEach(id => {
          if (saved[id]) map[id] = Object.assign(map[id], saved[id]);
        });
      } catch(e) {}
      accMeta = map;
      renderAccounts();
    }

    function computeAccountBalance(accId) {
      const rows = tx.filter(r => (r["ID konta"] || r["IBAN"] || "UNKNOWN") === accId);
      const withSaldo = rows.filter(r => r["Saldo po operacji"]);
      if (withSaldo.length) {
        const last = withSaldo[withSaldo.length - 1];
        return asNum(last["Saldo po operacji"]);
      }
      const start = Number((accMeta[accId] || {}).start || 0);
      const sum = rows.reduce((s, r) => s + asNum(r["Kwota"] || r["Kw–æ—Ç–∞"] || r["Kwota"] || r["Kwota"]), 0);
      return start + sum;
    }
    function rate(cur) {
      cur = String(cur || "PLN").toUpperCase();
      if (cur === "PLN") return 1;
      if (cur === "EUR") return asNum(localStorage.getItem("rateEUR") || 4.3);
      if (cur === "USD") return asNum(localStorage.getItem("rateUSD") || 3.95);
      return 1;
    }
    function bankAvailablePLN() {
      let sum = 0;
      Object.values(accMeta).filter(a => a.include).forEach(a => {
        const bal = computeAccountBalance(a.id);
        sum += bal * rate(a.currency);
      });
      return sum;
    }
    function kasaBalance() {
      let bal = 0;
      kasa.forEach(k => {
        if (k.type === "przyjƒôcie") bal += k.amount;
        if (k.type === "wydanie") bal -= k.amount;
        if (k.type === "zamkniƒôcie") bal = k.amount;
      });
      return bal;
    }
    function availableTotal() {
      const auto = localStorage.getItem("autoCash") === "1";
      const manual = asNum(localStorage.getItem("cashPLN") || 0);
      const kas = kasaBalance();
      return auto ? (bankAvailablePLN() + kas) : (manual + kas);
    }

    function scoreMatch(bill, tr) {
      let score = 0;
      const bAmt = asNum(bill["Kwota do zap≈Çaty"] || bill["Kw–æ—Ç–∞ do zap≈Çaty"]);
      const tAmt = Math.abs(asNum(tr["Kwota"] || tr["Kw–æ—Ç–∞"] || tr["Kw–æ—Ç–∞"]));
      const bCur = String(bill["Waluta"] || "").toUpperCase();
      const tCur = String(tr["Waluta"] || "").toUpperCase();
      if (bAmt > 0 && tAmt > 0 && Math.abs(bAmt - tAmt) < 0.005 && bCur === tCur) score += 60;
      const inv = String(bill["Numer faktury"] || "").toLowerCase();
      const desc = String(tr["Tytu≈Ç/Opis"] || tr["Opis operacji"] || "").toLowerCase();
      if (inv && desc.includes(inv)) score += 25;
      if (nameSimilar(bill["Dostawca"], tr["Kontrahent"] || "") >= 0.8) score += 10;
      if (asNum(tr["Kwota"] || tr["Kw–æ—Ç–∞"] || tr["Kw–æ—Ç–∞"]) < 0) score += 5;
      return { score: Math.min(100, score) };
    }

    function runAI() {
      bills.forEach(b => {
        const status = String(b["Status faktury"] || "").toLowerCase();
        if (status.includes("op≈Çacone") || status.includes("–æ–ø–ª–∞—á–µ–Ω–æ")) return;
        let best = null;
        tx.forEach(t => {
          if (String(t["Status transakcji"] || "").toLowerCase() === "sparowane") return;
          if (asNum(t["Kw–æ—Ç–∞"] || t["Kw–æ—Ç–∞"] || t["Kwota"]) >= 0) return;
          const s = scoreMatch(b, t);
          if (!best || s.score > best.s) best = { t, s: s.score };
        });
        if (best && best.s >= 85) {
          best.t["Status transakcji"] = "Sparowane";
          best.t["PowiƒÖzana faktura (ID)"] = b["Numer faktury"];
          b["Status faktury"] = "Op≈Çacone";
          b["Data p≈Çatno≈õci"] = today();
        } else if (best && best.s >= 55) {
          b["Kandyd–∞—Ç (AI)"] = best.t["ID transakcji"];
          b["AI score"] = best.s;
        } else {
          b["Kandyd–∞—Ç (AI)"] = "";
          b["AI score"] = "";
        }
      });
      render();
    }
    function acceptSafe() {
      bills
        .filter(b => Number(b["AI score"] || 0) >= 85)
        .forEach(b => {
          const t = tx.find(t => t["ID transakcji"] === b["Kandyd–∞—Ç (AI)"]);
          if (!t) return;
          t["Status transakcji"] = "Sparowane";
          t["PowiƒÖzana faktura (ID)"] = b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];
          b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
          b["Data p≈Ç–∞—Çno≈õci"] = today();
          b["Kandyd–∞—Ç (AI)"] = b["AI score"] = "";
        });
      render();
    }

    // ---- FIXED: normalizeRowKeys now robustly prefers Latin "Kwota" and tolerates variants ----
    function normalizeRowKeys(r) {
      const out = {
        "Data ksiƒôgowania": r["Data ksiƒôgowania"] || r.date || r["–î–∞—Ç–∞"] || today(),
        "ID transakcji": r["ID transakcji"] || r.id || ("IMG-" + Date.now()),
        "ID konta": r["ID konta"] || r.account || r["IBAN"] || "UNKNOWN",
        "Kontrahent": r["Kontrahent"] || r.counterparty || r["–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"] || "",
        "Tytu≈Ç/Opis": r["Tytu≈Ç/Opis"] || r.desc || r["–û–ø–∏—Å–∞–Ω–∏–µ"] || (r.title || ""),
        // prefer Latin "Kwota" but also create cyrillic variant for legacy checks
        "Kwota": (typeof r["Kwota"] !== "undefined") ? String(r["Kwota"]) : (typeof r["Kw–æ—Ç–∞"] !== "undefined" ? String(r["Kw–æ—Ç–∞"]) : (r.amount != null ? String(r.amount) : "")),
        "Kw–æ—Ç–∞": (typeof r["Kwota"] !== "undefined") ? String(r["Kw–æ—Ç–∞"] || r["Kw–æ—Ç–∞"] || r.amount || "") : (typeof r["Kw–æ—Ç–∞"] !== "undefined" ? String(r["Kw–æ—Ç–∞"]) : (r.amount != null ? String(r.amount) : "")),
        "Waluta": r["Waluta"] || r.currency || "PLN",
        "Status transakcji": r["Status transakcji"] || r.status || "imported",
        "Saldo po operacji": r["Saldo po operacji"] || r.saldo || ""
      };
      return out;
    }

    // ---- OCR processing logic for images (wyciag / faktury) with improved preprocessing ----
    async function processImageFileFor(targetArrayName, file) {
      if (!file) return;
      const imgURL = URL.createObjectURL(file);
      try {
        // choose correct preview element by target
        let thumbId = 'lastThumb';
        if (targetArrayName === 'tx') thumbId = 'txLastThumb';
        else if (targetArrayName === 'bills') thumbId = 'billLastThumb';
        const thumb = document.getElementById(thumbId);
        if (thumb) { thumb.src = imgURL; thumb.style.display = "inline-block"; }

        // load image into Image for preprocessing
        const img = await new Promise((res, rej) => {
          const i = new Image();
          i.onload = () => res(i);
          i.onerror = (e) => rej(e);
          i.src = imgURL;
        });

        // canvas preprocess: upscale a bit, grayscale, auto-invert for dark theme, adaptive-ish threshold
        const maxDim = 3000; // increased max dimension for better OCR on small screenshots
        const w0 = img.width, h0 = img.height;
        const scale = Math.min(3, Math.max(1, maxDim / Math.max(w0, h0))); // allow up to 3x upscale
        const w = Math.round(w0 * scale), h = Math.round(h0 * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        // draw with smoothing disabled to preserve text shapes
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(img, 0, 0, w, h);

        try {
          // grayscale
          const id = ctx.getImageData(0, 0, w, h);
          const d = id.data;
          let sum = 0, sum2 = 0, cnt = 0;
          for (let i = 0; i < d.length; i += 4) {
            const r = d[i], g = d[i+1], b = d[i+2];
            const l = Math.round(0.299*r + 0.587*g + 0.114*b);
            d[i] = d[i+1] = d[i+2] = l;
            sum += l; sum2 += l*l; cnt++;
          }
          ctx.putImageData(id, 0, 0);

          const mean = sum / Math.max(1, cnt);
          const std = Math.sqrt(Math.max(0, sum2 / Math.max(1, cnt) - mean*mean));

          // if image seems dark (low mean) ‚Äî invert to make text dark on light background
          if (mean < 120) {
            const idInv = ctx.getImageData(0,0,w,h);
            const dinv = idInv.data;
            for (let i = 0; i < dinv.length; i += 4) {
              dinv[i] = 255 - dinv[i];
              dinv[i+1] = 255 - dinv[i+1];
              dinv[i+2] = 255 - dinv[i+2];
            }
            ctx.putImageData(idInv, 0, 0);
          }

          // now simple global threshold informed by mean/std (adaptive-ish)
          const final = ctx.getImageData(0,0,w,h);
          const df = final.data;
          const thresh = Math.max(120, Math.round(mean - std * 0.10));
          for (let i = 0; i < df.length; i += 4) {
            const v = df[i];
            const val = v < thresh ? 0 : 255;
            df[i] = df[i+1] = df[i+2] = val;
          }
          ctx.putImageData(final, 0, 0);
        } catch(procErr) {
          console.warn("Preprocess failed, continuing with original image", procErr);
        }

        const processedDataUrl = canvas.toDataURL('image/png', 1.0);

        // create worker (best-effort); languages list kept minimal to avoid failures
        const worker = await Tesseract.createWorker({
          logger: m => console.debug("TESS:", m) // keep logs for debugging
        });
        await worker.load();
        // try to load languages; ignore failures and fallback gracefully
        try {
          await worker.loadLanguage("pol+eng");
          await worker.initialize("pol+eng");
        } catch(e) {
          try { await worker.loadLanguage("eng"); await worker.initialize("eng"); } catch(_) {}
        }

        // prefer recognize on processed DataURL
        const { data: { text } } = await worker.recognize(processedDataUrl);
        await worker.terminate();

        const cleaned = String(text || "").replace(/\u00A0/g, ' ').trim();
        console.log("OCR result (preview):", cleaned);
        localStorage.setItem('lastOCR', cleaned);

        // basic heuristics: find amounts (multiple), date, invoice, supplier
        // find all amounts
        const amountRe = /(-?\d{1,3}(?:[ \u00A0.,]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç|zl|zlot|EUR|USD)?/gi;
        const found = [];
        let m;
        while ((m = amountRe.exec(cleaned)) !== null) {
          found.push({ raw: m[0], value: m[1], cur: m[2] ? m[2] : 'PLN', index: m.index });
        }

        const dateMatch = cleaned.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
        const invoiceMatch = cleaned.match(/(faktura|FV|nr[:\s]*)([A-Za-z0-9\-\/]+)/i);
        const supplierMatch = cleaned.split("\n").map(l=>l.trim()).filter(Boolean)[0] || "";

        // sign detection
        const outWords = /(wydatek|wydano|wydat|spend|zap≈Çacono|–æ–ø–ª–∞—á–µ–Ω–æ|p≈Çatno≈õƒá|p≈Çatn|p≈Çatno≈õƒá|zap≈Çacono|przelew do|payed|paid|transfer to|do:)/i;
        const inWords = /(wp≈Çata|przych√≥d|przychod|przych√≥d|otrzymano|saldo|przelew od|received|przyjƒôcie|od:|from:)/i;
        const signHintOut = outWords.test(cleaned);
        const signHintIn = inWords.test(cleaned);

        // make entries for each found amount; if none found, fallback to previous single amount behavior
        if (found.length) {
          for (let i = 0; i < found.length; i++) {
            const item = found[i];
            let amtStr = item.value.replace(/\u00A0/g,'').replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
            // but careful: if number like "1 234" (no decimals) ‚Äî try to parse
            if (!amtStr.includes('.')) {
              // leave as integer
            }
            let amt = Number(amtStr);
            if (isNaN(amt)) amt = null;
            // attempt sign assignment
            if (amt != null) {
              if (signHintOut) amt = -Math.abs(amt);
              else if (!signHintIn && /\b(paid|zap≈Çacono|wydano|przelew do|transfer to|do:)\b/i.test(cleaned)) amt = -Math.abs(amt);
              // else if signHintIn -> positive
            }

            const baseObj = {
              "ID transakcji": "IMG-" + Date.now() + "-" + Math.floor(Math.random()*9999) + "-" + i,
              "Data ksiƒôgowania": dateMatch ? toISO(dateMatch[1]) : today(),
              "ID konta": "UNKNOWN",
              "Kontrahent": supplierMatch || "",
              "Tytu≈Ç/Opis": ("OCR: " + cleaned.split("\n").slice(0,3).join(" ")).slice(0,400) + (found.length>1 ? ` (part ${i+1}/${found.length})` : ""),
              "Kw–æ—Ç–∞": (amt != null ? amt.toFixed(2) : ""),
              "Waluta": (item.cur || "PLN").toUpperCase(),
              "Status transakcji": "imported"
            };

            const normalized = normalizeRowKeys(baseObj);

            if (targetArrayName === 'tx') {
              tx.unshift(normalized);
            } else if (targetArrayName === 'bills') {
              const billRow = {
                "Termin p≈Çatno≈õci": normalized["Data ksiƒôgowania"],
                "Numer faktury": invoiceMatch ? invoiceMatch[2] : ("IMG-FV-" + Date.now() + "-" + i),
                "Dostawca": normalized["Kontrahent"] || supplierMatch,
                "Kwota do zap≈Çaty": Math.abs(asNum(normalized["Kw–æ—Ç–∞"] || normalized["Kwota"] || 0)).toFixed(2),
                "Waluta": normalized["Waluta"] || "PLN",
                "Status faktury": "do zap≈Çaty",
                "Kandyd–∞—Ç (AI)": "",
                "AI score": ""
              };
              bills.unshift(billRow);
            }
          }
          try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){}
          try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
          inferAccounts();
          render();
        } else {
          // If no amounts found ‚Äî fallback to pushing a single OCR-like tx row
          const amtMatch = cleaned.replace(",", ".").match(/(-?\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç|zl|zlot|EUR|USD)?/i);
          const amtStr = amtMatch ? amtMatch[1].replace(/\s/g,'').replace(/\./g,'').replace(',', '.') : null;
          let amt = amtStr ? Number(amtStr) : null;
          const baseObj = {
            "ID transakcji": "IMG-" + Date.now(),
            "Data ksiƒôgowania": dateMatch ? toISO(dateMatch[1]) : today(),
            "ID konta": "UNKNOWN",
            "Kontrahent": supplierMatch || "",
            "Tytu≈Ç/Opis": ("OCR: " + cleaned.split("\n").slice(0,3).join(" ")).slice(0,400),
            "Kw–æ—Ç–∞": (amt != null ? amt.toFixed(2) : ""),
            "Waluta": amtMatch && amtMatch[2] ? amtMatch[2].toUpperCase() : "PLN",
            "Status transakcji": "imported"
          };
          const normalized = normalizeRowKeys(baseObj);
          if (targetArrayName === 'tx') {
            tx.unshift(normalized);
            try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){}
            inferAccounts();
          } else if (targetArrayName === 'bills') {
            const billRow = {
              "Termin p≈Çatno≈õci": normalized["Data ksiƒôgowania"],
              "Numer faktury": invoiceMatch ? invoiceMatch[2] : ("IMG-FV-" + Date.now()),
              "Dostawca": normalized["Kontrahent"] || supplierMatch,
              "Kw–æ—Ç–∞ do –∑–∞–ø≈Ç–∞—Ç—ã": Math.abs(asNum(normalized["Kw–æ—Ç–∞"]) || 0).toFixed(2),
              "Waluta": normalized["Waluta"] || "PLN",
              "Status —Ñ–∞–∫—Ç—É—Ä—ã": "do zap≈Çaty",
              "Kandyd–∞—Ç (AI)": "",
              "AI score": ""
            };
            bills.unshift(billRow);
            try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
          }
          render();
        }

        // optional: persist original image on server (best effort)
        try {
          const reader = new FileReader();
          reader.onload = async function() {
            const dataUrl = reader.result;
            fetch('/save-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ filename: file.name || ('img-' + Date.now() + '.png'), data: dataUrl })
            }).catch(()=>{});
          };
          reader.readAsDataURL(file);
        } catch(e){}
      } catch(err) {
        console.error("OCR error:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–∫—Ä–∏–Ω: " + (err && err.message ? err.message : String(err)));
      }
    }

    // Bind handlers for new image inputs (multiple files)
    document.addEventListener('DOMContentLoaded', () => {
      const txImage = document.getElementById('txImage');
      if (txImage) {
        txImage.addEventListener('change', async e => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          document.getElementById("lastSync").textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
          for (const f of files) {
            try {
              await processImageFileFor('tx', f);
            } catch(err) {
              console.error('txImage OCR error:', err);
              alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≤—ã–ø–∏—Å–∫–∏: ' + (err && err.message ? err.message : String(err)));
            }
          }
        });
      }

      const billImage = document.getElementById('billImage');
      if (billImage) {
        billImage.addEventListener('change', async e => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          for (const f of files) {
            try {
              await processImageFileFor('bills', f);
            } catch(err) {
              console.error('billImage OCR error:', err);
              alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç—É—Ä—ã: ' + (err && err.message ? err.message : String(err)));
            }
          }
          render();
        });
      }

      // re-attach the older billImage handler (kept for backwards)
      const billImageLegacy = document.getElementById('billImage');
      if (billImageLegacy) {
        billImageLegacy.addEventListener('change', async e => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          for (const f of files) {
            await processImageFileFor('bills', f);
          }
          render();
        });
      }
    });

    // rest of UI bindings and functions (kept, with small key-name tolerances)
    function toDueList(mode) {
      const t = today();
      const excl = document.getElementById("excludeBlacklist")?.checked;
      return bills.filter(r => {
        const s = String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || r["Status faktury"] || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s)) return false;
        const d = toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"] || r["Termin –ø–ª–∞—Ç–µ–∂i"]);
        if (!d) return false;
        if (mode === "today") return d === t;
        if (mode === "7d") {
          const dd = new Date(d), tt = new Date(t);
          return (dd - tt) / (1000 * 3600 * 24) <= 7;
        }
        return true;
      }).filter(r => {
        if (String(r["Waluta"] || r["Wal—É—Ç–∞"] || "").toUpperCase() !== "PLN") return false;
        if (excl) {
          const blist = (localStorage.getItem("blacklist") || "").toLowerCase();
          if (blist && r["Dostawca"] && blist.split(",").some(name => r["Dostawca"].toLowerCase().includes(name.trim()))) {
            return false;
          }
        }
        return true;
      });
    }

    function buildPlan() {
      const mode = document.getElementById("planFilter").value;
      const cand = toDueList(mode).sort((a, b) => {
        const da = new Date(toISO(a["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || a["Termin –ø–ª–∞—Çno≈õci"] || a["Termin –ø–ª–∞—Ç–µ–∂–∏"] || a["Termin –ø–ª–∞—Ç–µ–∂i"]));
        const db = new Date(toISO(b["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || b["Termin –ø–ª–∞—Çno≈õci"] || b["Termin –ø–ª–∞—Ç–µ–∂–∏"] || b["Termin –ø–ª–∞—Ç–µ–∂i"]));
        const lateA = da < new Date(today());
        const lateB = db < new Date(today());
        if (lateA !== lateB) return lateB - lateA;
        return asNum(b["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || b["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || b["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || b["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0) - asNum(a["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || a["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || a["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0);
      });
      let left = availableTotal();
      const plan = [];
      for (const r of cand) {
        const amt = asNum(r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–∞—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0);
        if (amt <= left) {
          plan.push({
            r,
            amt,
            reason: (toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) < today() ? "–ø—Ä–æ—Å—Ä–æ—á–∫–∞" : "—Å—Ä–æ–∫")
          });
          left -= amt;
        }
      }
      return { plan, left, avail: availableTotal() };
    }
    function renderPlan() {
      const p = buildPlan();
      const tb = document.getElementById("planTable").querySelector("tbody");
      tb.innerHTML = "";
      p.plan.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${x.r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || x.r["Numer faktury"] || ""}</td><td>${x.r["Dostawca"] || ""}</td><td>${toISO(x.r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || x.r["Termin –ø–ª–∞—Çno≈õci"] || x.r["Termin –ø–ª–∞—Ç–µ–∂–∏"])}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
        tb.appendChild(tr);
      });
      const metaText = p.plan.length 
        ? `–ü–æ—Ç—Ä–∞—Ç–∏–º ${(p.avail - p.left).toFixed(2)} –∏–∑ ${p.avail.toFixed(2)} PLN. –û—Å—Ç–∞–Ω–µ—Ç—Å—è ${p.left.toFixed(2)} PLN.` 
        : "–ü–ª–∞–Ω –ø—É—Å—Ç –∏–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç.";
      document.getElementById("planMeta").textContent = metaText;
    }

    function computeMinPay() {
      const t = today();
      const pct = asNum(localStorage.getItem("penaltyPct") || 0.05) / 100.0;
      const cand = bills.filter(r => 
        String((r["Waluta"] || r["Wal—É—Ç–∞"] || "").toUpperCase()) === "PLN" &&
        toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) <= t &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || r["Status faktury"] || "").toLowerCase())
      ).map(r => (({
        r,
        amt: asNum(r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–∞—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0),
        risk: asNum(r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0) * pct
      }))).sort((a, b) => b.risk - a.risk || b.amt - a.amt);
      return cand[0] || null;
    }
    function renderMinPay() {
      const m = computeMinPay();
      const el = document.getElementById("minPayBox");
      if (!m) {
        el.textContent = "‚Äî";
        return;
      }
      el.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ${m.r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || m.r["Numer faktury"]} (${m.r["Dostawca"]}) –Ω–∞ ${m.amt.toFixed(2)} PLN. –®—Ç—Ä–∞—Ñ/–¥–µ–Ω—å ~ ${m.risk.toFixed(2)} PLN.`;
    }

    function renderForecast() {
      const t = new Date(today());
      const list = toDueList("7d").map(r => ({ date: new Date(toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"])), amt: asNum(r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0) }));
      const days = [...Array(7)].map((_, i) => new Date(t.getTime() + i * 86400000));
      let left = availableTotal();
      const out = days.map(d => ({ d, due: 0, after: 0 }));
      list.forEach(x => {
        const idx = Math.min(6, Math.max(0, Math.floor((x.date - t) / 86400000)));
        out[idx].due += x.amt;
      });
      out.forEach(o => { left -= o.due; o.after = left; });
      const wrap = document.getElementById("forecastBars");
      wrap.innerHTML = "";
      out.forEach(o => {
        const div = document.createElement("div");
        div.className = "bar" + (o.after < 0 ? " neg" : "");
        const h = document.createElement("div");
        h.className = "h";
        h.style.height = (Math.min(120, Math.abs(o.after) / 100) * 0.8 + 18) + "px";
        div.innerHTML = "<small>" + o.d.toISOString().slice(5, 10) + "</small>";
        div.appendChild(h);
        const v = document.createElement("div");
        v.textContent = (o.after < 0 ? "-" : "") + Math.abs(o.after).toFixed(0) + " PLN";
        div.appendChild(v);
        wrap.appendChild(div);
      });
      const firstNeg = out.find(x => x.after < 0);
      document.getElementById("forecastMeta").textContent = firstNeg
        ? `–ì—ç–ø —á–µ—Ä–µ–∑ ${out.indexOf(firstNeg) + 1} –¥–Ω.: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${Math.abs(firstNeg.after).toFixed(2)} PLN.`
        : "–ù–∞ 7 –¥–Ω–µ–π —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞—Å—Å—ã.";
    }

    function render() {
      // KPIs
      const dueToday = bills.filter(r => {
        const s = String(r["Status faktury"] || r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || "").toLowerCase();
        return ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s) && toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) === today();
      }).length;
      const unmatch = tx.filter(r => String(r["Status transakcji"] || r["Status —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"] || "").toLowerCase() !== "sparowane").length;
      document.getElementById("kpiDue").textContent = dueToday;
      document.getElementById("kpiUnmatch").textContent = unmatch;
      const bankPLN = bankAvailablePLN();
      document.getElementById("kpiBank").textContent = bankPLN.toFixed(2);
      const kas = kasaBalance();
      document.getElementById("kpiCash").textContent = kas.toFixed(2);
      const avail = availableTotal();
      document.getElementById("kpiAvail").textContent = avail.toFixed(2);

      // sumDueToday calculation
      const sumDueToday = bills.filter(r =>
        String((r["Wal—É—Ç–∞"] || r["Wal—É—Ç–∞"] || "").toUpperCase()) === "PLN" &&
        toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]) <= today() &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || r["Status faktury"] || "").toLowerCase())
      ).reduce((s, r) => s + asNum(r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || 0), 0);
      document.getElementById("kpiGap").textContent = Math.max(0, sumDueToday - avail).toFixed(2);

      // Transactions table
      const txBody = document.getElementById("txTable").querySelector("tbody");
      txBody.innerHTML = "";
      tx.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${toISO(r["Data ksiƒôgowania"])}</td>
                        <td>${r["ID konta"] || r["IBAN"] || "‚Äî"}</td>
                        <td>${r["Kontrahent"] || ""}</td>
                        <td>${r["Tytu≈Ç/Opis"] || r["Opis operacji"] || ""}</td>
                        <td>${(r["Kw–æ—Ç–∞"] || r["Kwota"] || "")}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td>${r["Status transakcji"] || ""}</td>`;
        txBody.appendChild(tr);
      });

      // Invoices table
      const billBody = document.getElementById("billTable").querySelector("tbody");
      billBody.innerHTML = "";
      const scope = document.getElementById("billScope").value;
      const onlyOverdue = document.getElementById("billOverdueOnly")?.checked;
      bills.forEach(r => {
        const s = String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || r["Status faktury"] || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s)) return;
        if (onlyOverdue && !(s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä"))) return;
        const d = toISO(r["Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"] || r["Termin –ø–ª–∞—Çno≈õci"] || r["Termin –ø–ª–∞—Ç–µ–∂–∏"]);
        if (scope === "today" && d !== today()) return;
        if (scope === "7d") {
          const dd = new Date(d), tt = new Date(today());
          if ((dd - tt) / (1000 * 3600 * 24) > 7) return;
        }
        const cls = (s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä")) ? "overdue" : "due";
        const cand = r["Kandyd–∞—Ç (AI)"] || r["Kandyd–∞—Ç (AI)"] || "";
        const score = r["AI score"] || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d}</td>
                        <td>${r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Numer faktury"] || ""}</td>
                        <td>${r["Dostawca"] || ""}</td>
                        <td>${r["Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw—É—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || r["Kw–∞—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"] || ""}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td><span class="badge ${cls}">${r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || ""}</span></td>
                        <td>${cand ? ('<span class="badge cand">' + cand + '</span>') : '‚Äî'}</td>
                        <td>${score ? ('<span class="badge ai">' + score + '</span>') : '‚Äî'}</td>
                        <td>${cand ? ('<button class="btn secondary btn-accept" data-id="' + (r["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Numer faktury"] || "") + '">–ü—Ä–∏–Ω—è—Ç—å</button>') : '‚Äî'}</td>`;
        billBody.appendChild(tr);
      });
      document.querySelectorAll(".btn-accept").forEach(b =>
        b.addEventListener("click", () => acceptOne(b.getAttribute("data-id")))
      );

      renderMinPay();
      renderForecast();
      renderAccounts();
      renderKasa();
    }

    function acceptOne(id) {
      const b = bills.find(x => (x["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || x["Numer faktury"] || "") === id);
      if (!b) return;
      const t = tx.find(x => (x["ID transakcji"] || "") === (b["Kandyd–∞—Ç (AI)"] || ""));
      if (!t) return;
      t["Status transakcji"] = "Sparowane";
      t["PowiƒÖzana faktura (ID)"] = b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"] || b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];
      b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
      b["Data p≈Çatno≈õci"] = today();
      b["Kandyd–∞—Ç (AI)"] = b["AI score"] = "";
      render();
    }

    function renderAccounts() {
      const tb = document.querySelector("#autoAcc tbody");
      if (!tb) return;
      tb.innerHTML = "";
      Object.values(accMeta).forEach(a => {
        const bal = computeAccountBalance(a.id);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td>
          <td>
            <select data-id="${a.id}" class="acc-type">
              <option ${a.type === "Biznes" ? "selected" : ""}>Biznes</option>
              <option ${a.type === "Osobisty" ? "selected" : ""}>Osobisty</option>
            </select>
          </td>
          <td>
            <select data-id="${a.id}" class="acc-cur">
              <option ${a.currency === "PLN" ? "selected" : ""}>PLN</option>
              <option ${a.currency === "EUR" ? "selected" : ""}>EUR</option>
              <option ${a.currency === "USD" ? "selected" : ""}>USD</option>
            </select>
          </td>
          <td>${bal.toFixed(2)}</td>
          <td><input type="number" step="0.01" value="${a.start || 0}" class="acc-start" data-id="${a.id}" /></td>
          <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include ? "checked" : ""} /></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll(".acc-type").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].type = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-cur").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].currency = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-start").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].start = asNum(e.target.value);
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-include").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].include = e.target.checked;
        saveAccMeta();
        render();
      }));
    }
    function saveAccMeta() {
      localStorage.setItem("accMeta", JSON.stringify(accMeta));
    }

    // Kasa: keep logic, display and storage separate (unchanged behaviour)
    function loadKasa() {
      try { kasa = JSON.parse(localStorage.getItem("kasa") || "[]"); } catch(e) { kasa = []; }
    }
    function saveKasa() {
      localStorage.setItem("kasa", JSON.stringify(kasa));
    }
    function renderKasa() {
      const tb = document.querySelector("#kasaTable tbody");
      if (!tb) return;
      tb.innerHTML = "";
      kasa.forEach((k, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source || ""}</td><td>${k.comment || ""}</td>`;
        tb.appendChild(tr);
      });
    }
    function addKasa(type, amount, comment, source) {
      if (amount == null || isNaN(amount)) return alert("–°—É–º–º–∞");
      kasa.push({ id: Date.now(), date: today(), type, amount: Number(amount), comment: comment || "", source: source || "—Ä—É—á–Ω–æ–π" });
      saveKasa();
      render();
      renderKasa();
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("runAI").addEventListener("click", runAI);
      document.getElementById("acceptSafe").addEventListener("click", acceptSafe);
      document.getElementById("makePlan").addEventListener("click", renderPlan);
      document.getElementById("applyPlan").addEventListener("click", applyPlan);
      document.getElementById("applyMinPay").addEventListener("click", () => {
        const m = computeMinPay();
        if (!m) return alert("–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤");
        m.r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
        m.r["Data p≈Çatno≈õci"] = today();
        render();
      });
      document.getElementById("planFilter").addEventListener("change", renderPlan);
      document.getElementById("billScope").addEventListener("change", render);
      document.getElementById("excludeBlacklist")?.addEventListener("change", () => { renderPlan(); render(); });
      document.getElementById("billOverdueOnly")?.addEventListener("change", render);
      document.getElementById("exportPDF").addEventListener("click", () => window.print());
      document.getElementById("syncNow").addEventListener("click", async () => {
        try {
          const u1 = localStorage.getItem("txUrl") || "";
          const u2 = localStorage.getItem("billUrl") || "";
          if (u1) tx = await fetchCSV(u1);
          if (u2) bills = await fetchCSV(u2);
          inferAccounts();
          render();
          document.getElementById("lastSync").textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
        } catch(e) {
          document.getElementById("lastSync").textContent = "–û—à–∏–±–∫–∞: " + (e && e.message ? e.message : String(e));
        }
      });

      document.getElementById("txFile")?.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        tx = parseCSV(await f.text());
        inferAccounts();
        render();
      });
      document.getElementById("billFile")?.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        bills = parseCSV(await f.text());
        render();
      });
      document.getElementById("saveTxUrl")?.addEventListener("click", () => {
        localStorage.setItem("txUrl", document.getElementById("txUrl").value.trim());
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL wyciƒÖga");
      });
      document.getElementById("saveBillUrl")?.addEventListener("click", () => {
        localStorage.setItem("billUrl", document.getElementById("billUrl").value.trim());
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL faktur");
      });

      // cash controls
      document.getElementById("addIn").addEventListener("click", () =>
        addKasa("przyjƒôcie", asNum(document.getElementById("quickAmt").value), document.getElementById("quickNote").value, "—Ä—É—á–Ω–æ–π")
      );
      document.getElementById("addOut").addEventListener("click", () =>
        addKasa("wydanie", asNum(document.getElementById("quickAmt").value), document.getElementById("quickNote").value, "—Ä—É—á–Ω–æ–π")
      );
      document.getElementById("cashClose").addEventListener("click", () => {
        const a = prompt("–ò—Ç–æ–≥ –≤ –∫–∞—Å—Å–µ (PLN):", kasaBalance().toFixed(2));
        if (a === null) return;
        addKasa("zamkniƒôcie", asNum(a), "close", "—Ä—É—á–Ω–æ–π");
      });
      document.getElementById("q50").addEventListener("click", () => {
        document.getElementById("quickAmt").value = (Number(document.getElementById("quickAmt").value || 0) + 50).toFixed(2);
      });
      document.getElementById("q100").addEventListener("click", () => {
        document.getElementById("quickAmt").value = (Number(document.getElementById("quickAmt").value || 0) + 100).toFixed(2);
      });
      document.getElementById("q200").addEventListener("click", () => {
        document.getElementById("quickAmt").value = (Number(document.getElementById("quickAmt").value || 0) + 200).toFixed(2);
      });

      // Voice recognition (unchanged)
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      let rec = null;
      if (SR) {
        rec = new SR();
        rec.continuous = false;
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.lang = localStorage.getItem("speechLang") || "pl-PL";
        rec.onstart = () => {
          if (document.querySelector(".mic")) document.querySelector(".mic").classList.add("on");
          document.getElementById("micStatus").textContent = `üéôÔ∏è –°–ª—É—à–∞—é... (${rec.lang})`;
        };
        rec.onend = () => {
          if (document.querySelector(".mic")) document.querySelector(".mic").classList.remove("on");
        };
        rec.onresult = (e) => {
          const text = (e.results[0][0].transcript || "").toLowerCase();
          document.getElementById("micStatus").textContent = "üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: " + text;
          const numMatch = text.match(/(\d+[.,]?\d*)\s*(z≈Ç|pln)?/);
          const num = numMatch ? numMatch[1] : null;
          const isOut = /(wyda|minus|wydat|–≤—ã–¥–∞|–º–∏–Ω—É—Å|—Ä–∞—Å—Ö–æ–¥)/.test(text);
          const isIn = /(przyj|plus|wp≈Çyw|–ø—Ä–∏–Ω—è—Ç—å|–ø–ª—é—Å|–ø—Ä–∏—Ö–æ–¥)/.test(text) || !isOut;
          const note = text.replace(/(\d+[.,]?\d*\s*(z≈Ç|pln)?)/, "").trim();
          if (!num) {
            document.getElementById("micStatus").textContent = "üéôÔ∏è –°—É–º–º—É –Ω–µ –Ω–∞—à—ë–ª";
            return;
          }
          addKasa(isOut ? "wydanie" : "przyjƒôcie", asNum(num), note || "–≥–æ–ª–æ—Å", "voice");
        };
      }
      document.getElementById("micBtn").addEventListener("click", () => {
        if (!rec) { alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ —Ç—Ä–µ–±—É–µ—Ç Chrome + HTTPS/localhost."); return; }
        try {
          const sel = document.getElementById("speechLang");
          if (sel) {
            rec.lang = sel.value;
            localStorage.setItem("speechLang", rec.lang);
          }
          rec.start();
        } catch(e) {
          document.getElementById("micStatus").textContent = "üéôÔ∏è –ù–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å: " + e.message;
        }
      });
      document.getElementById("micTest").addEventListener("click", () => {
        document.getElementById("micStatus").textContent = "üéôÔ∏è –¢–µ—Å—Ç: –ø—Ä–∏–π–Ω—è—Ç–æ 120 –Ω–∞ –∫–∞—Å—Å—É (—Å–∏–º—É–ª—è—Ü–∏—è)";
        addKasa("przyjƒôcie", 120, "—Å–∏–º—É–ª—è—Ü–∏—è", "test");
      });

      // OCR in kasa for receipt photo (keeps user choice)
      document.getElementById("cashPhoto")?.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        const imgURL = URL.createObjectURL(f);
        const thumb = document.getElementById("lastThumb");
        if (thumb) { thumb.src = imgURL; thumb.style.display = "inline-block"; }
        try {
          const worker = await Tesseract.createWorker();
          await worker.load();
          try { await worker.loadLanguage("eng+pol"); await worker.initialize("eng+pol"); } catch(e){ try{ await worker.loadLanguage("eng"); await worker.initialize("eng"); } catch(_){} }
          const { data: { text } } = await worker.recognize(imgURL);
          await worker.terminate();
          const amountMatch = text.replace(",", ".").match(/(\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç)?/i);
          const dateMatch = text.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
          const amtStr = amountMatch ? amountMatch[1].replace(/\s/g,'').replace(/\./g,'').replace(',', '.') : null;
          const note = "OCR: " + (dateMatch ? dateMatch[1] + " " : "") + (text.split("\n")[0] || "paragon");
          if (amtStr) {
            const amt = Number(amtStr);
            if (confirm(`–ß–µ–∫: —Å—É–º–º–∞ ${amt.toFixed(2)} PLN. –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Å—Å—É –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥?`)) {
              addKasa("wydanie", amt, note, "OCR");
            }
          } else {
            alert("–ù–µ –Ω–∞—à—ë–ª —Å—É–º–º—É –Ω–∞ —Ñ–æ—Ç–æ. –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.");
          }
        } catch(err) {
          alert("OCR –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: " + (err && err.message ? err.message : String(err)));
        }
      });

      // Settings handlers
      document.getElementById("applySettings").addEventListener("click", () => {
        localStorage.setItem("cashPLN", document.getElementById("cashPLN").value || "0");
        localStorage.setItem("penaltyPct", document.getElementById("penaltyPct").value || "0.05");
        localStorage.setItem("intervalMin", document.getElementById("intervalMin").value || "10");
        localStorage.setItem("rateEUR", document.getElementById("rateEUR").value || "4.30");
        localStorage.setItem("rateUSD", document.getElementById("rateUSD").value || "3.95");
        localStorage.setItem("blacklist", document.getElementById("blacklist").value || "");
        localStorage.setItem("autoCash", document.getElementById("autoCash").checked ? "1" : "0");
        document.getElementById("modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
          ? "–†–µ–∂–∏–º: " + (document.getElementById("autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
          : (localStorage.getItem("otd_lang") || "ru") === "pl"
            ? "Tryb: " + (document.getElementById("autoCash").checked ? "auto" : "rƒôczny")
            : (localStorage.getItem("otd_lang") || "ru") === "uk"
              ? "–†–µ–∂–∏–º: " + (document.getElementById("autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–∏–π")
              : "Mode: " + (document.getElementById("autoCash").checked ? "auto" : "manual");
        render();
      });
      document.getElementById("exportCfg").addEventListener("click", () => {
        const cfg = {
          txUrl: localStorage.getItem("txUrl") || "",
          billUrl: localStorage.getItem("billUrl") || "",
          cashPLN: localStorage.getItem("cashPLN") || "0",
          penaltyPct: localStorage.getItem("penaltyPct") || "0.05",
          intervalMin: localStorage.getItem("intervalMin") || "10",
          rateEUR: localStorage.getItem("rateEUR") || "4.30",
          rateUSD: localStorage.getItem("rateUSD") || "3.95",
          blacklist: localStorage.getItem("blacklist") || "",
          autoCash: localStorage.getItem("autoCash") || "0",
          accMeta: localStorage.getItem("accMeta") || "{}"
        };
        const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "onetapday_settings.json";
        a.click();
      });
      document.getElementById("importCfg")?.addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;
        const cfg = JSON.parse(await f.text());
        Object.entries(cfg).forEach(([k, v]) => localStorage.setItem(k, typeof v === "string" ? v : JSON.stringify(v)));
        location.reload();
      });

      // Pilot admin actions (POST endpoints)
      (function pilotUI() {
        function getPilot() { try { return JSON.parse(localStorage.getItem("otd_pilot") || "{}"); } catch(e){ return {}; } }
        function setPilot(s) { try { localStorage.setItem("otd_pilot", JSON.stringify(s)); } catch(e){} }
        function isoDate(d) { const x = new Date(d); return isNaN(x) ? "‚Äî" : x.toISOString().slice(0,10); }
        function daysLeft(endIso) { if (!endIso) return 0; const e = new Date(endIso), n = new Date(); return Math.max(0, Math.ceil((e - n) / 86400000)); }
        function updatePilotUI() {
          const s = getPilot();
          const st = s.status || "none";
          let desc = "‚Äî";
          if (st === "none") desc = "–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞";
          if (st === "deposit_paid") desc = "–¥–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω";
          if (st === "active") desc = "–ø–∏–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω";
          if (st === "ended") desc = "–ø–∏–ª–æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω";
          if (st === "discount_active") desc = "—Å–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
          const mini = document.getElementById("pilotMini"); if (mini) mini.textContent = "–°—Ç–∞—Ç—É—Å: " + desc;
          const ps = document.getElementById("pilotStart"); if (ps) ps.textContent = s.startAt ? isoDate(s.startAt) : "‚Äî";
          const pe = document.getElementById("pilotEnd"); if (pe) pe.textContent = s.endAt ? isoDate(s.endAt) : "‚Äî";
          const pc = document.getElementById("pilotCountdown"); if (pc) pc.textContent = (st === "active" && s.endAt) ? (" ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å " + daysLeft(s.endAt) + " –¥–Ω.") : "";
          const du = document.getElementById("discountUntil"); if (du) du.textContent = s.discountUntil ? isoDate(s.discountUntil) : "‚Äî";
          const userEmail = localStorage.getItem("otd_user") || "";
          const isAdmin = userEmail && (userEmail === "1tapday@gmail.com");
          document.getElementById("btnMarkPaid").style.display = isAdmin ? "inline-block" : "none";
          document.getElementById("btnStartPilot").style.display = isAdmin ? "inline-block" : "none";
          document.getElementById("btnResetPilot").style.display = isAdmin ? "inline-block" : "none";
          const showDiscount = st === "ended";
          document.getElementById("btnActivateDiscount").style.display = showDiscount ? "inline-block" : (isAdmin ? "none" : "none");
        }
        document.addEventListener("click", (e) => {
          const id = e.target && e.target.id;
          if (!id) return;
          let s = getPilot();
          if (id === "btnMarkPaid") {
            fetch("/mark-paid", { method: "POST" })
              .then(res => res.json()).then(data => {
                if (data.success) {
                  s.status = "deposit_paid";
                  s.paidAt = new Date().toISOString();
                  setPilot(s);
                  updatePilotUI();
                } else {
                  alert(data.error || "–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã");
                }
              });
          }
          if (id === "btnStartPilot") {
            fetch("/start-pilot", { method: "POST" })
              .then(res => res.json()).then(data => {
                if (data.success) {
                  s.status = "active";
                  s.startAt = new Date().toISOString();
                  const d = new Date(); d.setMonth(d.getMonth() + 2); s.endAt = d.toISOString();
                  s.reminders = [14,7,3].map(n => { let x = new Date(d); x.setDate(x.getDate() - n); return x.toISOString(); });
                  setPilot(s); updatePilotUI();
                } else {
                  alert(data.error || "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∏–ª–æ—Ç–∞");
                }
              });
          }
          if (id === "btnActivateDiscount") {
            fetch("/activate-discount", { method: "POST" })
              .then(res => res.json()).then(data => {
                if (data.success) {
                  s.status = "discount_active";
                  s.discountSince = new Date().toISOString();
                  const e2 = new Date(); e2.setMonth(e2.getMonth() + 12); s.discountUntil = e2.toISOString();
                  setPilot(s); updatePilotUI();
                } else {
                  alert(data.error || "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–∫–∏–¥–∫–∏");
                }
              });
          }
          if (id === "btnResetPilot") {
            localStorage.removeItem("otd_pilot");
            updatePilotUI();
          }
        }, false);
        setInterval(() => {
          const s = JSON.parse(localStorage.getItem("otd_pilot") || "{}");
          if ((s.status || "") === "active") updatePilotUI();
        }, 60000);
        updatePilotUI();
      })();

      // init load
      (function init() {
        loadKasa();
        try { accMeta = JSON.parse(localStorage.getItem("accMeta") || "{}"); } catch(e) { accMeta = {}; }
        try { tx = JSON.parse(localStorage.getItem("tx_manual_import") || "[]").concat(tx); } catch(e){}
        try { bills = JSON.parse(localStorage.getItem("bills_manual_import") || "[]").concat(bills); } catch(e){}
        renderKasa();
        document.getElementById("txUrl").value = localStorage.getItem("txUrl") || "";
        document.getElementById("billUrl").value = localStorage.getItem("billUrl") || "";
        document.getElementById("cashPLN").value = localStorage.getItem("cashPLN") || "5000";
        document.getElementById("penaltyPct").value = localStorage.getItem("penaltyPct") || "0.05";
        document.getElementById("intervalMin").value = localStorage.getItem("intervalMin") || "10";
        document.getElementById("rateEUR").value = localStorage.getItem("rateEUR") || "4.30";
        document.getElementById("rateUSD").value = localStorage.getItem("rateUSD") || "3.95";
        document.getElementById("blacklist").value = localStorage.getItem("blacklist") || "";
        document.getElementById("autoCash").checked = localStorage.getItem("autoCash") === "1";
        const saved = localStorage.getItem("speechLang");
        if (saved) document.getElementById("speechLang").value = saved;
        document.getElementById("modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
          ? "–†–µ–∂–∏–º: " + (document.getElementById("autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
          : (localStorage.getItem("otd_lang") || "ru") === "pl"
            ? "Tryb: " + (document.getElementById("autoCash").checked ? "auto" : "rƒôczny")
            : (localStorage.getItem("otd_lang") || "ru") === "uk"
              ? "–†–µ–∂–∏–º: " + (document.getElementById("autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–∏–π")
              : "Mode: " + (document.getElementById("autoCash").checked ? "auto" : "manual");
        inferAccounts();
        render();
      })();
    });

    // simple helpers used by event handlers below
    function applyPlan() {
      const p = buildPlan();
      p.plan.forEach(x => {
        x.r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
        x.r["Data p≈Ç–∞—Çno≈õci"] = today();
      });
      render();
    }
  })();
  </script>

  <script>
  (async function(){
    function fmtTime(ms){ if(ms <= 0) return '00:00:00'; const h = Math.floor(ms/3600000), m = Math.floor(ms%3600000/60000), s = Math.floor(ms%60000/1000); return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
    async function whoami(){ try { const r = await fetch('/me', { credentials: 'include' }); if (!r.ok) return null; const json = await r.json(); return json.user || null;} catch(e){ return null; } }
    const user = await whoami();
    if (!user) { alert('–í–∞–º –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞.'); window.location.href = '/'; return; }
    const statusEl = document.getElementById('mvp-status') || (function(){ const e = document.createElement('div'); e.id='mvp-status'; e.style.margin='8px'; document.body.prepend(e); return e; })();
    const endISO = user.endAt || user.demo_until || user.demoUntil;
    if (endISO) {
      let until = Date.parse(endISO); if (isNaN(until)) until = Date.now() + 24*60*60*1000;
      statusEl.textContent = '–î–µ–º–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å ' + fmtTime(until - Date.now());
      const t = setInterval(()=>{ const diff = until - Date.now(); if (diff <= 0) { clearInterval(t); statusEl.innerHTML = '–î–µ–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. <button id="payAfterDemo">–û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å</button>'; document.getElementById('payAfterDemo').addEventListener('click', async ()=>{ const r = await fetch('/create-checkout-session', { method: 'POST', credentials: 'include' }); const j = await r.json().catch(()=>null); const redirect = (j && (j.url || j.sessionUrl || j.session && j.session.url)) || null; if (redirect) window.location.href = redirect; else alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–µ—Å—Å–∏—é. –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏.'); }); return; } else statusEl.textContent = '–î–µ–º–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å ' + fmtTime(diff) + ' (–ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞)'; }, 1000);
    } else {
      statusEl.innerHTML = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. <button id="payNow">–û–ø–ª–∞—Ç–∏—Ç—å 2 –º–µ—Å—è—Ü–∞</button>';
      document.getElementById('payNow').addEventListener('click', async ()=>{ const r = await fetch('/create-checkout-session', { method: 'POST', credentials: 'include' }); const j = await r.json().catch(()=>null); const redirect = (j && (j.url || j.sessionUrl || j.session && j.session.url)) || null; if (redirect) window.location.href = redirect; else alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Stripe-—Å–µ—Å—Å–∏—é.'); });
    }
  })();
  </script>
</body>
</html>
