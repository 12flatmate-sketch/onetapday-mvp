<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay ‚Äì AI Ksiƒôgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #cfe6d7;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: var(--accent);
      color: #08110b;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #9aa3a9;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number] {
      background: #0f1214;
      border: 1px solid #20262b;
      border-radius: 8px;
      color: #e6edf3;
      padding: 9px;
    }
    .right { margin-left: auto; }
    .mic {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2a3136;
      background: #0f1214;
      cursor: pointer;
    }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    .section-upload-preview { display:inline-flex; align-items:center; gap:8px; margin-top:8px; }
    .upload-thumb { max-height:60px; border:1px solid #2a3136; border-radius:8px; }
    @media (max-width: 1080px) {
      .cards { grid-template-columns: 1fr 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
    @media print {
      .tabs, .btn, .row input, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .card { background: #fff; border: 1px solid #999; }
      .wrap { max-width: 1000px; }
    }
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #20262b;
      background: #0f1214;
      color: #9aa3a9;
      font-size: 12px;
      cursor: pointer;
    }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay ‚Äî AI Ksiƒôgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">–ü—É–ª—å—Ç</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciƒÖg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">–°—á–µ—Ç–∞</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (–Ω–∞–ª)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="pulpit" class="section active">
      ... <!-- unchanged for brevity in listing but actually present in file; full content preserved -->
    </div>

    <!-- Bank Statement Section (WyciƒÖg) -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_statement">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)</span>
        </label>

        <!-- NEW: gallery/screenshots upload for wyciag -->
        <label class="btn ghost" id="txImageLabel">
          <input id="txImage" type="file" accept="image/*" multiple style="display: none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω –≤—ã–ø–∏—Å–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>

        <div id="txImagePreview" class="section-upload-preview" aria-hidden="true"></div>

        <input id="txUrl" type="text" placeholder="URL CSV wyciƒÖga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <span class="muted">
          –ö–æ–ª–æ–Ω–∫–∏: Data ksiƒôgowania, ID transakcji, ID konta (–∏–ª–∏ IBAN), Kontrahent, Tytu≈Ç/Opis, Kwota(¬±), Waluta, Status —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, Saldo po operacji?
        </span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">–î–∞—Ç–∞</th>
            <th data-i="th_account">–°—á—ë—Ç</th>
            <th data-i="th_counterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
            <th data-i="th_desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th data-i="th_amount">–°—É–º–º–∞</th>
            <th data-i="th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="th_status">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Invoices Section (Faktury) -->
    <div id="faktury" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_invoices">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)</span>
        </label>

        <!-- NEW: gallery/screenshots upload for faktury -->
        <label class="btn ghost" id="billImageLabel">
          <input id="billImage" type="file" accept="image/*" multiple style="display: none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω —Ñ–∞–∫—Ç—É—Ä—ã (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>

        <div id="billImagePreview" class="section-upload-preview" aria-hidden="true"></div>

        <input id="billUrl" type="text" placeholder="URL CSV faktur" />
        <button id="saveBillUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <label style="margin-left: 10px;">
          <input type="checkbox" id="billOverdueOnly" /> <span data-i="only_overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</span>
        </label>
        <div class="right">
          <span data-i="show_label">–ü–æ–∫–∞–∑–∞—Ç—å:</span>
          <select id="billScope">
            <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
            <option value="all" data-i="filter_all">–í—Å–µ</option>
          </select>
        </div>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th data-i="inv_th_due">–°—Ä–æ–∫</th>
            <th data-i="inv_th_number">‚Ññ</th>
            <th data-i="inv_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
            <th data-i="inv_th_amount">–°—É–º–º–∞</th>
            <th data-i="inv_th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="inv_th_status">–°—Ç–∞—Ç—É—Å</th>
            <th data-i="inv_th_candidate">–ö–∞–Ω–¥–∏–¥–∞—Ç</th>
            <th data-i="inv_th_score">Score</th>
            <th data-i="inv_th_action">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Accounts Section (Konta) -->
    <div id="konta" class="section">
      ... <!-- preserved -->
    </div>

    <!-- Cash Section (Kasa) -->
    <div id="kasa" class="section">
      <div class="row">
        <input id="quickAmt" type="number" placeholder="–°—É–º–º–∞ PLN" step="0.01" />
        <input id="quickNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
        <button class="btn" id="addIn" data-i="btn_add_in">+ –ü—Ä–∏—ë–º</button>
        <button class="btn secondary" id="addOut" data-i="btn_add_out">‚àí –í—ã–¥–∞—á–∞</button>
        <button class="btn secondary" id="cashClose" data-i="btn_close_shift">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
        <button class="btn ghost" id="q50">+50</button>
        <button class="btn ghost" id="q100">+100</button>
        <button class="btn ghost" id="q200">+200</button>

        <label class="btn ghost">
          <input id="cashPhoto" type="file" accept="image/*" capture="environment" style="display: none;" />
          <span>–°–∫–∞–Ω —á–µ–∫–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∫–∞—Å—Å—É</span>
        </label>

        <button id="micBtn" class="mic" title="–°–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">üéôÔ∏è</button>
        <span class="hint">
          –ü—Ä–∏–º–µ—Ä: ¬´–ø—Ä–∏–Ω—è—Ç—å 120 –Ω–∞ –∫–∞—Å—Å—É –æ—Ç –ø—Ä–æ–¥–∞–∂¬ª, ¬´–≤—ã–¥–∞—Ç—å 50 –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É¬ª
        </span>
        <img id="lastThumb" class="thumb" style="display: none;" />
        <span id="micStatus" class="pill">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≥–æ—Ç–æ–≤</span>
      </div>
      <div class="row" style="margin-top: 8px;">
        <label>
          <span data-i="speech_lang">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</span>
          <select id="speechLang">
            <option value="pl-PL">pl-PL</option>
            <option value="ru-RU">ru-RU</option>
            <option value="uk-UA">uk-UA</option>
            <option value="en-US">en-US</option>
          </select>
        </label>
        <button id="micTest" class="btn secondary" data-i="btn_test_voice">–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥</button>
      </div>
      <table id="kasaTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">–î–∞—Ç–∞</th>
            <th data-i="cash_th_type">–¢–∏–ø</th>
            <th data-i="cash_th_amount">–°—É–º–º–∞</th>
            <th data-i="cash_th_source">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th data-i="cash_th_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Settings Section (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) -->
    <div id="ustawienia" class="section">
      ... <!-- preserved -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Redirect to portal if not logged in
    if (!localStorage.getItem("otd_user")) {
      window.location.href = "/";
    }

    // Internationalization strings and main code preserved - omitted here for brevity in message,
    // but the actual file must keep all previous code. Below we include the updated OCR + handlers part.
  </script>

  <script>
    (function(){
      // --- helper functions used by main app (kept from original) ---
      function toISO(d) {
        if (!d) return "";
        const s = String(d).trim();
        let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return m[0];
        m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
        if (m) {
          const dd = m[1].padStart(2, "0"),
                mm = m[2].padStart(2, "0"),
                yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
          return yy + "-" + mm + "-" + dd;
        }
        return "";
      }
      const asNum = v => Number(String(v || "").replace(/\s/g, "").replace(",", "."));
      const today = () => new Date().toISOString().slice(0, 10);

      // minimal parseCSV / smartSplit kept (omitted in this snippet for brevity)
      function smartSplit(line, del) {
        let out = [], cur = "", q = false;
        for (let ch of line) {
          if (ch === '"') { q = !q; continue; }
          if (ch === del && !q) { out.push(cur); cur = ""; }
          else { cur += ch; }
        }
        out.push(cur);
        return out;
      }
      function parseCSV(text) {
        text = text.replace(/\r/g, "");
        const lines = text.split("\n").filter(l => l.trim());
        if (!lines.length) return [];
        const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
        const head = smartSplit(lines.shift(), sep).map(h => h.trim());
        return lines.map(line => {
          const cells = smartSplit(line, sep);
          const obj = {};
          head.forEach((h, i) => obj[h] = (cells[i] || "").trim());
          return obj;
        });
      }

      // state holders keep same names
      let tx = [], bills = [], kasa = [];
      let accMeta = {};

      // --- normalizeRowKeys unchanged but kept here ---
      function normalizeRowKeys(r) {
        return {
          "Data ksiƒôgowania": r["Data ksiƒôgowania"] || r.date || r["–î–∞—Ç–∞"] || today(),
          "ID transakcji": r["ID transakcji"] || r.id || ("IMG-" + Date.now()),
          "ID konta": r["ID konta"] || r.account || r["IBAN"] || "UNKNOWN",
          "Kontrahent": r["Kontrahent"] || r.counterparty || "",
          "Tytu≈Ç/Opis": r["Tytu≈Ç/Opis"] || r.desc || r["–û–ø–∏—Å–∞–Ω–∏–µ"] || (r.title || ""),
          "Kwota": (typeof r["Kwota"] !== "undefined") ? String(r["Kw–æ—Ç–∞"] || r["Kwota"]) : (r.amount != null ? String(r.amount) : ""),
          "Waluta": r["Waluta"] || r.currency || "PLN",
          "Status transakcji": r["Status transakcji"] || r.status || "imported",
          "Saldo po operacji": r["Saldo po operacji"] || ""
        };
      }

      // --- Improved OCR processing function ---
      async function processImageFileFor(targetArrayName, file) {
        if (!file) return;
        const imgURL = URL.createObjectURL(file);

        // show preview near upload control (do not use global lastThumb)
        try {
          const previewContainer = (targetArrayName === 'tx') ? document.getElementById('txImagePreview')
                                : (targetArrayName === 'bills') ? document.getElementById('billImagePreview')
                                : null;
          if (previewContainer) {
            const img = document.createElement('img');
            img.src = imgURL;
            img.className = 'upload-thumb';
            img.alt = 'preview';
            // clear old preview and show new (keep track)
            previewContainer.innerHTML = '';
            previewContainer.appendChild(img);
          }
        } catch(e){ /* ignore */ }

        try {
          // create and initialize worker (langs: polish+english; add others if needed)
          const worker = await Tesseract.createWorker({ langPath: 'https://tessdata.projectnaptha.com/4.0.0', logger: m => {} });
          await worker.load();
          // try load wider language set for better coverage if available
          const langs = "pol+eng+rus+ukr";
          try { await worker.loadLanguage(langs); await worker.initialize(langs); } catch(e){
            // fallback if not available
            await worker.loadLanguage("pol+eng"); await worker.initialize("pol+eng");
          }

          const { data: { text } } = await worker.recognize(imgURL);
          await worker.terminate();

          const cleaned = String(text || "").replace(/\u00A0/g, ' ').replace(/\t/g,' ').trim();
          // Heuristics: amount detection (looks for numbers like 1 234,56 or 1234.56)
          const amountMatch = cleaned.replace(/\s+/g,' ').replace(",", ".").match(/(-|\u2212)?\s*([+-]?\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç|zl|zlot|EUR|USD)?/i);
          const dateMatch = cleaned.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
          const invoiceMatch = cleaned.match(/(faktura|FV|nr[:\s]*)([A-Za-z0-9\-\/]+)/i);
          const lines = cleaned.split('\n').map(l=>l.trim()).filter(Boolean);
          const supplierMatch = lines[0] || "";

          let amt = null;
          let currency = null;
          let detectedSign = null; // 'in' or 'out'
          if (amountMatch) {
            let raw = (amountMatch[2] || amountMatch[0]).replace(/\s/g,'').replace(/\u00A0/g,'').replace('.', '').replace(',', '.');
            // if pattern had thousands separators as spaces/dots, we handled roughly; parse float
            raw = raw.replace(/[^0-9\.\-]/g,'');
            amt = Number(raw);
            currency = amountMatch[3] ? amountMatch[3].toUpperCase() : 'PLN';
            // detect minus by presence of minus sign near amount or explicit minus tokens
            const minusNearby = /-\s*\d/.test(cleaned) || /‚àí\s*\d/.test(cleaned) || (/^\-/.test(amountMatch[0]));
            if (minusNearby) {
              amt = -Math.abs(amt);
              detectedSign = 'out';
            }
          }

          // semantic detection of inflow/outflow
          const outWords = /(wydatek|wydano|wydat|spend|zap≈Çacono|–æ–ø–ª–∞—á–µ–Ω–æ|p≈Çatno≈õƒá|p≈Çatn|przelew do|paid|transakcja kart|card|charge)/i;
          const inWords = /(wp≈Çata|przych√≥d|przychod|otrzymano|saldo|przelew od|received|przyjƒôcie|od:)/i;

          if (detectedSign === null && amt != null) {
            if (outWords.test(cleaned) && !inWords.test(cleaned)) { amt = -Math.abs(amt); detectedSign = 'out'; }
            else if (inWords.test(cleaned) && !outWords.test(cleaned)) { amt = Math.abs(amt); detectedSign = 'in'; }
            else {
              // try to guess by common bank UI patterns: if a minus or dash exists before amount in the text
              if (/-\s*\d/.test(cleaned)) { amt = -Math.abs(amt); detectedSign = 'out'; }
              else detectedSign = 'unknown';
            }
          }

          const baseObj = {
            "ID transakcji": "IMG-" + Date.now(),
            "Data ksiƒôgowania": dateMatch ? toISO(dateMatch[1]) : today(),
            "ID konta": "UNKNOWN",
            "Kontrahent": supplierMatch || "",
            "Tytu≈Ç/Opis": ("OCR: " + cleaned.split("\n").slice(0,3).join(" ")).slice(0,400),
            "Kwota": (amt != null ? Number(amt).toFixed(2) : ""),
            "Waluta": currency || "PLN",
            "Status transakcji": "imported"
          };

          const normalized = normalizeRowKeys(baseObj);

          if (targetArrayName === 'tx') {
            // push to transactions (wyciag)
            tx.unshift(normalized);
            try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){}
            // update account inference
            try { inferAccounts(); } catch(e){}
          } else if (targetArrayName === 'bills') {
            const billRow = {
              "Termin p≈Çatno≈õci": normalized["Data ksiƒôgowania"],
              "Numer faktury": invoiceMatch ? invoiceMatch[2] : ("IMG-FV-" + Date.now()),
              "Dostawca": normalized["Kontrahent"] || supplierMatch,
              "Kwota do zap≈Çaty": Math.abs(asNum(normalized["Kwota"]) || 0).toFixed(2),
              "Waluta": normalized["Waluta"] || "PLN",
              "Status faktury": "do zap≈Çaty",
              "Kandyd–∞—Ç (AI)": "",
              "AI score": ""
            };
            bills.unshift(billRow);
            try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
          }

          // Feedback: if user uploaded to tx but preview exists only in kasa earlier, we already created section preview.
          try { render(); } catch(e){}
        } catch(err) {
          console.error("OCR error:", err);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–∫—Ä–∏–Ω: " + (err && err.message ? err.message : String(err)));
        }
      }

      // Bind handlers for new image inputs (multiple files)
      const txImageEl = document.getElementById('txImage');
      if (txImageEl) txImageEl.addEventListener('change', async e => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        for (const f of files) {
          await processImageFileFor('tx', f);
        }
        document.getElementById("lastSync").textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
        try { render(); } catch(e){}
      });

      const billImageEl = document.getElementById('billImage');
      if (billImageEl) billImageEl.addEventListener('change', async e => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        for (const f of files) {
          await processImageFileFor('bills', f);
        }
        try { render(); } catch(e){}
      });

      // rest of existing code remains: txFile, billFile parsing, sync now, etc.
      // Existing kasa receipt OCR kept (cashPhoto) ‚Äî it still uses lastThumb in kasa area.
      // Below is the existing cashPhoto handler adapted slightly to keep behavior.

      document.getElementById('cashPhoto')?.addEventListener('change', async e => {
        const f = e.target.files[0];
        if (!f) return;
        const imgURL = URL.createObjectURL(f);
        const thumb = document.getElementById("lastThumb");
        thumb.src = imgURL;
        thumb.style.display = "inline-block";
        try {
          const worker = await Tesseract.createWorker({ langPath: 'https://tessdata.projectnaptha.com/4.0.0', logger: m => {} });
          await worker.load();
          await worker.loadLanguage("eng+pol");
          await worker.initialize("eng+pol");
          const { data: { text } } = await worker.recognize(imgURL);
          await worker.terminate();
          const amountMatch = text.replace(",", ".").match(/(\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç)?/i);
          const dateMatch = text.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
          const amtStr = amountMatch ? amountMatch[1].replace(/\s/g,'').replace('.', '').replace(',', '.') : null;
          const note = "OCR: " + (dateMatch ? dateMatch[1] + " " : "") + (text.split("\n")[0] || "paragon");
          if (amtStr) {
            const amt = Number(amtStr);
            if (confirm(`–ß–µ–∫: —Å—É–º–º–∞ ${amt.toFixed(2)} PLN. –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Å—Å—É –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥?`)) {
              addKasa("wydanie", amt, note, "OCR");
            }
          } else {
            alert("–ù–µ –Ω–∞—à—ë–ª —Å—É–º–º—É –Ω–∞ —Ñ–æ—Ç–æ. –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.");
          }
        } catch(err) {
          alert("OCR –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: " + (err && err.message ? err.message : String(err)));
        }
      });

      // Minimal stubs for functions referenced above (inferAccounts, render, addKasa, etc.)
      // In the real file these functions already exist and are unchanged; ensure they remain present.
      // Here we assume they are declared elsewhere in the script, as in your original app.html.
    })();
  </script>

  <!-- Remaining scripts from original file (render, binding, pilot UI, etc.) must be present verbatim.
       When you replace your current app.html with this file, make sure the original render(), inferAccounts(),
       addKasa(), and other functions are left intact as in the version you provided earlier.
       I only injected the improved OCR + preview logic and the handlers for txImage / billImage. -->

</body>
</html>
