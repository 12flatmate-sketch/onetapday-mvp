<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OneTapDay — AI Księgowy (MVP)</title>
  <style>
    :root{
      --accent:#35D36B;--bg:#0d0f10;--card:#15181a;--muted:#9aa3a9;--text:#e6edf3;
      --danger:#ff7070;--warn:#f4d06f;--pos:#a8e8c7;--neg:#ff8a8a
    }
    html,body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;-webkit-tap-highlight-color:transparent}
    button,select,input,label{touch-action:manipulation}
    .wrap{max-width:1240px;margin:0 auto;padding:12px 16px 48px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;position:relative;z-index:2}
    .brand{font-weight:700}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;position:relative;z-index:2}
    .tab{padding:8px 12px;border-radius:10px;background:#0f1214;border:1px solid #20262b;color:#cfe6d7;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#08110b;border-color:#49e084}
    .tab.disabled{opacity:.45;cursor:not-allowed}
    .section{display:none;margin-top:14px;position:relative;z-index:1}
    .section.active{display:block}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #22282c;border-radius:12px;padding:14px}
    .muted{color:var(--muted);font-size:13px}
    .kpi{font-size:34px;font-weight:800;margin:2px 0 0}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#08110b;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#20262b;color:#fff;border:1px solid #2a3136}
    .btn.ghost{background:transparent;color:#e6edf3;border:1px dashed #2a3136}
    .btn.link{background:transparent;border:0;color:#9fe8b8;text-decoration:underline;cursor:pointer}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #242b30;padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:#9aa3a9;font-weight:600}
    .pill{display:inline-block;padding:3px 9px;border-radius:999px;background:#0f1214;border:1px solid #20262b;color:#9aa3a9;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px}
    .due{background:#2a1f1f;color:#ffb3b3;border:1px solid #4d3030}
    .overdue{background:#381f1f;color:#ff8a8a;border:1px solid #5c2a2a}
    .cand{background:#23221a;color:#e3e0b0;border:1px solid #49452c}
    .ai{background:#1a2320;color:#a8e8c7;border:1px solid #274b32}
    .barwrap{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .bar{background:#0f1214;border:1px solid #20262b;border-radius:8px;padding:6px;text-align:center}
    .bar .h{height:36px;background:#203026;border:1px solid #2e4635;border-radius:6px;margin:4px 0}
    .bar.neg .h{background:#3a2222;border-color:#5b3030}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=file],input[type=text],input[type=number],select{background:#0f1214;border:1px solid #20262b;border-radius:8px;color:#e6edf3;padding:9px}
    input::placeholder{color:#6f7a80}
    .right{margin-left:auto}
    .mic{border-radius:50%;width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border:2px solid #2a3136;background:#0f1214;cursor:pointer}
    .mic.on{background:#1d2;color:#08110b;border-color:#3f6}
    .thumb{max-height:60px;border:1px solid #2a3136;border-radius:8px;margin-left:8px}
    .amt-pos{color:var(--pos);font-weight:700}
    .amt-neg{color:var(--neg);font-weight:700}
    .lang{display:flex;gap:6px;margin-left:12px}
    .lang button{padding:4px 8px;border-radius:999px;border:1px solid #20262b;background:#0f1214;color:#9aa3a9;font-size:12px;cursor:pointer}
    .lang button.on{background:#274b32;color:#a8e8c7;border-color:#274b32}
    .gate{background:#2a1f1f;border:1px solid #4d3030;color:#ffb3b3;padding:12px;border-radius:10px;margin-top:10px}
    .hint{font-size:12px;color:#9aa3a9}
    .kasa-quick{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .kasa-quick button{padding:6px 10px;border-radius:8px;border:1px solid #2a3136;background:#0f1214;color:#e6edf3;cursor:pointer;font-size:13px}
    .actions button{background:#0f1214;border:1px solid #2a3136;color:#e6edf3;border-radius:6px;padding:4px 8px;cursor:pointer}
    .actions button:hover{border-color:#3a4248}
    .inline-edit{display:flex;gap:6px;flex-wrap:wrap}
    .hidden{display:none !important}
    @media (max-width:1080px){.cards{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}}
    @media print{.tabs,.btn,.row input,.toast,.lang{display:none !important}body{background:#fff;color:#000}.card{background:#fff;border:1px solid #999}.wrap{max-width:1000px}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand"><b>OneTapDay — AI Księgowy</b> <span class="pill">MVP</span></div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">Panel</div>
      <div class="tab" data-sec="wyciag" data-i="tab_statement">Wyciąg</div>
      <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
      <div class="tab" data-sec="konta" data-i="tab_accounts">Konta</div>
      <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa</div>
      <div class="tab" data-sec="ustawienia" data-i="tab_settings">Ustawienia</div>
      <div class="lang" id="langBarMain">
        <button data-lang="pl" class="on">PL</button>
        <button data-lang="ru">RU</button>
        <button data-lang="en">EN</button>
        <button data-lang="uk">UK</button>
      </div>
    </div>
  </div>

  <!-- ACCESS GATE -->
  <div id="gate" class="gate hidden">
    <div data-i="gate_locked_title" style="font-weight:700;margin-bottom:6px">Dostęp zablokowany</div>
    <div class="muted" data-i="gate_locked_desc">
      Okres demo zakończony lub brak aktywnej subskrypcji. Przejdź do Ustawień, aby uruchomić demo (24h) lub opłacić dostęp.
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn secondary" onclick="document.querySelector('[data-sec=ustawienia]').click()" data-i="gate_open_settings">Otwórz Ustawienia</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="pulpit" class="section active">
    <div class="cards">
      <div class="card"><div class="muted" data-i="kpi_due_today">Do zapłaty dziś</div><div id="kpiDue" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_unmatched">Niesparowane transakcje</div><div id="kpiUnmatch" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_banks">Bilans banków</div><div id="kpiBank" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_cash">Kasa (PLN)</div><div id="kpiCash" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_total">Dostępnie razem</div><div id="kpiAvail" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_gap_today">Brak środków dziś</div><div id="kpiGap" class="kpi">0</div></div>
    </div>

    <div class="row" style="margin:10px 0">
      <button id="syncNow" class="btn" data-i="btn_sync">Synchronizuj</button>
      <button id="runAI" class="btn secondary" data-i="btn_ai_match">Dopasowanie AI</button>
      <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">Akceptuj bezpieczne pary</button>
      <button id="exportPDF" class="btn secondary" data-i="btn_pdf">Raport PDF</button>
      <span id="lastSync" class="pill" data-i="sync_ts">Synchronizacja: —</span>
      <span class="right pill" id="modeCash">Mode: auto</span>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="font-weight:700" data-i="minpay_title">Minimalna płatność (kara-stop)</div>
        <div id="minPayBox" class="muted">—</div>
        <div class="row" style="margin-top:6px">
          <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">Oznacz jako opłacone</button>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:700" data-i="forecast_7d">Prognoza 7 dni</div>
        <div class="muted" data-i="forecast7d_note">Liczy PLN-konta z wyciągu (włączone) + kasa.</div>
        <div id="forecastBars" class="barwrap"></div>
        <div id="forecastMeta" class="muted" style="margin-top:6px">—</div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="font-weight:700" data-i="forecast_30d">Prognoza 30 dni</div>
        <div class="muted" data-i="forecast30_note">Autoprognoza z wyciągów + kasa na 30 dni.</div>
        <div id="forecast30Table" class="muted">—</div>
      </div>
      <div class="card">
        <div style="font-weight:700" data-i="month_summary_title">Podsumowanie miesiąca</div>
        <div id="monthSummary" class="muted">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row">
        <div style="font-weight:700" data-i="plan_title">Plan płatności pod kasę</div>
        <div class="right">
          <span data-i="filter_label">Filtr:</span>
          <select id="planFilter">
            <option value="today" data-i="filter_today">Dziś</option>
            <option value="7d" data-i="filter_7d" selected>7 dni</option>
            <option value="all" data-i="filter_all">Wszystko</option>
          </select>
        </div>
        <label style="margin-left:10px">
          <input type="checkbox" id="excludeBlacklist"/> <span data-i="exclude_blacklist">Wyklucz blacklistę</span>
        </label>
      </div>
      <div class="row" style="margin:8px 0">
        <button id="makePlan" class="btn secondary" data-i="btn_make_plan">Utwórz plan</button>
        <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">Zastosuj plan</button>
        <span id="planMeta" class="pill">—</span>
      </div>
      <table id="planTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="plan_th_invoice">Faktura</th>
            <th data-i="plan_th_supplier">Dostawca</th>
            <th data-i="plan_th_due">Termin</th>
            <th data-i="plan_th_amount">Kwota</th>
            <th data-i="plan_th_reason">Powód</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- STATEMENT -->
  <div id="wyciag" class="section">
    <div class="row">
      <label class="btn ghost">
        <input id="txFile" name="txFile" type="file" accept=".csv" style="display:none"/>
        <span data-i="upload_statement">Załaduj wyciąg (CSV)</span>
      </label>

      <label class="btn ghost">
        <input id="txImage" name="txImage" type="file" accept="image/*" multiple style="display:none"/>
        <span data-i="upload_statement_image">Załaduj zrzut wyciągu (galeria)</span>
      </label>

      <img id="txLastThumb" class="thumb" alt="thumb" style="display:none"/>

      <input id="txUrl" type="text" placeholder="" data-i-ph="placeholder_csv_url" aria-label="CSV URL"/>
      <button id="saveTxUrl" class="btn secondary" data-i="save_url">Zapisz URL</button>
      <span class="muted" data-i="statement_columns_note">
        Kolumny: Data księgowania, ID transakcji, ID konta (lub IBAN), Kontrahent, Tytuł/Opis, Kwota(±), Waluta, Status, Saldo?
      </span>
    </div>
    <table id="txTable">
      <thead>
        <tr>
          <th data-i="th_date">Data</th>
          <th data-i="th_account">Konto</th>
          <th data-i="th_counterparty">Kontrahent</th>
          <th data-i="th_desc">Opis</th>
          <th data-i="th_amount">Kwota</th>
          <th data-i="th_currency">Waluta</th>
          <th data-i="th_status">Status</th>
          <th data-i="th_actions">Działania</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="row" style="margin-top:12px">
      <button id="exportBook" class="btn secondary">Eksport księgi (CSV)</button>
      <span class="muted">Zunifikowana tabela: bank + faktury + kasa</span>
    </div>
    <table id="bookTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Źródło</th>
          <th>Konto</th>
          <th>Kontrahent</th>
          <th>Opis</th>
          <th>Kwota</th>
          <th>Waluta</th>
          <th>Typ</th>
          <th>Nr</th>
          <th>Data dok.</th>
          <th>Termin</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- INVOICES -->
  <div id="faktury" class="section">
    <div class="row" style="align-items:center;margin-bottom:8px">
      <label class="btn ghost">
        <input id="billFile" name="billFile" type="file" accept=".csv" style="display:none"/>
        <span data-i="upload_invoices">Załaduj faktury (CSV)</span>
      </label>
      <label class="btn ghost">
        <input id="billImage" name="billImage" type="file" accept="image/*" multiple style="display:none"/>
        <span data-i="upload_invoice_images">Załaduj zdjęcia faktur</span>
      </label>
      <span class="muted" style="margin-left:12px" data-i="invoices_note">Tu wykrywamy numer faktury, kwotę i datę.</span>
    </div>
    <table id="billTable">
      <thead>
        <tr>
          <th data-i="inv_th_due">Termin</th>
          <th data-i="inv_th_number">Nr</th>
          <th data-i="inv_th_supplier">Dostawca</th>
          <th data-i="inv_th_amount">Kwota</th>
          <th data-i="inv_th_currency">Waluta</th>
          <th data-i="inv_th_status">Status</th>
          <th data-i="inv_th_candidate">Kandydat</th>
          <th data-i="inv_th_score">Score</th>
          <th data-i="inv_th_action">Działanie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ACCOUNTS -->
  <div id="konta" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="auto_accounts_title">Konta z wyciągu (auto)</div>
      <div class="muted" data-i="auto_accounts_desc">Edycja waluty, salda początkowego i uwzględnienia w planie.</div>
      <table id="autoAcc">
        <thead>
          <tr>
            <th data-i="acc_th_account">Konto</th>
            <th data-i="acc_th_type">Typ</th>
            <th data-i="acc_th_currency">Waluta</th>
            <th data-i="acc_th_balance_calc">Saldo (oblicz)</th>
            <th data-i="acc_th_start_balance">Start</th>
            <th data-i="acc_th_include">Uwzględnij</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- CASH -->
  <div id="kasa" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="cash_title">Kasa — szybkie operacje</div>
      <div class="muted" data-i="cash_note">Głosowa kasa + szybkie przyciski</div>
      <div id="kasaQuickHolder" class="kasa-quick"></div>

      <div class="row" style="margin-top:8px;align-items:center">
        <input id="quickAmt" type="number" step="0.01" placeholder="0.00" data-i-ph="ph_amount" style="width:120px"/>
        <input id="quickNote" type="text" placeholder="" data-i-ph="ph_comment" style="width:300px"/>
        <button id="addIn" class="btn secondary" data-i="btn_add_in">+ Przyjęcie</button>
        <button id="addOut" class="btn secondary" data-i="btn_add_out">− Wydanie</button>
        <button id="q50" class="btn ghost">+50</button>
        <button id="q100" class="btn ghost">+100</button>
        <button id="q200" class="btn ghost">+200</button>
        <div style="margin-left:12px">
          <button id="cashClose" class="btn" data-i="btn_close_shift">Zamknij zmianę</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <input id="cashPhoto" name="cashPhoto" type="file" accept="image/*" style="display:inline-block"/>
        <span class="muted" data-i="cash_photo_note">Zdjęcie paragonu/wyciągu — wykryj kwotę i opis.</span>
      </div>

      <table id="kasaTable" style="margin-top:12px">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">Data</th>
            <th data-i="cash_th_type">Typ</th>
            <th data-i="cash_th_amount">Kwota</th>
            <th data-i="cash_th_source">Źródło</th>
            <th data-i="cash_th_comment">Komentarz</th>
            <th data-i="th_actions">Działania</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="ustawienia" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="parameters">Parametry</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <label data-i="param_cash_label">Ręczna dostępna kasa dziś (PLN):</label>
          <input id="cashPLN" type="text"/><br/>
          <label data-i="param_penalty_label">Kara, %/dzień:</label>
          <input id="penaltyPct" type="text"/><br/>
          <label data-i="param_interval_label">Interwał synchronizacji, min:</label>
          <input id="intervalMin" type="text"/>
        </div>
        <div>
          <label data-i="rateEUR_label">rateEUR:</label> <input id="rateEUR" type="text"/><br/>
          <label data-i="rateUSD_label">rateUSD:</label> <input id="rateUSD" type="text"/><br/>
          <label data-i="blacklist_label">Czarna lista (przecinki):</label> <input id="blacklist" type="text"/><br/>
          <label><input id="autoCash" type="checkbox"/> <span data-i="auto_mode_label">Auto: z kont wyciągu (włączone) + kasa</span></label>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <button id="applySettings" class="btn secondary" data-i="btn_save_settings">Zapisz</button>
        <button id="exportCfg" class="btn ghost" data-i="btn_export_settings">Eksport ustawień</button>
        <label class="btn ghost"><span data-i="btn_import_settings">Import ustawień</span> <input id="importCfg" type="file" style="display:none"/></label>
        <button id="clearAll" class="btn ghost" data-i="btn_clear_all">Wyczyść historię (lokalnie)</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700" data-i="sub_title">Subskrypcja / Demo</div>
      <div class="muted" id="subStatus">—</div>
      <div class="row" style="margin-top:8px">
        <button id="startDemo" class="btn secondary" data-i="btn_start_demo">Uruchom demo (24h)</button>
        <button id="payNow" class="btn" data-i="btn_pay_sub">Opłać subskrypcję</button>
        <button id="endDemo" class="btn ghost" data-i="btn_end_demo">Zakończ demo</button>
      </div>
      <div class="hint" style="margin-top:6px" data-i="sub_hint">
        Opłata dostępna tylko tutaj. Jeśli masz link Stripe — ustaw <code>localStorage.stripe_link</code>.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* ==== CONFIG / API ==== */
const API_BASE = '/api';
const SUB_KEY = 'otd_sub_active';
const SUB_FROM = 'otd_sub_from';
const SUB_TO   = 'otd_sub_to';
const DEMO_START = 'otd_demo_started_at';
const USER_KEY = 'otd_user';
let REMOTE_OK = localStorage.getItem('remote_disabled')==='1' ? false : true;

/* ==== I18N (полный словарь) ==== */
const M = {
  ru:{ /* ——— RU ——— */
    tab_dashboard:"Пульт", tab_statement:"Выписка", tab_invoices:"Фактуры", tab_accounts:"Счета", tab_cash:"Касса", tab_settings:"Настройки",
    gate_locked_title:"Доступ заблокирован",
    gate_locked_desc:"Демо истекло или нет активной подписки. Перейдите в Настройки, чтобы запустить демо (24 ч) или оплатить доступ.",
    gate_open_settings:"Открыть Настройки",
    kpi_due_today:"К оплате сегодня", kpi_unmatched:"Несвязанные транзакции", kpi_banks:"Банки в расчёте", kpi_cash:"Касса (нал)", kpi_total:"Доступно всего", kpi_gap_today:"Разрыв кассы сегодня",
    btn_sync:"Синхронизация", btn_ai_match:"ИИ-сверка", btn_accept_safe:"Принять безопасные пары", btn_pdf:"PDF отчёт", sync_ts:"Синхронизация: —",
    minpay_title:"Минимальный платёж (штраф-стоп)", btn_apply_minpay:"Отметить как оплачено",
    forecast_7d:"Прогноз 7 дней", forecast7d_note:"Считает PLN-счета (включённые) + кассу.",
    forecast_30d:"Прогноз 30 дней", forecast30_note:"Автопрогноз по выпискам + кассе на 30 дней.",
    month_summary_title:"Итоги месяца",
    plan_title:"План платежей под кассу", filter_label:"Фильтр:", filter_today:"Сегодня", filter_7d:"7 дней", filter_all:"Все", exclude_blacklist:"Исключать blacklist",
    btn_make_plan:"Сформировать", btn_apply_plan:"Применить",
    plan_th_invoice:"Фактура", plan_th_supplier:"Поставщик", plan_th_due:"Срок", plan_th_amount:"Сумма", plan_th_reason:"Причина",
    upload_statement:"Загрузить выписку (CSV)", upload_statement_image:"Загрузить скрин выписки (галерея)",
    placeholder_csv_url:"URL CSV выписки", save_url:"Сохранить URL",
    statement_columns_note:"Колонки: дата, id транзакции, id счёта/IBAN, контрагент, описание, сумма(±), валюта, статус, saldo?",
    th_date:"Дата", th_account:"Счёт", th_counterparty:"Контрагент", th_desc:"Описание", th_amount:"Сумма", th_currency:"Валюта", th_status:"Статус", th_actions:"Действия",
    upload_invoices:"Загрузить счета (CSV)", upload_invoice_images:"Загрузить фото фактуры", invoices_note:"Распознаются № фактуры, суммы и даты.",
    inv_th_due:"Срок", inv_th_number:"№", inv_th_supplier:"Поставщик", inv_th_amount:"Сумма", inv_th_currency:"Валюта", inv_th_status:"Статус", inv_th_candidate:"Кандидат", inv_th_score:"Score", inv_th_action:"Действие",
    auto_accounts_title:"Счета из выписки (авто)", auto_accounts_desc:"Редактируй валюту, стартовый баланс и включение в план.",
    acc_th_account:"Счёт", acc_th_type:"Тип", acc_th_currency:"Валюта", acc_th_balance_calc:"Баланс (расчёт)", acc_th_start_balance:"Стартовый баланс", acc_th_include:"В расчёт",
    cash_title:"Касса — быстрые операции", cash_note:"Голосовая касса + быстрые кнопки",
    btn_add_in:"+ Приём", btn_add_out:"− Выдача", btn_close_shift:"Закрыть смену",
    speech_lang_label:"Язык распознавания:", cash_photo_note:"Фото чека/выписки — распознать сумму и описание.",
    cash_th_date:"Дата", cash_th_type:"Тип", cash_th_amount:"Сумма", cash_th_source:"Источник", cash_th_comment:"Комментарий",
    parameters:"Параметры", param_cash_label:"Доступная касса сегодня (PLN):", param_penalty_label:"Пеня, %/день:", param_interval_label:"Интервал синха, мин:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Blacklist (через запятую):", auto_mode_label:"Авто: из счетов (включённые) + касса",
    btn_save_settings:"Сохранить", btn_export_settings:"Экспорт настроек", btn_import_settings:"Импорт настроек",
    btn_clear_all:"Очистить историю (локально)",
    sub_title:"Подписка / Демо", btn_start_demo:"Запустить демо (24 ч)", btn_pay_sub:"Оплатить подписку", btn_end_demo:"Закончить демо",
    sub_hint:"Оплата только в Настройках. Если есть ссылka Stripe — положи в localStorage.stripe_link.",
    ph_amount:"Сумма", ph_comment:"Комментарий"
  },
  en:{ /* ——— EN ——— */
    tab_dashboard:"Dashboard", tab_statement:"Statement", tab_invoices:"Invoices", tab_accounts:"Accounts", tab_cash:"Cash", tab_settings:"Settings",
    gate_locked_title:"Access locked",
    gate_locked_desc:"Demo ended or subscription inactive. Go to Settings to start a 24h demo or pay.",
    gate_open_settings:"Open Settings",
    kpi_due_today:"Due today", kpi_unmatched:"Unmatched transactions", kpi_banks:"Bank balances", kpi_cash:"Cash (PLN)", kpi_total:"Available total", kpi_gap_today:"Cash gap today",
    btn_sync:"Sync", btn_ai_match:"AI match", btn_accept_safe:"Accept safe matches", btn_pdf:"PDF report", sync_ts:"Sync: —",
    minpay_title:"Minimum payment (penalty-stop)", btn_apply_minpay:"Mark as paid",
    forecast_7d:"7-day forecast", forecast7d_note:"Calculates included PLN accounts + cash.",
    forecast_30d:"30-day forecast", forecast30_note:"Auto-forecast from statements + cash.",
    month_summary_title:"Month summary",
    plan_title:"Payment plan for cash", filter_label:"Filter:", filter_today:"Today", filter_7d:"7 days", filter_all:"All", exclude_blacklist:"Exclude blacklist",
    btn_make_plan:"Build plan", btn_apply_plan:"Apply plan",
    plan_th_invoice:"Invoice", plan_th_supplier:"Supplier", plan_th_due:"Due", plan_th_amount:"Amount", plan_th_reason:"Reason",
    upload_statement:"Upload statement (CSV)", upload_statement_image:"Upload statement screenshot (gallery)",
    placeholder_csv_url:"CSV statement URL", save_url:"Save URL",
    statement_columns_note:"Columns: booking date, tx id, account id/IBAN, counterparty, title/description, amount(±), currency, status, balance?",
    th_date:"Date", th_account:"Account", th_counterparty:"Counterparty", th_desc:"Description", th_amount:"Amount", th_currency:"Currency", th_status:"Status", th_actions:"Actions",
    upload_invoices:"Upload invoices (CSV)", upload_invoice_images:"Upload invoice photos", invoices_note:"We detect invoice numbers, amounts and dates.",
    inv_th_due:"Due", inv_th_number:"No", inv_th_supplier:"Supplier", inv_th_amount:"Amount", inv_th_currency:"Currency", inv_th_status:"Status", inv_th_candidate:"Candidate", inv_th_score:"Score", inv_th_action:"Action",
    auto_accounts_title:"Accounts from statement (auto)", auto_accounts_desc:"Edit currency, start balance and include-in-plan.",
    acc_th_account:"Account", acc_th_type:"Type", acc_th_currency:"Currency", acc_th_balance_calc:"Balance (calc)", acc_th_start_balance:"Start", acc_th_include:"Include",
    cash_title:"Cash — quick ops", cash_note:"Voice cash + quick buttons",
    btn_add_in:"+ In", btn_add_out:"− Out", btn_close_shift:"Close shift",
    speech_lang_label:"Recognition language:", cash_photo_note:"Receipt/statement photo — detect amount and description.",
    cash_th_date:"Date", cash_th_type:"Type", cash_th_amount:"Amount", cash_th_source:"Source", cash_th_comment:"Comment",
    parameters:"Parameters", param_cash_label:"Manual available cash today (PLN):", param_penalty_label:"Penalty, %/day:", param_interval_label:"Sync interval, min:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Blacklist (comma):", auto_mode_label:"Auto: from included statement accounts + cash",
    btn_save_settings:"Save", btn_export_settings:"Export settings", btn_import_settings:"Import settings",
    btn_clear_all:"Clear history (local)",
    sub_title:"Subscription / Demo", btn_start_demo:"Start demo (24h)", btn_pay_sub:"Pay subscription", btn_end_demo:"End demo",
    sub_hint:"Payment only in Settings. If you have a Stripe link, put it in localStorage.stripe_link.",
    ph_amount:"Amount", ph_comment:"Comment"
  },
  pl:{ /* ——— PL ——— */
    tab_dashboard:"Panel", tab_statement:"Wyciąg", tab_invoices:"Faktury", tab_accounts:"Konta", tab_cash:"Kasa", tab_settings:"Ustawienia",
    gate_locked_title:"Dostęp zablokowany",
    gate_locked_desc:"Demo zakończone lub brak subskrypcji. Przejdź do Ustawień, aby uruchomić demo (24h) lub opłacić.",
    gate_open_settings:"Otwórz Ustawienia",
    kpi_due_today:"Do zapłaty dziś", kpi_unmatched:"Niesparowane transakcje", kpi_banks:"Bilans banków", kpi_cash:"Kasa (PLN)", kpi_total:"Dostępnie razem", kpi_gap_today:"Brak środków dziś",
    btn_sync:"Synchronizuj", btn_ai_match:"Dopasowanie AI", btn_accept_safe:"Akceptuj bezpieczne pary", btn_pdf:"Raport PDF", sync_ts:"Synchronizacja: —",
    minpay_title:"Minimalna płatność (kara-stop)", btn_apply_minpay:"Oznacz jako opłacone",
    forecast_7d:"Prognoza 7 dni", forecast7d_note:"Liczy włączone konta PLN + kasa.",
    forecast_30d:"Prognoza 30 dni", forecast30_note:"Autoprognoza z wyciągów + kasa na 30 dni.",
    month_summary_title:"Podsumowanie miesiąca",
    plan_title:"Plan płatności pod kasę", filter_label:"Filtr:", filter_today:"Dziś", filter_7d:"7 dni", filter_all:"Wszystko", exclude_blacklist:"Wyklucz blacklistę",
    btn_make_plan:"Utwórz plan", btn_apply_plan:"Zastosuj plan",
    plan_th_invoice:"Faktura", plan_th_supplier:"Dostawca", plan_th_due:"Termin", plan_th_amount:"Kwota", plan_th_reason:"Powód",
    upload_statement:"Załaduj wyciąg (CSV)", upload_statement_image:"Załaduj zrzut wyciągu (galeria)",
    placeholder_csv_url:"URL CSV wyciągu", save_url:"Zapisz URL",
    statement_columns_note:"Kolumny: Data księgowania, ID transakcji, ID konta/IBAN, Kontrahent, Tytuł/Opis, Kwota(±), Waluta, Status, Saldo?",
    th_date:"Data", th_account:"Konto", th_counterparty:"Kontrahent", th_desc:"Opis", th_amount:"Kwota", th_currency:"Waluta", th_status:"Status", th_actions:"Działania",
    upload_invoices:"Załaduj faktury (CSV)", upload_invoice_images:"Załaduj zdjęcia faktur", invoices_note:"Wykrywamy nr faktury, kwotę i datę.",
    inv_th_due:"Termin", inv_th_number:"Nr", inv_th_supplier:"Dostawca", inv_th_amount:"Kwota", inv_th_currency:"Waluta", inv_th_status:"Status", inv_th_candidate:"Kandydat", inv_th_score:"Score", inv_th_action:"Akcja",
    auto_accounts_title:"Konta z wyciągu (auto)", auto_accounts_desc:"Edycja waluty, salda początkowego i uwzględnienia w planie.",
    acc_th_account:"Konto", acc_th_type:"Typ", acc_th_currency:"Waluta", acc_th_balance_calc:"Saldo (oblicz)", acc_th_start_balance:"Start", acc_th_include:"Uwzględnij",
    cash_title:"Kasa — szybkie operacje", cash_note:"Głosowa kasa + szybkie przyciski",
    btn_add_in:"+ Przyjęcie", btn_add_out:"− Wydanie", btn_close_shift:"Zamknij zmianę",
    speech_lang_label:"Język rozpoznawania:", cash_photo_note:"Zdjęcie paragonu/wyciągu — wykryj kwotę i opis.",
    cash_th_date:"Data", cash_th_type:"Typ", cash_th_amount:"Kwota", cash_th_source:"Źródło", cash_th_comment:"Komentarz",
    parameters:"Parametry", param_cash_label:"Ręczna dostępna kasa dziś (PLN):", param_penalty_label:"Kara, %/dzień:", param_interval_label:"Interwał synchronizacji, min:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Czarna lista (przecinki):", auto_mode_label:"Auto: z kont wyciągu (włączone) + kasa",
    btn_save_settings:"Zapisz", btn_export_settings:"Eksport ustawień", btn_import_settings:"Import ustawień",
    btn_clear_all:"Wyczyść historię (lokalnie)",
    sub_title:"Subskrypcja / Demo", btn_start_demo:"Uruchom demo (24h)", btn_pay_sub:"Opłać subskrypcję", btn_end_demo:"Zakończ demo",
    sub_hint:"Płatność tylko w Ustawieniach. Jeśli masz link Stripe — ustaw w localStorage.stripe_link.",
    ph_amount:"Kwota", ph_comment:"Komentarz"
  },
  uk:{ /* ——— UK ——— */
    tab_dashboard:"Пульт", tab_statement:"Виписка", tab_invoices:"Рахунки", tab_accounts:"Рахунки", tab_cash:"Каса", tab_settings:"Налаштування",
    gate_locked_title:"Доступ заблоковано",
    gate_locked_desc:"Демо завершено або немає підписки. Перейдіть у Налаштування, щоб запустити демо (24 год) або оплатити доступ.",
    gate_open_settings:"Відкрити Налаштування",
    kpi_due_today:"До сплати сьогодні", kpi_unmatched:"Неповʼязані транзакції", kpi_banks:"Баланс банків", kpi_cash:"Каса (PLN)", kpi_total:"Доступно всього", kpi_gap_today:"Розрив каси сьогодні",
    btn_sync:"Синхронізація", btn_ai_match:"AI-звірка", btn_accept_safe:"Прийняти безпечні пари", btn_pdf:"Звіт PDF", sync_ts:"Синхр.: —",
    minpay_title:"Мінімальний платіж (штраф-стоп)", btn_apply_minpay:"Позначити як сплачено",
    forecast_7d:"Прогноз 7 днів", forecast7d_note:"Рахує увімкнені PLN-рахунки + касу.",
    forecast_30d:"Прогноз 30 днів", forecast30_note:"Автопрогноз з виписок + каси.",
    month_summary_title:"Підсумки місяця",
    plan_title:"План платежів під касу", filter_label:"Фільтр:", filter_today:"Сьогодні", filter_7d:"7 днів", filter_all:"Всі", exclude_blacklist:"Виключати blacklist",
    btn_make_plan:"Сформувати", btn_apply_plan:"Застосувати",
    plan_th_invoice:"Рахунок", plan_th_supplier:"Постачальник", plan_th_due:"Термін", plan_th_amount:"Сума", plan_th_reason:"Причина",
    upload_statement:"Завантажити виписку (CSV)", upload_statement_image:"Завантажити скрин виписки (галерея)",
    placeholder_csv_url:"URL CSV виписки", save_url:"Зберегти URL",
    statement_columns_note:"Колонки: дата, id транзакції, id рахунку/IBAN, контрагент, опис, сума(±), валюта, статус, баланс?",
    th_date:"Дата", th_account:"Рахунок", th_counterparty:"Контрагент", th_desc:"Опис", th_amount:"Сума", th_currency:"Валюта", th_status:"Статус", th_actions:"Дії",
    upload_invoices:"Завантажити рахунки (CSV)", upload_invoice_images:"Завантажити фото рахунків", invoices_note:"Виявляємо № рахунку, суму і дату.",
    inv_th_due:"Термін", inv_th_number:"№", inv_th_supplier:"Постачальник", inv_th_amount:"Сума", inv_th_currency:"Валюта", inv_th_status:"Статус", inv_th_candidate:"Кандидат", inv_th_score:"Score", inv_th_action:"Дія",
    auto_accounts_title:"Рахунки з виписки (авто)", auto_accounts_desc:"Редагуйте валюту, початковий баланс і включення до плану.",
    acc_th_account:"Рахунок", acc_th_type:"Тип", acc_th_currency:"Валюта", acc_th_balance_calc:"Баланс (обр.)", acc_th_start_balance:"Старт", acc_th_include:"Включити",
    cash_title:"Каса — швидкі операції", cash_note:"Голосова каса + швидкі кнопки",
    btn_add_in:"+ Прихід", btn_add_out:"− Видаток", btn_close_shift:"Закрити зміну",
    speech_lang_label:"Мова розпізнавання:", cash_photo_note:"Фото чеку/виписки — розпізнати суму та опис.",
    cash_th_date:"Дата", cash_th_type:"Тип", cash_th_amount:"Сума", cash_th_source:"Джерело", cash_th_comment:"Коментар",
    parameters:"Параметри", param_cash_label:"Ручна доступна каса сьогодні (PLN):", param_penalty_label:"Пеня, %/день:", param_interval_label:"Інтервал синхр., хв:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Чорний список (через кому):", auto_mode_label:"Авто: з рахунків (включені) + каса",
    btn_save_settings:"Зберегти", btn_export_settings:"Експорт налаштувань", btn_import_settings:"Імпорт налаштувань",
    btn_clear_all:"Очистити історію (локально)",
    sub_title:"Підписка / Демо", btn_start_demo:"Запустити демо (24 год)", btn_pay_sub:"Оплатити підписку", btn_end_demo:"Завершити демо",
    sub_hint:"Оплата лише в Налаштуваннях. Якщо є посилання Stripe — покладіть у localStorage.stripe_link.",
    ph_amount:"Сума", ph_comment:"Коментар"
  }
};

/* PLACEHOLDER APPLIER */
function applyPlaceholders(lang){
  const dict = M[lang]||M.pl;
  document.querySelectorAll('[data-i-ph]').forEach(el=>{
    const k = el.getAttribute('data-i-ph');
    if (dict[k]) el.setAttribute('placeholder', dict[k]);
  });
}

/* LANGUAGE APPLY */
function applyLang(lang){
  const dict = M[lang]||M.pl;
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k = el.getAttribute('data-i'); if (dict[k]) el.textContent = dict[k];
  });
  document.querySelectorAll('#langBarMain button').forEach(btn=>btn.classList.toggle('on', btn.dataset.lang===lang));
  localStorage.setItem('otd_lang', lang);
  applyPlaceholders(lang);
  if (typeof renderCashExamples==='function') renderCashExamples(lang);
}

/* ==== HELPERS ==== */
const $id = id => document.getElementById(id);
const today = () => new Date().toISOString().slice(0,10);
const asNum = v=>{
  if(v==null) return 0; let s=String(v).trim(); if(!s) return 0;
  s=s.replace(/\u00A0/g,' ');
  if(/^(\(|−|-).*\)$/.test(s)) s='-'+s.replace(/^\(|−|-|\)$/g,'');
  if(/^−/.test(s)) s='-'+s.replace(/^−/,'');
  const hasComma=/,/.test(s), hasDot=/\./.test(s);
  s=s.replace(/\b(PLN|zł|zl|zlot|EUR|USD|GBP)\b/ig,'');
  if(hasComma && !hasDot) s=s.replace(/\s/g,'').replace(/,/g,'.'); else s=s.replace(/[\s\u00A0]/g,'').replace(/,/g,'');
  s=s.replace(/[^\d\.\-]/g,'');
  const n=Number(s); return isNaN(n)?0:n;
};
function detectCurrency(s){
  s=(s||'').toUpperCase();
  if(/PLN|ZŁ|ZL/.test(s)) return 'PLN';
  if(/EUR/.test(s)) return 'EUR';
  if(/USD|\$/.test(s)) return 'USD';
  return 'PLN';
}
function toISO(d){
  if(!d) return ""; const s=String(d).trim();
  let m=s.match(/^(\d{4})-(\d{2})-(\d{2})/); if(m) return m[0];
  m=s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
  if(m){const dd=m[1].padStart(2,'0'),mm=m[2].padStart(2,'0'),yy=m[3].length===2?('20'+m[3]):m[3]; return yy+'-'+mm+'-'+dd;}
  const months = {
    'stycznia':'01','lutego':'02','marca':'03','kwietnia':'04','maja':'05','czerwca':'06','lipca':'07','sierpnia':'08','września':'09','pazdziernika':'10','października':'10','listopada':'11','grudnia':'12',
    'января':'01','февраля':'02','марта':'03','апреля':'04','мая':'05','июня':'06','июля':'07','августа':'08','сентября':'09','октября':'10','ноября':'11','декабря':'12'
  };
  let md = s.match(/(\d{1,2})\s+([A-Za-zА-Яа-яęóąśłżźćńё]+)\s+(\d{4})/);
  if(md){ const dd=md[1].padStart(2,'0'); const mm=months[(md[2]||'').toLowerCase()]||'01'; return md[3]+'-'+mm+'-'+dd; }
  const p=Date.parse(s); if(!isNaN(p)) return new Date(p).toISOString().slice(0,10);
  return "";
}
function fmtAmountRaw(raw){
  const n=asNum(raw); if(!Number.isFinite(n)) return '<span>—</span>';
  const sign=n<0?'-':'+', cls=n<0?'amt-neg':'amt-pos';
  const abs=Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g," ");
  return `<span class="${cls}">${sign} ${abs}</span>`;
}
function smartSplit(line,del){
  let out=[],cur="",q=false;
  for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"'){q=!q;continue} if(ch===del && !q){out.push(cur);cur="";} else cur+=ch;}
  out.push(cur); return out;
}
function parseCSV(text){
  if(!text) return []; text=text.replace(/^\uFEFF/,'').replace(/\r/g,"");
  const lines=text.split("\n").filter(l=>l.trim()); if(!lines.length) return [];
  const sep=(lines[0].split(";").length>lines[0].split(",").length)?";":",";
  const head=smartSplit(lines.shift(),sep).map(h=>h.trim());
  return lines.map(line=>{
    const cells=smartSplit(line,sep); const obj={};
    head.forEach((h,i)=>{let v=(cells[i]||"").trim(); v=v.replace(/\u00A0/g,' ').trim(); obj[h]=v;}); return obj;
  });
}
function getVal(obj,keys){
  if(!obj) return ""; for(const k of keys){ if(k in obj && String(obj[k]).trim()!=="") return obj[k]; }
  const low=Object.keys(obj).reduce((m,x)=>(m[x.toLowerCase()]=obj[x],m),{});
  for(const k of keys){const kk=k.toLowerCase(); if(kk in low && String(low[kk]).trim()!="") return low[kk];}
  return "";
}

/* ==== STATE ==== */
let tx=[], bills=[], kasa=[], accMeta={};
const stateKeys = ['tx_manual_import','bills_manual_import','kasa','accMeta','cashPLN','penaltyPct','intervalMin','rateEUR','rateUSD','blacklist','autoCash',SUB_KEY,SUB_FROM,SUB_TO,DEMO_START,'txUrl','billUrl','otd_lang','speechLang'];

/* ==== REMOTE SYNC (optional) ==== */
async function pullState(){
  if(!REMOTE_OK) return null;
  const email = localStorage.getItem(USER_KEY)||"";
  if(!email) return null;
  try{
    const r=await fetch(`${API_BASE}/state/get?email=${encodeURIComponent(email)}`,{credentials:'include'});
    if(!r.ok){ if(r.status===404){ REMOTE_OK=false; localStorage.setItem('remote_disabled','1'); } return null; }
    const json=await r.json();
    if(json.tx) localStorage.setItem('tx_manual_import', JSON.stringify(json.tx));
    if(json.bills) localStorage.setItem('bills_manual_import', JSON.stringify(json.bills));
    if(json.kasa) localStorage.setItem('kasa', JSON.stringify(json.kasa));
    if(json.accMeta) localStorage.setItem('accMeta', JSON.stringify(json.accMeta));
    if(json.settings) Object.entries(json.settings).forEach(([k,v])=> localStorage.setItem(k, typeof v==='string'?v:JSON.stringify(v)));
    return json;
  }catch(e){ REMOTE_OK=false; localStorage.setItem('remote_disabled','1'); return null; }
}
const pushState = (function(){
  let t=null, inflight=false;
  return function(){
    if(!REMOTE_OK) return;
    if(inflight) return;
    clearTimeout(t);
    t=setTimeout(async ()=>{
      const email = localStorage.getItem(USER_KEY)||"";
      if(!email) return;
      inflight=true;
      const body={
        email,
        tx: JSON.parse(localStorage.getItem('tx_manual_import')||'[]'),
        bills: JSON.parse(localStorage.getItem('bills_manual_import')||'[]'),
        kasa: JSON.parse(localStorage.getItem('kasa')||'[]'),
        accMeta: JSON.parse(localStorage.getItem('accMeta')||'{}'),
        settings: stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k), m), {})
      };
      try{
        const res=await fetch(`${API_BASE}/state/save`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          credentials:'include',body:JSON.stringify(body)
        });
        if(!res.ok && res.status===404){ REMOTE_OK=false; localStorage.setItem('remote_disabled','1'); }
      }catch(e){ REMOTE_OK=false; localStorage.setItem('remote_disabled','1'); } finally{ inflight=false; }
    }, 600);
  }
})();

/* ==== MONEY / RATES ==== */
function rate(cur){
  cur=String(cur||"PLN").toUpperCase();
  if(cur==='PLN') return 1;
  if(cur==='EUR') return asNum(localStorage.getItem('rateEUR')||4.3);
  if(cur==='USD') return asNum(localStorage.getItem('rateUSD')||3.95);
  return 1;
}
function computeAccountBalance(accId){
  const rows=tx.filter(r=> (getVal(r,["ID konta","IBAN","account","ID"])||"UNKNOWN")===accId);
  const withSaldo = rows.filter(r=> getVal(r,["Saldo po operacji","Saldo","saldo"]));
  if(withSaldo.length){ const last=withSaldo[withSaldo.length-1]; return asNum(getVal(last,["Saldo po operacji","Saldo","saldo"])); }
  const start=Number((accMeta[accId]||{}).start||0);
  const sum=rows.reduce((s,r)=> s+asNum(getVal(r,["Kwota","Kwота","amount","Kwota_raw"])) ,0);
  return start+sum;
}
function bankAvailablePLN(){
  let sum=0;
  Object.values(accMeta).filter(a=>a.include).forEach(a=>{
    sum+=computeAccountBalance(a.id)*rate(a.currency);
  });
  return sum;
}
function kasaBalance(){
  let bal=0;
  kasa.forEach(k=>{
    if(k.type==='przyjęcie') bal+=k.amount;
    if(k.type==='wydanie') bal-=k.amount;
    if(k.type==='zamknięcie') bal = k.amount;
  });
  return bal;
}
function availableTotal(){
  const auto = localStorage.getItem('autoCash')==='1';
  const manual = asNum(localStorage.getItem('cashPLN')||0);
  const kas = kasaBalance();
  return auto ? (bankAvailablePLN()+kas) : (manual+kas);
}

/* ==== AI MATCH ==== */
function normName(s){s=(s||"").toString().toLowerCase().replace(/[.,]/g," ").replace(/\s+/g," ").trim();["sp z oo","sp. z o.o.","spolka","spółka","sa","s.a","ooo"].forEach(t=>s=s.replace(t,""));return s}
function nameSimilar(a,b){a=normName(a);b=normName(b);if(!a||!b) return 0;if(a===b) return 1;if(a.includes(b)||b.includes(a)) return 0.8;return 0}
function scoreMatch(bill,tr){
  let score=0;
  const bAmt=asNum(getVal(bill,["Kwota do zapłaty","Kwота do заплаты","Kwota","amount"]));
  const tAmt=Math.abs(asNum(getVal(tr,["Kwota","Kwота","amount","Kwota_raw"])));
  const bCur=(getVal(bill,["Waluta","currency"])||"").toUpperCase();
  const tCur=(getVal(tr,["Waluta","currency"])||"").toUpperCase();
  if(bAmt>0 && tAmt>0 && Math.abs(bAmt-tAmt)<0.01 && (bCur===tCur || !bCur || !tCur)) score+=60;
  const inv=String(getVal(bill,["Numer faktury","Numer фактуры","Invoice number"])||"").toLowerCase();
  const desc=String(getVal(tr,["Tytuł/Opis","Opis","Title","description"])||"").toLowerCase();
  if(inv && desc.includes(inv)) score+=25;
  if(nameSimilar(getVal(bill,["Dostawca","Supplier"]), getVal(tr,["Kontrahent","Counterparty"]))>=0.8) score+=10;
  if(asNum(getVal(tr,["Kwota","amount"]))<0) score+=5;
  return {score:Math.min(100,score)};
}
function runAI(){
  bills.forEach(b=>{
    const status=String(getVal(b,["Status faktury","Status фактуры","Status"])||"").toLowerCase();
    if(status.includes("opłacone")||status.includes("paid")||status.includes("оплачено")) return;
    let best=null;
    tx.forEach(t=>{
      if(String(getVal(t,["Status transakcji","status"])||"").toLowerCase()==="sparowane") return;
      if(asNum(getVal(t,["Kwota","amount"]))>=0) return;
      const s=scoreMatch(b,t);
      if(!best || s.score>best.s) best={t,s:s.score};
    });
    if(best && best.s>=85){
      best.t["Status transakcji"]="Sparowane";
      best.t["Powiązana faktura (ID)"]=getVal(b,["Numer faktury","Numer фактуры"]);
      b["Status faktury"]="Opłacone"; b["Data płatności"]=today();
    }else if(best && best.s>=55){
      b["Kandydat (AI)"]=getVal(best.t,["ID transakcji"]);
      b["AI score"]=best.s;
    }else{ b["Kandydat (AI)"]=""; b["AI score"]=""; }
  });
  render(); saveLocal(); pushState();
}
function acceptSafe(){
  bills.filter(b=> Number(getVal(b,["AI score"])||0)>=85).forEach(b=>{
    const t=tx.find(t=> getVal(t,["ID transakcji"])===getVal(b,["Kandydat (AI)"]));
    if(!t) return;
    t["Status transakcji"]="Sparowane";
    t["Powiązana faktura (ID)"]=getVal(b,["Numer faktury","Numer фактуры"]);
    b["Status faktury"]="Opłacone"; b["Data płatności"]=today(); b["Kandydat (AI)"]=b["AI score"]="";
  });
  render(); saveLocal(); pushState();
}

/* ==== OCR IMPORT (images) ==== */
async function recognizeImage(file){
  const { data:{ text } } = await Tesseract.recognize(file, 'pol+eng+rus', { logger:()=>{} });
  return text.replace(/\u00A0/g,' ').replace(/\r/g,'').replace(/\t/g,' ').replace(/ +/g,' ').trim();
}
function parseBankOCR(text){
  const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  let curDate = today();
  for(let i=0;i<lines.length;i++){
    const L = lines[i];
    const d1=L.match(/(\d{1,2}\s+[A-Za-zĄąĆćĘęŁłŃńÓóŚśŹźŻżА-Яа-яё]+\s+\d{4})/);
    const d2=L.match(/(\d{4}-\d{2}-\d{2})/);
    if(d1||d2){ curDate = toISO((d1?d1[1]:d2[1])); continue; }

    const amtM = L.match(/([−-]?\s?\d{1,3}(?:[ \.]\d{3})*(?:[,.]\d{2})|\b[−-]?\d+[,.]\d{2})\s*(PLN|EUR|USD|zł|zl)?/i);
    if(amtM){
      const amountRaw = amtM[1];
      const cur = detectCurrency(L);
      let sign = /[−-]/.test(amountRaw) ? -1 : 1;
      if(/obciążen|charge|fee|prowizj/i.test(L)) sign = -1;

      const prev = (lines[i-1]||'').trim();
      const maybeName = prev && !/(PLN|EUR|USD|zł|zl)/i.test(prev) ? prev : L.split(amountRaw)[0];
      const counterparty = maybeName.replace(/[•·]/g,'').slice(0,120);

      const amt = asNum(amountRaw) * sign;
      if(Math.abs(amt)>0){
        out.push({
          "Data księgowania": curDate || today(),
          "ID transakcji": 'ocr-'+Date.now()+'-'+out.length,
          "ID konta": 'UNKNOWN',
          "Kontrahent": counterparty,
          "Tytuł/Opis": L.slice(0,200),
          "Kwota": amt.toFixed(2),
          "Waluta": cur,
          "Status transakcji":""
        });
      }
    }
  }
  return out;
}
function parseInvoiceOCR(text){
  const raw = text.replace(/\r/g,'').replace(/[ \t]+/g,' ').replace(/\n+/g,'\n');
  const get = (re)=>{ const m=raw.match(re); return m?m[1].trim():''; };

  // суммы
  let totalTxt = get(/Do\s*zapłaty[:\s]*([0-9\s.,]+(?:PLN|EUR|USD)?)/i)
               || get(/Razem\s*(?:brutto)?[:\s]*([0-9\s.,]+(?:PLN|EUR|USD)?)/i)
               || get(/Wartość\s*brutto[:\s]*([0-9\s.,]+(?:PLN|EUR|USD)?)/i)
               || get(/Kwota\s*brutto[:\s]*([0-9\s.,]+(?:PLN|EUR|USD)?)/i);

  const currency = detectCurrency(totalTxt||raw);
  let total = Math.abs(asNum(totalTxt));
  if(!total){
    const nums=[...raw.matchAll(/(\d{1,3}(?:[ \.]\d{3})*(?:[,.]\d{2}))/g)].map(m=>asNum(m[1]));
    total = nums.length ? Math.max(...nums) : 0;
  }

  // номер
  const inv = get(/Faktura\s*(?:numer|nr)?[:\s]*([A-Za-z0-9\-\/\.]+)/i)
           || get(/Invoice\s*(?:No|Number)[:\s]*([A-Za-z0-9\-\/\.]+)/i)
           || ('INV-'+Date.now());

  // стороны
  const block = (head)=> {
    const i=raw.search(head); if(i<0) return '';
    const tail=raw.slice(i).split(/\n{2,}/)[0];
    return tail.replace(head,'').trim();
  };
  const sprzedawca = block(/(Sprzedawca|Seller)[:\s]*/i);
  const nabywca    = block(/(Nabywca|Buyer)[:\s]*/i);

  const meNames = (localStorage.getItem('my_names')||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
  const meTax   = (localStorage.getItem('my_taxids')||'').toLowerCase().replace(/\s|-/g,'').split(',').map(s=>s.trim()).filter(Boolean);
  const hasMe = s=>{
    const c=(s||'').toLowerCase().replace(/\s|-/g,'');
    if(!c) return false;
    if(meTax.some(t=> t && c.includes(t))) return true;
    return meNames.some(n => n && c.includes(n.replace(/\s|-/g,'')));
  };

  let type='my_out', supplier='UNKNOWN';
  if(hasMe(sprzedawca)){ type='my_in'; supplier=(nabywca.split('\n')[0]||'UNKNOWN').trim(); }
  else if(hasMe(nabywca)){ type='my_out'; supplier=(sprzedawca.split('\n')[0]||'UNKNOWN').trim(); }
  else { supplier=(sprzedawca.split('\n')[0]||'UNKNOWN').trim(); }

  const due = toISO(get(/Termin\s*płatności[:\s]+([^\n]+)/i)) || toISO(get(/Due\s*date[:\s]+([^\n]+)/i)) || today();

  return [{
    "Termin płatności": due,
    "Numer faktury": inv,
    "Dostawca": supplier,
    "Kwota do zapłaty": type==='my_out' ? total.toFixed(2) : '0.00',
    "Waluta": currency,
    "Typ": type,
    "Status faktury": type==='my_out' ? "do zapłaty" : "przychodząca"
  }];
}

/* ==== PERSIST LOCAL ==== */
function loadLocal(){
  try{ kasa = JSON.parse(localStorage.getItem('kasa')||'[]'); }catch(e){kasa=[]}
  try{ tx = JSON.parse(localStorage.getItem('tx_manual_import')||'[]'); }catch(e){tx=[]}
  try{ bills = JSON.parse(localStorage.getItem('bills_manual_import')||'[]'); }catch(e){bills=[]}
  try{ accMeta = JSON.parse(localStorage.getItem('accMeta')||'{}'); }catch(e){accMeta={}}
}
function saveLocal(){
  try{ localStorage.setItem('kasa', JSON.stringify(kasa)); }catch(e){}
  try{ localStorage.setItem('tx_manual_import', JSON.stringify(tx)); }catch(e){}
  try{ localStorage.setItem('bills_manual_import', JSON.stringify(bills)); }catch(e){}
  try{ localStorage.setItem('accMeta', JSON.stringify(accMeta)); }catch(e){}
}

/* ==== ACCOUNTS ==== */
function inferAccounts(){
  const map={};
  tx.forEach(r=>{
    const id=getVal(r,["ID konta","IBAN","account","ID"])||"UNKNOWN";
    const cur=(getVal(r,["Waluta","currency"])||"PLN").toUpperCase();
    if(!map[id]) map[id]={id,name:String(id).slice(0,12),currency:cur,include:true,type:"Biznes",start:0};
  });
  try{ const saved=JSON.parse(localStorage.getItem('accMeta')||'{}'); Object.keys(map).forEach(id=>{ if(saved[id]) map[id]=Object.assign(map[id], saved[id]); }); }catch(e){}
  accMeta=map; renderAccounts();
}

/* ==== GATE: DEMO / SUB ==== */
function isSubActive(){
  const a=localStorage.getItem(SUB_KEY)==='1';
  if(!a) return false;
  const to=localStorage.getItem(SUB_TO)||''; if(!to) return a;
  return new Date(to) >= new Date();
}
function demoLeftMs(){
  const t=localStorage.getItem(DEMO_START); if(!t) return 0;
  const start=new Date(t).getTime(); const left = (start + 24*3600*1000) - Date.now();
  return left;
}
function isDemoActive(){ return demoLeftMs() > 0; }
function gateAccess(){
  const ok = isSubActive() || isDemoActive();
  const gate = $id('gate'); const tabs = document.querySelectorAll('.tabs .tab');
  if(!gate) return;
  gate.classList.toggle('hidden', ok);
  tabs.forEach(t=>{
    if(t.dataset.sec==='ustawienia') t.classList.remove('disabled');
    else t.classList.toggle('disabled', !ok);
  });
  if(!ok){
    document.querySelector('[data-sec=ustawienia]')?.click();
  }
}
function updateSubUI(){
  const el=$id('subStatus'); if(!el) return;
  let s='—';
  if(isSubActive()){
    s=`✅ Sub aktywna: ${localStorage.getItem(SUB_FROM)||'—'} → ${localStorage.getItem(SUB_TO)||'—'}`;
  }else if(isDemoActive()){
    const leftMs=demoLeftMs(); const hrs=Math.ceil(leftMs/3600000);
    s=`🧪 Demo aktywne ~ ${hrs}h`;
  }else{
    s='⛔ Brak dostępu: włącz demo lub opłać.';
  }
  el.textContent=s;
}

/* ==== AUTOSYNC ==== */
let syncTimer=null, syncing=false;
async function fetchSources(){
  if(syncing) return; syncing=true;
  try{
    const u1=localStorage.getItem('txUrl')||$id('txUrl')?.value||"";
    const u2=localStorage.getItem('billUrl')||$id('billUrl')?.value||"";
    if(u1){ const r=await fetch(u1,{cache:'no-store'}); tx = parseCSV(await r.text()); }
    if(u2){ const r2=await fetch(u2,{cache:'no-store'}); bills = parseCSV(await r2.text()); }
    inferAccounts(); render();
    const last=$id('lastSync'); if(last) last.textContent = (M[localStorage.getItem('otd_lang')||'pl'].sync_ts||"Synchronizacja: —").replace('—', new Date().toLocaleString());
    saveLocal(); pushState();
  }catch(e){
    const last=$id('lastSync'); if(last) last.textContent = 'Error: '+(e?.message||e);
  }finally{ syncing=false; }
}
function scheduleAutosync(){
  clearInterval(syncTimer); const m = parseInt(localStorage.getItem('intervalMin')||'0',10);
  if(m>0 && (localStorage.getItem('txUrl')||localStorage.getItem('billUrl'))){
    syncTimer = setInterval(fetchSources, Math.max(1,m)*60*1000);
  }
}

/* ==== CASH QUICK EXAMPLES ==== */
const cashQuickExamples={pl:["Przyjąć 250 na produkty","Wypłacić 50 na dostawę","Przyjąć 1000 depozyt","Przyjąć 50 na napoje"],
ru:["Принять 250 на продукты","Выдать 50 на доставку","Принять 1000 депозит","Принять 50 на напитки"],
en:["Accept 250 for groceries","Pay out 50 for delivery","Accept 1000 deposit","Accept 50 for drinks"],
uk:["Прийняти 250 на продукти","Видати 50 на доставку","Прийняти 1000 депозит","Прийняти 50 на напої"]};
function renderCashExamples(lang){
  const holder=$id('kasaQuickHolder'); if(!holder) return; holder.innerHTML='';
  const arr=cashQuickExamples[lang]||cashQuickExamples.pl;
  arr.forEach(txt=>{
    const btn=document.createElement('button'); btn.type='button'; btn.textContent=txt;
    btn.addEventListener('click',()=>{
      const numMatch=txt.match(/(-?\d+[.,]?\d*)/); const num=numMatch?asNum(numMatch[1]):0;
      const outRe=/(wyda|wypłac|pay out|видат|выда)/i; const isOut=outRe.test(txt);
      const note=txt.replace(/(-?\d+[.,]?\d*\s*(zł|pln|PLN|USD|EUR)?)/i,"").trim();
      addKasa(isOut?'wydanie':'przyjęcie', num, note||txt, 'quick');
    });
    holder.appendChild(btn);
  });
}

/* ==== UNIFIED BOOK ==== */
function bookRows(){
  const rows=[];
  (tx||[]).forEach(r=>{
    rows.push({
      date: toISO(getVal(r,["Data księgowania","date","Дата"]))||today(),
      source: 'bank',
      account: getVal(r,["ID konta","IBAN","account"])||'UNKNOWN',
      counterparty: getVal(r,["Kontrahent","Counterparty"])||'',
      desc: getVal(r,["Tytuł/Opis","Opis","title"])||'',
      amount: asNum(getVal(r,["Kwota","Kwота","amount","Kwota_raw"]))||0,
      currency: (getVal(r,["Waluta","currency"])||'PLN').toUpperCase(),
      type:'', no:'', doc_date:'', due:'', status: getVal(r,["Status transakcji","status"])||''
    });
  });
  (bills||[]).forEach(b=>{
    const amt = -Math.abs(asNum(getVal(b,["Kwota do zapłaty","Kwota","Kwота"]))||0);
    rows.push({
      date: toISO(getVal(b,["Data wystawienia","IssueDate"]))||toISO(getVal(b,["Termin płatności","Termin"]))||today(),
      source:'invoice',
      account:'',
      counterparty: getVal(b,["Dostawca","Supplier"])||'',
      desc: 'INVOICE',
      amount: amt,
      currency: (getVal(b,["Waluta","currency"])||'PLN').toUpperCase(),
      type:'INVOICE', no:getVal(b,["Numer faktury","Invoice number"])||'',
      doc_date: toISO(getVal(b,["Data wystawienia","IssueDate"]))||'',
      due: toISO(getVal(b,["Termin płatności","Termin"]))||'',
      status: getVal(b,["Status faktury","Status"])||''
    });
  });
  (kasa||[]).forEach(k=>{
    rows.push({
      date: k.date||today(), source:'cash', account:'KASA', counterparty:'', desc:k.comment||k.source||'',
      amount: (k.type==='wydanie'?-1:1)*Math.abs(k.amount||0), currency:'PLN', type:'CASH', no:'', doc_date:'', due:'', status:''
    });
  });
  return rows.sort((a,b)=> (a.date<b.date?-1: a.date>b.date?1:0));
}
function renderBook(){
  const tb=document.querySelector('#bookTable tbody'); if(!tb) return; tb.innerHTML='';
  const rows=bookRows();
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.source}</td><td>${r.account||'—'}</td><td>${r.counterparty||''}</td><td>${r.desc||''}</td><td>${fmtAmountRaw(r.amount)}</td><td>${r.currency}</td><td>${r.type||''}</td><td>${r.no||''}</td><td>${r.doc_date||''}</td><td>${r.due||''}</td><td>${r.status||''}</td>`;
    tb.appendChild(tr);
  });
}
function exportBookCSV(){
  const rows=bookRows();
  const head=['date','source','account','counterparty','description','amount','currency','doc_type','doc_no','doc_date','due_date','status'];
  const csv=[head.join(',')].concat(rows.map(r=>[
    r.date,r.source,r.account,(r.counterparty||'').replace(/,/g,' '),(r.desc||'').replace(/,/g,' '),
    (r.amount||0).toFixed(2),r.currency,r.type||'',r.no||'',r.doc_date||'',r.due||'',(r.status||'').replace(/,/g,' ')
  ].join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='otd_book.csv'; a.click();
}

/* ==== RENDER ==== */
function renderKasa(){
  const tb=document.querySelector('#kasaTable tbody'); if(!tb) return; tb.innerHTML='';
  kasa.forEach((k,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source||""}</td><td>${k.comment||""}</td>
                    <td class="actions">
                      <button data-act="edit" data-kind="kasa" data-id="${k.id}">✎</button>
                      <button data-act="del" data-kind="kasa" data-id="${k.id}">🗑</button>
                    </td>`;
    tb.appendChild(tr);
  });
}
function renderAccounts(){
  const tb=document.querySelector('#autoAcc tbody'); if(!tb) return; tb.innerHTML='';
  Object.values(accMeta).forEach(a=>{
    const bal=computeAccountBalance(a.id);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${a.id}</td>
      <td><select data-id="${a.id}" class="acc-type">
            <option ${a.type==="Biznes"?"selected":""}>Biznes</option>
            <option ${a.type==="Osobisty"?"selected":""}>Osobisty</option>
          </select></td>
      <td><select data-id="${a.id}" class="acc-cur">
            <option ${a.currency==="PLN"?"selected":""}>PLN</option>
            <option ${a.currency==="EUR"?"selected":""}>EUR</option>
            <option ${a.currency==="USD"?"selected":""}>USD</option>
          </select></td>
      <td>${bal.toFixed(2)}</td>
      <td><input type="number" step="0.01" value="${a.start||0}" class="acc-start" data-id="${a.id}"/></td>
      <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include?"checked":""}/></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll(".acc-type").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].type=e.target.value;saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-cur").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].currency=e.target.value;saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-start").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].start=asNum(e.target.value);saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-include").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].include=e.target.checked;saveLocal();render();pushState();}));
}
function render(){
  // KPIs
  const dueToday=(bills||[]).filter(r=>{
    const s=String(getVal(r,["Status faktury","Status фактуры","Status"])||"").toLowerCase();
    return ["do zapłaty","przeterminowane","к оплате","просрочено","to pay"].includes(s) &&
           toISO(getVal(r,["Termin płatności","Termin","Termin платності"]))===today();
  }).length;
  const unmatch=(tx||[]).filter(r=> String(getVal(r,["Status transakcji","status"])||"").toLowerCase()!=="sparowane").length;
  $id('kpiDue')&&( $id('kpiDue').textContent = dueToday );
  $id('kpiUnmatch')&&( $id('kpiUnmatch').textContent = unmatch );
  const bankPLN=bankAvailablePLN(); $id('kpiBank')&&( $id('kpiBank').textContent = bankPLN.toFixed(2) );
  const kas=kasaBalance(); $id('kpiCash')&&( $id('kpiCash').textContent = kas.toFixed(2) );
  const avail=availableTotal(); $id('kpiAvail')&&( $id('kpiAvail').textContent = avail.toFixed(2) );
  const sumDue=(bills||[]).filter(r=>
    String((getVal(r,["Waluta"])||"").toUpperCase())==="PLN" &&
    toISO(getVal(r,["Termin płatności","Termin","Termin платності"]))<=today() &&
    ["do zapłaty","przeterminowane","к оплате","просрочено"].includes(String(getVal(r,["Status faktury","Status"])||"").toLowerCase())
  ).reduce((s,r)=> s+asNum(getVal(r,["Kwota do zapłaty","Kwota"])||0),0);
  $id('kpiGap')&&( $id('kpiGap').textContent = Math.max(0,sumDue-avail).toFixed(2) );

  // TX table
  const txBody=document.querySelector('#txTable tbody'); if(txBody){
    txBody.innerHTML='';
    (tx||[]).forEach(r=>{
      const id=getVal(r,["ID transakcji","ID","id"])||("noid-"+Math.random());
      const curStr = getVal(r,["Waluta","currency"])||''; const cur = detectCurrency(curStr);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${toISO(getVal(r,["Data księgowania","date","Дата"]))}</td>
        <td>${getVal(r,["ID konta","IBAN","account"])||"—"}</td>
        <td>${getVal(r,["Kontrahent","Counterparty"])||""}</td>
        <td>${getVal(r,["Tytuł/Opis","Opis","title"])||""}</td>
        <td>${fmtAmountRaw(getVal(r,["Kwota","Kwота","amount","Kwota_raw"]))}</td>
        <td>${cur}</td>
        <td>${getVal(r,["Status transakcji","status"])||""}</td>
        <td class="actions">
          <button data-act="edit" data-kind="tx" data-id="${id}">✎</button>
          <button data-act="del" data-kind="tx" data-id="${id}">🗑</button>
        </td>`;
      txBody.appendChild(tr);
    });
  }

  // Bills
  const billBody=document.querySelector('#billTable tbody'); if(billBody){
    billBody.innerHTML='';
    (bills||[]).forEach(r=>{
      const s=String(getVal(r,["Status faktury","Status фактуры","Status"])||"").toLowerCase();
      const cls=(s.includes('przetermin')||s.includes('проср'))?'overdue':'due';
      const cand=getVal(r,["Kandydat (AI)"])||"";
      const score=getVal(r,["AI score"])||"";
      const id=getVal(r,["Numer faktury","Numer фактуры","Invoice number"])||("noinv-"+Math.random());
      const cur = detectCurrency(getVal(r,["Waluta","currency"])||'');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${toISO(getVal(r,["Termin płatności","Termin","Termin платності"])||"")}</td>
        <td>${getVal(r,["Numer faktury","Numer фактуры","Invoice number"])||""}</td>
        <td>${getVal(r,["Dostawca","Supplier"])||""}</td>
        <td>${getVal(r,["Kwota do zapłaty","Kwота","Kwota"])||""}</td>
        <td>${cur}</td>
        <td><span class="badge ${cls}">${getVal(r,["Status faktury","Status фактуры","Status"])||""}</span></td>
        <td>${cand?('<span class="badge cand">'+cand+'</span>'):'—'}</td>
        <td>${score?('<span class="badge ai">'+score+'</span>'):'—'}</td>
        <td class="actions">
          ${cand?('<button class="btn secondary btn-accept" data-invid="'+id+'">OK</button>'):''}
          <button data-act="edit" data-kind="bill" data-id="${id}">✎</button>
          <button data-act="del" data-kind="bill" data-id="${id}">🗑</button>
        </td>`;
      billBody.appendChild(tr);
    });
    document.querySelectorAll(".btn-accept").forEach(b=> b.addEventListener('click',()=>acceptOne(b.getAttribute('data-invid'))));
  }

  renderMinPay(); renderForecast(); renderAccounts(); renderKasa(); renderBook(); updateSubUI(); gateAccess();
}

/* ==== PLAN / FORECAST / MINPAY ==== */
function toDueList(mode){
  const t=today(); const excl=$id('excludeBlacklist')?.checked||false;
  return bills.filter(r=>{
    const s=String(getVal(r,["Status faktury","Status фактуры","Status"])||"").toLowerCase();
    if(!["do zapłaty","przeterminowane","к оплате","просрочено","to pay"].includes(s)) return false;
    const d=toISO(getVal(r,["Termin płatności","Termin","Termin платності"])); if(!d) return false;
    if(mode==='today') return d===t;
    if(mode==='7d'){ const dd=new Date(d), tt=new Date(t); return (dd-tt)/86400000 <= 7; }
    return true;
  }).filter(r=>{
    if(String((getVal(r,["Waluta"])||"").toUpperCase())!=="PLN") return false;
    if(excl){
      const bl=(localStorage.getItem('blacklist')||"").toLowerCase();
      const nm=(getVal(r,["Dostawca","Supplier"])||"").toLowerCase();
      if(bl && bl.split(",").some(x=> nm.includes(x.trim()))) return false;
    }
    return true;
  });
}
function buildPlan(){
  const mode=$id('planFilter')?.value||'7d';
  const cand=toDueList(mode).sort((a,b)=>{
    const da=new Date(toISO(getVal(a,["Termin płatności","Termin","Termin платності"])||today()));
    const db=new Date(toISO(getVal(b,["Termin płatności","Termin","Termin платності"])||today()));
    const lateA=da<new Date(today()), lateB=db<new Date(today());
    if(lateA!==lateB) return lateB-lateA;
    return asNum(getVal(b,["Kwota do zapłaty","Kwota"])) - asNum(getVal(a,["Kwota do zapłaty","Kwota"]));
  });
  let left=availableTotal(); const plan=[];
  for(const r of cand){
    const amt=asNum(getVal(r,["Kwota do zapłaty","Kwota"])||0);
    if(amt<=left){ plan.push({r,amt,reason:(toISO(getVal(r,["Termin płatności","Termin"])||today())<today()?"просрочка":"срок")}); left-=amt; }
  }
  return {plan,left,avail:availableTotal()};
}
function renderPlan(){
  const p=buildPlan(); const tb=document.querySelector('#planTable tbody'); if(!tb) return; tb.innerHTML='';
  p.plan.forEach((x,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${getVal(x.r,["Numer faktury","Numer фактуры"])||""}</td><td>${getVal(x.r,["Dostawca","Supplier"])||""}</td><td>${toISO(getVal(x.r,["Termin płatności","Termin"])||"")}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
    tb.appendChild(tr);
  });
  const pm=$id('planMeta'); if(pm) pm.textContent = p.plan.length?`Wydamy ${(p.avail-p.left).toFixed(2)} z ${p.avail.toFixed(2)} PLN. Zostanie ${p.left.toFixed(2)} PLN.`:"Plan pusty lub brak środków.";
}
function computeMinPay(){
  const t=today(); const pct=asNum(localStorage.getItem('penaltyPct')||0.05)/100.0;
  const cand=bills.filter(r=>
    String((getVal(r,["Waluta"])||"").toUpperCase())==="PLN" &&
    toISO(getVal(r,["Termin płatności","Termin"])||"")<=t &&
    ["do zapłaty","przeterminowane","к оплате","просрочено"].includes(String(getVal(r,["Status faktury","Status"])||"").toLowerCase())
  ).map(r=>({r,amt:asNum(getVal(r,["Kwota do zapłaty","Kwota"])||0),risk:asNum(getVal(r,["Kwota do zapłaty","Kwota"])||0)*pct}))
   .sort((a,b)=> b.risk-a.risk || b.amt-a.amt);
  return cand[0]||null;
}
function renderMinPay(){
  const m=computeMinPay(); const el=$id('minPayBox'); if(!el) return;
  if(!m){ el.textContent='—'; return; }
  el.textContent = `Оплатить ${getVal(m.r,["Numer faktуры","Numer faktury","Numer фактуры"])||getVal(m.r,["Numer faktury"])} (${getVal(m.r,["Dostawca","Supplier"])} ) на ${m.amt.toFixed(2)} PLN. Штраф/день ~ ${m.risk.toFixed(2)} PLN.`;
}
function renderForecast(){
  const t=new Date(today());
  const list=toDueList("7d").map(r=>({date:new Date(toISO(getVal(r,["Termin płatności","Termin"]))), amt:asNum(getVal(r,["Kwota do zapłaty","Kwota"])||0)}));
  const days=[...Array(7)].map((_,i)=> new Date(t.getTime()+i*86400000));
  let left=availableTotal(); const out=days.map(d=>({d,due:0,after:0}));
  list.forEach(x=>{ const idx=Math.min(6, Math.max(0, Math.floor((x.date - t)/86400000))); out[idx].due += x.amt; });
  out.forEach(o=>{ left-=o.due; o.after=left; });
  const wrap=$id('forecastBars'); if(!wrap) return; wrap.innerHTML='';
  out.forEach(o=>{
    const div=document.createElement('div'); div.className='bar'+(o.after<0?' neg':'');
    const h=document.createElement('div'); h.className='h'; h.style.height=(Math.min(120,Math.abs(o.after)/100)*0.8+18)+'px';
    div.innerHTML=`<small>${o.d.toISOString().slice(5,10)}</small>`; div.appendChild(h);
    const v=document.createElement('div'); v.textContent = (o.after<0?'-':'')+Math.abs(o.after).toFixed(0)+' PLN'; div.appendChild(v);
    wrap.appendChild(div);
  });
  const firstNeg=out.find(x=>x.after<0); const meta=$id('forecastMeta');
  if(meta) meta.textContent = firstNeg?`Гэп через ${out.indexOf(firstNeg)+1} дн.: не хватает ${Math.abs(firstNeg.after).toFixed(2)} PLN.`:"На 7 дней хватает кассы.";
}

/* ==== ACCEPT ONE ==== */
function acceptOne(id){
  const b=(bills||[]).find(x=> (getVal(x,["Numer faktury","Numer фактуры","Invoice number"])||"")===id);
  if(!b) return;
  const t=(tx||[]).find(x=> (getVal(x,["ID transakcji","ID","id"])||"")=== (getVal(b,["Kandydat (AI)"])||""));
  if(!t) return;
  t["Status transakcji"]="Sparowane"; t["Powiązana faktura (ID)"]=getVal(b,["Numer faktury","Numer фактуры"]);
  b["Status faktury"]="Opłacone"; b["Data płatności"]=today(); b["Kandydat (AI)"]=b["AI score"]="";
  render(); saveLocal(); pushState();
}

/* ==== KASA CRUD ==== */
function loadKasa(){ try{kasa=JSON.parse(localStorage.getItem('kasa')||'[]');}catch(e){kasa=[]} }
function addKasa(type,amount,comment,source){
  if(amount==null||isNaN(amount)) return alert("Сумма некорректна");
  kasa.push({id:Date.now(),date:today(),type,amount:Number(amount),comment:comment||"",source:source||"ручной"});
  saveLocal(); render(); pushState();
}
function editRow(kind,id){
  if(kind==='kasa'){
    const idx=kasa.findIndex(x=> String(x.id)===String(id)); if(idx<0) return;
    const k=kasa[idx];
    const n=prompt("Сумма:", k.amount); if(n===null) return;
    const c=prompt("Комментарий:", k.comment||""); if(c===null) return;
    kasa[idx].amount=asNum(n); kasa[idx].comment=c; saveLocal(); render(); pushState(); return;
  }
  if(kind==='tx'){
    const idx=tx.findIndex(x=> (getVal(x,["ID transakcji","ID","id"])||"")===String(id)); if(idx<0) return;
    const r=tx[idx];
    const d=prompt("Дата (YYYY-MM-DD):", toISO(getVal(r,["Data księgowania"])||today())); if(d===null) return;
    const a=prompt("Сумма:", getVal(r,["Kwota","Kwota_raw","amount"])||""); if(a===null) return;
    r["Data księgowania"]=toISO(d)||today(); r["Kwota"]=asNum(a).toFixed(2); r["Waluta"]= detectCurrency(getVal(r,["Waluta"])||''); saveLocal(); render(); pushState(); return;
  }
  if(kind==='bill'){
    const idx=bills.findIndex(x=> (getVal(x,["Numer faktury","Numer фактуры","Invoice number"])||"")===String(id)); if(idx<0) return;
    const r=bills[idx];
    const due=prompt("Срок (YYYY-MM-DD):", toISO(getVal(r,["Termin płatności","Termin"])||today())); if(due===null) return;
    const amt=prompt("Сумма к оплате:", getVal(r,["Kwota do zapłaty","Kwota"])||""); if(amt===null) return;
    r["Termin płatności"]=toISO(due)||today(); r["Kwota do zapłaty"]=asNum(amt).toFixed(2); r["Waluta"]= detectCurrency(getVal(r,["Waluta"])||''); saveLocal(); render(); pushState(); return;
  }
}
function delRow(kind,id){
  if(kind==='kasa'){ kasa = kasa.filter(x=> String(x.id)!==String(id)); saveLocal(); render(); pushState(); return; }
  if(kind==='tx'){ tx = tx.filter(x=> (getVal(x,["ID transakcji","ID","id"])||"")!==String(id)); saveLocal(); render(); pushState(); return; }
  if(kind==='bill'){ bills = bills.filter(x=> (getVal(x,["Numer faktury","Numer фактуры","Invoice number"])||"")!==String(id)); saveLocal(); render(); pushState(); return; }
}

/* ==== EVENTS ==== */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const act=btn.getAttribute('data-act'); if(!act) return;
  const kind=btn.getAttribute('data-kind'), id=btn.getAttribute('data-id');
  if(act==='edit') editRow(kind,id);
  if(act==='del') delRow(kind,id);
});

function thumb(el,file){ const img=el; if(!img) return; img.src=URL.createObjectURL(file); img.style.display='inline-block'; }

async function ocrBankFiles(files){
  for(const f of files){
    try{
      thumb($id('txLastThumb'), f);
      const text = await recognizeImage(f);
      const rows = parseBankOCR(text);
      if(rows.length){ tx = tx.concat(rows); }
    }catch(e){ console.warn('OCR bank error', e); }
  }
  inferAccounts(); render(); saveLocal(); pushState();
}
async function ocrInvoiceFiles(files){
  for(const f of files){
    try{
      const text = await recognizeImage(f);
      const rows = parseInvoiceOCR(text);
      if(rows.length){ bills = bills.concat(rows); }
    }catch(e){ console.warn('OCR invoice error', e); }
  }
  render(); saveLocal(); pushState();
}

/* ==== DOM READY ==== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Lang bar
  document.querySelectorAll('#langBarMain button').forEach(b=>{
    b.addEventListener('click',()=> applyLang(b.dataset.lang));
  });
  applyLang(localStorage.getItem('otd_lang')||'pl');

  // Tabs (with gate)
  document.querySelectorAll('.tabs .tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      if(t.classList.contains('disabled')) { document.querySelector('[data-sec=ustawienia]')?.click(); return; }
      document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      t.classList.add('active'); const sec=t.dataset.sec; if(sec) $id(sec)?.classList.add('active');
      render();
    });
  });

  // Buttons
  $id('runAI')?.addEventListener('click', runAI);
  $id('acceptSafe')?.addEventListener('click', acceptSafe);
  $id('makePlan')?.addEventListener('click', renderPlan);
  $id('applyPlan')?.addEventListener('click', renderPlan);
  $id('applyMinPay')?.addEventListener('click', ()=>{ const m=computeMinPay(); if(!m) return alert('Нет кандидатов'); m.r["Status faktury"]="Opłacone"; m.r["Data płatności"]=today(); render(); saveLocal(); pushState(); });
  $id('exportPDF')?.addEventListener('click',()=>window.print());
  $id('syncNow')?.addEventListener('click', fetchSources);
  $id('exportBook')?.addEventListener('click', exportBookCSV);

  // File/url
  $id('txFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; tx=parseCSV(await f.text()); inferAccounts(); render(); saveLocal(); pushState(); });
  $id('txImage')?.addEventListener('change', async e=>{ const files=[...e.target.files]; if(!files.length) return; await ocrBankFiles(files); });
  $id('billFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; bills=parseCSV(await f.text()); render(); saveLocal(); pushState(); });
  $id('billImage')?.addEventListener('change', async e=>{ const files=[...e.target.files]; if(!files.length) return; await ocrInvoiceFiles(files); });
  $id('saveTxUrl')?.addEventListener('click',()=>{ const v=$id('txUrl')?.value.trim()||""; localStorage.setItem('txUrl',v); alert('Zapisano URL wyciągu'); scheduleAutosync(); });

  // Cash quick & ops
  $id('addIn')?.addEventListener('click',()=> addKasa('przyjęcie', asNum($id('quickAmt')?.value||0), $id('quickNote')?.value, 'manual'));
  $id('addOut')?.addEventListener('click',()=> addKasa('wydanie', asNum($id('quickAmt')?.value||0), $id('quickNote')?.value, 'manual'));
  $id('cashClose')?.addEventListener('click',()=>{ const a=prompt('Итог в кассе (PLN):', kasaBalance().toFixed(2)); if(a===null) return; addKasa('zamknięcie', asNum(a), 'close', 'manual'); });
  $id('q50')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+50).toFixed(2); });
  $id('q100')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+100).toFixed(2); });
  $id('q200')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+200).toFixed(2); });

  // Speech
  const micBtn=$id('micBtn');
  if(micBtn && (window.SpeechRecognition||window.webkitSpeechRecognition)){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition; const rec=new SR();
    rec.continuous=false; rec.interimResults=false; rec.maxAlternatives=1;
    rec.lang=localStorage.getItem('speechLang')||'pl-PL';
    rec.onstart=()=>{ micBtn.classList.add('on'); $id('micStatus')&&( $id('micStatus').textContent=`🎙️ ... (${rec.lang})` ); };
    rec.onend=()=>{ micBtn.classList.remove('on'); };
    rec.onresult=(e)=>{
      const text=(e.results[0][0].transcript||"").toLowerCase();
      $id('micStatus')&&( $id('micStatus').textContent='🎙️ '+text );
      const numMatch=text.match(/(\d+[.,]?\d*)\s*(zł|pln|eur|usd)?/); const num=numMatch?numMatch[1]:null;
      const isOut=/(wyda|minus|wydat|выда|минус|расход|видат)/.test(text);
      const note=text.replace(/(\d+[.,]?\d*\s*(zł|pln|eur|usd)?)/,"").trim();
      if(!num){ $id('micStatus')&&( $id('micStatus').textContent='🎙️ сумма не найдена'); return; }
      addKasa(isOut?'wydanie':'przyjęcie', asNum(num), note||'voice', 'voice');
    };
    $id('speechLang')?.addEventListener('change',e=>{ rec.lang=e.target.value; localStorage.setItem('speechLang', rec.lang); });
    micBtn.addEventListener('click',()=>{ try{ rec.start(); }catch(e){ $id('micStatus')&&( $id('micStatus').textContent='🎙️ не смог запустить: '+e.message ); } });
  }

  // Settings
  $id('applySettings')?.addEventListener('click',()=>{
    localStorage.setItem('cashPLN',$id('cashPLN')?.value||"0");
    localStorage.setItem('penaltyPct',$id('penaltyPct')?.value||"0.05");
    localStorage.setItem('intervalMin',$id('intervalMin')?.value||"10");
    localStorage.setItem('rateEUR',$id('rateEUR')?.value||"4.30");
    localStorage.setItem('rateUSD',$id('rateUSD')?.value||"3.95");
    localStorage.setItem('blacklist',$id('blacklist')?.value||"");
    localStorage.setItem('autoCash', ($id('autoCash')?.checked?"1":"0"));
    $id('modeCash')&&( $id('modeCash').textContent = (localStorage.getItem('otd_lang')||'pl')==='ru' ? ("Режим: "+($id('autoCash')?.checked?"авто":"ручной")) : ("Mode: "+($id('autoCash')?.checked?"auto":"manual")) );
    render(); saveLocal(); scheduleAutosync(); pushState();
  });
  $id('exportCfg')?.addEventListener('click',()=>{
    const cfg=stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k),m),{});
    const blob=new Blob([JSON.stringify(cfg,null,2)],{type:"application/json"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='onetapday_settings.json'; a.click();
  });
  $id('importCfg')?.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return; const cfg=JSON.parse(await f.text());
    Object.entries(cfg).forEach(([k,v])=> localStorage.setItem(k, v));
    location.reload();
  });
  $id('clearAll')?.addEventListener('click',()=>{
    if(!confirm('Очистить локальную историю и настройки?')) return;
    ['kasa','tx_manual_import','bills_manual_import','accMeta'].forEach(k=> localStorage.removeItem(k));
    loadLocal(); inferAccounts(); render(); pushState();
  });

  // Demo/Sub controls
  $id('startDemo')?.addEventListener('click',()=>{
    localStorage.setItem(DEMO_START, new Date().toISOString()); updateSubUI(); gateAccess();
  });
  $id('endDemo')?.addEventListener('click',()=>{
    localStorage.removeItem(DEMO_START); updateSubUI(); gateAccess();
  });
  $id('payNow')?.addEventListener('click', async ()=>{
    const link = localStorage.getItem('stripe_link')||localStorage.getItem('stripePaymentLink');
    if(link){ location.href=link; return; }
    try{
      const r=await fetch('/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({demo:true})});
      const j=await r.json(); if(j?.url) { location.href=j.url; return; }
      alert('No Stripe URL from backend');
    }catch(e){ alert('Stripe error: '+(e?.message||e)); }
  });

  // INIT
  loadLocal(); loadKasa();
  $id('txUrl')&&( $id('txUrl').value = localStorage.getItem('txUrl')||"" );
  ['cashPLN','penaltyPct','intervalMin','rateEUR','rateUSD','blacklist'].forEach(k=>{ if($id(k)) $id(k).value = localStorage.getItem(k)|| $id(k).value || ""; });
  if($id('autoCash')) $id('autoCash').checked = localStorage.getItem('autoCash')==='1';
  if($id('speechLang') && localStorage.getItem('speechLang')) $id('speechLang').value = localStorage.getItem('speechLang');

  inferAccounts();
  applyLang(localStorage.getItem('otd_lang')||'pl');
  render();
  scheduleAutosync();

  // Remote pull once, then push snapshot
  await pullState(); loadLocal(); inferAccounts(); render();
  pushState();

  // Save on unload
  window.addEventListener('beforeunload', ()=>{
    if(!REMOTE_OK) return;
    try{
      const email=localStorage.getItem(USER_KEY)||"";
      if(!email) return;
      const body={
        email,
        tx: JSON.parse(localStorage.getItem('tx_manual_import')||'[]'),
        bills: JSON.parse(localStorage.getItem('bills_manual_import')||'[]'),
        kasa: JSON.parse(localStorage.getItem('kasa')||'[]'),
        accMeta: JSON.parse(localStorage.getItem('accMeta')||'{}'),
        settings: stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k), m), {})
      };
      const blob=new Blob([JSON.stringify(body)],{type:'application/json'});
      navigator.sendBeacon && navigator.sendBeacon(`${API_BASE}/state/save`, blob);
    }catch(e){}
  });
});
</script>
</body>
</html>
