<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay ‚Äì AI Ksiƒôgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
      --pos: #a8e8c7;
      --neg: #ff8a8a;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab { padding: 8px 12px; border-radius: 10px; background: #0f1214; border: 1px solid #20262b; color: #cfe6d7; cursor: pointer; font-weight: 600; }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn { appearance: none; border: 0; border-radius: 10px; background: var(--accent); color: #08110b; padding: 10px 14px; font-weight: 700; cursor: pointer; }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill { display: inline-block; padding: 3px 9px; border-radius: 999px; background: #0f1214; border: 1px solid #20262b; color: #9aa3a9; font-size: 12px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number], select { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; color: #e6edf3; padding: 9px; }
    .right { margin-left: auto; }
    .mic { border-radius: 50%; width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; border: 2px solid #2a3136; background: #0f1214; cursor: pointer; }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    .amt-pos { color: var(--pos); font-weight:700; }
    .amt-neg { color: var(--neg); font-weight:700; }
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button { padding: 4px 8px; border-radius: 999px; border: 1px solid #20262b; background: #0f1214; color: #9aa3a9; font-size: 12px; cursor: pointer; }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
    @media (max-width: 1080px) { .cards { grid-template-columns: 1fr 1fr; } .grid2 { grid-template-columns: 1fr; } }
    @media print { .tabs, .btn, .row input, .toast { display: none !important; } body { background: #fff; color: #000; } .card { background: #fff; border: 1px solid #999; } .wrap { max-width: 1000px; } }
    .kasa-quick { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
    .kasa-quick button { padding:6px 10px; border-radius:8px; border:1px solid #2a3136; background:#0f1214; color:#e6edf3; cursor:pointer; font-size:13px; }
    /* –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö */
    td.actions > button { margin-right:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay ‚Äî AI Ksiƒôgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">–ü—É–ª—å—Ç</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciƒÖg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">–°—á–µ—Ç–∞</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (–Ω–∞–ª)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="pulpit" class="section active">
      <div class="cards">
        <div class="card"><div class="muted" data-i="kpi_due_today">–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è</div><div id="kpiDue" class="kpi">0</div></div>
        <div class="card"><div class="muted" data-i="kpi_unmatched">–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div><div id="kpiUnmatch" class="kpi">0</div></div>
        <div class="card"><div class="muted" data-i="kpi_banks">–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ</div><div id="kpiBank" class="kpi">0</div></div>
        <div class="card"><div class="muted" data-i="kpi_cash">–ö–∞—Å—Å–∞ (–Ω–∞–ª)</div><div id="kpiCash" class="kpi">0</div></div>
        <div class="card"><div class="muted" data-i="kpi_total">–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ</div><div id="kpiAvail" class="kpi">0</div></div>
        <div class="card"><div class="muted" data-i="kpi_gap_today">–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è</div><div id="kpiGap" class="kpi">0</div></div>
      </div>
      <div class="row" style="margin:10px 0;">
        <button id="syncNow" class="btn" data-i="btn_sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
        <button id="runAI" class="btn secondary" data-i="btn_ai_match">–ò–ò-—Å–≤–µ—Ä–∫–∞</button>
        <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã</button>
        <button id="exportPDF" class="btn secondary" data-i="btn_pdf">PDF –æ—Ç—á—ë—Ç</button>
        <span id="lastSync" class="pill">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ‚Äî</span>
        <span class="right pill" id="modeCash">–†–µ–∂–∏–º: –∞–≤—Ç–æ</span>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight:700;" data-i="minpay_title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)</div>
          <div id="minPayBox" class="muted">‚Äî</div>
          <div class="row" style="margin-top:6px;">
            <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight:700;" data-i="forecast_7d">–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast7d_note">–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.</div>
          <div id="forecastBars" class="barwrap"></div>
          <div id="forecastMeta" class="muted" style="margin-top:6px;">‚Äî</div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight:700;" data-i="forecast_30d">–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast30_note">–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.</div>
          <div id="forecast30Table"></div>
        </div>
        <div class="card">
          <div style="font-weight:700;" data-i="month_summary_title">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</div>
          <div id="monthSummary" class="muted">‚Äî</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="row">
          <div style="font-weight:700;" data-i="plan_title">–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É</div>
          <div class="right">
            <span data-i="filter_label">–§–∏–ª—å—Ç—Ä:</span>
            <select id="planFilter">
              <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
              <option value="all" data-i="filter_all">–í—Å–µ</option>
            </select>
          </div>
          <label style="margin-left:10px;"><input type="checkbox" id="excludeBlacklist" /> <span data-i="exclude_blacklist">–ò—Å–∫–ª—é—á–∞—Ç—å blacklist</span></label>
        </div>
        <div class="row" style="margin:8px 0;">
          <button id="makePlan" class="btn secondary" data-i="btn_make_plan">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span id="planMeta" class="pill">‚Äî</span>
        </div>
        <table id="planTable">
          <thead><tr>
            <th>#</th><th data-i="plan_th_invoice">–§–∞–∫—Ç—É—Ä–∞</th><th data-i="plan_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th data-i="plan_th_due">–°—Ä–æ–∫</th><th data-i="plan_th_amount">–°—É–º–º–∞</th><th data-i="plan_th_reason">–ü—Ä–∏—á–∏–Ω–∞</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- WyciƒÖg -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display:none;" />
          <span data-i="upload_statement">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)</span>
        </label>

        <!-- –î–û–ë–ê–í–õ–ï–ù–û: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤—ã–ø–∏—Å–∫–∏ -->
        <label class="btn ghost">
          <input id="txImage" type="file" accept="image/*" multiple style="display:none;" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω –≤—ã–ø–∏—Å–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</span>
        </label>
        <img id="txLastThumb" class="thumb" style="display:none;" />

        <input id="txUrl" type="text" placeholder="URL CSV wyciƒÖga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <span class="muted">–ö–æ–ª–æ–Ω–∫–∏: Data ksiƒôgowania, ID transakcji, ID konta (–∏–ª–∏ IBAN), Kontrahent, Tytu≈Ç/Opis, Kwota(¬±), Waluta, –°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, Saldo po operacji?</span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">–î–∞—Ç–∞</th><th data-i="th_account">–°—á—ë—Ç</th><th data-i="th_counterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th><th data-i="th_desc">–û–ø–∏—Å–∞–Ω–∏–µ</th><th data-i="th_amount">–°—É–º–º–∞</th><th data-i="th_currency">–í–∞–ª—é—Ç–∞</th><th data-i="th_status">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Faktury -->
    <div id="faktury" class="section">
      <div class="row" style="align-items:center; margin-bottom:8px;">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display:none" />
          <span data-i="upload_invoices">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)</span>
        </label>

        <!-- –î–û–ë–ê–í–õ–ï–ù–û: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ —Ñ–∞–∫—Ç—É—Ä -->
        <label class="btn ghost">
          <input id="billImage" type="file" accept="image/*" multiple style="display:none" />
          <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Ñ–∞–∫—Ç—É—Ä—ã</span>
        </label>
        <span class="muted" style="margin-left:12px;">–ó–¥–µ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –Ω–æ–º–µ—Ä–∞ —Ñ–∞–∫—Ç—É—Ä, —Å—É–º–º—ã –∏ –¥–∞—Ç—ã.</span>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th>–°—Ä–æ–∫</th><th>‚Ññ</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–°—É–º–º–∞</th><th>–í–∞–ª—é—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–∞–Ω–¥–∏–¥–∞—Ç</th><th>Score</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Konta -->
    <div id="konta" class="section">
      <div class="card">
        <div style="font-weight:700">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏</div>
        <div class="muted">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π –≤–∞–ª—é—Ç—É, —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–∞–ª—å–¥–æ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–∞—Å—á—ë—Ç.</div>
        <table id="autoAcc">
          <thead><tr><th>–°—á—ë—Ç</th><th>–¢–∏–ø</th><th>–í–∞–ª—é—Ç–∞</th><th>–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)</th><th>–°—Ç–∞—Ä—Ç</th><th>–í —Ä–∞—Å—á—ë—Ç</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Kasa -->
    <div id="kasa" class="section">
      <div class="card">
        <div style="font-weight:700">–ö–∞—Å—Å–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
        <div class="muted">–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–∞—Å—Å–∞ + –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏</div>
        <div id="kasaQuickHolder" class="kasa-quick" aria-hidden="false"></div>
        <div class="row" style="margin-top:8px; align-items:center;">
          <input id="quickAmt" type="number" step="0.01" placeholder="–°—É–º–º–∞" style="width:120px" />
          <input id="quickNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="width:300px" />
          <button id="addIn" class="btn secondary">+ –ü—Ä–∏—ë–º</button>
          <button id="addOut" class="btn secondary">‚àí –í—ã–¥–∞—á–∞</button>
          <button id="q50" class="btn ghost">+50</button>
          <button id="q100" class="btn ghost">+100</button>
          <button id="q200" class="btn ghost">+200</button>
          <div style="margin-left:12px;"><button id="cashClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button></div>
        </div>

        <div style="margin-top:8px;">
          <label>–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:
            <select id="speechLang">
              <option value="pl-PL">PL</option>
              <option value="ru-RU">RU</option>
              <option value="en-US">EN</option>
              <option value="uk-UA">UK</option> <!-- –î–û–ë–ê–í–õ–ï–ù–û -->
            </select>
          </label>
          <button id="micBtn" class="mic" title="–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–∞—Å—Å–∞">üé§</button>
          <span id="micStatus" class="muted" style="margin-left:8px;">‚Äî</span>
        </div>

        <div style="margin-top:12px;">
          <input id="cashPhoto" type="file" accept="image/*" style="display:inline-block" />
          <span class="muted">–°–∫–∞–Ω —á–µ–∫–∞/–≤—ã–ø–∏—Å–∫–∏ ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.</span>
        </div>

        <table id="kasaTable" style="margin-top:12px">
          <thead><tr><th>#</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ustawienia -->
    <div id="ustawienia" class="section">
      <div class="card">
        <div style="font-weight:700">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px;">
          <div>
            <label>Manual available cash today (PLN): <input id="cashPLN" type="text" /></label><br/>
            <label>–ü–µ–Ω—è, %/–¥–µ–Ω—å: <input id="penaltyPct" type="text" /></label><br/>
            <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω: <input id="intervalMin" type="text" /></label>
          </div>
          <div>
            <label>rateEUR: <input id="rateEUR" type="text" /></label><br/>
            <label>rateUSD: <input id="rateUSD" type="text" /></label><br/>
            <label>Blacklist (comma): <input id="blacklist" type="text" /></label><br/>
            <label><input id="autoCash" type="checkbox" /> –ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å–∞</label>
          </div>
        </div>
        <div style="margin-top:10px;">
          <button id="applySettings" class="btn secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="exportCfg" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <label class="btn ghost">–ò–º–ø–æ—Ä—Ç <input id="importCfg" type="file" style="display:none" /></label>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä
    const $id = (id) => document.getElementById(id);

    // i18n –∫–∞—Ä—Ç–∞ ‚Äî –æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è, –∫–ª—é—á–∏ –ù–ï —É–¥–∞–ª—è–ª
    const M = {
      ru: {
        tab_dashboard: "–ü—É–ª—å—Ç", tab_statement: "–í—ã–ø–∏—Å–∫–∞", tab_invoices: "–§–∞–∫—Ç—É—Ä—ã", tab_accounts: "–°—á–µ—Ç–∞", tab_cash: "–ö–∞—Å–∞", tab_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        kpi_due_today: "–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è", kpi_unmatched: "–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", kpi_banks: "–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ", kpi_cash: "–ö–∞—Å—Å–∞ (–Ω–∞–ª)", kpi_total: "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ", kpi_gap_today: "–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è",
        btn_sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", btn_ai_match: "–ò–ò-—Å–≤–µ—Ä–∫–∞", btn_accept_safe: "–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã", btn_pdf: "PDF –æ—Ç—á—ë—Ç",
        minpay_title: "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)", btn_apply_minpay: "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ",
        forecast_7d: "–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π", forecast7d_note: "–°—á–∏—Ç–∞–µ—Ç PLN-—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.",
        forecast_30d: "–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π", forecast30_note: "–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.",
        month_summary_title: "–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞",
        plan_title: "–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É", filter_label: "–§–∏–ª—å—Ç—Ä:", filter_today: "–°–µ–≥–æ–¥–Ω—è", filter_7d: "7 –¥–Ω–µ–π", filter_all: "–í—Å–µ", exclude_blacklist: "–ò—Å–∫–ª—é—á–∞—Ç—å blacklist",
        btn_make_plan: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", btn_apply_plan: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
        plan_th_invoice: "–§–∞–∫—Ç—É—Ä–∞", plan_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", plan_th_due: "–°—Ä–æ–∫", plan_th_amount: "–°—É–º–º–∞", plan_th_reason: "–ü—Ä–∏—á–∏–Ω–∞",
        upload_statement: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)", save_url: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL",
        th_date: "–î–∞—Ç–∞", th_account: "–°—á—ë—Ç", th_counterparty: "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc: "–û–ø–∏—Å–∞–Ω–∏–µ", th_amount: "–°—É–º–º–∞", th_currency: "–í–∞–ª—é—Ç–∞", th_status: "–°—Ç–∞—Ç—É—Å",
        upload_invoices: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)",
        inv_th_due: "–°—Ä–æ–∫", inv_th_number: "‚Ññ", inv_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", inv_th_amount: "–°—É–º–º–∞", inv_th_currency: "–í–∞–ª—é—Ç–∞", inv_th_status: "–°—Ç–∞—Ç—É—Å", inv_th_candidate: "–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score: "Score", inv_th_action: "–î–µ–π—Å—Ç–≤–∏–µ",
        auto_accounts_title: "–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)",
        auto_accounts_desc: "–ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.",
        acc_th_account: "–°—á—ë—Ç", acc_th_type: "–¢–∏–ø", acc_th_currency: "–í–∞–ª—é—Ç–∞", acc_th_balance_calc: "–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)", acc_th_start_balance: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å", acc_th_include: "–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞",
        btn_add_in: "+ –ü—Ä–∏—ë–º", btn_add_out: "‚àí –í—ã–¥–∞—á–∞", btn_close_shift: "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É", btn_scan_receipt: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ)",
        speech_lang: "–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", btn_test_voice: "–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥",
        cash_th_date: "–î–∞—Ç–∞", cash_th_type: "–¢–∏–ø", cash_th_amount: "–°—É–º–º–∞", cash_th_source: "–ò—Å—Ç–æ—á–Ω–∏–∫", cash_th_comment: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        parameters: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã", param_cash: "–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):", param_penalty: "–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval: "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:",
        btn_save_settings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btn_export_settings: "–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫", btn_import_settings: "–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫",
        auto_mode_explain: "–†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ + –∫–∞—Å—É."
      },
      en: {
        tab_dashboard:"Dashboard", tab_statement:"Statement", tab_invoices:"Invoices", tab_accounts:"Accounts", tab_cash:"Cash", tab_settings:"Settings",
        kpi_due_today:"Due today", kpi_unmatched:"Unmatched transactions", kpi_banks:"Bank balances", kpi_cash:"Cash (PLN)", kpi_total:"Available total", kpi_gap_today:"Cash gap today",
        btn_sync:"Sync", btn_ai_match:"AI match", btn_accept_safe:"Accept safe matches", btn_pdf:"PDF report",
        minpay_title:"Minimum payment (penalty-stop)", btn_apply_minpay:"Mark as paid",
        forecast_7d:"7-day forecast", forecast7d_note:"Calculates PLN accounts from statements (included) + cash.",
        forecast_30d:"30-day forecast", forecast30_note:"Autoforecast from statements + cash for 30 days.", month_summary_title:"Month summary",
        plan_title:"Payment plan for cash", filter_label:"Filter:", filter_today:"Today", filter_7d:"7 days", filter_all:"All", exclude_blacklist:"Exclude blacklist",
        btn_make_plan:"Build plan", btn_apply_plan:"Apply plan",
        plan_th_invoice:"Invoice", plan_th_supplier:"Supplier", plan_th_due:"Due", plan_th_amount:"Amount", plan_th_reason:"Reason",
        upload_statement:"Upload statement (CSV)", save_url:"Save URL",
        th_date:"Date", th_account:"Account", th_counterparty:"Counterparty", th_desc:"Description", th_amount:"Amount", th_currency:"Currency", th_status:"Status",
        upload_invoices:"Upload invoices (CSV)",
        inv_th_due:"Due", inv_th_number:"No", inv_th_supplier:"Supplier", inv_th_amount:"Amount", inv_th_currency:"Currency", inv_th_status:"Status", inv_th_candidate:"Candidate", inv_th_score:"Score", inv_th_action:"Action",
        auto_accounts_title:"Accounts from statement (auto)", auto_accounts_desc:"Edit currency, start balance and include-in-plan.",
        acc_th_account:"Account", acc_th_type:"Type", acc_th_currency:"Currency", acc_th_balance_calc:"Balance (calc)", acc_th_start_balance:"Start", acc_th_include:"Include",
        btn_add_in:"+ In", btn_add_out:"‚àí Out", btn_close_shift:"Close shift",
        parameters:"Parameters", param_cash_label:"Manual available cash today (PLN):", param_penalty_label:"Penalty, %/day:", param_interval_label:"Sync interval, min:",
        btn_save_settings:"Save", btn_export_settings:"Export", btn_import_settings:"Import"
      },
      pl: {
        tab_dashboard:"Panel", tab_statement:"WyciƒÖg", tab_invoices:"Faktury", tab_accounts:"Konta", tab_cash:"Kasa", tab_settings:"Ustawienia",
        kpi_due_today:"Do zap≈Çaty dzi≈õ", kpi_unmatched:"Niesparowane transakcje", kpi_banks:"Bilans bank√≥w", kpi_cash:"Kasa (PLN)", kpi_total:"Dostƒôpnie razem", kpi_gap_today:"Brak ≈õrodk√≥w dzi≈õ",
        btn_sync:"Synchronizuj", btn_ai_match:"Dopasowanie AI", btn_accept_safe:"Akceptuj bezpieczne pary", btn_pdf:"Raport PDF",
        minpay_title:"Minimalna p≈Çatno≈õƒá (kara-stop)", btn_apply_minpay:"Oznacz jako op≈Çacone",
        forecast_7d:"Prognoza 7 dni", forecast7d_note:"Liczy PLN-konta z wyciƒÖgu (w≈ÇƒÖczone) + kasa.",
        forecast_30d:"Prognoza 30 dni", forecast30_note:"Autoprognoza z wyciƒÖg√≥w + kasa na 30 dni.", month_summary_title:"Podsumowanie miesiƒÖca",
        plan_title:"Plan p≈Çatno≈õci pod kasƒô", filter_label:"Filtr:", filter_today:"Dzi≈õ", filter_7d:"7 dni", filter_all:"Wszystko", exclude_blacklist:"Wyklucz blacklistƒô",
        btn_make_plan:"Utw√≥rz plan", btn_apply_plan:"Zastosuj plan",
        plan_th_invoice:"Faktura", plan_th_supplier:"Dostawca", plan_th_due:"Termin", plan_th_amount:"Kwota", plan_th_reason:"Pow√≥d",
        upload_statement:"Za≈Çaduj wyciƒÖg (CSV)", save_url:"Zapisz URL",
        th_date:"Data", th_account:"Konto", th_counterparty:"Kontrahent", th_desc:"Opis", th_amount:"Kwota", th_currency:"Waluta", th_status:"Status",
        upload_invoices:"Za≈Çaduj faktury (CSV)",
        inv_th_due:"Termin", inv_th_number:"Nr", inv_th_supplier:"Dostawca", inv_th_amount:"Kwota", inv_th_currency:"Waluta", inv_th_status:"Status", inv_th_candidate:"Kandydat", inv_th_score:"Score", inv_th_action:"Akcja",
        auto_accounts_title:"Konta z wyciƒÖgu (auto)", auto_accounts_desc:"Edycja waluty, salda poczƒÖtkowego i uwzglƒôdnienia w planie.",
        acc_th_account:"Konto", acc_th_type:"Typ", acc_th_currency:"Waluta", acc_th_balance_calc:"Saldo (oblicz)", acc_th_start_balance:"Start", acc_th_include:"Uwzglƒôdnij",
        btn_add_in:"+ Przyjƒôcie", btn_add_out:"‚àí Wydanie", btn_close_shift:"Zamknij zmianƒô",
        parameters:"Parametry", param_cash_label:"Rƒôczna dostƒôpna kasa dzi≈õ (PLN):", param_penalty_label:"Kara, %/dzie≈Ñ:", param_interval_label:"Interwa≈Ç synchronizacji, min:",
        btn_save_settings:"Zapisz", btn_export_settings:"Eksport", btn_import_settings:"Import"
      },
      uk: {
        tab_dashboard:"–ü—É–ª—å—Ç", tab_statement:"–í–∏–ø–∏—Å–∫–∞", tab_invoices:"–†–∞—Ö—É–Ω–∫–∏", tab_accounts:"–†–∞—Ö—É–Ω–∫–∏", tab_cash:"–ö–∞—Å–∞", tab_settings:"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
        kpi_due_today:"–î–æ —Å–ø–ª–∞—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ", kpi_unmatched:"–ù–µ–ø–æ–≤'—è–∑–∞–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó", kpi_banks:"–ë–∞–ª–∞–Ω—Å –±–∞–Ω–∫—ñ–≤", kpi_cash:"–ö–∞—Å–∞ (PLN)", kpi_total:"–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å—å–æ–≥–æ", kpi_gap_today:"–†–æ–∑—Ä–∏–≤ –∫–∞—Å–∏ —Å—å–æ–≥–æ–¥–Ω—ñ",
        btn_sync:"–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è", btn_ai_match:"AI-–∑–≤—ñ—Ä–∫–∞", btn_accept_safe:"–ü—Ä–∏–π–Ω—è—Ç–∏ –±–µ–∑–ø–µ—á–Ω—ñ –ø–∞—Ä–∏", btn_pdf:"–ó–≤—ñ—Ç PDF",
        minpay_title:"–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–ª–∞—Ç—ñ–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)", btn_apply_minpay:"–ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ —Å–ø–ª–∞—á–µ–Ω–æ",
        forecast_7d:"–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω—ñ–≤", forecast7d_note:"–†–∞—Ö—É—î PLN-—Ä–∞—Ö—É–Ω–∫–∏ –∑ –≤–∏–ø–∏—Å–æ–∫ (–≤–∫–ª—é—á–µ–Ω—ñ) + –∫–∞—Å—É.",
        forecast_30d:"–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω—ñ–≤", forecast30_note:"–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –∑ –≤–∏–ø–∏—Å–æ–∫ + –∫–∞—Å–∏ –Ω–∞ 30 –¥–Ω—ñ–≤.", month_summary_title:"–ü—ñ–¥—Å—É–º–∫–∏ –º—ñ—Å—è—Ü—è",
        plan_title:"–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂—ñ–≤ –ø—ñ–¥ –∫–∞—Å—É", filter_label:"–§—ñ–ª—å—Ç—Ä:", filter_today:"–°—å–æ–≥–æ–¥–Ω—ñ", filter_7d:"7 –¥–Ω—ñ–≤", filter_all:"–í—Å—ñ", exclude_blacklist:"–í–∏–∫–ª—é—á–∞—Ç–∏ blacklist",
        btn_make_plan:"–°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏", btn_apply_plan:"–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏",
        plan_th_invoice:"–†–∞—Ö—É–Ω–æ–∫", plan_th_supplier:"–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫", plan_th_due:"–¢–µ—Ä–º—ñ–Ω", plan_th_amount:"–°—É–º–∞", plan_th_reason:"–ü—Ä–∏—á–∏–Ω–∞",
        upload_statement:"–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∏–ø–∏—Å–∫—É (CSV)", save_url:"–ó–±–µ—Ä–µ–≥—Ç–∏ URL",
        th_date:"–î–∞—Ç–∞", th_account:"–†–∞—Ö—É–Ω–æ–∫", th_counterparty:"–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc:"–û–ø–∏—Å", th_amount:"–°—É–º–∞", th_currency:"–í–∞–ª—é—Ç–∞", th_status:"–°—Ç–∞—Ç—É—Å",
        upload_invoices:"–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–∞—Ö—É–Ω–∫–∏ (CSV)",
        inv_th_due:"–¢–µ—Ä–º—ñ–Ω", inv_th_number:"‚Ññ", inv_th_supplier:"–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫", inv_th_amount:"–°—É–º–∞", inv_th_currency:"–í–∞–ª—é—Ç–∞", inv_th_status:"–°—Ç–∞—Ç—É—Å", inv_th_candidate:"–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score:"Score", inv_th_action:"–î—ñ—è",
        auto_accounts_title:"–†–∞—Ö—É–Ω–∫–∏ –∑ –≤–∏–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)", auto_accounts_desc:"–†–µ–¥–∞–≥—É–π—Ç–µ –≤–∞–ª—é—Ç—É, –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å —ñ –≤–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–ª–∞–Ω—É.",
        acc_th_account:"–†–∞—Ö—É–Ω–æ–∫", acc_th_type:"–¢–∏–ø", acc_th_currency:"–í–∞–ª—é—Ç–∞", acc_th_balance_calc:"–ë–∞–ª–∞–Ω—Å (–æ–±—Ä.)", acc_th_start_balance:"–°—Ç–∞—Ä—Ç", acc_th_include:"–í–∫–ª—é—á–∏—Ç–∏",
        btn_add_in:"+ –ü—Ä–∏—Ö—ñ–¥", btn_add_out:"‚àí –í–∏–¥–∞—Ç–æ–∫", btn_close_shift:"–ó–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É",
        parameters:"–ü–∞—Ä–∞–º–µ—Ç—Ä–∏", param_cash_label:"–†—É—á–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–∞—Å–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (PLN):", param_penalty_label:"–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval_label:"–Ü–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä., —Ö–≤:",
        btn_save_settings:"–ó–±–µ—Ä–µ–≥—Ç–∏", btn_export_settings:"–ï–∫—Å–ø–æ—Ä—Ç", btn_import_settings:"–Ü–º–ø–æ—Ä—Ç"
      }
    };

    function applyLang(lang) {
      const dict = (M[lang] || M.ru);
      document.querySelectorAll('[data-i]').forEach(el => {
        const k = el.getAttribute('data-i');
        if (k && dict && dict[k]) el.textContent = dict[k];
      });
      document.querySelectorAll('#langBarMain button').forEach(btn=>btn.classList.toggle('on', btn.dataset.lang === lang));
      localStorage.setItem('otd_lang', lang);
      if (typeof window.renderCashExamples === 'function') window.renderCashExamples(lang);
    }

    // helpers
    const asNum = v => {
      if (v == null) return 0;
      let s = String(v).trim();
      if (!s) return 0;
      s = s.replace(/\u00A0/g,' ').trim();
      if (s.match(/^\(.*\)$/)) { s = '-' + s.replace(/^\(|\)$/g,''); }
      const hasComma = /,/.test(s); const hasDot = /\./.test(s);
      s = s.replace(/\b(PLN|z≈Ç|zl|zlot|EUR|USD|GBP|PLN\.)\b/ig, '');
      if (hasComma && !hasDot) { s = s.replace(/\s/g, '').replace(/,/g, '.'); }
      else { s = s.replace(/[\s\u00A0]/g, '').replace(/,/g, ''); }
      s = s.replace(/[^\d\.\-]/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    };
    const today = () => new Date().toISOString().slice(0, 10);

    function smartSplit(line, del) {
      let out = [], cur = "", q = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { q = !q; continue; }
        if (ch === del && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      if (!text) return [];
      text = text.replace(/^\uFEFF/, '').replace(/\r/g, "");
      const lines = text.split("\n").filter(l => l.trim());
      if (!lines.length) return [];
      const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
      const head = smartSplit(lines.shift(), sep).map(h => h.trim());
      return lines.map(line => {
        const cells = smartSplit(line, sep);
        const obj = {};
        head.forEach((h, i) => {
          let v = (cells[i] || "").trim();
          v = v.replace(/\u00A0/g,' ').trim();
          obj[h] = v;
        });
        return obj;
      });
    }

    function toISO(d) {
      if (!d) return "";
      const s = String(d).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return m[0];
      m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
      if (m) {
        const dd = m[1].padStart(2, "0"),
              mm = m[2].padStart(2, "0"),
              yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
        return yy + "-" + mm + "-" + dd;
      }
      const maybe = Date.parse(s);
      if (!isNaN(maybe)) {
        const D = new Date(maybe);
        return D.toISOString().slice(0,10);
      }
      return "";
    }

    function fmtAmountRaw(raw) {
      const n = asNum(raw);
      if (!Number.isFinite(n)) return '<span>‚Äî</span>';
      const sign = n < 0 ? '-' : '+';
      const cls = n < 0 ? 'amt-neg' : 'amt-pos';
      const abs = Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
      return `<span class="${cls}">${sign} ${abs}</span>`;
    }

    function getVal(obj, keys) {
      if (!obj) return "";
      for (const k of keys) {
        if (k in obj && obj[k] !== null && obj[k] !== undefined && String(obj[k]).trim() !== "") return obj[k];
      }
      const low = Object.keys(obj).reduce((m, x) => (m[x.toLowerCase()] = obj[x], m), {});
      for (const k of keys) {
        const kk = k.toLowerCase();
        if (kk in low && String(low[kk]).trim() !== "") return low[kk];
      }
      return "";
    }
  </script>

  <script>
  (function(){
    // –ª–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
    let tx = [];
    let bills = [];
    let kasa = [];
    let accMeta = {};

    // –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –∫–∞—Å—Å—ã (–º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ)
    const cashQuickExamples = {
      ru: ["–ü—Ä–∏–Ω—è—Ç—å 250 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã","–í—ã–¥–∞—Ç—å 50 –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É","–ü—Ä–∏–Ω—è—Ç—å 1000 –¥–µ–ø–æ–∑–∏—Ç","–ü—Ä–∏–Ω—è—Ç—å 50 –Ω–∞ –Ω–∞–ø–∏—Ç–∫–∏"],
      en: ["Accept 250 for groceries","Pay out 50 for delivery","Accept 1000 deposit","Accept 50 for drinks"],
      pl: ["PrzyjƒÖƒá 250 na produkty","Wyp≈Çaciƒá 50 na dostawƒô","PrzyjƒÖƒá 1000 depozyt","PrzyjƒÖƒá 50 na napoje"],
      uk: ["–ü—Ä–∏–π–Ω—è—Ç–∏ 250 –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏","–í–∏–¥–∞—Ç–∏ 50 –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É","–ü—Ä–∏–π–Ω—è—Ç–∏ 1000 –¥–µ–ø–æ–∑–∏—Ç","–ü—Ä–∏–π–Ω—è—Ç–∏ 50 –Ω–∞ –Ω–∞–ø–æ—ó"]
    };

    window.renderCashExamples = function(lang) {
      try {
        lang = lang || (localStorage.getItem('otd_lang') || 'ru');
        const holder = document.getElementById('kasaQuickHolder');
        if (!holder) return;
        holder.innerHTML = '';
        const arr = cashQuickExamples[lang] || cashQuickExamples['ru'];
        arr.forEach(txt => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = txt;
          btn.addEventListener('click', () => {
            const numMatch = txt.match(/(-?\d+[.,]?\d*)/);
            const num = numMatch ? asNum(numMatch[1]) : 0;
            const note = txt.replace(/(-?\d+[.,]?\d*\s*(z≈Ç|pln|PLN|USD|EUR)?)/i, "").trim();
            const outRe = /(–≤—ã–¥–∞|–≤—ã–ø–ª–∞|wydaj|wydat|pay out|wyp≈Çac|–≤–∏–¥–∞—Ç)/i;
            const isOut = outRe.test(txt);
            addKasa(isOut ? 'wydanie' : 'przyjƒôcie', num, note || txt, 'quick');
          });
          holder.appendChild(btn);
        });
      } catch(e) { console.warn('renderCashExamples error', e); }
    };

    // —Å—á–µ—Ç–∞ –ø–æ –≤—ã–ø–∏—Å–∫–µ
    function inferAccounts() {
      const map = {};
      tx.forEach(r => {
        const id = getVal(r, ["ID konta","IBAN","ID konta ","account","ID","IDkonto"]) || "UNKNOWN";
        const cur = (getVal(r, ["Waluta","currency","Currency","Waluta "]) || "PLN").toUpperCase();
        if (!map[id]) {
          map[id] = { id, name: String(id).slice(0, 12), currency: cur, include: true, type: "Biznes", start: 0 };
        }
      });
      try {
        const saved = JSON.parse(localStorage.getItem("accMeta") || "{}");
        Object.keys(map).forEach(id => { if (saved[id]) map[id] = Object.assign(map[id], saved[id]); });
      } catch(e){}
      accMeta = map;
      renderAccounts();
    }

    function computeAccountBalance(accId) {
      const rows = tx.filter(r => (getVal(r, ["ID konta","IBAN","account","ID"]) || "UNKNOWN") === accId);
      const withSaldo = rows.filter(r => getVal(r, ["Saldo po operacji","Saldo","saldo"]));
      if (withSaldo.length) { const last = withSaldo[withSaldo.length - 1]; return asNum(getVal(last, ["Saldo po operacji","Saldo","saldo"])); }
      const start = Number((accMeta[accId] || {}).start || 0);
      const sum = rows.reduce((s, r) => s + asNum(getVal(r, ["Kwota","Kw–æ—Ç–∞","amount","Kwota_raw"])), 0);
      return start + sum;
    }

    function rate(cur) {
      cur = String(cur || "PLN").toUpperCase();
      if (cur === "PLN") return 1;
      if (cur === "EUR") return asNum(localStorage.getItem("rateEUR") || 4.3);
      if (cur === "USD") return asNum(localStorage.getItem("rateUSD") || 3.95);
      return 1;
    }
    function bankAvailablePLN() {
      let sum = 0;
      Object.values(accMeta).filter(a => a.include).forEach(a => {
        const bal = computeAccountBalance(a.id);
        sum += bal * rate(a.currency);
      });
      return sum;
    }
    function kasaBalance() {
      let bal = 0;
      kasa.forEach(k => {
        if (k.type === "przyjƒôcie") bal += k.amount;
        if (k.type === "wydanie") bal -= k.amount;
        if (k.type === "zamkniƒôcie") bal = k.amount;
      });
      return bal;
    }
    function availableTotal() {
      const auto = localStorage.getItem("autoCash") === "1";
      const manual = asNum(localStorage.getItem("cashPLN") || 0);
      const kas = kasaBalance();
      return auto ? (bankAvailablePLN() + kas) : (manual + kas);
    }

    function normName(s) { s = (s || "").toString().toLowerCase().replace(/[.,]/g, " ").replace(/\s+/g, " ").trim(); ["sp z oo","sp. z o.o.","spolka","sp√≥≈Çka","sa","s.a","ooo"].forEach(t => s = s.replace(t, "")); return s.trim(); }
    function nameSimilar(a, b) { a = normName(a); b = normName(b); if (!a || !b) return 0; if (a === b) return 1; if (a.includes(b) || b.includes(a)) return 0.8; return 0; }
    function scoreMatch(bill, tr) {
      let score = 0;
      const bAmt = asNum(getVal(bill, ["Kw–æ—Ç–∞ do zap≈Çaty","Kw–æ—Ç–∞","Kwota do zap≈Çaty","amount"]));
      const tAmt = Math.abs(asNum(getVal(tr, ["Kwota","Kw–æ—Ç–∞","amount","Kwota_raw"])));
      const bCur = String(getVal(bill, ["Waluta","currency","Waluta "]) || "").toUpperCase();
      const tCur = String(getVal(tr, ["Waluta","currency","Waluta "]) || "").toUpperCase();
      if (bAmt > 0 && tAmt > 0 && Math.abs(bAmt - tAmt) < 0.01 && (bCur === tCur || !bCur || !tCur)) score += 60;
      const inv = String(getVal(bill, ["Numer faktury","Numer —Ñ–∞–∫—Ç—É—Ä—ã","Invoice number"]) || "").toLowerCase();
      const desc = String(getVal(tr, ["Tytu≈Ç/Opis","Opis","Title","description"]) || "").toLowerCase();
      if (inv && desc.includes(inv)) score += 25;
      if (nameSimilar(getVal(bill, ["Dostawca","Supplier"]), getVal(tr, ["Kontrahent","Counterparty","Kontrahent"])) >= 0.8) score += 10;
      if (asNum(getVal(tr, ["Kwota","amount"])) < 0) score += 5;
      return { score: Math.min(100, score) };
    }

    function runAI() {
      bills.forEach(b => {
        const status = String(getVal(b, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status faktury","Status"]) || "").toLowerCase();
        if (status.includes("op≈Çacone") || status.includes("–æ–ø–ª–∞—á–µ–Ω–æ") || status.includes("paid")) return;
        let best = null;
        tx.forEach(t => {
          if (String(getVal(t, ["Status transakcji","status"]) || "").toLowerCase() === "sparowane") return;
          if (asNum(getVal(t, ["Kwota","amount"])) >= 0) return;
          const s = scoreMatch(b, t);
          if (!best || s.score > best.s) best = { t, s: s.score };
        });
        if (best && best.s >= 85) {
          best.t["Status transakcji"] = "Sparowane";
          best.t["PowiƒÖzana —Ñ–∞–∫—Ç—É—Ä–∞ (ID)"] = getVal(b, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury"]);
          b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
          b["Data –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] = today();
        } else if (best && best.s >= 55) {
          b["Kand–∏–¥–∞—Ç (AI)"] = getVal(best.t, ["ID transakcji","ID"]);
          b["AI score"] = best.s;
        } else {
          b["Kand–∏–¥–∞—Ç (AI)"] = "";
          b["AI score"] = "";
        }
      });
      render();
    }
    function acceptSafe() {
      bills
        .filter(b => Number(getVal(b, ["AI score"]) || 0) >= 85)
        .forEach(b => {
          const t = tx.find(t => getVal(t, ["ID transakcji"]) === getVal(b, ["Kand–∏–¥–∞—Ç (AI)"]));
          if (!t) return;
          t["Status transakcji"] = "Sparowane";
          t["PowiƒÖzana —Ñ–∞–∫—Ç—É—Ä–∞ (ID)"] = getVal(b, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury"]);
          b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
          b["Data –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] = today();
          b["Kand–∏–¥–∞—Ç (AI)"] = b["AI score"] = "";
        });
      render();
    }

    function normalizeRowKeys(r) {
      const kwRaw = getVal(r, ["Kwota","Kw–æ—Ç–∞","amount","Kwota_raw"]) || "";
      const kwNum = asNum(kwRaw);
      return {
        "Data ksiƒôgowania": getVal(r, ["Data ksiƒôgowania","date","–î–∞—Ç–∞"]) || today(),
        "ID transakcji": getVal(r, ["ID transakcji","id","ID"]) || ("IMG-" + Date.now() + "-" + Math.floor(Math.random()*9999)),
        "ID konta": getVal(r, ["ID konta","account","IBAN"]) || "UNKNOWN",
        "Kontrahent": getVal(r, ["Kontrahent","Kontrah–µ–Ω—Ç","counterparty","Counterparty"]) || "",
        "Tytu≈Ç/Opis": getVal(r, ["Tytu≈Ç/Opis","Opis","title","Title"]) || "",
        "Kwota": (Number.isFinite(kwNum) ? kwNum.toFixed(2) : (typeof kwRaw === 'number' ? String(kwRaw) : (kwRaw || ""))),
        "Kwota_raw": kwRaw || "",
        "Waluta": (getVal(r, ["Waluta","currency"]) || "PLN"),
        "Status transakcji": getVal(r, ["Status transakcji","status"]) || "imported",
        "Saldo po operacji": getVal(r, ["Saldo po operacji","Saldo","saldo"]) || ""
      };
    }

    /* ==== OCR IMPORT: –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ –≤—ã–ø–∏—Å–æ–∫ –∏ —Ñ–æ—Ç–æ —Ñ–∞–∫—Ç—É—Ä ==== */
    async function ocrRecognizeFile(file, langs='pol+eng+rus+ukr') {
      const worker = await Tesseract.createWorker();
      await worker.load();
      try { await worker.loadLanguage(langs); await worker.initialize(langs); }
      catch(e) { await worker.loadLanguage('eng'); await worker.initialize('eng'); }
      const { data:{ text } } = await worker.recognize(file);
      await worker.terminate();
      return (text||'').replace(/\u00A0/g,' ').trim();
    }

    function ocrTxFromText(text){
      const date = (text.match(/\b(\d{4}[-./]\d{2}[-./]\d{2})\b/)||[])[1]
                || (text.match(/\b(\d{1,2}[-./]\d{1,2}[-./]\d{2,4})\b/)?.[1]) || today();
      const dueISO = toISO(date);
      const amtRaw = (text.match(/([+-]?\d{1,3}(?:[ \u00A0]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s?(PLN|EUR|USD|z≈Ç)/i)||[])[1];
      const cur = (text.match(/PLN|EUR|USD|z≈Ç/i)||['PLN'])[0].toUpperCase().replace('Z≈Å','PLN');
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const counterparty = lines.find(s=>s.length>3 && !/\d{2}[:.]\d{2}/.test(s)) || 'Unknown';
      const desc = (lines[1]||lines[0]||'').slice(0,160);
      if(!amtRaw) return null;
      return {
        "Data ksiƒôgowania": dueISO,
        "ID transakcji": "OCR-" + Date.now() + "-" + Math.floor(Math.random()*10000),
        "ID konta": "OCR",
        "Kontrahent": counterparty,
        "Tytu≈Ç/Opis": desc,
        "Kwota": asNum(amtRaw).toFixed(2),
        "Waluta": cur,
        "Status transakcji": "imported"
      };
    }

    function ocrInvoiceFromText(text){
      const num = (text.match(/(FV|Faktura|Invoice)[\s#:]*([A-Z0-9\-/._]+)/i)||[])[2] || ("OCR-"+Date.now());
      const due = (text.match(/\b(Termin|Due|P≈Çatno≈õci|Payment\s*due)[:\s]*([0-9]{4}[-./][0-9]{2}[-./][0-9]{2}|[0-9]{1,2}[-./][0-9]{1,2}[-./][0-9]{2,4})/i)||[])[2] || today();
      const dueISO = toISO(due);
      const amtRaw = (text.match(/(Suma|Kwota|Total)\s*[:\-]?\s*([0-9]+[.,][0-9]{2})/i)||[])[2]
                  || (text.match(/([0-9]+[.,][0-9]{2})\s?(PLN|EUR|USD)/i)||[])[1];
      const cur = (text.match(/PLN|EUR|USD/i)||['PLN'])[0].toUpperCase();
      const supplier = (text.match(/(Sprzedawca|Supplier)[:\s]*([^\n]+)/i)||[])[2]
                    || (text.split('\n')[0]||'Unknown');
      if(!amtRaw) return null;
      return {
        "Termin p≈Çatno≈õci": dueISO,
        "Numer —Ñ–∞–∫—Ç—É—Ä—ã": num,
        "Dostawca": supplier.slice(0,200),
        "Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã": asNum(amtRaw).toFixed(2),
        "Kwota do zap≈Çaty": asNum(amtRaw).toFixed(2),
        "Waluta": cur,
        "Status —Ñ–∞–∫—Ç—É—Ä—ã": "do zap≈Çaty",
        "Kand–∏–¥–∞—Ç (AI)": "",
        "AI score": ""
      };
    }
    /* ==== /OCR IMPORT ==== */

    function renderKasa() {
      const tb = document.querySelector("#kasaTable tbody");
      if (!tb) return;
      tb.innerHTML = "";
      // –ù–û–í–û–ï: –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å–≤–µ—Ä—Ö—É
      [...kasa].slice().reverse().forEach((k, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source || ""}</td><td>${k.comment || ""}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderAccounts() {
      const tb = document.querySelector("#autoAcc tbody");
      if (!tb) return;
      tb.innerHTML = "";
      Object.values(accMeta).forEach(a => {
        const bal = computeAccountBalance(a.id);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td>
          <td><select data-id="${a.id}" class="acc-type">
              <option ${a.type === "Biznes" ? "selected" : ""}>Biznes</option>
              <option ${a.type === "Osobisty" ? "selected" : ""}>Osobisty</option>
            </select></td>
          <td><select data-id="${a.id}" class="acc-cur">
              <option ${a.currency === "PLN" ? "selected" : ""}>PLN</option>
              <option ${a.currency === "EUR" ? "selected" : ""}>EUR</option>
              <option ${a.currency === "USD" ? "selected" : ""}>USD</option>
            </select></td>
          <td>${bal.toFixed(2)}</td>
          <td><input type="number" step="0.01" value="${a.start || 0}" class="acc-start" data-id="${a.id}" /></td>
          <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include ? "checked" : ""} /></td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll(".acc-type").forEach(el => el.addEventListener("change", e => { const id = e.target.dataset.id; accMeta[id].type = e.target.value; saveAccMeta(); render(); }));
      tb.querySelectorAll(".acc-cur").forEach(el => el.addEventListener("change", e => { const id = e.target.dataset.id; accMeta[id].currency = e.target.value; saveAccMeta(); render(); }));
      tb.querySelectorAll(".acc-start").forEach(el => el.addEventListener("change", e => { const id = e.target.dataset.id; accMeta[id].start = asNum(e.target.value); saveAccMeta(); render(); }));
      tb.querySelectorAll(".acc-include").forEach(el => el.addEventListener("change", e => { const id = e.target.dataset.id; accMeta[id].include = e.target.checked; saveAccMeta(); render(); }));
    }
    function saveAccMeta() { try { localStorage.setItem("accMeta", JSON.stringify(accMeta)); } catch(e){} }

    function loadKasa() { try { kasa = JSON.parse(localStorage.getItem("kasa") || "[]"); } catch(e) { kasa = []; } }
    function saveKasa() { try { localStorage.setItem("kasa", JSON.stringify(kasa)); } catch(e){} }
    function addKasa(type, amount, comment, source) {
      if (amount == null || isNaN(amount)) return alert("–°—É–º–º–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞");
      kasa.push({ id: Date.now(), date: today(), type, amount: Number(amount), comment: comment || "", source: source || "—Ä—É—á–Ω–æ–π" });
      saveKasa(); render(); renderKasa();
    }

    function toDueList(mode) {
      const t = today();
      const excl = $id("excludeBlacklist") ? document.getElementById("excludeBlacklist").checked : false;
      return bills.filter(r => {
        const s = String(getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status faktury","Status"]) || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ","to pay"].includes(s)) return false;
        const d = toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]));
        if (!d) return false;
        if (mode === "today") return d === t;
        if (mode === "7d") { const dd = new Date(d), tt = new Date(t); return (dd - tt) / (1000 * 3600 * 24) <= 7; }
        return true;
      }).filter(r => {
        if (String((getVal(r, ["Waluta","Waluta "]) || "").toUpperCase()) !== "PLN") return false;
        if (excl) {
          const blist = (localStorage.getItem("blacklist") || "").toLowerCase();
          if (blist && getVal(r, ["Dostawca","Supplier"]) && blist.split(",").some(name => getVal(r, ["Dostawca","Supplier"]).toLowerCase().includes(name.trim()))) return false;
        }
        return true;
      });
    }

    function buildPlan() {
      const planFilter = $id("planFilter");
      const mode = planFilter ? planFilter.value : "7d";
      const cand = toDueList(mode).sort((a, b) => {
        const da = new Date(toISO(getVal(a, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || today()));
        const db = new Date(toISO(getVal(b, ["Termin p≈Ç–∞—Çno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || today()));
        const lateA = da < new Date(today());
        const lateB = db < new Date(today());
        if (lateA !== lateB) return lateB - lateA;
        return asNum(getVal(b, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kw–æ—Ç–∞ do –∑–∞–ø–ª–∞—Ç—ã"]) || 0) - asNum(getVal(a, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"]) || 0);
      });
      let left = availableTotal();
      const plan = [];
      for (const r of cand) {
        const amt = asNum(getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"]) || 0);
        if (amt <= left) {
          plan.push({ r, amt, reason: (toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || today()) < today() ? "–ø—Ä–æ—Å—Ä–æ—á–∫–∞" : "—Å—Ä–æ–∫") });
          left -= amt;
        }
      }
      return { plan, left, avail: availableTotal() };
    }

    function renderPlan() {
      const p = buildPlan();
      const tb = document.getElementById("planTable") ? document.getElementById("planTable").querySelector("tbody") : null;
      if (!tb) return;
      tb.innerHTML = "";
      p.plan.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${getVal(x.r, ["Numer faktury","Numer —Ñ–∞–∫—Ç—É—Ä—ã","Invoice number"]) || ""}</td><td>${getVal(x.r, ["Dostawca","Supplier"]) || ""}</td><td>${toISO(getVal(x.r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || "")}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
        tb.appendChild(tr);
      });
      const metaText = p.plan.length ? `–ü–æ—Ç—Ä–∞—Ç–∏–º ${(p.avail - p.left).toFixed(2)} –∏–∑ ${p.avail.toFixed(2)} PLN. –û—Å—Ç–∞–Ω–µ—Ç—Å—è ${p.left.toFixed(2)} PLN.` : "–ü–ª–∞–Ω –ø—É—Å—Ç –∏–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç.";
      const pm = $id("planMeta"); if (pm) pm.textContent = metaText;
    }

    function computeMinPay() {
      const t = today();
      const pctVal = asNum(localStorage.getItem("penaltyPct") || 0.05);
      const pct = pctVal / 100.0;
      const cand = bills.filter(r =>
        String((getVal(r, ["Waluta","Waluta "]) || "").toUpperCase()) === "PLN" &&
        toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || "") <= t &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status"]) || "").toLowerCase())
      ).map(r => ({
        r,
        amt: asNum(getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kw–æ—Ç–∞ do zap≈Çaty"]) || 0),
        risk: asNum(getVal(r, ["Kwota do –∑–∞–ø≈Çaty","Kw–æ—Ç–∞","Kwota do zap≈Çaty"]) || 0) * pct
      })).sort((a, b) => b.risk - a.risk || b.amt - a.amt);
      return cand[0] || null;
    }
    function renderMinPay() {
      const m = computeMinPay();
      const el = $id("minPayBox");
      if (!el) return;
      if (!m) { el.textContent = "‚Äî"; return; }
      el.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ${getVal(m.r, ["Numer faktury","Numer —Ñ–∞–∫—Ç—É—Ä—ã"])} (${getVal(m.r, ["Dostawca","Supplier"])}) –Ω–∞ ${m.amt.toFixed(2)} PLN. –®—Ç—Ä–∞—Ñ/–¥–µ–Ω—å ~ ${m.risk.toFixed(2)} PLN.`;
    }

    function renderForecast() {
      const t = new Date(today());
      const list = toDueList("7d").map(r => ({ date: new Date(toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"]))), amt: asNum(getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kwota do zap≈Çaty"]) || 0) }));
      const days = [...Array(7)].map((_, i) => new Date(t.getTime() + i * 86400000));
      let left = availableTotal();
      const out = days.map(d => ({ d, due: 0, after: 0 }));
      list.forEach(x => { const idx = Math.min(6, Math.max(0, Math.floor((x.date - t) / 86400000))); out[idx].due += x.amt; });
      out.forEach(o => { left -= o.due; o.after = left; });
      const wrap = document.getElementById("forecastBars"); if (!wrap) return;
      wrap.innerHTML = "";
      out.forEach(o => {
        const div = document.createElement("div"); div.className = "bar" + (o.after < 0 ? " neg" : "");
        const h = document.createElement("div"); h.className = "h"; h.style.height = (Math.min(120, Math.abs(o.after) / 100) * 0.8 + 18) + "px";
        div.innerHTML = "<small>" + o.d.toISOString().slice(5, 10) + "</small>";
        div.appendChild(h);
        const v = document.createElement("div"); v.textContent = (o.after < 0 ? "-" : "") + Math.abs(o.after).toFixed(0) + " PLN";
        div.appendChild(v);
        wrap.appendChild(div);
      });
      const firstNeg = out.find(x => x.after < 0);
      const meta = $id("forecastMeta");
      if (meta) meta.textContent = firstNeg ? `–ì—ç–ø —á–µ—Ä–µ–∑ ${out.indexOf(firstNeg) + 1} –¥–Ω.: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${Math.abs(firstNeg.after).toFixed(2)} PLN.` : "–ù–∞ 7 –¥–Ω–µ–π —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞—Å—Å—ã.";
    }

    function render() {
      try {
        const stored = JSON.parse(localStorage.getItem("tx_manual_import") || "[]");
        const map = {}; (stored.concat(tx || [])).forEach(r => { map[getVal(r, ["ID transakcji","ID","id"]) || ("noid-"+JSON.stringify(r))] = r; });
        tx = Object.values(map).slice(0, 5000);
      } catch(e){}
      try {
        const storedB = JSON.parse(localStorage.getItem("bills_manual_import") || "[]");
        const mapB = {}; (storedB.concat(bills || [])).forEach(r => { mapB[getVal(r, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury","Invoice number"]) || ("noinv-"+JSON.stringify(r))] = r; });
        bills = Object.values(mapB).slice(0, 5000);
      } catch(e){}
      try { accMeta = Object.assign({}, JSON.parse(localStorage.getItem("accMeta") || "{}"), accMeta || {}); } catch(e){}

      const dueToday = (bills || []).filter(r => {
        const s = String(getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status faktury","Status"]) || "").toLowerCase();
        return ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ","to pay"].includes(s) && toISO(getVal(r, ["Termin p≈Ç–∞—Ç–Ω–æ—Å—Ç—ñ","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"])) === today();
      }).length;
      const unmatch = (tx || []).filter(r => String(getVal(r, ["Status transakcji","status"]) || "").toLowerCase() !== "sparowane").length;
      $id("kpiDue") && ($id("kpiDue").textContent = dueToday);
      $id("kpiUnmatch") && ($id("kpiUnmatch").textContent = unmatch);
      const bankPLN = bankAvailablePLN();
      $id("kpiBank") && ($id("kpiBank").textContent = bankPLN.toFixed(2));
      const kas = kasaBalance();
      $id("kpiCash") && ($id("kpiCash").textContent = kas.toFixed(2));
      const avail = availableTotal();
      $id("kpiAvail") && ($id("kpiAvail").textContent = avail.toFixed(2));

      const sumDueToday = (bills || []).filter(r =>
        String((getVal(r, ["Waluta","Waluta "]) || "").toUpperCase()) === "PLN" &&
        toISO(getVal(r, ["Termin p≈Çat–Ω–æ—Å—Ç—ñ","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏"])) <= today() &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status"]) || "").toLowerCase())
      ).reduce((s, r) => s + asNum(getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞","Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã"]) || 0), 0);
      $id("kpiGap") && ($id("kpiGap").textContent = Math.max(0, sumDueToday - avail).toFixed(2));

      // Transactions
      const txBody = document.querySelector("#txTable tbody");
      if (txBody) {
        txBody.innerHTML = "";
        (tx || []).forEach(r => {
          const date = toISO(getVal(r, ["Data ksiƒôgowania","date","–î–∞—Ç–∞"]));
          const account = getVal(r, ["ID konta","IBAN","account"]) || "‚Äî";
          const counterparty = getVal(r, ["Kontrahent","Kontrah–µ–Ω—Ç","Kontragent","counterparty"]) || "";
          const desc = getVal(r, ["Tytu≈Ç/Opis","Opis","title"]) || "";
          const amountHtml = fmtAmountRaw(getVal(r, ["Kwota","Kw–æ—Ç–∞","amount","Kwota_raw"]));
          const cur = getVal(r, ["Waluta","currency"]) || "";
          const status = getVal(r, ["Status transakcji","status"]) || "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${date}</td><td>${account}</td><td>${counterparty}</td><td>${desc}</td><td>${amountHtml}</td><td>${cur}</td><td>${status}</td>`;
          txBody.appendChild(tr);
        });
      }

      // Bills (+ –¥–µ–π—Å—Ç–≤–∏—è)
      const billTable = document.querySelector("#billTable tbody");
      if (billTable) {
        billTable.innerHTML = "";
        (bills || []).forEach(r => {
          const s = String(getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status faktury","Status"]) || "").toLowerCase();
          const cls = (s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä")) ? "overdue" : "due";
          const cand = getVal(r, ["Kand–∏–¥–∞—Ç (AI)","Kand–∏–¥at (AI)"]) || "";
          const score = getVal(r, ["AI score"]) || "";
          const d = toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || "");
          const num = getVal(r, ["Numer faktury","Numer —Ñ–∞–∫—Ç—É—Ä—ã","Invoice number"]) || "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d}</td>
            <td>${num}</td>
            <td>${getVal(r, ["Dostawca","Supplier"]) || ""}</td>
            <td>${getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã","Kw–æ—Ç–∞","Kwota"]) || ""}</td>
            <td>${getVal(r, ["Waluta","currency"]) || ""}</td>
            <td><span class="badge ${cls}">${getVal(r, ["Status —Ñ–∞–∫—Ç—É—Ä—ã","Status faktury","Status"]) || ""}</span></td>
            <td>${cand ? ('<span class="badge cand">' + cand + '</span>') : '‚Äî'}</td>
            <td>${score ? ('<span class="badge ai">' + score + '</span>') : '‚Äî'}</td>
            <td class="actions">
              ${cand ? ('<button class="btn secondary btn-accept" data-id="' + num + '">OK</button>') : ''}
              <button class="btn ghost" data-act="edit" data-kind="bill" data-id="${num}">‚úé</button>
              <button class="btn ghost" data-act="del" data-kind="bill" data-id="${num}">üóë</button>
            </td>`;
          billTable.appendChild(tr);
        });
        document.querySelectorAll(".btn-accept").forEach(b => b.addEventListener("click", () => acceptOne(b.getAttribute("data-id"))));
      }

      renderMinPay();
      renderForecast();
      renderAccounts();
      renderKasa();
      try { window.renderCashExamples && window.renderCashExamples(localStorage.getItem('otd_lang') || 'ru'); } catch(e){}
    }

    function acceptOne(id) {
      const b = (bills || []).find(x => (getVal(x, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury","Invoice number"]) || "") === id);
      if (!b) return;
      const t = (tx || []).find(x => (getVal(x, ["ID transakcji","ID","id"]) || "") === (getVal(b, ["Kand–∏–¥–∞—Ç (AI)"]) || ""));
      if (!t) return;
      t["Status transakcji"] = "Sparowane";
      t["PowiƒÖzana —Ñ–∞–∫—Ç—É—Ä–∞ (ID)"] = getVal(b, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury"]);
      b["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone";
      b["Data –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] = today();
      b["Kand–∏–¥–∞—Ç (AI)"] = b["AI score"] = "";
      render();
    }

    // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤
    document.addEventListener('click', (e) => {
      const act = e.target?.getAttribute('data-act');
      if (!act) return;
      const kind = e.target.getAttribute('data-kind');
      const id = e.target.getAttribute('data-id');
      if (kind !== 'bill') return;

      const idx = bills.findIndex(r => (getVal(r, ["Numer —Ñ–∞–∫—Ç—É—Ä—ã","Numer faktury","Invoice number"]) || "") === id);
      if (idx < 0) return;

      if (act === 'del') {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç ' + id + '?')) {
          bills.splice(idx, 1);
          try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
          render();
        }
      }
      if (act === 'edit') {
        const r = bills[idx];
        const newDue = prompt('–°—Ä–æ–∫ (YYYY-MM-DD):', toISO(getVal(r, ["Termin p≈Çatno≈õci","Termin","Termin –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"]) || today()));
        if (newDue === null) return;
        const newAmt = prompt('–°—É–º–º–∞ (xx.xx):', getVal(r, ["Kwota do zap≈Çaty","Kw–æ—Ç–∞ –¥–æ –∑–∞–ø–ª–∞—Ç—ã","Kw–æ—Ç–∞","Kwota"]) || "");
        if (newAmt === null) return;
        const newCur = prompt('–í–∞–ª—é—Ç–∞ (PLN/EUR/USD):', (getVal(r, ["Waluta","currency"]) || "PLN"));
        if (newCur === null) return;
        r["Termin p≈Çatno≈õci"] = toISO(newDue)||today();
        r["Kwota do –∑–∞–ø≈Çaty"] = asNum(newAmt).toFixed(2);
        r["Waluta"] = (newCur||"PLN").toUpperCase();
        try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
        render();
      }
    }, false);

    document.addEventListener('DOMContentLoaded', () => {
      // –ò–ò, –ø–ª–∞–Ω, –º–∏–Ω–∏–º–∞–ª–∫–∞
      $id("runAI") && $id("runAI").addEventListener("click", runAI);
      $id("acceptSafe") && $id("acceptSafe").addEventListener("click", acceptSafe);
      $id("makePlan") && $id("makePlan").addEventListener("click", renderPlan);
      $id("applyPlan") && $id("applyPlan").addEventListener("click", renderPlan);
      $id("applyMinPay") && $id("applyMinPay").addEventListener("click", () => {
        const m = computeMinPay(); if (!m) return alert("–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤");
        m.r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] = "Op≈Çacone"; m.r["Data –ø–ª–∞—Ç–Ω–æ—Å—Ç—ñ"] = today(); render();
      });
      $id("planFilter") && $id("planFilter").addEventListener("change", renderPlan);
      $id("excludeBlacklist") && $id("excludeBlacklist").addEventListener("change", () => { renderPlan(); render(); });

      $id("exportPDF") && $id("exportPDF").addEventListener("click", () => window.print());

      $id("syncNow") && $id("syncNow").addEventListener("click", async () => {
        try {
          const u1 = localStorage.getItem("txUrl") || $id("txUrl")?.value || "";
          const u2 = localStorage.getItem("billUrl") || $id("billUrl")?.value || "";
          if (u1) { const res = await fetch(u1, { cache: 'no-store' }); const txt = await res.text(); tx = parseCSV(txt).map(normalizeRowKeys); }
          if (u2) { const res2 = await fetch(u2, { cache: 'no-store' }); const txt2 = await res2.text(); bills = parseCSV(txt2); }
          inferAccounts(); render();
          $id("lastSync") && ($id("lastSync").textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString());
        } catch(e) {
          $id("lastSync") && ($id("lastSync").textContent = "–û—à–∏–±–∫–∞: " + (e?.message || String(e)));
        }
      });

      // CSV –∑–∞–≥—Ä—É–∑–∫–∏
      $id("txFile") && $id("txFile").addEventListener("change", async e => { const f = e.target.files[0]; if (!f) return; tx = parseCSV(await f.text()).map(normalizeRowKeys); inferAccounts(); render(); });
      $id("billFile") && $id("billFile").addEventListener("change", async e => { const f = e.target.files[0]; if (!f) return; bills = parseCSV(await f.text()); render(); });

      $id("saveTxUrl") && $id("saveTxUrl").addEventListener("click", () => { const v = $id("txUrl") ? $id("txUrl").value.trim() : ""; localStorage.setItem("txUrl", v); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL wyciƒÖga"); });

      // –î–û–ë–ê–í–õ–ï–ù–û: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤—ã–ø–∏—Å–∫–∏ (OCR)
      $id('txImage') && $id('txImage').addEventListener('change', async e=>{
        const files = [...e.target.files]; if (!files.length) return;
        for (const f of files) {
          const text = await ocrRecognizeFile(f);
          const row = ocrTxFromText(text);
          if (row) { tx.push(normalizeRowKeys(row)); }
          if ($id('txLastThumb')) { $id('txLastThumb').src = URL.createObjectURL(f); $id('txLastThumb').style.display='inline-block'; }
        }
        try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){}
        inferAccounts(); render();
        e.target.value = '';
      });

      // –î–û–ë–ê–í–õ–ï–ù–û: –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ñ–∞–∫—Ç—É—Ä (OCR)
      $id('billImage') && $id('billImage').addEventListener('change', async e=>{
        const files = [...e.target.files]; if (!files.length) return;
        for (const f of files) {
          const text = await ocrRecognizeFile(f);
          const row = ocrInvoiceFromText(text);
          if (row) bills.push(row);
        }
        try { localStorage.setItem("bills_manual_import", JSON.stringify(bills)); } catch(e){}
        render();
        e.target.value = '';
      });

      // –∫–∞—Å—Å–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏/–æ–ø–µ—Ä–∞—Ü–∏–∏
      $id("addIn") && $id("addIn").addEventListener("click", () => addKasa("przyjƒôcie", asNum($id("quickAmt")?.value || 0), $id("quickNote")?.value, "—Ä—É—á–Ω–æ–π"));
      $id("addOut") && $id("addOut").addEventListener("click", () => addKasa("wydanie", asNum($id("quickAmt")?.value || 0), $id("quickNote")?.value, "—Ä—É—á–Ω–æ–π"));
      $id("cashClose") && $id("cashClose").addEventListener("click", () => {
        const a = prompt("–ò—Ç–æ–≥ –≤ –∫–∞—Å—Å–µ (PLN):", kasaBalance().toFixed(2)); if (a === null) return; addKasa("zamkniƒôcie", asNum(a), "close", "—Ä—É—á–Ω–æ–π");
      });
      $id("q50") && $id("q50").addEventListener("click", () => { const el = $id("quickAmt"); if (!el) return; el.value = (Number(el.value || 0) + 50).toFixed(2); });
      $id("q100") && $id("q100").addEventListener("click", () => { const el = $id("quickAmt"); if (!el) return; el.value = (Number(el.value || 0) + 100).toFixed(2); });
      $id("q200") && $id("q200").addEventListener("click", () => { const el = $id("quickAmt"); if (!el) return; el.value = (Number(el.value || 0) + 200).toFixed(2); });

      // Speech
      const micBtn = $id("micBtn");
      if (micBtn && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR();
        rec.continuous = false; rec.interimResults = false; rec.maxAlternatives = 1;
        rec.lang = localStorage.getItem("speechLang") || "pl-PL";
        rec.onstart = () => { micBtn.classList.add('on'); $id("micStatus") && ($id("micStatus").textContent = `üéôÔ∏è –°–ª—É—à–∞—é... (${rec.lang})`); };
        rec.onend = () => { micBtn.classList.remove('on'); };
        rec.onresult = (e) => {
          const text = (e.results[0][0].transcript || "").toLowerCase();
          $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: " + text);
          const numMatch = text.match(/(\d+[.,]?\d*)\s*(z≈Ç|pln)?/);
          const num = numMatch ? numMatch[1] : null;
          const isOut = /(wyda|minus|wydat|–≤—ã–¥–∞|–º–∏–Ω—É—Å|—Ä–∞—Å—Ö–æ–¥|–≤–∏–¥–∞—Ç)/.test(text);
          const note = text.replace(/(\d+[.,]?\d*\s*(z≈Ç|pln)?)/, "").trim();
          if (!num) { $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –°—É–º–º—É –Ω–µ –Ω–∞—à—ë–ª"); return; }
          addKasa(isOut ? "wydanie" : "przyjƒôcie", asNum(num), note || "–≥–æ–ª–æ—Å", "voice");
        };
        micBtn.addEventListener("click", () => {
          try {
            const sel = $id("speechLang");
            if (sel) { rec.lang = sel.value; localStorage.setItem("speechLang", rec.lang); }
            rec.start();
          } catch(e) { $id("micStatus") && ($id("micStatus").textContent = "üéôÔ∏è –ù–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å: " + e.message); }
        });
      }

      // OCR —á–µ–∫–∞ –≤ –∫–∞—Å—Å–µ
      $id("cashPhoto") && $id("cashPhoto").addEventListener("change", async e => {
        const f = e.target.files[0]; if (!f) return;
        const text = await ocrRecognizeFile(f);
        const row = ocrTxFromText(text);
        if (row) { tx.push(normalizeRowKeys(row)); try { localStorage.setItem("tx_manual_import", JSON.stringify(tx)); } catch(e){} inferAccounts(); render(); }
      });

      // settings
      $id("applySettings") && $id("applySettings").addEventListener("click", () => {
        localStorage.setItem("cashPLN", $id("cashPLN") ? $id("cashPLN").value : "0");
        localStorage.setItem("penaltyPct", $id("penaltyPct") ? $id("penaltyPct").value : "0.05");
        localStorage.setItem("intervalMin", $id("intervalMin") ? $id("intervalMin").value : "10");
        localStorage.setItem("rateEUR", $id("rateEUR") ? $id("rateEUR").value : "4.30");
        localStorage.setItem("rateUSD", $id("rateUSD") ? $id("rateUSD").value : "3.95");
        localStorage.setItem("blacklist", $id("blacklist") ? $id("blacklist").value : "");
        localStorage.setItem("autoCash", $id("autoCash") && $id("autoCash").checked ? "1" : "0");
        const modeText = (localStorage.getItem("otd_lang") || "ru") === "ru"
          ? "–†–µ–∂–∏–º: " + (($id("autoCash") && $id("autoCash").checked) ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
          : "Mode: " + (($id("autoCash") && $id("autoCash").checked) ? "auto" : "manual");
        if ($id("modeCash")) $id("modeCash").textContent = modeText;
        render();
      });

      // init
      loadKasa();
      try { accMeta = JSON.parse(localStorage.getItem("accMeta") || "{}"); } catch(e) { accMeta = {}; }
      try { tx = JSON.parse(localStorage.getItem("tx_manual_import") || "[]").concat(tx); } catch(e){}
      try { bills = JSON.parse(localStorage.getItem("bills_manual_import") || "[]").concat(bills); } catch(e){}
      renderKasa();
      if ($id("txUrl")) $id("txUrl").value = localStorage.getItem("txUrl") || "";
      if ($id("cashPLN")) $id("cashPLN").value = localStorage.getItem("cashPLN") || "5000";
      if ($id("penaltyPct")) $id("penaltyPct").value = localStorage.getItem("penaltyPct") || "0.05";
      if ($id("intervalMin")) $id("intervalMin").value = localStorage.getItem("intervalMin") || "10";
      if ($id("rateEUR")) $id("rateEUR").value = localStorage.getItem("rateEUR") || "4.30";
      if ($id("rateUSD")) $id("rateUSD").value = localStorage.getItem("rateUSD") || "3.95";
      if ($id("blacklist")) $id("blacklist").value = localStorage.getItem("blacklist") || "";
      if ($id("autoCash")) $id("autoCash").checked = localStorage.getItem("autoCash") === "1";
      const saved = localStorage.getItem("speechLang"); if (saved && $id("speechLang")) $id("speechLang").value = saved;
      if ($id("modeCash")) $id("modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
        ? "–†–µ–∂–∏–º: " + (($id("autoCash") && $id("autoCash").checked) ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
        : "Mode: " + (($id("autoCash") && $id("autoCash").checked) ? "auto" : "manual");
      inferAccounts();
      applyLang(localStorage.getItem('otd_lang') || 'ru');
      render();
    });

  })();
  </script>

  <!-- Patch init (tabs/lang/stripe safety) ‚Äî –∫–∞–∫ —É —Ç–µ–±—è, –Ω–µ —Ç—Ä–æ–≥–∞–ª -->
  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function safeCall(name, ...args){ try{ if (typeof window[name] === 'function') return window[name](...args); return null;}catch(e){return null;} }
    function initTabs(){ const tabs = $$('.tabs .tab'); if (!tabs.length) return; tabs.forEach(t => { t.removeEventListener('click', t._otd_cb); const cb = () => { $$('.tabs .tab').forEach(x=>x.classList.remove('active')); $$('.section').forEach(s=>s.classList.remove('active')); t.classList.add('active'); const sec = t.dataset.sec || t.getAttribute('data-sec') || t.getAttribute('data-section') || t.getAttribute('data-tab'); if (sec) { const el = document.getElementById(sec); if (el) el.classList.add('active'); } if (typeof render === 'function') try { render(); } catch(e){} safeCall('renderPlan'); safeCall('renderForecast'); safeCall('renderKasa'); safeCall('renderAccounts'); }; t._otd_cb = cb; t.addEventListener('click', cb); }); }
    function initLangButtons(){ const langButtons = $$('.lang button, .lang .btn'); if (!langButtons.length) return; langButtons.forEach(b=>{ b.removeEventListener('click', b._otd_cb); const cb = () => { const L = b.dataset.lang || b.getAttribute('data-lang') || b.textContent.trim().slice(0,2).toLowerCase(); if (typeof applyLang === 'function') { try { applyLang(L); } catch(e){} } else if (window.M && window.M[L]) { document.querySelectorAll('[data-i]').forEach(el=>{ const k = el.getAttribute('data-i'); if (window.M[L][k]) el.textContent = window.M[L][k]; }); } langButtons.forEach(x => x.classList.remove('on')); b.classList.add('on'); localStorage.setItem('otd_lang', L); safeCall('render'); }; b._otd_cb = cb; b.addEventListener('click', cb); }); const saved = localStorage.getItem('otd_lang') || 'ru'; const btn = langButtons.find(b=> (b.dataset.lang||'').toLowerCase()===saved); if (btn) btn._otd_cb(); }
    function ensureRenderers(){ if (typeof render === 'function') try { render(); } catch(e) {} if (typeof renderAccounts === 'function') try { renderAccounts(); } catch(e) {} if (typeof renderKasa === 'function') try { renderKasa(); } catch(e) {} if (typeof renderPlan === 'function') try { renderPlan(); } catch(e) {} if (typeof renderForecast === 'function') try { renderForecast(); } catch(e) {} }
    function initAll(){ try { initTabs(); } catch(e){} try { initLangButtons(); } catch(e){} try { ensureRenderers(); } catch(e){} }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initAll); else initAll();
    window.OTD_PATCH = { init: initAll };
  })();
  </script>
</body>
</html>
