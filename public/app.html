<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OneTapDay â€” AI KsiÄ™gowy (MVP)</title>
  <style>
    :root{
      --accent:#35D36B;--bg:#0d0f10;--card:#15181a;--muted:#9aa3a9;--text:#e6edf3;
      --danger:#ff7070;--warn:#f4d06f;--pos:#a8e8c7;--neg:#ff8a8a
    }
    html,body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;-webkit-tap-highlight-color:transparent}
    button,select,input,label{touch-action:manipulation}
    .wrap{max-width:1240px;margin:0 auto;padding:12px 16px 48px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;position:relative;z-index:2}
    .brand{font-weight:700}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;position:relative;z-index:2}
    .tab{padding:8px 12px;border-radius:10px;background:#0f1214;border:1px solid #20262b;color:#cfe6d7;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#08110b;border-color:#49e084}
    .section{display:none;margin-top:14px;position:relative;z-index:1}
    .section.active{display:block}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #22282c;border-radius:12px;padding:14px}
    .muted{color:var(--muted);font-size:13px}
    .kpi{font-size:34px;font-weight:800;margin:2px 0 0}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#08110b;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#20262b;color:#fff;border:1px solid #2a3136}
    .btn.ghost{background:transparent;color:#e6edf3;border:1px dashed #2a3136}
    .btn.link{background:transparent;border:0;color:#9fe8b8;text-decoration:underline;cursor:pointer}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #242b30;padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:#9aa3a9;font-weight:600}
    .pill{display:inline-block;padding:3px 9px;border-radius:999px;background:#0f1214;border:1px solid #20262b;color:#9aa3a9;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px}
    .due{background:#2a1f1f;color:#ffb3b3;border:1px solid #4d3030}
    .overdue{background:#381f1f;color:#ff8a8a;border:1px solid #5c2a2a}
    .cand{background:#23221a;color:#e3e0b0;border:1px solid #49452c}
    .ai{background:#1a2320;color:#a8e8c7;border:1px solid #274b32}
    .barwrap{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .bar{background:#0f1214;border:1px solid #20262b;border-radius:8px;padding:6px;text-align:center}
    .bar .h{height:36px;background:#203026;border:1px solid #2e4635;border-radius:6px;margin:4px 0}
    .bar.neg .h{background:#3a2222;border-color:#5b3030}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=file],input[type=text],input[type=number],select{background:#0f1214;border:1px solid #20262b;border-radius:8px;color:#e6edf3;padding:9px}
    input::placeholder{color:#6f7a80}
    .right{margin-left:auto}
    .mic{border-radius:50%;width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border:2px solid #2a3136;background:#0f1214;cursor:pointer}
    .mic.on{background:#1d2;color:#08110b;border-color:#3f6}
    .thumb{max-height:60px;border:1px solid #2a3136;border-radius:8px;margin-left:8px}
    .amt-pos{color:var(--pos);font-weight:700}
    .amt-neg{color:var(--neg);font-weight:700}
    .lang{display:flex;gap:6px;margin-left:12px}
    .lang button{padding:4px 8px;border-radius:999px;border:1px solid #20262b;background:#0f1214;color:#9aa3a9;font-size:12px;cursor:pointer}
    .lang button.on{background:#274b32;color:#a8e8c7;border-color:#274b32}
    .gate{background:#2a1f1f;border:1px solid #4d3030;color:#ffb3b3;padding:12px;border-radius:10px;margin-top:10px}
    .hint{font-size:12px;color:#9aa3a9}
    .kasa-quick{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .kasa-quick button{padding:6px 10px;border-radius:8px;border:1px solid #2a3136;background:#0f1214;color:#e6edf3;cursor:pointer;font-size:13px}
    .actions button{background:#0f1214;border:1px solid #2a3136;color:#e6edf3;border-radius:6px;padding:4px 8px;cursor:pointer}
    .actions button:hover{border-color:#3a4248}
    .inline-edit{display:flex;gap:6px;flex-wrap:wrap}
    .hidden{display:none !important}
    @media (max-width:1080px){.cards{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}}
    @media print{.tabs,.btn,.row input,.toast,.lang{display:none !important}body{background:#fff;color:#000}.card{background:#fff;border:1px solid #999}.wrap{max-width:1000px}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand"><b>OneTapDay â€” AI KsiÄ™gowy</b> <span class="pill">MVP</span></div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">Panel</div>
      <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciÄ…g</div>
      <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
      <div class="tab" data-sec="konta" data-i="tab_accounts">Konta</div>
      <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa</div>
      <div class="tab" data-sec="ustawienia" data-i="tab_settings">Ustawienia</div>
      <div class="lang" id="langBarMain">
        <button data-lang="pl" class="on">PL</button>
        <button data-lang="ru">RU</button>
        <button data-lang="en">EN</button>
        <button data-lang="uk">UK</button>
      </div>
    </div>
  </div>

  <!-- ACCESS GATE (hidden if demo/sub active) -->
  <div id="gate" class="gate hidden">
    <div data-i="gate_locked_title" style="font-weight:700;margin-bottom:6px">DostÄ™p zablokowany</div>
    <div class="muted" data-i="gate_locked_desc">
      Okres demo zakoÅ„czony lub brak aktywnej subskrypcji. PrzejdÅº do UstawieÅ„, aby uruchomiÄ‡ demo (24h) lub opÅ‚aciÄ‡ dostÄ™p.
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn secondary" onclick="document.querySelector('[data-sec=ustawienia]').click()" data-i="gate_open_settings">OtwÃ³rz Ustawienia</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="pulpit" class="section active">
    <div class="cards">
      <div class="card"><div class="muted" data-i="kpi_due_today">Do zapÅ‚aty dziÅ›</div><div id="kpiDue" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_unmatched">Niesparowane transakcje</div><div id="kpiUnmatch" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_banks">Bilans bankÃ³w</div><div id="kpiBank" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_cash">Kasa (PLN)</div><div id="kpiCash" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_total">DostÄ™pnie razem</div><div id="kpiAvail" class="kpi">0</div></div>
      <div class="card"><div class="muted" data-i="kpi_gap_today">Brak Å›rodkÃ³w dziÅ›</div><div id="kpiGap" class="kpi">0</div></div>
    </div>

    <div class="row" style="margin:10px 0">
      <button id="syncNow" class="btn" data-i="btn_sync">Synchronizuj</button>
      <button id="runAI" class="btn secondary" data-i="btn_ai_match">Dopasowanie AI</button>
      <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">Akceptuj bezpieczne pary</button>
      <button id="exportPDF" class="btn secondary" data-i="btn_pdf">Raport PDF</button>
      <span id="lastSync" class="pill" data-i="sync_ts">Synchronizacja: â€”</span>
      <span class="right pill" id="modeCash">Mode: auto</span>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="font-weight:700" data-i="minpay_title">Minimalna pÅ‚atnoÅ›Ä‡ (kara-stop)</div>
        <div id="minPayBox" class="muted">â€”</div>
        <div class="row" style="margin-top:6px">
          <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">Oznacz jako opÅ‚acone</button>
        </div>
      </div>
      <div class="card">
        <div style="font-weight:700" data-i="forecast_7d">Prognoza 7 dni</div>
        <div class="muted" data-i="forecast7d_note">Liczy PLN-konta z wyciÄ…gu (wÅ‚Ä…czone) + kasa.</div>
        <div id="forecastBars" class="barwrap"></div>
        <div id="forecastMeta" class="muted" style="margin-top:6px">â€”</div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div style="font-weight:700" data-i="forecast_30d">Prognoza 30 dni</div>
        <div class="muted" data-i="forecast30_note">Autoprognoza z wyciÄ…gÃ³w + kasa na 30 dni.</div>
        <div id="forecast30Table" class="muted">â€”</div>
      </div>
      <div class="card">
        <div style="font-weight:700" data-i="month_summary_title">Podsumowanie miesiÄ…ca</div>
        <div id="monthSummary" class="muted">â€”</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row">
        <div style="font-weight:700" data-i="plan_title">Plan pÅ‚atnoÅ›ci pod kasÄ™</div>
        <div class="right">
          <span data-i="filter_label">Filtr:</span>
          <select id="planFilter">
            <option value="today" data-i="filter_today">DziÅ›</option>
            <option value="7d" data-i="filter_7d" selected>7 dni</option>
            <option value="all" data-i="filter_all">Wszystko</option>
          </select>
        </div>
        <label style="margin-left:10px">
          <input type="checkbox" id="excludeBlacklist"/> <span data-i="exclude_blacklist">Wyklucz blacklistÄ™</span>
        </label>
      </div>
      <div class="row" style="margin:8px 0">
        <button id="makePlan" class="btn secondary" data-i="btn_make_plan">UtwÃ³rz plan</button>
        <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">Zastosuj plan</button>
        <span id="planMeta" class="pill">â€”</span>
      </div>
      <table id="planTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="plan_th_invoice">Faktura</th>
            <th data-i="plan_th_supplier">Dostawca</th>
            <th data-i="plan_th_due">Termin</th>
            <th data-i="plan_th_amount">Kwota</th>
            <th data-i="plan_th_reason">PowÃ³d</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- STATEMENT -->
  <div id="wyciag" class="section">
    <div class="row">
      <label class="btn ghost">
        <input id="txFile" type="file" accept=".csv" style="display:none"/>
        <span data-i="upload_statement">ZaÅ‚aduj wyciÄ…g (CSV)</span>
      </label>

      <label class="btn ghost">
        <input id="txImage" type="file" accept="image/*" multiple style="display:none"/>
        <span data-i="upload_statement_image">ZaÅ‚aduj zrzut wyciÄ…gu (galeria)</span>
      </label>

      <img id="txLastThumb" class="thumb" style="display:none"/>

      <input id="txUrl" type="text" placeholder="" data-i-ph="placeholder_csv_url"/>
      <button id="saveTxUrl" class="btn secondary" data-i="save_url">Zapisz URL</button>
      <span class="muted" data-i="statement_columns_note">
        Kolumny: Data ksiÄ™gowania, ID transakcji, ID konta (lub IBAN), Kontrahent, TytuÅ‚/Opis, Kwota(Â±), Waluta, Status, Saldo?
      </span>
    </div>
    <table id="txTable">
      <thead>
        <tr>
          <th data-i="th_date">Data</th>
          <th data-i="th_account">Konto</th>
          <th data-i="th_counterparty">Kontrahent</th>
          <th data-i="th_desc">Opis</th>
          <th data-i="th_amount">Kwota</th>
          <th data-i="th_currency">Waluta</th>
          <th data-i="th_status">Status</th>
          <th data-i="th_actions">DziaÅ‚ania</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- INVOICES -->
  <div id="faktury" class="section">
    <div class="row" style="align-items:center;margin-bottom:8px">
      <label class="btn ghost">
        <input id="billFile" type="file" accept=".csv" style="display:none"/>
        <span data-i="upload_invoices">ZaÅ‚aduj faktury (CSV)</span>
      </label>
      <label class="btn ghost">
        <input id="billImage" type="file" accept="image/*" multiple style="display:none"/>
        <span data-i="upload_invoice_images">ZaÅ‚aduj zdjÄ™cia faktur</span>
      </label>
      <span class="muted" style="margin-left:12px" data-i="invoices_note">Tu wykrywamy numer faktury, kwotÄ™ i datÄ™.</span>
    </div>
    <table id="billTable">
      <thead>
        <tr>
          <th data-i="inv_th_due">Termin</th>
          <th data-i="inv_th_number">Nr</th>
          <th data-i="inv_th_supplier">Dostawca</th>
          <th data-i="inv_th_amount">Kwota</th>
          <th data-i="inv_th_currency">Waluta</th>
          <th data-i="inv_th_status">Status</th>
          <th data-i="inv_th_candidate">Kandydat</th>
          <th data-i="inv_th_score">Score</th>
          <th data-i="inv_th_action">DziaÅ‚anie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ACCOUNTS -->
  <div id="konta" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="auto_accounts_title">Konta z wyciÄ…gu (auto)</div>
      <div class="muted" data-i="auto_accounts_desc">Edycja waluty, salda poczÄ…tkowego i uwzglÄ™dnienia w planie.</div>
      <table id="autoAcc">
        <thead>
          <tr>
            <th data-i="acc_th_account">Konto</th>
            <th data-i="acc_th_type">Typ</th>
            <th data-i="acc_th_currency">Waluta</th>
            <th data-i="acc_th_balance_calc">Saldo (oblicz)</th>
            <th data-i="acc_th_start_balance">Start</th>
            <th data-i="acc_th_include">UwzglÄ™dnij</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- CASH -->
  <div id="kasa" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="cash_title">Kasa â€” szybkie operacje</div>
      <div class="muted" data-i="cash_note">GÅ‚osowa kasa + szybkie przyciski</div>
      <div id="kasaQuickHolder" class="kasa-quick"></div>

      <div class="row" style="margin-top:8px;align-items:center">
        <input id="quickAmt" type="number" step="0.01" placeholder="0.00" data-i-ph="ph_amount" style="width:120px"/>
        <input id="quickNote" type="text" placeholder="" data-i-ph="ph_comment" style="width:300px"/>
        <button id="addIn" class="btn secondary" data-i="btn_add_in">+ PrzyjÄ™cie</button>
        <button id="addOut" class="btn secondary" data-i="btn_add_out">âˆ’ Wydanie</button>
        <button id="q50" class="btn ghost">+50</button>
        <button id="q100" class="btn ghost">+100</button>
        <button id="q200" class="btn ghost">+200</button>
        <div style="margin-left:12px">
          <button id="cashClose" class="btn" data-i="btn_close_shift">Zamknij zmianÄ™</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <label data-i="speech_lang_label">JÄ™zyk rozpoznawania:</label>
        <select id="speechLang">
          <option value="pl-PL">PL</option>
          <option value="ru-RU">RU</option>
          <option value="en-US">EN</option>
          <option value="uk-UA">UK</option>
        </select>
        <button id="micBtn" class="mic" title="Voice">ðŸŽ¤</button>
        <span id="micStatus" class="muted" style="margin-left:8px">â€”</span>
      </div>

      <div style="margin-top:12px">
        <input id="cashPhoto" type="file" accept="image/*" style="display:inline-block"/>
        <span class="muted" data-i="cash_photo_note">ZdjÄ™cie paragonu/wyciÄ…gu â€” wykryj kwotÄ™ i opis.</span>
      </div>

      <table id="kasaTable" style="margin-top:12px">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">Data</th>
            <th data-i="cash_th_type">Typ</th>
            <th data-i="cash_th_amount">Kwota</th>
            <th data-i="cash_th_source">Å¹rÃ³dÅ‚o</th>
            <th data-i="cash_th_comment">Komentarz</th>
            <th data-i="th_actions">DziaÅ‚ania</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="ustawienia" class="section">
    <div class="card">
      <div style="font-weight:700" data-i="parameters">Parametry</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div>
          <label data-i="param_cash_label">RÄ™czna dostÄ™pna kasa dziÅ› (PLN):</label>
          <input id="cashPLN" type="text"/><br/>
          <label data-i="param_penalty_label">Kara, %/dzieÅ„:</label>
          <input id="penaltyPct" type="text"/><br/>
          <label data-i="param_interval_label">InterwaÅ‚ synchronizacji, min:</label>
          <input id="intervalMin" type="text"/>
        </div>
        <div>
          <label data-i="rateEUR_label">rateEUR:</label> <input id="rateEUR" type="text"/><br/>
          <label data-i="rateUSD_label">rateUSD:</label> <input id="rateUSD" type="text"/><br/>
          <label data-i="blacklist_label">Czarna lista (przecinki):</label> <input id="blacklist" type="text"/><br/>
          <label><input id="autoCash" type="checkbox"/> <span data-i="auto_mode_label">Auto: z kont wyciÄ…gu (wÅ‚Ä…czone) + kasa</span></label>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <button id="applySettings" class="btn secondary" data-i="btn_save_settings">Zapisz</button>
        <button id="exportCfg" class="btn ghost" data-i="btn_export_settings">Eksport ustawieÅ„</button>
        <label class="btn ghost"><span data-i="btn_import_settings">Import ustawieÅ„</span> <input id="importCfg" type="file" style="display:none"/></label>
        <button id="clearAll" class="btn ghost" data-i="btn_clear_all">WyczyÅ›Ä‡ historiÄ™ (lokalnie)</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700" data-i="sub_title">Subskrypcja / Demo</div>
      <div class="muted" id="subStatus">â€”</div>
      <div class="row" style="margin-top:8px">
        <button id="startDemo" class="btn secondary" data-i="btn_start_demo">Uruchom demo (24h)</button>
        <button id="payNow" class="btn" data-i="btn_pay_sub">OpÅ‚aÄ‡ subskrypcjÄ™</button>
        <button id="endDemo" class="btn ghost" data-i="btn_end_demo">ZakoÅ„cz demo</button>
      </div>
      <div class="hint" style="margin-top:6px" data-i="sub_hint">
        OpÅ‚ata dostÄ™pna tylko tutaj. JeÅ›li masz link Stripe â€” ustaw <code>localStorage.stripe_link</code>.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* ==== CONFIG / API ==== */
const API_BASE = '/api';
const SUB_KEY = 'otd_sub_active';
const SUB_FROM = 'otd_sub_from';
const SUB_TO   = 'otd_sub_to';
const DEMO_START = 'otd_demo_started_at';
const USER_KEY = 'otd_user'; // email

/* ==== I18N ==== */
const M = {
  ru:{ /* â€”â€”â€” RU â€”â€”â€” */
    tab_dashboard:"ÐŸÑƒÐ»ÑŒÑ‚", tab_statement:"Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°", tab_invoices:"Ð¤Ð°ÐºÑ‚ÑƒÑ€Ñ‹", tab_accounts:"Ð¡Ñ‡ÐµÑ‚Ð°", tab_cash:"ÐšÐ°ÑÑÐ°", tab_settings:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
    gate_locked_title:"Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½",
    gate_locked_desc:"Ð”ÐµÐ¼Ð¾ Ð¸ÑÑ‚ÐµÐºÐ»Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð´ÐµÐ¼Ð¾ (24 Ñ‡) Ð¸Ð»Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿.",
    gate_open_settings:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
    kpi_due_today:"Ðš Ð¾Ð¿Ð»Ð°Ñ‚Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ", kpi_unmatched:"ÐÐµÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸", kpi_banks:"Ð‘Ð°Ð½ÐºÐ¸ Ð² Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ðµ", kpi_cash:"ÐšÐ°ÑÑÐ° (Ð½Ð°Ð»)", kpi_total:"Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð²ÑÐµÐ³Ð¾", kpi_gap_today:"Ð Ð°Ð·Ñ€Ñ‹Ð² ÐºÐ°ÑÑÑ‹ ÑÐµÐ³Ð¾Ð´Ð½Ñ",
    btn_sync:"Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ", btn_ai_match:"Ð˜Ð˜-ÑÐ²ÐµÑ€ÐºÐ°", btn_accept_safe:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ñ‹", btn_pdf:"PDF Ð¾Ñ‚Ñ‡Ñ‘Ñ‚", sync_ts:"Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: â€”",
    minpay_title:"ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð»Ð°Ñ‚Ñ‘Ð¶ (ÑˆÑ‚Ñ€Ð°Ñ„-ÑÑ‚Ð¾Ð¿)", btn_apply_minpay:"ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ðº Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾",
    forecast_7d:"ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· 7 Ð´Ð½ÐµÐ¹", forecast7d_note:"Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ PLN-ÑÑ‡ÐµÑ‚Ð° (Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½Ð½Ñ‹Ðµ) + ÐºÐ°ÑÑÑƒ.",
    forecast_30d:"ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· 30 Ð´Ð½ÐµÐ¹", forecast30_note:"ÐÐ²Ñ‚Ð¾Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¿Ð¾ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ°Ð¼ + ÐºÐ°ÑÑÐµ Ð½Ð° 30 Ð´Ð½ÐµÐ¹.",
    month_summary_title:"Ð˜Ñ‚Ð¾Ð³Ð¸ Ð¼ÐµÑÑÑ†Ð°",
    plan_title:"ÐŸÐ»Ð°Ð½ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ Ð¿Ð¾Ð´ ÐºÐ°ÑÑÑƒ", filter_label:"Ð¤Ð¸Ð»ÑŒÑ‚Ñ€:", filter_today:"Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ", filter_7d:"7 Ð´Ð½ÐµÐ¹", filter_all:"Ð’ÑÐµ", exclude_blacklist:"Ð˜ÑÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ blacklist",
    btn_make_plan:"Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ", btn_apply_plan:"ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ",
    plan_th_invoice:"Ð¤Ð°ÐºÑ‚ÑƒÑ€Ð°", plan_th_supplier:"ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº", plan_th_due:"Ð¡Ñ€Ð¾Ðº", plan_th_amount:"Ð¡ÑƒÐ¼Ð¼Ð°", plan_th_reason:"ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°",
    upload_statement:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ (CSV)", upload_statement_image:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð½ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ (Ð³Ð°Ð»ÐµÑ€ÐµÑ)",
    placeholder_csv_url:"URL CSV Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸", save_url:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ URL",
    statement_columns_note:"ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸: Ð´Ð°Ñ‚Ð°, id Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸, id ÑÑ‡Ñ‘Ñ‚Ð°/IBAN, ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚, Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ, ÑÑƒÐ¼Ð¼Ð°(Â±), Ð²Ð°Ð»ÑŽÑ‚Ð°, ÑÑ‚Ð°Ñ‚ÑƒÑ, saldo?",
    th_date:"Ð”Ð°Ñ‚Ð°", th_account:"Ð¡Ñ‡Ñ‘Ñ‚", th_counterparty:"ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚", th_desc:"ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ", th_amount:"Ð¡ÑƒÐ¼Ð¼Ð°", th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", th_status:"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ", th_actions:"Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ",
    upload_invoices:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÑ‡ÐµÑ‚Ð° (CSV)", upload_invoice_images:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾ Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹", invoices_note:"Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°ÑŽÑ‚ÑÑ â„– Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹, ÑÑƒÐ¼Ð¼Ñ‹ Ð¸ Ð´Ð°Ñ‚Ñ‹.",
    inv_th_due:"Ð¡Ñ€Ð¾Ðº", inv_th_number:"â„–", inv_th_supplier:"ÐŸÐ¾ÑÑ‚Ð°Ð²Ñ‰Ð¸Ðº", inv_th_amount:"Ð¡ÑƒÐ¼Ð¼Ð°", inv_th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", inv_th_status:"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ", inv_th_candidate:"ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚", inv_th_score:"Score", inv_th_action:"Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ",
    auto_accounts_title:"Ð¡Ñ‡ÐµÑ‚Ð° Ð¸Ð· Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ (Ð°Ð²Ñ‚Ð¾)", auto_accounts_desc:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹ Ð²Ð°Ð»ÑŽÑ‚Ñƒ, ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð¿Ð»Ð°Ð½.",
    acc_th_account:"Ð¡Ñ‡Ñ‘Ñ‚", acc_th_type:"Ð¢Ð¸Ð¿", acc_th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", acc_th_balance_calc:"Ð‘Ð°Ð»Ð°Ð½Ñ (Ñ€Ð°ÑÑ‡Ñ‘Ñ‚)", acc_th_start_balance:"Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ", acc_th_include:"Ð’ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚",
    cash_title:"ÐšÐ°ÑÑÐ° â€” Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸", cash_note:"Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð°Ñ ÐºÐ°ÑÑÐ° + Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸",
    btn_add_in:"+ ÐŸÑ€Ð¸Ñ‘Ð¼", btn_add_out:"âˆ’ Ð’Ñ‹Ð´Ð°Ñ‡Ð°", btn_close_shift:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐ¼ÐµÐ½Ñƒ",
    speech_lang_label:"Ð¯Ð·Ñ‹Ðº Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ:", cash_photo_note:"Ð¤Ð¾Ñ‚Ð¾ Ñ‡ÐµÐºÐ°/Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ â€” Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ.",
    cash_th_date:"Ð”Ð°Ñ‚Ð°", cash_th_type:"Ð¢Ð¸Ð¿", cash_th_amount:"Ð¡ÑƒÐ¼Ð¼Ð°", cash_th_source:"Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº", cash_th_comment:"ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹",
    parameters:"ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹", param_cash_label:"Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°Ñ ÐºÐ°ÑÑÐ° ÑÐµÐ³Ð¾Ð´Ð½Ñ (PLN):", param_penalty_label:"ÐŸÐµÐ½Ñ, %/Ð´ÐµÐ½ÑŒ:", param_interval_label:"Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» ÑÐ¸Ð½Ñ…Ð°, Ð¼Ð¸Ð½:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Blacklist (Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ):", auto_mode_label:"ÐÐ²Ñ‚Ð¾: Ð¸Ð· ÑÑ‡ÐµÑ‚Ð¾Ð² (Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½Ð½Ñ‹Ðµ) + ÐºÐ°ÑÑÐ°",
    btn_save_settings:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ", btn_export_settings:"Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº", btn_import_settings:"Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº",
    btn_clear_all:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾)",
    sub_title:"ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ° / Ð”ÐµÐ¼Ð¾", btn_start_demo:"Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð´ÐµÐ¼Ð¾ (24 Ñ‡)", btn_pay_sub:"ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ", btn_end_demo:"Ð—Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ñ‚ÑŒ Ð´ÐµÐ¼Ð¾",
    sub_hint:"ÐžÐ¿Ð»Ð°Ñ‚Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ…. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÑÑ‹Ð»ka Stripe â€” Ð¿Ð¾Ð»Ð¾Ð¶Ð¸ Ð² localStorage.stripe_link.",
    ph_amount:"Ð¡ÑƒÐ¼Ð¼Ð°", ph_comment:"ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹"
  },
  en:{ /* â€”â€”â€” EN â€”â€”â€” */
    tab_dashboard:"Dashboard", tab_statement:"Statement", tab_invoices:"Invoices", tab_accounts:"Accounts", tab_cash:"Cash", tab_settings:"Settings",
    gate_locked_title:"Access locked",
    gate_locked_desc:"Demo ended or subscription inactive. Go to Settings to start a 24h demo or pay.",
    gate_open_settings:"Open Settings",
    kpi_due_today:"Due today", kpi_unmatched:"Unmatched transactions", kpi_banks:"Bank balances", kpi_cash:"Cash (PLN)", kpi_total:"Available total", kpi_gap_today:"Cash gap today",
    btn_sync:"Sync", btn_ai_match:"AI match", btn_accept_safe:"Accept safe matches", btn_pdf:"PDF report", sync_ts:"Sync: â€”",
    minpay_title:"Minimum payment (penalty-stop)", btn_apply_minpay:"Mark as paid",
    forecast_7d:"7-day forecast", forecast7d_note:"Calculates included PLN accounts + cash.",
    forecast_30d:"30-day forecast", forecast30_note:"Auto-forecast from statements + cash.",
    month_summary_title:"Month summary",
    plan_title:"Payment plan for cash", filter_label:"Filter:", filter_today:"Today", filter_7d:"7 days", filter_all:"All", exclude_blacklist:"Exclude blacklist",
    btn_make_plan:"Build plan", btn_apply_plan:"Apply plan",
    plan_th_invoice:"Invoice", plan_th_supplier:"Supplier", plan_th_due:"Due", plan_th_amount:"Amount", plan_th_reason:"Reason",
    upload_statement:"Upload statement (CSV)", upload_statement_image:"Upload statement screenshot (gallery)",
    placeholder_csv_url:"CSV statement URL", save_url:"Save URL",
    statement_columns_note:"Columns: booking date, tx id, account id/IBAN, counterparty, title/description, amount(Â±), currency, status, balance?",
    th_date:"Date", th_account:"Account", th_counterparty:"Counterparty", th_desc:"Description", th_amount:"Amount", th_currency:"Currency", th_status:"Status", th_actions:"Actions",
    upload_invoices:"Upload invoices (CSV)", upload_invoice_images:"Upload invoice photos", invoices_note:"We detect invoice numbers, amounts and dates.",
    inv_th_due:"Due", inv_th_number:"No", inv_th_supplier:"Supplier", inv_th_amount:"Amount", inv_th_currency:"Currency", inv_th_status:"Status", inv_th_candidate:"Candidate", inv_th_score:"Score", inv_th_action:"Action",
    auto_accounts_title:"Accounts from statement (auto)", auto_accounts_desc:"Edit currency, start balance and include-in-plan.",
    acc_th_account:"Account", acc_th_type:"Type", acc_th_currency:"Currency", acc_th_balance_calc:"Balance (calc)", acc_th_start_balance:"Start", acc_th_include:"Include",
    cash_title:"Cash â€” quick ops", cash_note:"Voice cash + quick buttons",
    btn_add_in:"+ In", btn_add_out:"âˆ’ Out", btn_close_shift:"Close shift",
    speech_lang_label:"Recognition language:", cash_photo_note:"Receipt/statement photo â€” detect amount and description.",
    cash_th_date:"Date", cash_th_type:"Type", cash_th_amount:"Amount", cash_th_source:"Source", cash_th_comment:"Comment",
    parameters:"Parameters", param_cash_label:"Manual available cash today (PLN):", param_penalty_label:"Penalty, %/day:", param_interval_label:"Sync interval, min:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Blacklist (comma):", auto_mode_label:"Auto: from included statement accounts + cash",
    btn_save_settings:"Save", btn_export_settings:"Export settings", btn_import_settings:"Import settings",
    btn_clear_all:"Clear history (local)",
    sub_title:"Subscription / Demo", btn_start_demo:"Start demo (24h)", btn_pay_sub:"Pay subscription", btn_end_demo:"End demo",
    sub_hint:"Payment only in Settings. If you have a Stripe link, put it in localStorage.stripe_link.",
    ph_amount:"Amount", ph_comment:"Comment"
  },
  pl:{ /* â€”â€”â€” PL â€”â€”â€” */
    tab_dashboard:"Panel", tab_statement:"WyciÄ…g", tab_invoices:"Faktury", tab_accounts:"Konta", tab_cash:"Kasa", tab_settings:"Ustawienia",
    gate_locked_title:"DostÄ™p zablokowany",
    gate_locked_desc:"Demo zakoÅ„czone lub brak subskrypcji. PrzejdÅº do UstawieÅ„, aby uruchomiÄ‡ demo (24h) lub opÅ‚aciÄ‡.",
    gate_open_settings:"OtwÃ³rz Ustawienia",
    kpi_due_today:"Do zapÅ‚aty dziÅ›", kpi_unmatched:"Niesparowane transakcje", kpi_banks:"Bilans bankÃ³w", kpi_cash:"Kasa (PLN)", kpi_total:"DostÄ™pnie razem", kpi_gap_today:"Brak Å›rodkÃ³w dziÅ›",
    btn_sync:"Synchronizuj", btn_ai_match:"Dopasowanie AI", btn_accept_safe:"Akceptuj bezpieczne pary", btn_pdf:"Raport PDF", sync_ts:"Synchronizacja: â€”",
    minpay_title:"Minimalna pÅ‚atnoÅ›Ä‡ (kara-stop)", btn_apply_minpay:"Oznacz jako opÅ‚acone",
    forecast_7d:"Prognoza 7 dni", forecast7d_note:"Liczy wÅ‚Ä…czone konta PLN + kasa.",
    forecast_30d:"Prognoza 30 dni", forecast30_note:"Autoprognoza z wyciÄ…gÃ³w + kasa na 30 dni.",
    month_summary_title:"Podsumowanie miesiÄ…ca",
    plan_title:"Plan pÅ‚atnoÅ›ci pod kasÄ™", filter_label:"Filtr:", filter_today:"DziÅ›", filter_7d:"7 dni", filter_all:"Wszystko", exclude_blacklist:"Wyklucz blacklistÄ™",
    btn_make_plan:"UtwÃ³rz plan", btn_apply_plan:"Zastosuj plan",
    plan_th_invoice:"Faktura", plan_th_supplier:"Dostawca", plan_th_due:"Termin", plan_th_amount:"Kwota", plan_th_reason:"PowÃ³d",
    upload_statement:"ZaÅ‚aduj wyciÄ…g (CSV)", upload_statement_image:"ZaÅ‚aduj zrzut wyciÄ…gu (galeria)",
    placeholder_csv_url:"URL CSV wyciÄ…gu", save_url:"Zapisz URL",
    statement_columns_note:"Kolumny: Data ksiÄ™gowania, ID transakcji, ID konta/IBAN, Kontrahent, TytuÅ‚/Opis, Kwota(Â±), Waluta, Status, Saldo?",
    th_date:"Data", th_account:"Konto", th_counterparty:"Kontrahent", th_desc:"Opis", th_amount:"Kwota", th_currency:"Waluta", th_status:"Status", th_actions:"DziaÅ‚ania",
    upload_invoices:"ZaÅ‚aduj faktury (CSV)", upload_invoice_images:"ZaÅ‚aduj zdjÄ™cia faktur", invoices_note:"Wykrywamy nr faktury, kwotÄ™ i datÄ™.",
    inv_th_due:"Termin", inv_th_number:"Nr", inv_th_supplier:"Dostawca", inv_th_amount:"Kwota", inv_th_currency:"Waluta", inv_th_status:"Status", inv_th_candidate:"Kandydat", inv_th_score:"Score", inv_th_action:"Akcja",
    auto_accounts_title:"Konta z wyciÄ…gu (auto)", auto_accounts_desc:"Edycja waluty, salda poczÄ…tkowego i uwzglÄ™dnienia w planie.",
    acc_th_account:"Konto", acc_th_type:"Typ", acc_th_currency:"Waluta", acc_th_balance_calc:"Saldo (oblicz)", acc_th_start_balance:"Start", acc_th_include:"UwzglÄ™dnij",
    cash_title:"Kasa â€” szybkie operacje", cash_note:"GÅ‚osowa kasa + szybkie przyciski",
    btn_add_in:"+ PrzyjÄ™cie", btn_add_out:"âˆ’ Wydanie", btn_close_shift:"Zamknij zmianÄ™",
    speech_lang_label:"JÄ™zyk rozpoznawania:", cash_photo_note:"ZdjÄ™cie paragonu/wyciÄ…gu â€” wykryj kwotÄ™ i opis.",
    cash_th_date:"Data", cash_th_type:"Typ", cash_th_amount:"Kwota", cash_th_source:"Å¹rÃ³dÅ‚o", cash_th_comment:"Komentarz",
    parameters:"Parametry", param_cash_label:"RÄ™czna dostÄ™pna kasa dziÅ› (PLN):", param_penalty_label:"Kara, %/dzieÅ„:", param_interval_label:"InterwaÅ‚ synchronizacji, min:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Czarna lista (przecinki):", auto_mode_label:"Auto: z kont wyciÄ…gu (wÅ‚Ä…czone) + kasa",
    btn_save_settings:"Zapisz", btn_export_settings:"Eksport ustawieÅ„", btn_import_settings:"Import ustawieÅ„",
    btn_clear_all:"WyczyÅ›Ä‡ historiÄ™ (lokalnie)",
    sub_title:"Subskrypcja / Demo", btn_start_demo:"Uruchom demo (24h)", btn_pay_sub:"OpÅ‚aÄ‡ subskrypcjÄ™", btn_end_demo:"ZakoÅ„cz demo",
    sub_hint:"PÅ‚atnoÅ›Ä‡ tylko w Ustawieniach. JeÅ›li masz link Stripe â€” ustaw w localStorage.stripe_link.",
    ph_amount:"Kwota", ph_comment:"Komentarz"
  },
  uk:{ /* â€”â€”â€” UK â€”â€”â€” */
    tab_dashboard:"ÐŸÑƒÐ»ÑŒÑ‚", tab_statement:"Ð’Ð¸Ð¿Ð¸ÑÐºÐ°", tab_invoices:"Ð Ð°Ñ…ÑƒÐ½ÐºÐ¸", tab_accounts:"Ð Ð°Ñ…ÑƒÐ½ÐºÐ¸", tab_cash:"ÐšÐ°ÑÐ°", tab_settings:"ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ",
    gate_locked_title:"Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¾Ð²Ð°Ð½Ð¾",
    gate_locked_desc:"Ð”ÐµÐ¼Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ Ð°Ð±Ð¾ Ð½ÐµÐ¼Ð°Ñ” Ð¿Ñ–Ð´Ð¿Ð¸ÑÐºÐ¸. ÐŸÐµÑ€ÐµÐ¹Ð´Ñ–Ñ‚ÑŒ Ñƒ ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ, Ñ‰Ð¾Ð± Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð´ÐµÐ¼Ð¾ (24 Ð³Ð¾Ð´) Ð°Ð±Ð¾ Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿.",
    gate_open_settings:"Ð’Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¸ ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ",
    kpi_due_today:"Ð”Ð¾ ÑÐ¿Ð»Ð°Ñ‚Ð¸ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–", kpi_unmatched:"ÐÐµÐ¿Ð¾Ð²Ê¼ÑÐ·Ð°Ð½Ñ– Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ñ–Ñ—", kpi_banks:"Ð‘Ð°Ð»Ð°Ð½Ñ Ð±Ð°Ð½ÐºÑ–Ð²", kpi_cash:"ÐšÐ°ÑÐ° (PLN)", kpi_total:"Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð²ÑÑŒÐ¾Ð³Ð¾", kpi_gap_today:"Ð Ð¾Ð·Ñ€Ð¸Ð² ÐºÐ°ÑÐ¸ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–",
    btn_sync:"Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ñ–Ð·Ð°Ñ†Ñ–Ñ", btn_ai_match:"AI-Ð·Ð²Ñ–Ñ€ÐºÐ°", btn_accept_safe:"ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¸ Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ñ– Ð¿Ð°Ñ€Ð¸", btn_pdf:"Ð—Ð²Ñ–Ñ‚ PDF", sync_ts:"Ð¡Ð¸Ð½Ñ…Ñ€.: â€”",
    minpay_title:"ÐœÑ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð¿Ð»Ð°Ñ‚Ñ–Ð¶ (ÑˆÑ‚Ñ€Ð°Ñ„-ÑÑ‚Ð¾Ð¿)", btn_apply_minpay:"ÐŸÐ¾Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ ÑÐº ÑÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾",
    forecast_7d:"ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· 7 Ð´Ð½Ñ–Ð²", forecast7d_note:"Ð Ð°Ñ…ÑƒÑ” ÑƒÐ²Ñ–Ð¼ÐºÐ½ÐµÐ½Ñ– PLN-Ñ€Ð°Ñ…ÑƒÐ½ÐºÐ¸ + ÐºÐ°ÑÑƒ.",
    forecast_30d:"ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· 30 Ð´Ð½Ñ–Ð²", forecast30_note:"ÐÐ²Ñ‚Ð¾Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð· Ð²Ð¸Ð¿Ð¸ÑÐ¾Ðº + ÐºÐ°ÑÐ¸.",
    month_summary_title:"ÐŸÑ–Ð´ÑÑƒÐ¼ÐºÐ¸ Ð¼Ñ–ÑÑÑ†Ñ",
    plan_title:"ÐŸÐ»Ð°Ð½ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ñ–Ð² Ð¿Ñ–Ð´ ÐºÐ°ÑÑƒ", filter_label:"Ð¤Ñ–Ð»ÑŒÑ‚Ñ€:", filter_today:"Ð¡ÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–", filter_7d:"7 Ð´Ð½Ñ–Ð²", filter_all:"Ð’ÑÑ–", exclude_blacklist:"Ð’Ð¸ÐºÐ»ÑŽÑ‡Ð°Ñ‚Ð¸ blacklist",
    btn_make_plan:"Ð¡Ñ„Ð¾Ñ€Ð¼ÑƒÐ²Ð°Ñ‚Ð¸", btn_apply_plan:"Ð—Ð°ÑÑ‚Ð¾ÑÑƒÐ²Ð°Ñ‚Ð¸",
    plan_th_invoice:"Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº", plan_th_supplier:"ÐŸÐ¾ÑÑ‚Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¸Ðº", plan_th_due:"Ð¢ÐµÑ€Ð¼Ñ–Ð½", plan_th_amount:"Ð¡ÑƒÐ¼Ð°", plan_th_reason:"ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°",
    upload_statement:"Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ð²Ð¸Ð¿Ð¸ÑÐºÑƒ (CSV)", upload_statement_image:"Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ ÑÐºÑ€Ð¸Ð½ Ð²Ð¸Ð¿Ð¸ÑÐºÐ¸ (Ð³Ð°Ð»ÐµÑ€ÐµÑ)",
    placeholder_csv_url:"URL CSV Ð²Ð¸Ð¿Ð¸ÑÐºÐ¸", save_url:"Ð—Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸ URL",
    statement_columns_note:"ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸: Ð´Ð°Ñ‚Ð°, id Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ñ–Ñ—, id Ñ€Ð°Ñ…ÑƒÐ½ÐºÑƒ/IBAN, ÐºÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚, Ð¾Ð¿Ð¸Ñ, ÑÑƒÐ¼Ð°(Â±), Ð²Ð°Ð»ÑŽÑ‚Ð°, ÑÑ‚Ð°Ñ‚ÑƒÑ, Ð±Ð°Ð»Ð°Ð½Ñ?",
    th_date:"Ð”Ð°Ñ‚Ð°", th_account:"Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº", th_counterparty:"ÐšÐ¾Ð½Ñ‚Ñ€Ð°Ð³ÐµÐ½Ñ‚", th_desc:"ÐžÐ¿Ð¸Ñ", th_amount:"Ð¡ÑƒÐ¼Ð°", th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", th_status:"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ", th_actions:"Ð”Ñ–Ñ—",
    upload_invoices:"Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ñ€Ð°Ñ…ÑƒÐ½ÐºÐ¸ (CSV)", upload_invoice_images:"Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ñ„Ð¾Ñ‚Ð¾ Ñ€Ð°Ñ…ÑƒÐ½ÐºÑ–Ð²", invoices_note:"Ð’Ð¸ÑÐ²Ð»ÑÑ”Ð¼Ð¾ â„– Ñ€Ð°Ñ…ÑƒÐ½ÐºÑƒ, ÑÑƒÐ¼Ñƒ Ñ– Ð´Ð°Ñ‚Ñƒ.",
    inv_th_due:"Ð¢ÐµÑ€Ð¼Ñ–Ð½", inv_th_number:"â„–", inv_th_supplier:"ÐŸÐ¾ÑÑ‚Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¸Ðº", inv_th_amount:"Ð¡ÑƒÐ¼Ð°", inv_th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", inv_th_status:"Ð¡Ñ‚Ð°Ñ‚ÑƒÑ", inv_th_candidate:"ÐšÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚", inv_th_score:"Score", inv_th_action:"Ð”Ñ–Ñ",
    auto_accounts_title:"Ð Ð°Ñ…ÑƒÐ½ÐºÐ¸ Ð· Ð²Ð¸Ð¿Ð¸ÑÐºÐ¸ (Ð°Ð²Ñ‚Ð¾)", auto_accounts_desc:"Ð ÐµÐ´Ð°Ð³ÑƒÐ¹Ñ‚Ðµ Ð²Ð°Ð»ÑŽÑ‚Ñƒ, Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÐ¾Ð²Ð¸Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ Ñ– Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð´Ð¾ Ð¿Ð»Ð°Ð½Ñƒ.",
    acc_th_account:"Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº", acc_th_type:"Ð¢Ð¸Ð¿", acc_th_currency:"Ð’Ð°Ð»ÑŽÑ‚Ð°", acc_th_balance_calc:"Ð‘Ð°Ð»Ð°Ð½Ñ (Ð¾Ð±Ñ€.)", acc_th_start_balance:"Ð¡Ñ‚Ð°Ñ€Ñ‚", acc_th_include:"Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸",
    cash_title:"ÐšÐ°ÑÐ° â€” ÑˆÐ²Ð¸Ð´ÐºÑ– Ð¾Ð¿ÐµÑ€Ð°Ñ†Ñ–Ñ—", cash_note:"Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð° ÐºÐ°ÑÐ° + ÑˆÐ²Ð¸Ð´ÐºÑ– ÐºÐ½Ð¾Ð¿ÐºÐ¸",
    btn_add_in:"+ ÐŸÑ€Ð¸Ñ…Ñ–Ð´", btn_add_out:"âˆ’ Ð’Ð¸Ð´Ð°Ñ‚Ð¾Ðº", btn_close_shift:"Ð—Ð°ÐºÑ€Ð¸Ñ‚Ð¸ Ð·Ð¼Ñ–Ð½Ñƒ",
    speech_lang_label:"ÐœÐ¾Ð²Ð° Ñ€Ð¾Ð·Ð¿Ñ–Ð·Ð½Ð°Ð²Ð°Ð½Ð½Ñ:", cash_photo_note:"Ð¤Ð¾Ñ‚Ð¾ Ñ‡ÐµÐºÑƒ/Ð²Ð¸Ð¿Ð¸ÑÐºÐ¸ â€” Ñ€Ð¾Ð·Ð¿Ñ–Ð·Ð½Ð°Ñ‚Ð¸ ÑÑƒÐ¼Ñƒ Ñ‚Ð° Ð¾Ð¿Ð¸Ñ.",
    cash_th_date:"Ð”Ð°Ñ‚Ð°", cash_th_type:"Ð¢Ð¸Ð¿", cash_th_amount:"Ð¡ÑƒÐ¼Ð°", cash_th_source:"Ð”Ð¶ÐµÑ€ÐµÐ»Ð¾", cash_th_comment:"ÐšÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ñ€",
    parameters:"ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸", param_cash_label:"Ð ÑƒÑ‡Ð½Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° ÐºÐ°ÑÐ° ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ– (PLN):", param_penalty_label:"ÐŸÐµÐ½Ñ, %/Ð´ÐµÐ½ÑŒ:", param_interval_label:"Ð†Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» ÑÐ¸Ð½Ñ…Ñ€., Ñ…Ð²:",
    rateEUR_label:"rateEUR:", rateUSD_label:"rateUSD:", blacklist_label:"Ð§Ð¾Ñ€Ð½Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº (Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ñƒ):", auto_mode_label:"ÐÐ²Ñ‚Ð¾: Ð· Ñ€Ð°Ñ…ÑƒÐ½ÐºÑ–Ð² (Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ–) + ÐºÐ°ÑÐ°",
    btn_save_settings:"Ð—Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸", btn_export_settings:"Ð•ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½ÑŒ", btn_import_settings:"Ð†Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½ÑŒ",
    btn_clear_all:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚Ð¸ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾)",
    sub_title:"ÐŸÑ–Ð´Ð¿Ð¸ÑÐºÐ° / Ð”ÐµÐ¼Ð¾", btn_start_demo:"Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð´ÐµÐ¼Ð¾ (24 Ð³Ð¾Ð´)", btn_pay_sub:"ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚Ð¸ Ð¿Ñ–Ð´Ð¿Ð¸ÑÐºÑƒ", btn_end_demo:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ð¸ Ð´ÐµÐ¼Ð¾",
    sub_hint:"ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð»Ð¸ÑˆÐµ Ð² ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½ÑÑ…. Ð¯ÐºÑ‰Ð¾ Ñ” Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Stripe â€” Ð¿Ð¾ÐºÐ»Ð°Ð´Ñ–Ñ‚ÑŒ Ñƒ localStorage.stripe_link.",
    ph_amount:"Ð¡ÑƒÐ¼Ð°", ph_comment:"ÐšÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ñ€"
  }
};

/* PLACEHOLDER APPLIER */
function applyPlaceholders(lang){
  const dict = M[lang]||M.pl;
  document.querySelectorAll('[data-i-ph]').forEach(el=>{
    const k = el.getAttribute('data-i-ph');
    if (dict[k]) el.setAttribute('placeholder', dict[k]);
  });
}

/* LANGUAGE APPLY */
function applyLang(lang){
  const dict = M[lang]||M.pl;
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k = el.getAttribute('data-i'); if (dict[k]) el.textContent = dict[k];
  });
  document.querySelectorAll('#langBarMain button').forEach(btn=>btn.classList.toggle('on', btn.dataset.lang===lang));
  localStorage.setItem('otd_lang', lang);
  applyPlaceholders(lang);
  if (typeof renderCashExamples==='function') renderCashExamples(lang);
}

/* ==== HELPERS ==== */
const $id = id => document.getElementById(id);
const today = () => new Date().toISOString().slice(0,10);
const asNum = v=>{
  if(v==null) return 0; let s=String(v).trim(); if(!s) return 0;
  s=s.replace(/\u00A0/g,' ');
  if(/^\(.*\)$/.test(s)) s='-'+s.replace(/^\(|\)$/g,'');
  const hasComma=/,/.test(s), hasDot=/\./.test(s);
  s=s.replace(/\b(PLN|zÅ‚|zl|zlot|EUR|USD|GBP)\b/ig,'');
  if(hasComma && !hasDot) s=s.replace(/\s/g,'').replace(/,/g,'.'); else s=s.replace(/[\s\u00A0]/g,'').replace(/,/g,'');
  s=s.replace(/[^\d\.\-]/g,'');
  const n=Number(s); return isNaN(n)?0:n;
};
function toISO(d){
  if(!d) return ""; const s=String(d).trim();
  let m=s.match(/^(\d{4})-(\d{2})-(\d{2})/); if(m) return m[0];
  m=s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
  if(m){const dd=m[1].padStart(2,'0'),mm=m[2].padStart(2,'0'),yy=m[3].length===2?('20'+m[3]):m[3]; return yy+'-'+mm+'-'+dd;}
  const p=Date.parse(s); if(!isNaN(p)) return new Date(p).toISOString().slice(0,10);
  return "";
}
function fmtAmountRaw(raw){
  const n=asNum(raw); if(!Number.isFinite(n)) return '<span>â€”</span>';
  const sign=n<0?'-':'+', cls=n<0?'amt-neg':'amt-pos';
  const abs=Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g," ");
  return `<span class="${cls}">${sign} ${abs}</span>`;
}
function smartSplit(line,del){
  let out=[],cur="",q=false;
  for(let i=0;i<line.length;i++){const ch=line[i]; if(ch==='"'){q=!q;continue} if(ch===del && !q){out.push(cur);cur="";} else cur+=ch;}
  out.push(cur); return out;
}
function parseCSV(text){
  if(!text) return []; text=text.replace(/^\uFEFF/,'').replace(/\r/g,"");
  const lines=text.split("\n").filter(l=>l.trim()); if(!lines.length) return [];
  const sep=(lines[0].split(";").length>lines[0].split(",").length)?";":",";
  const head=smartSplit(lines.shift(),sep).map(h=>h.trim());
  return lines.map(line=>{
    const cells=smartSplit(line,sep); const obj={};
    head.forEach((h,i)=>{let v=(cells[i]||"").trim(); v=v.replace(/\u00A0/g,' ').trim(); obj[h]=v;}); return obj;
  });
}
function getVal(obj,keys){
  if(!obj) return ""; for(const k of keys){ if(k in obj && String(obj[k]).trim()!=="") return obj[k]; }
  const low=Object.keys(obj).reduce((m,x)=>(m[x.toLowerCase()]=obj[x],m),{});
  for(const k of keys){const kk=k.toLowerCase(); if(kk in low && String(low[kk]).trim()!=="") return low[kk];}
  return "";
}

/* ==== STATE ==== */
let tx=[], bills=[], kasa=[], accMeta={};
const stateKeys = ['tx_manual_import','bills_manual_import','kasa','accMeta','cashPLN','penaltyPct','intervalMin','rateEUR','rateUSD','blacklist','autoCash',SUB_KEY,SUB_FROM,SUB_TO,DEMO_START,'txUrl','billUrl','otd_lang','speechLang'];

/* ==== REMOTE SYNC (optional) ==== */
async function pullState(){
  const email = localStorage.getItem(USER_KEY)||"";
  if(!email) return null;
  try{
    const r=await fetch(`${API_BASE}/state/get?email=${encodeURIComponent(email)}`,{credentials:'include'});
    if(!r.ok) return null;
    const json=await r.json();
    if(!json) return null;
    // merge
    if(json.tx) localStorage.setItem('tx_manual_import', JSON.stringify(json.tx));
    if(json.bills) localStorage.setItem('bills_manual_import', JSON.stringify(json.bills));
    if(json.kasa) localStorage.setItem('kasa', JSON.stringify(json.kasa));
    if(json.accMeta) localStorage.setItem('accMeta', JSON.stringify(json.accMeta));
    if(json.settings) Object.entries(json.settings).forEach(([k,v])=> localStorage.setItem(k, typeof v==='string'?v:JSON.stringify(v)));
    return json;
  }catch(e){ return null; }
}
const pushState = (function(){
  let t=null, inflight=false;
  return function(){
    if(inflight) return;
    clearTimeout(t);
    t=setTimeout(async ()=>{
      const email = localStorage.getItem(USER_KEY)||"";
      if(!email) return;
      inflight=true;
      const body={
        email,
        tx: JSON.parse(localStorage.getItem('tx_manual_import')||'[]'),
        bills: JSON.parse(localStorage.getItem('bills_manual_import')||'[]'),
        kasa: JSON.parse(localStorage.getItem('kasa')||'[]'),
        accMeta: JSON.parse(localStorage.getItem('accMeta')||'{}'),
        settings: stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k), m), {})
      };
      try{
        await fetch(`${API_BASE}/state/save`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          credentials:'include',body:JSON.stringify(body)
        });
      }catch(e){} finally{ inflight=false; }
    }, 600);
  }
})();

/* ==== MONEY / RATES ==== */
function rate(cur){
  cur=String(cur||"PLN").toUpperCase();
  if(cur==='PLN') return 1;
  if(cur==='EUR') return asNum(localStorage.getItem('rateEUR')||4.3);
  if(cur==='USD') return asNum(localStorage.getItem('rateUSD')||3.95);
  return 1;
}
function computeAccountBalance(accId){
  const rows=tx.filter(r=> (getVal(r,["ID konta","IBAN","account","ID"])||"UNKNOWN")===accId);
  const withSaldo = rows.filter(r=> getVal(r,["Saldo po operacji","Saldo","saldo"]));
  if(withSaldo.length){ const last=withSaldo[withSaldo.length-1]; return asNum(getVal(last,["Saldo po operacji","Saldo","saldo"])); }
  const start=Number((accMeta[accId]||{}).start||0);
  const sum=rows.reduce((s,r)=> s+asNum(getVal(r,["Kwota","KwÐ¾Ñ‚Ð°","amount","Kwota_raw"])),0);
  return start+sum;
}
function bankAvailablePLN(){
  let sum=0;
  Object.values(accMeta).filter(a=>a.include).forEach(a=>{
    sum+=computeAccountBalance(a.id)*rate(a.currency);
  });
  return sum;
}
function kasaBalance(){
  let bal=0;
  kasa.forEach(k=>{
    if(k.type==='przyjÄ™cie') bal+=k.amount;
    if(k.type==='wydanie') bal-=k.amount;
    if(k.type==='zamkniÄ™cie') bal = k.amount;
  });
  return bal;
}
function availableTotal(){
  const auto = localStorage.getItem('autoCash')==='1';
  const manual = asNum(localStorage.getItem('cashPLN')||0);
  const kas = kasaBalance();
  return auto ? (bankAvailablePLN()+kas) : (manual+kas);
}

/* ==== AI MATCH (unchanged core scoring) ==== */
function normName(s){s=(s||"").toString().toLowerCase().replace(/[.,]/g," ").replace(/\s+/g," ").trim();["sp z oo","sp. z o.o.","spolka","spÃ³Å‚ka","sa","s.a","ooo"].forEach(t=>s=s.replace(t,""));return s}
function nameSimilar(a,b){a=normName(a);b=normName(b);if(!a||!b) return 0;if(a===b) return 1;if(a.includes(b)||b.includes(a)) return 0.8;return 0}
function scoreMatch(bill,tr){
  let score=0;
  const bAmt=asNum(getVal(bill,["Kwota do zapÅ‚aty","KwÐ¾Ñ‚Ð° do Ð·Ð°Ð¿Ð»Ð°Ñ‚Ñ‹","KwÐ¾Ñ‚Ð°","amount"]));
  const tAmt=Math.abs(asNum(getVal(tr,["Kwota","KwÐ¾Ñ‚Ð°","amount","Kwota_raw"])));
  const bCur=(getVal(bill,["Waluta","currency"])||"").toUpperCase();
  const tCur=(getVal(tr,["Waluta","currency"])||"").toUpperCase();
  if(bAmt>0 && tAmt>0 && Math.abs(bAmt-tAmt)<0.01 && (bCur===tCur || !bCur || !tCur)) score+=60;
  const inv=String(getVal(bill,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||"").toLowerCase();
  const desc=String(getVal(tr,["TytuÅ‚/Opis","Opis","Title","description"])||"").toLowerCase();
  if(inv && desc.includes(inv)) score+=25;
  if(nameSimilar(getVal(bill,["Dostawca","Supplier"]), getVal(tr,["Kontrahent","Counterparty"]))>=0.8) score+=10;
  if(asNum(getVal(tr,["Kwota","amount"]))<0) score+=5;
  return {score:Math.min(100,score)};
}
function runAI(){
  bills.forEach(b=>{
    const status=String(getVal(b,["Status faktury","Status Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Status"])||"").toLowerCase();
    if(status.includes("opÅ‚acone")||status.includes("paid")||status.includes("Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾")) return;
    let best=null;
    tx.forEach(t=>{
      if(String(getVal(t,["Status transakcji","status"])||"").toLowerCase()==="sparowane") return;
      if(asNum(getVal(t,["Kwota","amount"]))>=0) return;
      const s=scoreMatch(b,t);
      if(!best || s.score>best.s) best={t,s:s.score};
    });
    if(best && best.s>=85){
      best.t["Status transakcji"]="Sparowane";
      best.t["PowiÄ…zana faktura (ID)"]=getVal(b,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹"]);
      b["Status faktury"]="OpÅ‚acone"; b["Data pÅ‚atnoÅ›ci"]=today();
    }else if(best && best.s>=55){
      b["Kandydat (AI)"]=getVal(best.t,["ID transakcji"]);
      b["AI score"]=best.s;
    }else{ b["Kandydat (AI)"]=""; b["AI score"]=""; }
  });
  render(); saveLocal(); pushState();
}
function acceptSafe(){
  bills.filter(b=> Number(getVal(b,["AI score"])||0)>=85).forEach(b=>{
    const t=tx.find(t=> getVal(t,["ID transakcji"])===getVal(b,["Kandydat (AI)"]));
    if(!t) return;
    t["Status transakcji"]="Sparowane";
    t["PowiÄ…zana faktura (ID)"]=getVal(b,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹"]);
    b["Status faktury"]="OpÅ‚acone"; b["Data pÅ‚atnoÅ›ci"]=today(); b["Kandydat (AI)"]=b["AI score"]="";
  });
  render(); saveLocal(); pushState();
}

/* ==== OCR IMPORT (kept from your base; unchanged except safety) ==== */
/* ... (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽ ÐºÐ°Ðº Ð±Ñ‹Ð»Ð¾ Ñƒ Ñ‚ÐµÐ±Ñ â€” Ð½Ðµ Ð²Ñ‹Ñ€ÐµÐ·Ð°ÑŽ Ð´Ð»Ñ ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ‚Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°) ... */

/* ==== PERSIST LOCAL ==== */
function loadLocal(){
  try{ kasa = JSON.parse(localStorage.getItem('kasa')||'[]'); }catch(e){kasa=[]}
  try{ tx = JSON.parse(localStorage.getItem('tx_manual_import')||'[]'); }catch(e){tx=[]}
  try{ bills = JSON.parse(localStorage.getItem('bills_manual_import')||'[]'); }catch(e){bills=[]}
  try{ accMeta = JSON.parse(localStorage.getItem('accMeta')||'{}'); }catch(e){accMeta={}}
}
function saveLocal(){
  try{ localStorage.setItem('kasa', JSON.stringify(kasa)); }catch(e){}
  try{ localStorage.setItem('tx_manual_import', JSON.stringify(tx)); }catch(e){}
  try{ localStorage.setItem('bills_manual_import', JSON.stringify(bills)); }catch(e){}
  try{ localStorage.setItem('accMeta', JSON.stringify(accMeta)); }catch(e){}
}

/* ==== ACCOUNTS ==== */
function inferAccounts(){
  const map={};
  tx.forEach(r=>{
    const id=getVal(r,["ID konta","IBAN","account","ID"])||"UNKNOWN";
    const cur=(getVal(r,["Waluta","currency"])||"PLN").toUpperCase();
    if(!map[id]) map[id]={id,name:String(id).slice(0,12),currency:cur,include:true,type:"Biznes",start:0};
  });
  try{ const saved=JSON.parse(localStorage.getItem('accMeta')||'{}'); Object.keys(map).forEach(id=>{ if(saved[id]) map[id]=Object.assign(map[id], saved[id]); }); }catch(e){}
  accMeta=map; renderAccounts();
}

/* ==== GATE: DEMO / SUB ==== */
function isSubActive(){
  const a=localStorage.getItem(SUB_KEY)==='1';
  if(!a) return false;
  const to=localStorage.getItem(SUB_TO)||''; if(!to) return a;
  return new Date(to) >= new Date();
}
function demoLeftMs(){
  const t=localStorage.getItem(DEMO_START); if(!t) return 0;
  const start=new Date(t).getTime(); const left = (start + 24*3600*1000) - Date.now();
  return left;
}
function isDemoActive(){ return demoLeftMs() > 0; }
function gateAccess(){
  const ok = isSubActive() || isDemoActive();
  const gate = $id('gate'); const tabs = document.querySelectorAll('.tabs .tab');
  if(!gate) return;
  gate.classList.toggle('hidden', ok);
  tabs.forEach(t=>{
    if(t.dataset.sec==='ustawienia') t.classList.remove('disabled');
    else t.classList.toggle('disabled', !ok);
  });
  if(!ok){
    // force-open settings
    document.querySelector('[data-sec=ustawienia]')?.click();
  }
}
function updateSubUI(){
  const el=$id('subStatus'); if(!el) return;
  let s='â€”';
  if(isSubActive()){
    s=`âœ… Sub aktywna: ${localStorage.getItem(SUB_FROM)||'â€”'} â†’ ${localStorage.getItem(SUB_TO)||'â€”'}`;
  }else if(isDemoActive()){
    const leftMs=demoLeftMs(); const hrs=Math.ceil(leftMs/3600000);
    s=`ðŸ§ª Demo aktywne ~ ${hrs}h`;
  }else{
    s='â›” Brak dostÄ™pu: wÅ‚Ä…cz demo lub opÅ‚aÄ‡.';
  }
  el.textContent=s;
}

/* ==== AUTOSYNC ==== */
let syncTimer=null, syncing=false;
async function fetchSources(){
  if(syncing) return; syncing=true;
  try{
    const u1=localStorage.getItem('txUrl')||$id('txUrl')?.value||"";
    const u2=localStorage.getItem('billUrl')||$id('billUrl')?.value||"";
    if(u1){ const r=await fetch(u1,{cache:'no-store'}); tx = parseCSV(await r.text()); }
    if(u2){ const r2=await fetch(u2,{cache:'no-store'}); bills = parseCSV(await r2.text()); }
    inferAccounts(); render();
    const last=$id('lastSync'); if(last) last.textContent = (M[localStorage.getItem('otd_lang')||'pl'].sync_ts||"Synchronizacja: â€”").replace('â€”', new Date().toLocaleString());
    saveLocal(); pushState();
  }catch(e){
    const last=$id('lastSync'); if(last) last.textContent = 'Error: '+(e?.message||e);
  }finally{ syncing=false; }
}
function scheduleAutosync(){
  clearInterval(syncTimer); const m = parseInt(localStorage.getItem('intervalMin')||'0',10);
  if(m>0 && (localStorage.getItem('txUrl')||localStorage.getItem('billUrl'))){
    syncTimer = setInterval(fetchSources, Math.max(1,m)*60*1000);
  }
}

/* ==== CASH QUICK EXAMPLES ==== */
const cashQuickExamples={pl:["PrzyjÄ…Ä‡ 250 na produkty","WypÅ‚aciÄ‡ 50 na dostawÄ™","PrzyjÄ…Ä‡ 1000 depozyt","PrzyjÄ…Ä‡ 50 na napoje"],
ru:["ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ 250 Ð½Ð° Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹","Ð’Ñ‹Ð´Ð°Ñ‚ÑŒ 50 Ð½Ð° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ","ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ 1000 Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚","ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ 50 Ð½Ð° Ð½Ð°Ð¿Ð¸Ñ‚ÐºÐ¸"],
en:["Accept 250 for groceries","Pay out 50 for delivery","Accept 1000 deposit","Accept 50 for drinks"],
uk:["ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¸ 250 Ð½Ð° Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸","Ð’Ð¸Ð´Ð°Ñ‚Ð¸ 50 Ð½Ð° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ","ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¸ 1000 Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚","ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¸ 50 Ð½Ð° Ð½Ð°Ð¿Ð¾Ñ—"]};
function renderCashExamples(lang){
  const holder=$id('kasaQuickHolder'); if(!holder) return; holder.innerHTML='';
  const arr=cashQuickExamples[lang]||cashQuickExamples.pl;
  arr.forEach(txt=>{
    const btn=document.createElement('button'); btn.type='button'; btn.textContent=txt;
    btn.addEventListener('click',()=>{
      const numMatch=txt.match(/(-?\d+[.,]?\d*)/); const num=numMatch?asNum(numMatch[1]):0;
      const outRe=/(wyda|wypÅ‚ac|pay out|Ð²Ð¸Ð´Ð°Ñ‚|Ð²Ñ‹Ð´Ð°)/i; const isOut=outRe.test(txt);
      const note=txt.replace(/(-?\d+[.,]?\d*\s*(zÅ‚|pln|PLN|USD|EUR)?)/i,"").trim();
      addKasa(isOut?'wydanie':'przyjÄ™cie', num, note||txt, 'quick');
    });
    holder.appendChild(btn);
  });
}

/* ==== RENDER ==== */
function renderKasa(){
  const tb=document.querySelector('#kasaTable tbody'); if(!tb) return; tb.innerHTML='';
  kasa.forEach((k,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source||""}</td><td>${k.comment||""}</td>
                    <td class="actions">
                      <button data-act="edit" data-kind="kasa" data-id="${k.id}">âœŽ</button>
                      <button data-act="del" data-kind="kasa" data-id="${k.id}">ðŸ—‘</button>
                    </td>`;
    tb.appendChild(tr);
  });
}
function renderAccounts(){
  const tb=document.querySelector('#autoAcc tbody'); if(!tb) return; tb.innerHTML='';
  Object.values(accMeta).forEach(a=>{
    const bal=computeAccountBalance(a.id);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${a.id}</td>
      <td><select data-id="${a.id}" class="acc-type">
            <option ${a.type==="Biznes"?"selected":""}>Biznes</option>
            <option ${a.type==="Osobisty"?"selected":""}>Osobisty</option>
          </select></td>
      <td><select data-id="${a.id}" class="acc-cur">
            <option ${a.currency==="PLN"?"selected":""}>PLN</option>
            <option ${a.currency==="EUR"?"selected":""}>EUR</option>
            <option ${a.currency==="USD"?"selected":""}>USD</option>
          </select></td>
      <td>${bal.toFixed(2)}</td>
      <td><input type="number" step="0.01" value="${a.start||0}" class="acc-start" data-id="${a.id}"/></td>
      <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include?"checked":""}/></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll(".acc-type").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].type=e.target.value;saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-cur").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].currency=e.target.value;saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-start").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].start=asNum(e.target.value);saveLocal();render();pushState();}));
  tb.querySelectorAll(".acc-include").forEach(el=>el.addEventListener("change",e=>{accMeta[e.target.dataset.id].include=e.target.checked;saveLocal();render();pushState();}));
}
function render(){
  // KPIs
  const dueToday=(bills||[]).filter(r=>{
    const s=String(getVal(r,["Status faktury","Status Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Status"])||"").toLowerCase();
    return ["do zapÅ‚aty","przeterminowane","Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ","Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾","to pay"].includes(s) &&
           toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"]))===today();
  }).length;
  const unmatch=(tx||[]).filter(r=> String(getVal(r,["Status transakcji","status"])||"").toLowerCase()!=="sparowane").length;
  $id('kpiDue')&&( $id('kpiDue').textContent = dueToday );
  $id('kpiUnmatch')&&( $id('kpiUnmatch').textContent = unmatch );
  const bankPLN=bankAvailablePLN(); $id('kpiBank')&&( $id('kpiBank').textContent = bankPLN.toFixed(2) );
  const kas=kasaBalance(); $id('kpiCash')&&( $id('kpiCash').textContent = kas.toFixed(2) );
  const avail=availableTotal(); $id('kpiAvail')&&( $id('kpiAvail').textContent = avail.toFixed(2) );
  const sumDue=(bills||[]).filter(r=>
    String((getVal(r,["Waluta","Waluta "])||"").toUpperCase())==="PLN" &&
    toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"]))<=today() &&
    ["do zapÅ‚aty","przeterminowane","Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ","Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾"].includes(String(getVal(r,["Status faktury","Status"])||"").toLowerCase())
  ).reduce((s,r)=> s+asNum(getVal(r,["Kwota do zapÅ‚aty","Kwota","KwÐ¾Ñ‚Ð°"])||0),0);
  $id('kpiGap')&&( $id('kpiGap').textContent = Math.max(0,sumDue-avail).toFixed(2) );

  // TX table
  const txBody=document.querySelector('#txTable tbody'); if(txBody){
    txBody.innerHTML='';
    (tx||[]).forEach(r=>{
      const id=getVal(r,["ID transakcji","ID","id"])||("noid-"+Math.random());
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${toISO(getVal(r,["Data ksiÄ™gowania","date","Ð”Ð°Ñ‚Ð°"]))}</td>
        <td>${getVal(r,["ID konta","IBAN","account"])||"â€”"}</td>
        <td>${getVal(r,["Kontrahent","Counterparty"])||""}</td>
        <td>${getVal(r,["TytuÅ‚/Opis","Opis","title"])||""}</td>
        <td>${fmtAmountRaw(getVal(r,["Kwota","KwÐ¾Ñ‚Ð°","amount","Kwota_raw"]))}</td>
        <td>${getVal(r,["Waluta","currency"])||""}</td>
        <td>${getVal(r,["Status transakcji","status"])||""}</td>
        <td class="actions">
          <button data-act="edit" data-kind="tx" data-id="${id}">âœŽ</button>
          <button data-act="del" data-kind="tx" data-id="${id}">ðŸ—‘</button>
        </td>`;
      txBody.appendChild(tr);
    });
  }

  // Bills
  const billBody=document.querySelector('#billTable tbody'); if(billBody){
    billBody.innerHTML='';
    (bills||[]).forEach(r=>{
      const s=String(getVal(r,["Status faktury","Status Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Status"])||"").toLowerCase();
      const cls=(s.includes('przetermin')||s.includes('Ð¿Ñ€Ð¾ÑÑ€'))?'overdue':'due';
      const cand=getVal(r,["Kandydat (AI)"])||"";
      const score=getVal(r,["AI score"])||"";
      const id=getVal(r,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||("noinv-"+Math.random());
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"])||"")}</td>
        <td>${getVal(r,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||""}</td>
        <td>${getVal(r,["Dostawca","Supplier"])||""}</td>
        <td>${getVal(r,["Kwota do zapÅ‚aty","KwÐ¾Ñ‚Ð°","Kwota"])||""}</td>
        <td>${getVal(r,["Waluta","currency"])||""}</td>
        <td><span class="badge ${cls}">${getVal(r,["Status faktury","Status Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Status"])||""}</span></td>
        <td>${cand?('<span class="badge cand">'+cand+'</span>'):'â€”'}</td>
        <td>${score?('<span class="badge ai">'+score+'</span>'):'â€”'}</td>
        <td class="actions">
          ${cand?('<button class="btn secondary btn-accept" data-invid="'+id+'">OK</button>'):''}
          <button data-act="edit" data-kind="bill" data-id="${id}">âœŽ</button>
          <button data-act="del" data-kind="bill" data-id="${id}">ðŸ—‘</button>
        </td>`;
      billBody.appendChild(tr);
    });
    document.querySelectorAll(".btn-accept").forEach(b=> b.addEventListener('click',()=>acceptOne(b.getAttribute('data-invid'))));
  }

  renderMinPay(); renderForecast(); renderAccounts(); renderKasa(); updateSubUI(); gateAccess();
}

/* ==== PLAN / FORECAST / MINPAY (kept) ==== */
function toDueList(mode){
  const t=today(); const excl=$id('excludeBlacklist')?.checked||false;
  return bills.filter(r=>{
    const s=String(getVal(r,["Status faktury","Status Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Status"])||"").toLowerCase();
    if(!["do zapÅ‚aty","przeterminowane","Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ","Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾","to pay"].includes(s)) return false;
    const d=toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"])); if(!d) return false;
    if(mode==='today') return d===t;
    if(mode==='7d'){ const dd=new Date(d), tt=new Date(t); return (dd-tt)/86400000 <= 7; }
    return true;
  }).filter(r=>{
    if(String((getVal(r,["Waluta"])||"").toUpperCase())!=="PLN") return false;
    if(excl){
      const bl=(localStorage.getItem('blacklist')||"").toLowerCase();
      const nm=(getVal(r,["Dostawca","Supplier"])||"").toLowerCase();
      if(bl && bl.split(",").some(x=> nm.includes(x.trim()))) return false;
    }
    return true;
  });
}
function buildPlan(){
  const mode=$id('planFilter')?.value||'7d';
  const cand=toDueList(mode).sort((a,b)=>{
    const da=new Date(toISO(getVal(a,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"])||today()));
    const db=new Date(toISO(getVal(b,["Termin pÅ‚atnoÅ›ci","Termin","Termin Ð¿Ð»Ð°Ñ‚Ð½Ð¾ÑÑ‚Ñ–"])||today()));
    const lateA=da<new Date(today()), lateB=db<new Date(today());
    if(lateA!==lateB) return lateB-lateA;
    return asNum(getVal(b,["Kwota do zapÅ‚aty","Kwota"])) - asNum(getVal(a,["Kwota do zapÅ‚aty","Kwota"]));
  });
  let left=availableTotal(); const plan=[];
  for(const r of cand){
    const amt=asNum(getVal(r,["Kwota do zapÅ‚aty","Kwota"])||0);
    if(amt<=left){ plan.push({r,amt,reason:(toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin"])||today())<today()?"Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐºÐ°":"ÑÑ€Ð¾Ðº")}); left-=amt; }
  }
  return {plan,left,avail:availableTotal()};
}
function renderPlan(){
  const p=buildPlan(); const tb=document.querySelector('#planTable tbody'); if(!tb) return; tb.innerHTML='';
  p.plan.forEach((x,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${getVal(x.r,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹"])||""}</td><td>${getVal(x.r,["Dostawca","Supplier"])||""}</td><td>${toISO(getVal(x.r,["Termin pÅ‚atnoÅ›ci","Termin"])||"")}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
    tb.appendChild(tr);
  });
  const pm=$id('planMeta'); if(pm) pm.textContent = p.plan.length?`Wydamy ${(p.avail-p.left).toFixed(2)} z ${p.avail.toFixed(2)} PLN. Zostanie ${p.left.toFixed(2)} PLN.`:"Plan pusty lub brak Å›rodkÃ³w.";
}
function computeMinPay(){
  const t=today(); const pct=asNum(localStorage.getItem('penaltyPct')||0.05)/100.0;
  const cand=bills.filter(r=>
    String((getVal(r,["Waluta"])||"").toUpperCase())==="PLN" &&
    toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin"])||"")<=t &&
    ["do zapÅ‚aty","przeterminowane","Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ","Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð¾"].includes(String(getVal(r,["Status faktury","Status"])||"").toLowerCase())
  ).map(r=>({r,amt:asNum(getVal(r,["Kwota do zapÅ‚aty","Kwota"])||0),risk:asNum(getVal(r,["Kwota do zapÅ‚aty","Kwota"])||0)*pct}))
   .sort((a,b)=> b.risk-a.risk || b.amt-a.amt);
  return cand[0]||null;
}
function renderMinPay(){
  const m=computeMinPay(); const el=$id('minPayBox'); if(!el) return;
  if(!m){ el.textContent='â€”'; return; }
  el.textContent = `ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ ${getVal(m.r,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹"])} (${getVal(m.r,["Dostawca","Supplier"])}) Ð½Ð° ${m.amt.toFixed(2)} PLN. Ð¨Ñ‚Ñ€Ð°Ñ„/Ð´ÐµÐ½ÑŒ ~ ${m.risk.toFixed(2)} PLN.`;
}
function renderForecast(){
  const t=new Date(today());
  const list=toDueList("7d").map(r=>({date:new Date(toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin"]))), amt:asNum(getVal(r,["Kwota do zapÅ‚aty","KwÐ¾Ñ‚Ð°"])||0)}));
  const days=[...Array(7)].map((_,i)=> new Date(t.getTime()+i*86400000));
  let left=availableTotal(); const out=days.map(d=>({d,due:0,after:0}));
  list.forEach(x=>{ const idx=Math.min(6, Math.max(0, Math.floor((x.date - t)/86400000))); out[idx].due += x.amt; });
  out.forEach(o=>{ left-=o.due; o.after=left; });
  const wrap=$id('forecastBars'); if(!wrap) return; wrap.innerHTML='';
  out.forEach(o=>{
    const div=document.createElement('div'); div.className='bar'+(o.after<0?' neg':'');
    const h=document.createElement('div'); h.className='h'; h.style.height=(Math.min(120,Math.abs(o.after)/100)*0.8+18)+'px';
    div.innerHTML=`<small>${o.d.toISOString().slice(5,10)}</small>`; div.appendChild(h);
    const v=document.createElement('div'); v.textContent = (o.after<0?'-':'')+Math.abs(o.after).toFixed(0)+' PLN'; div.appendChild(v);
    wrap.appendChild(div);
  });
  const firstNeg=out.find(x=>x.after<0); const meta=$id('forecastMeta');
  if(meta) meta.textContent = firstNeg?`Ð“ÑÐ¿ Ñ‡ÐµÑ€ÐµÐ· ${out.indexOf(firstNeg)+1} Ð´Ð½.: Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ ${Math.abs(firstNeg.after).toFixed(2)} PLN.`:"ÐÐ° 7 Ð´Ð½ÐµÐ¹ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ ÐºÐ°ÑÑÑ‹.";
}

/* ==== ACCEPT ONE ==== */
function acceptOne(id){
  const b=(bills||[]).find(x=> (getVal(x,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||"")===id);
  if(!b) return;
  const t=(tx||[]).find(x=> (getVal(x,["ID transakcji","ID","id"])||"")=== (getVal(b,["Kandydat (AI)"])||""));
  if(!t) return;
  t["Status transakcji"]="Sparowane"; t["PowiÄ…zana faktura (ID)"]=getVal(b,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹"]);
  b["Status faktury"]="OpÅ‚acone"; b["Data pÅ‚atnoÅ›ci"]=today(); b["Kandydat (AI)"]=b["AI score"]="";
  render(); saveLocal(); pushState();
}

/* ==== KASA CRUD ==== */
function loadKasa(){ try{kasa=JSON.parse(localStorage.getItem('kasa')||'[]');}catch(e){kasa=[]} }
function addKasa(type,amount,comment,source){
  if(amount==null||isNaN(amount)) return alert("Ð¡ÑƒÐ¼Ð¼Ð° Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°");
  kasa.push({id:Date.now(),date:today(),type,amount:Number(amount),comment:comment||"",source:source||"Ñ€ÑƒÑ‡Ð½Ð¾Ð¹"});
  saveLocal(); render(); pushState();
}
function editRow(kind,id){
  if(kind==='kasa'){
    const idx=kasa.findIndex(x=> String(x.id)===String(id)); if(idx<0) return;
    const k=kasa[idx];
    const n=prompt("Ð¡ÑƒÐ¼Ð¼Ð°:", k.amount); if(n===null) return;
    const c=prompt("ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:", k.comment||""); if(c===null) return;
    kasa[idx].amount=asNum(n); kasa[idx].comment=c; saveLocal(); render(); pushState(); return;
  }
  if(kind==='tx'){
    const idx=tx.findIndex(x=> (getVal(x,["ID transakcji","ID","id"])||"")===String(id)); if(idx<0) return;
    const r=tx[idx];
    const d=prompt("Ð”Ð°Ñ‚Ð° (YYYY-MM-DD):", toISO(getVal(r,["Data ksiÄ™gowania"])||today())); if(d===null) return;
    const a=prompt("Ð¡ÑƒÐ¼Ð¼Ð°:", getVal(r,["Kwota","Kwota_raw","amount"])||""); if(a===null) return;
    r["Data ksiÄ™gowania"]=toISO(d)||today(); r["Kwota"]=asNum(a).toFixed(2); saveLocal(); render(); pushState(); return;
  }
  if(kind==='bill'){
    const idx=bills.findIndex(x=> (getVal(x,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||"")===String(id)); if(idx<0) return;
    const r=bills[idx];
    const due=prompt("Ð¡Ñ€Ð¾Ðº (YYYY-MM-DD):", toISO(getVal(r,["Termin pÅ‚atnoÅ›ci","Termin"])||today())); if(due===null) return;
    const amt=prompt("Ð¡ÑƒÐ¼Ð¼Ð° Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ:", getVal(r,["Kwota do zapÅ‚aty","Kwota"])||""); if(amt===null) return;
    r["Termin pÅ‚atnoÅ›ci"]=toISO(due)||today(); r["Kwota do zapÅ‚aty"]=asNum(amt).toFixed(2); saveLocal(); render(); pushState(); return;
  }
}
function delRow(kind,id){
  if(kind==='kasa'){ kasa = kasa.filter(x=> String(x.id)!==String(id)); saveLocal(); render(); pushState(); return; }
  if(kind==='tx'){ tx = tx.filter(x=> (getVal(x,["ID transakcji","ID","id"])||"")!==String(id)); saveLocal(); render(); pushState(); return; }
  if(kind==='bill'){ bills = bills.filter(x=> (getVal(x,["Numer faktury","Numer Ñ„Ð°ÐºÑ‚ÑƒÑ€Ñ‹","Invoice number"])||"")!==String(id)); saveLocal(); render(); pushState(); return; }
}

/* ==== EVENTS ==== */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const act=btn.getAttribute('data-act'); if(!act) return;
  const kind=btn.getAttribute('data-kind'), id=btn.getAttribute('data-id');
  if(act==='edit') editRow(kind,id);
  if(act==='del') delRow(kind,id);
});

document.addEventListener('DOMContentLoaded', async ()=>{
  // Lang bar
  document.querySelectorAll('#langBarMain button').forEach(b=>{
    b.addEventListener('click',()=> applyLang(b.dataset.lang));
  });
  applyLang(localStorage.getItem('otd_lang')||'pl');

  // Tabs (with gate)
  document.querySelectorAll('.tabs .tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      if(t.classList.contains('disabled')) { document.querySelector('[data-sec=ustawienia]')?.click(); return; }
      document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      t.classList.add('active'); const sec=t.dataset.sec; if(sec) $id(sec)?.classList.add('active');
      render();
    });
  });

  // Buttons
  $id('runAI')?.addEventListener('click', runAI);
  $id('acceptSafe')?.addEventListener('click', acceptSafe);
  $id('makePlan')?.addEventListener('click', renderPlan);
  $id('applyPlan')?.addEventListener('click', renderPlan);
  $id('applyMinPay')?.addEventListener('click', ()=>{ const m=computeMinPay(); if(!m) return alert('ÐÐµÑ‚ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²'); m.r["Status faktury"]="OpÅ‚acone"; m.r["Data pÅ‚atnoÅ›ci"]=today(); render(); saveLocal(); pushState(); });
  $id('exportPDF')?.addEventListener('click',()=>window.print());
  $id('syncNow')?.addEventListener('click', fetchSources);

  // File/url
  $id('txFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; tx=parseCSV(await f.text()); inferAccounts(); render(); saveLocal(); pushState(); });
  $id('billFile')?.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; bills=parseCSV(await f.text()); render(); saveLocal(); pushState(); });
  $id('saveTxUrl')?.addEventListener('click',()=>{ const v=$id('txUrl')?.value.trim()||""; localStorage.setItem('txUrl',v); alert('Zapisano URL wyciÄ…gu'); scheduleAutosync(); });

  // Cash quick & ops
  $id('addIn')?.addEventListener('click',()=> addKasa('przyjÄ™cie', asNum($id('quickAmt')?.value||0), $id('quickNote')?.value, 'manual'));
  $id('addOut')?.addEventListener('click',()=> addKasa('wydanie', asNum($id('quickAmt')?.value||0), $id('quickNote')?.value, 'manual'));
  $id('cashClose')?.addEventListener('click',()=>{ const a=prompt('Ð˜Ñ‚Ð¾Ð³ Ð² ÐºÐ°ÑÑÐµ (PLN):', kasaBalance().toFixed(2)); if(a===null) return; addKasa('zamkniÄ™cie', asNum(a), 'close', 'manual'); });
  $id('q50')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+50).toFixed(2); });
  $id('q100')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+100).toFixed(2); });
  $id('q200')?.addEventListener('click',()=>{ const el=$id('quickAmt'); if(el) el.value=(Number(el.value||0)+200).toFixed(2); });

  // Speech
  const micBtn=$id('micBtn');
  if(micBtn && (window.SpeechRecognition||window.webkitSpeechRecognition)){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition; const rec=new SR();
    rec.continuous=false; rec.interimResults=false; rec.maxAlternatives=1;
    rec.lang=localStorage.getItem('speechLang')||'pl-PL';
    rec.onstart=()=>{ micBtn.classList.add('on'); $id('micStatus')&&( $id('micStatus').textContent=`ðŸŽ™ï¸ ... (${rec.lang})` ); };
    rec.onend=()=>{ micBtn.classList.remove('on'); };
    rec.onresult=(e)=>{
      const text=(e.results[0][0].transcript||"").toLowerCase();
      $id('micStatus')&&( $id('micStatus').textContent='ðŸŽ™ï¸ '+text );
      const numMatch=text.match(/(\d+[.,]?\d*)\s*(zÅ‚|pln|eur|usd)?/); const num=numMatch?numMatch[1]:null;
      const isOut=/(wyda|minus|wydat|Ð²Ñ‹Ð´Ð°|Ð¼Ð¸Ð½ÑƒÑ|Ñ€Ð°ÑÑ…Ð¾Ð´|Ð²Ð¸Ð´Ð°Ñ‚)/.test(text);
      const note=text.replace(/(\d+[.,]?\d*\s*(zÅ‚|pln|eur|usd)?)/,"").trim();
      if(!num){ $id('micStatus')&&( $id('micStatus').textContent='ðŸŽ™ï¸ ÑÑƒÐ¼Ð¼Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°'); return; }
      addKasa(isOut?'wydanie':'przyjÄ™cie', asNum(num), note||'voice', 'voice');
    };
    $id('speechLang')?.addEventListener('change',e=>{ rec.lang=e.target.value; localStorage.setItem('speechLang', rec.lang); });
    micBtn.addEventListener('click',()=>{ try{ rec.start(); }catch(e){ $id('micStatus')&&( $id('micStatus').textContent='ðŸŽ™ï¸ Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: '+e.message ); } });
  }

  // Settings
  $id('applySettings')?.addEventListener('click',()=>{
    localStorage.setItem('cashPLN',$id('cashPLN')?.value||"0");
    localStorage.setItem('penaltyPct',$id('penaltyPct')?.value||"0.05");
    localStorage.setItem('intervalMin',$id('intervalMin')?.value||"10");
    localStorage.setItem('rateEUR',$id('rateEUR')?.value||"4.30");
    localStorage.setItem('rateUSD',$id('rateUSD')?.value||"3.95");
    localStorage.setItem('blacklist',$id('blacklist')?.value||"");
    localStorage.setItem('autoCash', ($id('autoCash')?.checked?"1":"0"));
    $id('modeCash')&&( $id('modeCash').textContent = (localStorage.getItem('otd_lang')||'pl')==='ru' ? ("Ð ÐµÐ¶Ð¸Ð¼: "+($id('autoCash')?.checked?"Ð°Ð²Ñ‚Ð¾":"Ñ€ÑƒÑ‡Ð½Ð¾Ð¹")) : ("Mode: "+($id('autoCash')?.checked?"auto":"manual")) );
    render(); saveLocal(); scheduleAutosync(); pushState();
  });
  $id('exportCfg')?.addEventListener('click',()=>{
    const cfg=stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k),m),{});
    const blob=new Blob([JSON.stringify(cfg,null,2)],{type:"application/json"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='onetapday_settings.json'; a.click();
  });
  $id('importCfg')?.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return; const cfg=JSON.parse(await f.text());
    Object.entries(cfg).forEach(([k,v])=> localStorage.setItem(k, v));
    location.reload();
  });
  $id('clearAll')?.addEventListener('click',()=>{
    if(!confirm('ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸?')) return;
    ['kasa','tx_manual_import','bills_manual_import','accMeta'].forEach(k=> localStorage.removeItem(k));
    loadLocal(); inferAccounts(); render(); pushState();
  });

  // Demo/Sub controls
  $id('startDemo')?.addEventListener('click',()=>{
    localStorage.setItem(DEMO_START, new Date().toISOString()); updateSubUI(); gateAccess();
  });
  $id('endDemo')?.addEventListener('click',()=>{
    localStorage.removeItem(DEMO_START); updateSubUI(); gateAccess();
  });
  $id('payNow')?.addEventListener('click', async ()=>{
    const link = localStorage.getItem('stripe_link')||localStorage.getItem('stripePaymentLink');
    if(link){ location.href=link; return; }
    try{
      const r=await fetch('/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({demo:true})});
      const j=await r.json(); if(j?.url) { location.href=j.url; return; }
      alert('No Stripe URL from backend');
    }catch(e){ alert('Stripe error: '+(e?.message||e)); }
  });

  // INIT
  loadLocal(); loadKasa();
  // Defaults for Settings
  $id('txUrl')&&( $id('txUrl').value = localStorage.getItem('txUrl')||"" );
  ['cashPLN','penaltyPct','intervalMin','rateEUR','rateUSD','blacklist'].forEach(k=>{ if($id(k)) $id(k).value = localStorage.getItem(k)|| $id(k).value || ""; });
  if($id('autoCash')) $id('autoCash').checked = localStorage.getItem('autoCash')==='1';
  if($id('speechLang') && localStorage.getItem('speechLang')) $id('speechLang').value = localStorage.getItem('speechLang');

  inferAccounts();
  applyLang(localStorage.getItem('otd_lang')||'pl');
  render();
  scheduleAutosync();

  // Remote pull once, then push snapshot
  await pullState(); loadLocal(); inferAccounts(); render();
  pushState();

  // Save on unload (sendBeacon fallback)
  window.addEventListener('beforeunload', ()=>{
    try{
      const email=localStorage.getItem(USER_KEY)||"";
      if(!email) return;
      const body={
        email,
        tx: JSON.parse(localStorage.getItem('tx_manual_import')||'[]'),
        bills: JSON.parse(localStorage.getItem('bills_manual_import')||'[]'),
        kasa: JSON.parse(localStorage.getItem('kasa')||'[]'),
        accMeta: JSON.parse(localStorage.getItem('accMeta')||'{}'),
        settings: stateKeys.reduce((m,k)=> (m[k]=localStorage.getItem(k), m), {})
      };
      const blob=new Blob([JSON.stringify(body)],{type:'application/json'});
      navigator.sendBeacon && navigator.sendBeacon(`${API_BASE}/state/save`, blob);
    }catch(e){}
  });
});
</script>
</body>
</html>
