<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay – Portal</title>
  <style>
    :root {
      --bg: #0b1211;
      --panel: #121a19;
      --panel-2: #0f1716;
      --text: #d1d5db;
      --muted: #93a1a1;
      --green: #22c55e;
      --green-2: #16a34a;
      --green-3: #065f46;
      --stroke: #1f2a28;
      --input: #0b1211;
      --chip-bg: #0e1615;
      --chip-on: #052e24;
      --shadow: 0 6px 22px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .wrap { max-width: 1080px; margin: 28px auto; padding: 0 20px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    .brand { color: var(--green); font-weight: 700; font-size: 20px; }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px;
      background: var(--chip-bg);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip.on { background: var(--chip-on); color: var(--green); border-color: var(--green-3); }
    .lang { margin-left: auto; display: flex; gap: 6px; }
    .lang button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--chip-bg);
      color: var(--muted);
      cursor: pointer;
    }
    .lang button.on { background: var(--chip-on); color: var(--green); border-color: var(--green-3); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h3 { margin: 0 0 12px; font-size: 18px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 14px; }
    .tabs button {
      border: 1px solid var(--stroke);
      background: var(--chip-bg);
      color: var(--muted);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .tabs button.on { background: var(--chip-on); color: var(--green); border-color: var(--green-3); }
    .input { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .input input {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--input);
      color: var(--text);
      outline: none;
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 10px 14px;
      border: 1px solid var(--green-2);
      background: var(--green);
      color: #052e24;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(34,197,94,0.15);
    }
    .btn.secondary {
      background: transparent;
      color: var(--green);
      border-color: var(--green);
    }
    .btn:active { transform: translateY(1px); }
    .btn.block { width: 100%; display: flex; justify-content: center; }
    .btn.ghost {
      background: transparent;
      border-color: var(--stroke);
      color: var(--muted);
    }
    .muted { color: var(--muted); font-size: 12px; margin-top: 8px; }
    /* API panel (for dev mode only) */
    .api { display: none; }
    .api.show { display: flex; gap: 8px; align-items: center; margin-left: 8px; }
    .api input { width: 340px; }
    /* Status pill */
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--stroke);
      color: var(--muted);
    }
    .section { margin-top: 14px; border-top: 1px dashed var(--stroke); padding-top: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">OneTapDay</div>
      <!-- API base URL input (visible only in ?dev=1 mode) -->
      <div class="api" id="apiBox">
        <span class="chip on">API:</span>
        <input id="api" class="chip" placeholder="https://your-api-url" value="http://127.0.0.1:3000">
        <button class="btn secondary" id="saveApi">Save</button>
      </div>
      <div class="lang" id="langBar">
        <button data-lang="ru" class="on">RU</button>
        <button data-lang="en">EN</button>
        <button data-lang="pl">PL</button>
        <button data-lang="uk">UK</button>
      </div>
    </header>

    <div class="grid">
      <!-- Login/Registration Section -->
      <section class="card">
        <h3 data-i="access_title">Доступ к MVP</h3>
        <div class="tabs">
          <button data-tab="login" class="on" data-i="login_tab">Вход</button>
          <button data-tab="reg" data-i="reg_tab">Регистрация</button>
        </div>
        <div class="input">
          <input id="email" type="email" placeholder="Email" />
          <input id="pass" type="password" placeholder="Пароль" />
        </div>
        <div class="row">
          <button class="btn" id="doLogin" data-i="login_btn">Войти</button>
          <button class="btn secondary" id="doPay" data-i="pay_or_demo">Оплата/Демо</button>
        </div>
        <div class="muted" data-i="after_login_hint">После входа можно оплатить или включить демо.</div>
      </section>

      <!-- Status & Access Actions Section -->
      <aside class="card">
        <h3 data-i="status_title">Статус</h3>
        <div class="status-pill" id="statusText" data-i="status_guest">
          Неизвестный пользователь. Войдите или зарегистрируйтесь.
        </div>

        <div class="section">
          <h3 data-i="access_actions">Доступ</h3>
          <div class="row">
            <a class="btn block" id="payStripe" href="#" target="_blank" data-i="stripe_2m">Оплатить 2 месяца (Stripe)</a>
            <button class="btn ghost block" id="demoBtn" data-i="demo_24">Демо 24 часа</button>
          </div>
          <div class="muted" data-i="access_note">Оплата даёт мгновенный доступ. Демо — 24 часа.</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Internationalization strings for portal
    const T = {
      ru: {
        access_title: "Доступ к MVP",
        login_tab: "Вход",
        reg_tab: "Регистрация",
        login_btn: "Войти",
        pay_or_demo: "Оплата/Демо",
        after_login_hint: "После входа можно оплатить или включить демо.",
        status_title: "Статус",
        status_guest: "Неизвестный пользователь. Войдите или зарегистрируйтесь.",
        access_actions: "Доступ",
        stripe_2m: "Оплатить 2 месяца (Stripe)",
        demo_24: "Демо 24 часа",
        access_note: "Оплата даёт мгновенный доступ. Демо — 24 часа.",
        // Status descriptions:
        status_none: "Ожидается оплата депозита",
        status_deposit_paid: "Депозит оплачен",
        status_active: "Пилот активен",
        status_ended: "Пилот завершён",
        status_discount_active: "Скидка активна"
      },
      en: {
        access_title: "MVP Access",
        login_tab: "Login",
        reg_tab: "Sign Up",
        login_btn: "Sign In",
        pay_or_demo: "Pay/Demo",
        after_login_hint: "After signing in, you can pay or start a demo.",
        status_title: "Status",
        status_guest: "Guest user. Please sign in or register.",
        access_actions: "Access",
        stripe_2m: "Pay 2 months (Stripe)",
        demo_24: "24h Demo",
        access_note: "Payment grants instant access. Demo lasts 24h.",
        status_none: "Awaiting deposit payment",
        status_deposit_paid: "Deposit paid",
        status_active: "Pilot active",
        status_ended: "Pilot ended",
        status_discount_active: "Discount active"
      },
      pl: {
        access_title: "Dostęp do MVP",
        login_tab: "Logowanie",
        reg_tab: "Rejestracja",
        login_btn: "Zaloguj",
        pay_or_demo: "Płatność/Demo",
        after_login_hint: "Po zalogowaniu możesz zapłacić lub włączyć demo.",
        status_title: "Status",
        status_guest: "Nieznany użytkownik. Zaloguj się lub zarejestruj.",
        access_actions: "Dostęp",
        stripe_2m: "Zapłać 2 miesiące (Stripe)",
        demo_24: "Demo 24 godziny",
        access_note: "Płatność daje natychmiastowy dostęp. Demo trwa 24h.",
        status_none: "Oczekiwanie na depozyt",
        status_deposit_paid: "Depozyt opłacony",
        status_active: "Pilot aktywny",
        status_ended: "Pilot zakończony",
        status_discount_active: "Zniżka aktywna"
      },
      uk: {
        access_title: "Доступ до MVP",
        login_tab: "Вхід",
        reg_tab: "Реєстрація",
        login_btn: "Увійти",
        pay_or_demo: "Оплата/Демо",
        after_login_hint: "Після входу можна оплатити або увімкнути демо.",
        status_title: "Статус",
        status_guest: "Невідомий користувач. Увійдіть або зареєструйтесь.",
        access_actions: "Доступ",
        stripe_2m: "Оплатити 2 місяці (Stripe)",
        demo_24: "Демо 24 години",
        access_note: "Оплата дає миттєвий доступ. Демо триває 24 години.",
        status_none: "Очікується оплата депозиту",
        status_deposit_paid: "Депозит сплачено",
        status_active: "Пілот активний",
        status_ended: "Пілот завершено",
        status_discount_active: "Знижка активна"
      }
    };
    function applyLang(lang) {
      const dict = T[lang] || T.ru;
      document.querySelectorAll("[data-i]").forEach(el => {
        const key = el.getAttribute("data-i");
        if (dict[key]) el.textContent = dict[key];
      });
      // Toggle active class on language buttons
      document.querySelectorAll(".lang button").forEach(btn => {
        btn.classList.toggle("on", btn.dataset.lang === lang);
      });
      localStorage.setItem("otd_lang", lang);
    }

    // Language switch handler
    document.getElementById("langBar").addEventListener("click", (e) => {
      if (e.target.dataset.lang) {
        applyLang(e.target.dataset.lang);
      }
    });

    // Initialize language on load
    applyLang(localStorage.getItem("otd_lang") || "ru");

    // Determine base API URL (use input value in dev mode, or same origin in production)
    const params = new URLSearchParams(location.search);
    const apiInput = document.getElementById("api");
    const apiBase = params.get("dev") === "1" ? apiInput.value.trim() : "";
    if (params.get("dev") === "1") {
      document.getElementById("apiBox").classList.add("show");
    }

    // Allow updating API base URL in dev mode
    document.getElementById("saveApi")?.addEventListener("click", () => {
      if (apiInput.value.trim()) {
        // Save new base URL (only in UI, not persisting to localStorage to avoid misuse in production)
        alert("API base URL set to " + apiInput.value.trim());
      }
    });

    // Track current user login status
    let currentUserEmail = null;

    // Toggle between Login and Registration tabs
    const tabs = document.querySelectorAll(".tabs button");
    let authMode = "login";  // "login" or "reg"
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        // Highlight selected tab
        tabs.forEach(b => b.classList.remove("on"));
        btn.classList.add("on");
        authMode = btn.dataset.tab;
        // Change the main action button text based on mode
        document.getElementById("doLogin").textContent = (authMode === "login" 
          ? T[localStorage.getItem("otd_lang")||"ru"].login_btn 
          : T[localStorage.getItem("otd_lang")||"ru"].reg_tab);
      });
    });

    // Handle Login or Registration submission
    document.getElementById("doLogin").addEventListener("click", () => {
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("pass").value;
      if (!email || !pass) {
        alert("📧 Пожалуйста, введите email и пароль.");  // Simple alert (we can localize this line if needed)
        return;
      }
      const endpoint = authMode === "login" ? "/login" : "/register";
      fetch(apiBase + endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: email, password: pass })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert(data.error || "Ошибка авторизации/регистрации");
          return;
        }
        // Successful login or registration
        currentUserEmail = data.user.email;
        localStorage.setItem("otd_user", currentUserEmail);
        // Update status pill text to reflect user's access status
        let statusKey;
        switch (data.user.status) {
          case "none":            statusKey = "status_none"; break;
          case "deposit_paid":    statusKey = "status_deposit_paid"; break;
          case "active":          statusKey = "status_active"; break;
          case "ended":           statusKey = "status_ended"; break;
          case "discount_active": statusKey = "status_discount_active"; break;
          default:                statusKey = "status_none";
        }
        document.getElementById("statusText").setAttribute("data-i", statusKey);
        applyLang(localStorage.getItem("otd_lang") || "ru");  // refresh text in selected language
        // Show user email and logout option in status pill
        document.getElementById("statusText").innerHTML = 
          (data.user.email + " – " + (T[localStorage.getItem('otd_lang')||'ru'][statusKey] || "") + 
           ' <button id="logoutBtn" class="btn ghost" style="padding:2px 6px; font-size:11px;">Logout</button>');
        // Enable the Pay/Demo buttons now that user is logged in
        // (In case they were disabled earlier)
        // If user already has active access, we might hide Pay/Demo options:
        if (data.user.status === "active" || data.user.status === "discount_active") {
          document.getElementById("payStripe").style.display = "none";
          document.getElementById("demoBtn").style.display = "none";
          document.querySelector("[data-i='access_note']").textContent = 
            T[localStorage.getItem('otd_lang')||'ru'].status_active || "Доступ активен.";
        }
        // If user has no access (none or ended), they can proceed with payment or demo
        // Attach logout handler
        document.getElementById("logoutBtn").onclick = () => {
          fetch(apiBase + "/logout", { method: "POST" }).finally(() => {
            localStorage.removeItem("otd_user");
            currentUserEmail = null;
            alert("Вы вышли из системы.");  // "Logged out."
            location.reload();
          });
        };
      })
      .catch(err => {
        console.error("Auth error:", err);
        alert("Произошла ошибка при соединении с сервером.");  // "An error occurred connecting to server."
      });
    });

    // Scroll to payment options (or focus them) when "Оплата/Демо" is clicked
    document.getElementById("doPay").addEventListener("click", () => {
      if (!currentUserEmail) {
        alert("Сначала войдите или зарегистрируйтесь."); // "Please log in or register first."
        return;
      }
      const paySection = document.getElementById("payStripe");
      paySection.focus();
      paySection.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    // Handle 24h Demo activation
    document.getElementById("demoBtn").addEventListener("click", () => {
      if (!currentUserEmail) {
        alert("Сначала войдите.");  // "Please log in first."
        return;
      }
      if (!confirm("Активировать демо-доступ на 24 часа?")) return;
      fetch(apiBase + "/start-demo", { method: "POST" })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("Демо-доступ активирован до " + data.demoUntil);
            // Update status to active (demo)
            document.getElementById("statusText").setAttribute("data-i", "status_active");
            applyLang(localStorage.getItem("otd_lang") || "ru");
            document.getElementById("statusText").innerHTML = 
              (currentUserEmail + " – " + (T[localStorage.getItem('otd_lang')||'ru'].status_active || "Пилот активен") +
               ' <button id="logoutBtn" class="btn ghost" style="padding:2px 6px; font-size:11px;">Logout</button>');
            // Hide Pay/Demo since user now has access
            document.getElementById("payStripe").style.display = "none";
            document.getElementById("demoBtn").style.display = "none";
            document.querySelector("[data-i='access_note']").textContent = 
              "Демо активен до " + data.demoUntil; // no full translation here for brevity
            // Attach logout (reassign because we replaced innerHTML)
            document.getElementById("logoutBtn").onclick = () => {
              fetch(apiBase + "/logout", { method: "POST" }).finally(() => {
                localStorage.removeItem("otd_user");
                currentUserEmail = null;
                location.reload();
              });
            };
          } else {
            alert(data.error || "Не удалось запустить демо.");
          }
        })
        .catch(err => console.error(err));
    });

    // Handle Stripe payment (redirect to Checkout)
    document.getElementById("payStripe").addEventListener("click", (e) => {
      e.preventDefault();
      if (!currentUserEmail) {
        alert("Сначала войдите."); 
        return;
      }
      // Request Checkout Session creation
      fetch(apiBase + "/create-checkout-session", { method: "POST" })
        .then(res => res.json())
        .then(data => {
          if (data.sessionUrl) {
            // Redirect to Stripe Checkout
            window.location = data.sessionUrl;
          } else {
            alert("Ошибка инициации платежа.");
          }
        })
        .catch(err => console.error("Stripe session error:", err));
    });
  </script>
</body>
</html>
