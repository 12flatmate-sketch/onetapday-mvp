<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OneTapDay — MVP</title>
  <style>
    body{background:#081311;color:#e6ffe6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;padding:40px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{font-size:28px;margin:0 0 24px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .card{background:#0f1f1c;border:1px solid #15312b;border-radius:14px;padding:20px;box-shadow:0 0 0 1px #0c1a16 inset}
    .title{font-weight:700;margin-bottom:12px}
    input[type=email]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1e3f37;background:#0a1715;color:#c9f7c9;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:#122a24;color:#c8ffd4}
    button.primary{background:#1ed45a;color:#07120f;font-weight:700}
    .muted{font-size:12px;color:#a7d8be;margin-top:8px}
    .statusline{font-size:14px;line-height:1.3;margin:6px 0}
    iframe{width:100%;height:70vh;border:0;border-radius:12px;display:none;background:#000}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>OneTapDay — MVP</h1>
    <div class="grid">
      <div class="card">
        <div class="title">Доступ к MVP</div>
        <label style="font-size:12px;color:#9fcfb4">Вход по Email (быстрый)</label>
        <input id="email" type="email" placeholder="you@email.com" autocomplete="email">
        <div class="row">
          <button id="loginBtn" class="primary">Войти / Зарегистрироваться</button>
          <button id="demoBtn">Демо 24ч</button>
        </div>
        <div class="row">
          <button id="payBtn" class="primary">Оплатить 2 месяца (99 PLN)</button>
        </div>
        <div class="muted">Демо — 24 часа. Подписка — 2 месяца за 99 PLN.</div>
        <div id="msg" class="muted"></div>
      </div>
      <div class="card">
        <div class="title">Статус</div>
        <div class="statusline">Email: <span id="sEmail">—</span></div>
        <div class="statusline">Paid: <span id="sPaid">—</span></div>
        <div class="statusline">Demo: <span id="sDemo">—</span></div>
        <div class="row">
          <button id="logoutBtn">Выход</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:20px">
      <iframe id="mvp" title="MVP"></iframe>
    </div>
  </div>

<script>
// helpers
const $ = (s)=>document.querySelector(s);
const api = async (url, data)=>{
  const res = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data||{})
  });
  if(!res.ok) throw new Error((await res.json().catch(()=>({}))).error||('HTTP '+res.status));
  return res.json();
};
const fmt = (t)=> t ? new Date(Number(t)).toLocaleString() : '—';

// state
function saveEmail(v){ localStorage.otd_email=v; }
function getEmail(){ return localStorage.otd_email||''; }
function setMsg(t){ $('#msg').textContent=t||''; }

// UI bind
function bind(){
  $('#email').value = getEmail();
  $('#sEmail').textContent = getEmail() || '—';

  $('#loginBtn').onclick = async ()=>{
    const email = $('#email').value.trim();
    if(!email){ setMsg('Укажи email'); return; }
    saveEmail(email);
    try{
      await api('/login',{email});
      setMsg('Вошли.');
      refreshStatus();
    }catch(e){ setMsg('Ошибка входа: '+e.message); }
  };

  $('#demoBtn').onclick = async ()=>{
    const email = $('#email').value.trim();
    if(!email){ setMsg('Укажи email'); return; }
    saveEmail(email);
    try{
      const r = await api('/demo',{email});
      setMsg('Демо включено до: '+fmt(r.demo_until));
      $('#mvp').style.display='block';
      $('#mvp').src = '/mvp.html';
      refreshStatus();
    }catch(e){ setMsg('Ошибка демо: '+e.message); }
  };

  $('#payBtn').onclick = async ()=>{
    const email = $('#email').value.trim();
    if(!email){ setMsg('Укажи email'); return; }
    saveEmail(email);
    try{
      const r = await api('/create-checkout-session',{email});
      window.location.href = r.url;
    }catch(e){ setMsg('Ошибка создания сессии: '+e.message); }
  };

  $('#logoutBtn').onclick = ()=>{
    localStorage.removeItem('otd_email');
    $('#email').value='';
    $('#sEmail').textContent='—';
    $('#sPaid').textContent='—';
    $('#sDemo').textContent='—';
    $('#mvp').style.display='none';
    $('#mvp').src='about:blank';
    setMsg('Вышли.');
  };
}

// status poll
async function refreshStatus(){
  const email = getEmail();
  if(!email) return;
  try{
    const qs = new URLSearchParams({email});
    const r = await fetch('/user?'+qs.toString()).then(x=>x.json());
    const u = r.user || {};
    $('#sEmail').textContent = email;
    $('#sPaid').textContent = fmt(u.paid_until);
    $('#sDemo').textContent = fmt(u.demo_until);
    // auto open MVP if paid or demo
    if( (u.paid_until && Number(u.paid_until) > Date.now()) ||
        (u.demo_until && Number(u.demo_until) > Date.now()) ){
      $('#mvp').style.display='block';
      if(!$('#mvp').src || $('#mvp').src==='about:blank') $('#mvp').src='/mvp.html';
    }
  }catch(e){
    // silent
  }
}

// confirm after redirect from Stripe
async function handleStripeReturn(){
  const sp = new URLSearchParams(location.search);
  const sid = sp.get('session_id');
  if(!sid) return;
  try{
    const r = await fetch('/confirm?session_id='+encodeURIComponent(sid)).then(x=>x.json());
    if(r.ok){
      setMsg('Оплата подтверждена. Доступ открыт.');
      $('#mvp').style.display='block';
      $('#mvp').src='/mvp.html';
      history.replaceState({},'',location.origin+location.pathname); // clean URL
      refreshStatus();
    }else{
      setMsg('Не удалось подтвердить оплату.');
    }
  }catch(e){
    setMsg('Ошибка подтверждения: '+e.message);
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  bind();
  await handleStripeReturn();
  refreshStatus();
  setInterval(refreshStatus, 5000);
});
</script>
</body>
</html>
