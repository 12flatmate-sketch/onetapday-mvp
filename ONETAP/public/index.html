<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OneTapDay – Доступ к MVP</title>
  <style>
    :root {
      --green: #35D36B;
      --bg: #f7f9fa;
      --card: #fff;
      --text: #000;
      --muted: #6c757d;
      --stroke: #ced4da;
      --input: #eef1f3;
      --chip-bg: #eef6f2;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
    }
    .wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
    }
    .lang button {
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.6;
      font-weight: 600;
    }
    .lang button.on {
      opacity: 1;
      text-decoration: underline;
    }
    .api {
      display: none;
    }
    .api.show {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: 8px;
    }
    .api input {
      width: 240px;
    }
    .chip {
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid var(--stroke);
      background: var(--chip-bg);
    }
    .chip.on {
      background: var(--green);
      color: #fff;
      border-color: var(--green);
    }
    .grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 14px;
      flex: 1;
      min-width: 260px;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .tabs button {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      background: var(--input);
      cursor: pointer;
    }
    .tabs button.on {
      background: var(--green);
      color: #fff;
      border-color: var(--green);
    }
    .input {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .input input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      background: var(--input);
      color: var(--text);
      outline: none;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 8px;
      background: var(--green);
      color: #fff;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      text-align: center;
    }
    .btn.secondary {
      background: transparent;
      color: var(--green);
      border: 2px solid var(--green);
      flex: 1;
    }
    .btn.block {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    .btn.ghost {
      background: transparent;
      border: 1px dashed var(--stroke);
      color: var(--muted);
    }
    .muted {
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--stroke);
      color: var(--muted);
      margin-bottom: 8px;
    }
    .section {
      margin-top: 14px;
      border-top: 1px dashed var(--stroke);
      padding-top: 14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">OneTapDay</div>
      <!-- API endpoint panel (visible only in dev mode) -->
      <div class="api" id="apiBox">
        <span class="chip on">API:</span>
        <input id="api" class="chip" 
               placeholder="https://<Ваш_домен_API>" 
               value="https://<ВАШ_БЭКЕНД>.onrender.com">
        <button class="btn secondary" id="saveApi">save</button>
      </div>
      <!-- Language switcher -->
      <div class="lang" id="langBar">
        <button data-lang="ru" class="on">RU</button>
        <button data-lang="en">EN</button>
        <button data-lang="pl">PL</button>
        <button data-lang="uk">UK</button>
      </div>
    </header>

    <div class="grid">
      <!-- Login/Registration card -->
      <section class="card">
        <h3 data-i="access_title">Доступ к MVP</h3>
        <div class="tabs">
          <button data-tab="login" class="on" data-i="login_tab">Вход</button>
          <button data-tab="reg" data-i="reg_tab">Регистрация</button>
        </div>

        <div class="input">
          <input id="email" type="email" placeholder="Email" />
          <input id="pass" type="password" placeholder="Пароль" />
        </div>

        <div class="row">
          <button class="btn" id="doLogin" data-i="login_btn">Войти</button>
          <button class="btn secondary" id="doPay" data-i="pay_or_demo">Оплата/Демо</button>
        </div>
        <div class="muted" data-i="after_login_hint">
          После входа можно оплатить или включить демо.
        </div>
      </section>

      <!-- Status & Access card -->
      <aside class="card">
        <h3 data-i="status_title">Статус</h3>
        <div class="status-pill" id="statusText" data-i="status_guest">
          Неизвестный пользователь. Войдите или зарегистрируйтесь.
        </div>

        <div class="section">
          <h3 data-i="access_actions">Доступ</h3>
          <div class="row">
            <!-- Stripe payment link (will redirect to app after payment) -->
            <a class="btn block" id="payStripe" href="#" data-i="stripe_2m">
              Оплатить 2 месяца (Stripe)
            </a>
            <!-- Demo activation button -->
            <button class="btn ghost block" id="demoBtn" data-i="demo_24">
              Демо 24 часа
            </button>
          </div>
          <div class="muted" data-i="access_note">
            Оплата даёт мгновенный доступ. Демо — 24 часа.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Utility to get API base URL from input or storage
    function getApiBase() {
      return localStorage.getItem('otd_api') || document.getElementById('api').value.trim();
    }
    // Get current language (default ru if not set)
    function currentLang() {
      return localStorage.getItem('otd_lang') || 'ru';
    }
    // Internationalization strings
    const T = {
      ru: {
        access_title: 'Доступ к MVP',
        login_tab: 'Вход',
        reg_tab: 'Регистрация',
        login_btn: 'Войти',
        pay_or_demo: 'Оплата/Демо',
        after_login_hint: 'После входа можно оплатить или включить демо.',
        status_title: 'Статус',
        status_guest: 'Неизвестный пользователь. Войдите или зарегистрируйтесь.',
        access_actions: 'Доступ',
        stripe_2m: 'Оплатить 2 месяца (Stripe)',
        demo_24: 'Демо 24 часа',
        access_note: 'Оплата даёт мгновенный доступ. Демо — 24 часа.'
      },
      en: {
        access_title: 'MVP Access',
        login_tab: 'Login',
        reg_tab: 'Sign up',
        login_btn: 'Sign in',
        pay_or_demo: 'Pay/Demo',
        after_login_hint: 'After sign-in you can pay or start demo.',
        status_title: 'Status',
        status_guest: 'Guest. Please sign in or register.',
        access_actions: 'Access',
        stripe_2m: 'Pay 2 months (Stripe)',
        demo_24: '24h Demo',
        access_note: 'Payment grants instant access. Demo lasts 24h.'
      },
      pl: {
        access_title: 'Dostęp do MVP',
        login_tab: 'Logowanie',
        reg_tab: 'Rejestracja',
        login_btn: 'Zaloguj',
        pay_or_demo: 'Płatność/Demo',
        after_login_hint: 'Po zalogowaniu możesz zapłacić lub włączyć demo.',
        status_title: 'Status',
        status_guest: 'Nieznany użytkownik. Zaloguj się lub zarejestruj.',
        access_actions: 'Dostęp',
        stripe_2m: 'Zapłać 2 miesiące (Stripe)',
        demo_24: 'Demo 24 godziny',
        access_note: 'Płatność daje natychmiastowy dostęp. Demo — 24h.'
      },
      uk: {
        access_title: 'Доступ до MVP',
        login_tab: 'Вхід',
        reg_tab: 'Реєстрація',
        login_btn: 'Увійти',
        pay_or_demo: 'Оплата/Демо',
        after_login_hint: 'Після входу можна оплатити або увімкнути демо.',
        status_title: 'Статус',
        status_guest: 'Гість. Увійдіть або зареєструйтеся.',
        access_actions: 'Доступ',
        stripe_2m: 'Оплатити 2 місяці (Stripe)',
        demo_24: 'Демо 24 години',
        access_note: 'Оплата дає миттєвий доступ. Демо — 24 год.'
      }
    };

    // Apply language translations to all elements with data-i attributes
    function applyLang(lang) {
      const d = T[lang] || T.ru;
      document.querySelectorAll('[data-i]').forEach(el => {
        const key = el.getAttribute('data-i');
        if (d[key]) el.textContent = d[key];
      });
      // Highlight active language button
      document.querySelectorAll('.lang button').forEach(b => {
        b.classList.toggle('on', b.dataset.lang === lang);
      });
      // Persist language selection
      localStorage.setItem('otd_lang', lang);
      // If registration tab is active, adjust submit button text
      if (document.querySelector('.tabs button.on[data-tab="reg"]')) {
        document.getElementById('doLogin').textContent = d['reg_tab'];
      }
    }

    // Initialize language on page load
    applyLang(currentLang());

    // Language switcher event
    document.getElementById('langBar').addEventListener('click', e => {
      if (e.target.dataset.lang) {
        applyLang(e.target.dataset.lang);
      }
    });

    // Show API panel if ?dev=1 in URL
    const params = new URLSearchParams(location.search);
    if (params.get('dev') === '1') {
      document.getElementById('apiBox').classList.add('show');
    }

    // Save API base to localStorage
    document.getElementById('saveApi').onclick = () => {
      const apiUrl = document.getElementById('api').value.trim();
      localStorage.setItem('otd_api', apiUrl);
      alert('API endpoint сохранён.');
    };

    // Tabs (Login vs Register) switching
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        // Toggle active tab
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('on'));
        btn.classList.add('on');
        // Update submit button text based on active tab
        const lang = currentLang();
        if (btn.dataset.tab === 'reg') {
          document.getElementById('doLogin').textContent = T[lang].reg_tab;
        } else {
          document.getElementById('doLogin').textContent = T[lang].login_btn;
        }
      });
    });

    // Disable Stripe link and Demo by default (require login first)
    let loggedIn = false;
    document.getElementById('payStripe').onclick = (e) => {
      if (!loggedIn) {
        e.preventDefault();
        alert('Сначала войдите или зарегистрируйтесь.');
      }
    };
    document.getElementById('demoBtn').onclick = () => {
      if (!loggedIn) {
        alert('Сначала войдите или зарегистрируйтесь.');
      }
    };

    // Login/Register action
    document.getElementById('doLogin').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('pass').value;
      if (!email || !pass) {
        alert('Введите Email и Пароль.');
        return;
      }
      const isReg = document.querySelector('.tabs button.on').dataset.tab === 'reg';
      const apiBase = getApiBase();
      const url = apiBase + (isReg ? '/register' : '/login');
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email, password: pass }),
          credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) {
          // If server returned error
          alert(data.message || (isReg ? 'Ошибка регистрации' : 'Ошибка входа'));
          return;
        }
        // Success:
        loggedIn = true;
        // Save token if provided (assume JWT token in data.token)
        if (data.token) {
          localStorage.setItem('otd_token', data.token);
        }
        // Save user email for later use (e.g., Stripe)
        localStorage.setItem('user_email', email);
        // Update status text to show logged-in user
        const statusEl = document.getElementById('statusText');
        const lang = currentLang();
        if (lang === 'ru') {
          statusEl.textContent = 'Вошли: ' + email;
        } else if (lang === 'pl') {
          statusEl.textContent = 'Zalogowano: ' + email;
        } else if (lang === 'uk') {
          statusEl.textContent = 'Увійшли: ' + email;
        } else {
          statusEl.textContent = 'Signed in: ' + email;
        }
        // Enable Stripe link and Demo button
        const stripeLinkBase = 'https://buy.stripe.com/test_7sY5kw9Uq8A34VQ22f9sk00';
        const stripeLinkFull = stripeLinkBase + '?prefilled_email=' + encodeURIComponent(email);
        document.getElementById('payStripe').href = stripeLinkFull;
        localStorage.setItem('otd_stripe', stripeLinkFull);
        // Adjust onclick for demo button to call API
        document.getElementById('demoBtn').onclick = async () => {
          try {
            const demoRes = await fetch(apiBase + '/demo', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': data.token ? 'Bearer ' + data.token : ''
              },
              credentials: 'include'
            });
            if (!demoRes.ok) {
              alert('Ошибка активации демо.');
              return;
            }
            // On successful demo activation, go to main app page
            window.location.href = 'app.html';
          } catch (e) {
            alert('Ошибка: не удалось подключиться к серверу.');
          }
        };
        // If user registered (isReg=true), optionally auto-trigger demo or inform user
        if (isReg) {
          alert('Регистрация успешно выполнена! Теперь вы можете активировать демо или оплатить подписку.');
        }
        // Scroll to access section (make buttons visible)
        document.getElementById('payStripe').focus();
        window.scrollTo({
          top: document.getElementById('payStripe').getBoundingClientRect().top + window.scrollY - 20,
          behavior: 'smooth'
        });
      } catch (err) {
        alert('Ошибка соединения с сервером.');
      }
    };

    // "Оплата/Демо" button scrolls to payment options section
    document.getElementById('doPay').onclick = () => {
      document.getElementById('payStripe').focus();
      window.scrollTo({
        top: document.getElementById('payStripe').getBoundingClientRect().top + window.scrollY - 20,
        behavior: 'smooth'
      });
    };
  </script>
</body>
</html>
