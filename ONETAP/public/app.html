<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay ‚Äì AI Ksiƒôgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #cfe6d7;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: var(--accent);
      color: #08110b;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #9aa3a9;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number] {
      background: #0f1214;
      border: 1px solid #20262b;
      border-radius: 8px;
      color: #e6edf3;
      padding: 9px;
    }
    .right { margin-left: auto; }
    .mic {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2a3136;
      background: #0f1214;
      cursor: pointer;
    }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    @media (max-width: 1080px) {
      .cards { grid-template-columns: 1fr 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
    @media print {
      .tabs, .btn, .row input, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .card { background: #fff; border: 1px solid #999; }
      .wrap { max-width: 1000px; }
    }
    /* Language toggle (reuse same style as portal) */
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #20262b;
      background: #0f1214;
      color: #9aa3a9;
      font-size: 12px;
      cursor: pointer;
    }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay ‚Äî AI Ksiƒôgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">–ü—É–ª—å—Ç</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">WyciƒÖg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">–°—á–µ—Ç–∞</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (–Ω–∞–ª)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="pulpit" class="section active">
      <div class="cards">
        <div class="card">
          <div class="muted" data-i="kpi_due_today">–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiDue" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_unmatched">–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
          <div id="kpiUnmatch" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_banks">–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ</div>
          <div id="kpiBank" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_cash">–ö–∞—Å—Å–∞ (–Ω–∞–ª)</div>
          <div id="kpiCash" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_total">–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ</div>
          <div id="kpiAvail" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_gap_today">–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è</div>
          <div id="kpiGap" class="kpi">0</div>
        </div>
      </div>
      <div class="row" style="margin: 10px 0;">
        <button id="syncNow" class="btn" data-i="btn_sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
        <button id="runAI" class="btn secondary" data-i="btn_ai_match">–ò–ò‚Äë—Å–≤–µ—Ä–∫–∞</button>
        <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã</button>
        <button id="exportPDF" class="btn secondary" data-i="btn_pdf">PDF –æ—Ç—á—ë—Ç</button>
        <span id="lastSync" class="pill">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ‚Äî</span>
        <span class="right pill" id="modeCash">–†–µ–∂–∏–º: –∞–≤—Ç–æ</span>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="minpay_title">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ‚Äë—Å—Ç–æ–ø)</div>
          <div id="minPayBox" class="muted">‚Äî</div>
          <div class="row" style="margin-top: 6px;">
            <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_7d">–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast7d_note">–°—á–∏—Ç–∞–µ—Ç PLN‚Äë—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.</div>
          <div id="forecastBars" class="barwrap"></div>
          <div id="forecastMeta" class="muted" style="margin-top: 6px;">‚Äî</div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_30d">–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π</div>
          <div class="muted" data-i="forecast30_note">–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.</div>
          <div id="forecast30Table"></div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="month_summary_title">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</div>
          <div id="monthSummary" class="muted">‚Äî</div>
        </div>
      </div>
      <div class="card" style="margin-top: 14px;">
        <div class="row">
          <div style="font-weight: 700;" data-i="plan_title">–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É</div>
          <div class="right"> 
            <span data-i="filter_label">–§–∏–ª—å—Ç—Ä:</span>
            <select id="planFilter">
              <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
              <option value="all" data-i="filter_all">–í—Å–µ</option>
            </select>
          </div>
          <label style="margin-left: 10px;">
            <input type="checkbox" id="excludeBlacklist" /> <span data-i="exclude_blacklist">–ò—Å–∫–ª—é—á–∞—Ç—å blacklist</span>
          </label>
        </div>
        <div class="row" style="margin: 8px 0;">
          <button id="makePlan" class="btn secondary" data-i="btn_make_plan">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <span id="planMeta" class="pill">‚Äî</span>
        </div>
        <table id="planTable">
          <thead>
            <tr>
              <th>#</th>
              <th data-i="plan_th_invoice">–§–∞–∫—Ç—É—Ä–∞</th>
              <th data-i="plan_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th data-i="plan_th_due">–°—Ä–æ–∫</th>
              <th data-i="plan_th_amount">–°—É–º–º–∞</th>
              <th data-i="plan_th_reason">–ü—Ä–∏—á–∏–Ω–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Bank Statement Section (WyciƒÖg) -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_statement">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)</span>
        </label>
        <input id="txUrl" type="text" placeholder="URL CSV wyciƒÖga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <span class="muted">
          –ö–æ–ª–æ–Ω–∫–∏: Data ksiƒôgowania, ID transakcji, ID konta (–∏–ª–∏ IBAN), Kontrahent, Tytu≈Ç/Opis, Kwota(¬±), Waluta, Status transakcji, Saldo po operacji?
        </span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">–î–∞—Ç–∞</th>
            <th data-i="th_account">–°—á—ë—Ç</th>
            <th data-i="th_counterparty">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
            <th data-i="th_desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th data-i="th_amount">–°—É–º–º–∞</th>
            <th data-i="th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="th_status">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Invoices Section (Faktury) -->
    <div id="faktury" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_invoices">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)</span>
        </label>
        <input id="billUrl" type="text" placeholder="URL CSV faktur" />
        <button id="saveBillUrl" class="btn secondary" data-i="save_url">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
        <label style="margin-left: 10px;">
          <input type="checkbox" id="billOverdueOnly" /> <span data-i="only_overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</span>
        </label>
        <div class="right">
          <span data-i="show_label">–ü–æ–∫–∞–∑–∞—Ç—å:</span>
          <select id="billScope">
            <option value="today" data-i="filter_today">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="7d" data-i="filter_7d" selected>7 –¥–Ω–µ–π</option>
            <option value="all" data-i="filter_all">–í—Å–µ</option>
          </select>
        </div>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th data-i="inv_th_due">–°—Ä–æ–∫</th>
            <th data-i="inv_th_number">‚Ññ</th>
            <th data-i="inv_th_supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
            <th data-i="inv_th_amount">–°—É–º–º–∞</th>
            <th data-i="inv_th_currency">–í–∞–ª—é—Ç–∞</th>
            <th data-i="inv_th_status">–°—Ç–∞—Ç—É—Å</th>
            <th data-i="inv_th_candidate">–ö–∞–Ω–¥–∏–¥–∞—Ç</th>
            <th data-i="inv_th_score">Score</th>
            <th data-i="inv_th_action">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Accounts Section (Konta) -->
    <div id="konta" class="section">
      <div class="card">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="auto_accounts_title">–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)</div>
        <div class="muted" data-i="auto_accounts_desc">
          –ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.
        </div>
        <table id="autoAcc">
          <thead>
            <tr>
              <th data-i="acc_th_account">–°—á—ë—Ç</th>
              <th data-i="acc_th_type">–¢–∏–ø</th>
              <th data-i="acc_th_currency">–í–∞–ª—é—Ç–∞</th>
              <th data-i="acc_th_balance_calc">–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)</th>
              <th data-i="acc_th_start_balance">–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</th>
              <th data-i="acc_th_include">–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cash Section (Kasa) -->
    <div id="kasa" class="section">
      <div class="row">
        <input id="quickAmt" type="number" placeholder="–°—É–º–º–∞ PLN" step="0.01" />
        <input id="quickNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
        <button class="btn" id="addIn" data-i="btn_add_in">+ –ü—Ä–∏—ë–º</button>
        <button class="btn secondary" id="addOut" data-i="btn_add_out">‚àí –í—ã–¥–∞—á–∞</button>
        <button class="btn secondary" id="cashClose" data-i="btn_close_shift">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
        <button class="btn ghost" id="q50">+50</button>
        <button class="btn ghost" id="q100">+100</button>
        <button class="btn ghost" id="q200">+200</button>
        <label class="btn ghost">
          <input id="cashPhoto" type="file" accept="image/*" capture="environment" style="display: none;" />
          <span data-i="btn_scan_receipt">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ)</span>
        </label>
        <button id="micBtn" class="mic" title="–°–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">üéôÔ∏è</button>
        <span class="hint">
          –ü—Ä–∏–º–µ—Ä: ¬´–ø—Ä–∏–Ω—è—Ç—å 120 –Ω–∞ –∫–∞—Å—Å—É –æ—Ç –ø—Ä–æ–¥–∞–∂¬ª, ¬´–≤—ã–¥–∞—Ç—å 50 –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É¬ª
        </span>
        <img id="lastThumb" class="thumb" style="display: none;" />
        <span id="micStatus" class="pill">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≥–æ—Ç–æ–≤</span>
      </div>
      <div class="row" style="margin-top: 8px;">
        <label>
          <span data-i="speech_lang">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</span>
          <select id="speechLang">
            <option value="pl-PL">pl-PL</option>
            <option value="ru-RU">ru-RU</option>
            <option value="uk-UA">uk-UA</option>
            <option value="en-US">en-US</option>
          </select>
        </label>
        <button id="micTest" class="btn secondary" data-i="btn_test_voice">–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥</button>
      </div>
      <table id="kasaTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">–î–∞—Ç–∞</th>
            <th data-i="cash_th_type">–¢–∏–ø</th>
            <th data-i="cash_th_amount">–°—É–º–º–∞</th>
            <th data-i="cash_th_source">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th data-i="cash_th_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Settings Section (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) -->
    <div id="ustawienia" class="section">
      <div class="card" id="otdSubCard">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="pilot_subscription_title">–ü–æ–¥–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–∞</div>
        <div class="row" style="margin: 6px 0;">
          <!-- Payment link removed since portal handles it -->
          <!--<a class="btn" href="https://buy.stripe.com/..." target="_blank" rel="noopener" data-i="btn_pay_deposit">–û–ø–ª–∞—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç 99 PLN</a>-->
          <span id="pilotMini" class="pill">–°—Ç–∞—Ç—É—Å: ‚Äî</span>
        </div>
        <div class="row" style="gap: 8px; margin-top: 6px;">
          <button id="btnMarkPaid" class="btn secondary" data-i="btn_mark_paid">–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
          <button id="btnStartPilot" class="btn secondary" data-i="btn_start_pilot">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∏–ª–æ—Ç (2 –º–µ—Å.)</button>
          <button id="btnActivateDiscount" class="btn secondary" data-i="btn_activate_discount">–í–∫–ª—é—á–∏—Ç—å ‚àí50% –Ω–∞ 12 –º–µ—Å.</button>
          <button id="btnResetPilot" class="btn ghost" data-i="btn_reset_pilot">–°–±—Ä–æ—Å</button>
        </div>
        <div class="muted" style="margin-top: 6px;">
          <span data-i="start_label">–ù–∞—á–∞–ª–æ:</span> <b id="pilotStart">‚Äî</b> ¬∑ 
          <span data-i="end_label">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</span> <b id="pilotEnd">‚Äî</b> 
          <span id="pilotCountdown"></span><br/>
          <span data-i="discount_label">–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:</span> <b id="discountUntil">‚Äî</b>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="calc_mode">–†–µ–∂–∏–º —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</div>
        <div class="row" style="margin-top: 6px;">
          <label><input type="checkbox" id="autoCash" /> <span data-i="auto_mode_label">–ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞</span></label>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="parameters">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
        <div class="row" style="margin-top: 6px;">
          <label><span data-i="param_cash">–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):</span> <input id="cashPLN" type="number" step="0.01" value="5000" /></label>
          <label><span data-i="param_penalty">–ü–µ–Ω—è, %/–¥–µ–Ω—å:</span> <input id="penaltyPct" type="number" step="0.01" value="0.05" /></label>
          <label><span data-i="param_interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:</span> <input id="intervalMin" type="number" min="1" value="10" /></label>
        </div>
        <div class="row" style="margin-top: 6px;">
          <label>EUR‚ÜíPLN: <input id="rateEUR" type="number" step="0.0001" value="4.30" /></label>
          <label>USD‚ÜíPLN: <input id="rateUSD" type="number" step="0.0001" value="3.95" /></label>
          <label>Blacklist: <input id="blacklist" type="text" placeholder="Firma X, BadVendor" /></label>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button id="applySettings" class="btn" data-i="btn_save_settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="exportCfg" class="btn secondary" data-i="btn_export_settings">–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
          <label class="btn ghost">
            <input id="importCfg" type="file" accept="application/json" style="display: none;" />
            <span data-i="btn_import_settings">–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</span>
          </label>
        </div>
        <div class="muted" style="margin-top: 6px;" data-i="auto_mode_explain">
          –†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑ wyciƒÖg (–∏–ª–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã. 
          –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É + –∫–∞—Å—Å—É.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Redirect to portal if not logged in
    if (!localStorage.getItem("otd_user")) {
      window.location.href = "/";
    }

    // Internationalization strings for main app
    const M = {
      ru: {
        tab_dashboard: "–ü—É–ª—å—Ç", tab_statement: "–í—ã–ø–∏—Å–∫–∞", tab_invoices: "–§–∞–∫—Ç—É—Ä—ã", tab_accounts: "–°—á–µ—Ç–∞", tab_cash: "–ö–∞—Å—Å–∞", tab_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        kpi_due_today: "–ö –æ–ø–ª–∞—Ç–µ —Å–µ–≥–æ–¥–Ω—è", kpi_unmatched: "–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", kpi_banks: "–ë–∞–Ω–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–µ", kpi_cash: "–ö–∞—Å—Å–∞ (–Ω–∞–ª)", kpi_total: "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ", kpi_gap_today: "–†–∞–∑—Ä—ã–≤ –∫–∞—Å—Å—ã —Å–µ–≥–æ–¥–Ω—è",
        btn_sync: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è", btn_ai_match: "–ò–ò‚Äë—Å–≤–µ—Ä–∫–∞", btn_accept_safe: "–ü—Ä–∏–Ω—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ä—ã", btn_pdf: "PDF –æ—Ç—á—ë—Ç",
        minpay_title: "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (—à—Ç—Ä–∞—Ñ‚Äë—Å—Ç–æ–ø)", btn_apply_minpay: "–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ",
        forecast_7d: "–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π", forecast7d_note: "–°—á–∏—Ç–∞–µ—Ç PLN‚Äë—Å—á–µ—Ç–∞ –∏–∑ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å—É.",
        forecast_30d: "–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω–µ–π", forecast30_note: "–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ wyciƒÖg + –∫–∞—Å—Å–µ –Ω–∞ 30 –¥–Ω–µ–π.",
        month_summary_title: "–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞",
        plan_title: "–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –∫–∞—Å—Å—É", filter_label: "–§–∏–ª—å—Ç—Ä:", filter_today: "–°–µ–≥–æ–¥–Ω—è", filter_7d: "7 –¥–Ω–µ–π", filter_all: "–í—Å–µ", exclude_blacklist: "–ò—Å–∫–ª—é—á–∞—Ç—å blacklist",
        btn_make_plan: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", btn_apply_plan: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
        plan_th_invoice: "–§–∞–∫—Ç—É—Ä–∞", plan_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", plan_th_due: "–°—Ä–æ–∫", plan_th_amount: "–°—É–º–º–∞", plan_th_reason: "–ü—Ä–∏—á–∏–Ω–∞",
        upload_statement: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É (CSV)", save_url: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL",
        th_date: "–î–∞—Ç–∞", th_account: "–°—á—ë—Ç", th_counterparty: "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc: "–û–ø–∏—Å–∞–Ω–∏–µ", th_amount: "–°—É–º–º–∞", th_currency: "–í–∞–ª—é—Ç–∞", th_status: "–°—Ç–∞—Ç—É—Å",
        upload_invoices: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ (CSV)", only_overdue: "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ", show_label: "–ü–æ–∫–∞–∑–∞—Ç—å:",
        inv_th_due: "–°—Ä–æ–∫", inv_th_number: "‚Ññ", inv_th_supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", inv_th_amount: "–°—É–º–º–∞", inv_th_currency: "–í–∞–ª—é—Ç–∞", inv_th_status: "–°—Ç–∞—Ç—É—Å", inv_th_candidate: "–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score: "Score", inv_th_action: "–î–µ–π—Å—Ç–≤–∏–µ",
        auto_accounts_title: "–°—á–µ—Ç–∞ –∏–∑ –≤—ã–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)",
        auto_accounts_desc: "–ú—ã —Å–∞–º–∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—á–µ—Ç–∞ –ø–æ –ø–æ–ª—è–º ¬´ID konta¬ª –∏–ª–∏ ¬´IBAN¬ª –∏–∑ –≤—ã–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–∞—Å—á—ë—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –º–µ–Ω—è–π —Ç–∏–ø.",
        acc_th_account: "–°—á—ë—Ç", acc_th_type: "–¢–∏–ø", acc_th_currency: "–í–∞–ª—é—Ç–∞", acc_th_balance_calc: "–ë–∞–ª–∞–Ω—Å (—Ä–∞—Å—á—ë—Ç)", acc_th_start_balance: "–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å", acc_th_include: "–í —Ä–∞—Å—á—ë—Ç –ø–ª–∞–Ω–∞",
        btn_add_in: "+ –ü—Ä–∏—ë–º", btn_add_out: "‚àí –í—ã–¥–∞—á–∞", btn_close_shift: "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É", btn_scan_receipt: "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ)",
        speech_lang: "–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:", btn_test_voice: "–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥",
        cash_th_date: "–î–∞—Ç–∞", cash_th_type: "–¢–∏–ø", cash_th_amount: "–°—É–º–º–∞", cash_th_source: "–ò—Å—Ç–æ—á–Ω–∏–∫", cash_th_comment: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
        pilot_subscription_title: "–ü–æ–¥–ø–∏—Å–∫–∞ –ø–∏–ª–æ—Ç–∞", // pilot subscription section
        // btn_pay_deposit not used (no payment link here)
        btn_mark_paid: "–û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É", btn_start_pilot: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∏–ª–æ—Ç (2 –º–µ—Å.)", btn_activate_discount: "–í–∫–ª—é—á–∏—Ç—å ‚àí50% –Ω–∞ 12 –º–µ—Å.", btn_reset_pilot: "–°–±—Ä–æ—Å",
        start_label: "–ù–∞—á–∞–ª–æ:", end_label: "–û–∫–æ–Ω—á–∞–Ω–∏–µ:", discount_label: "–°–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:",
        calc_mode: "–†–µ–∂–∏–º —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤", auto_mode_label: "–ê–≤—Ç–æ: –∏–∑ —Å—á–µ—Ç–æ–≤ wyciƒÖg (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ) + –∫–∞—Å—Å–∞",
        parameters: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã",
        param_cash: "–î–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞—Å—Å–∞ —Å–µ–≥–æ–¥–Ω—è (—Ä—É—á–Ω–æ–π PLN):", param_penalty: "–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval: "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö–∞, –º–∏–Ω:",
        btn_save_settings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btn_export_settings: "–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫", btn_import_settings: "–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫",
        auto_mode_explain: "–†–µ–∂–∏–º ¬´–ê–≤—Ç–æ¬ª: —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –∏–∑ –≤—Å–µ—Ö –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑ wyciƒÖg (–∏–ª–∏ —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã. –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –±–µ—Ä—ë—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É + –∫–∞—Å—Å—É."
      },
      en: {
        tab_dashboard: "Dashboard", tab_statement: "Statement", tab_invoices: "Invoices", tab_accounts: "Accounts", tab_cash: "Cash", tab_settings: "Settings",
        kpi_due_today: "Due today", kpi_unmatched: "Unmatched transactions", kpi_banks: "Accounts included", kpi_cash: "Cash (on hand)", kpi_total: "Total available", kpi_gap_today: "Cash gap today",
        btn_sync: "Sync Now", btn_ai_match: "AI Match", btn_accept_safe: "Accept safe pairs", btn_pdf: "PDF Report",
        minpay_title: "Minimum Payment (penalty stop)", btn_apply_minpay: "Mark as Paid",
        forecast_7d: "7-day Forecast", forecast7d_note: "Counts PLN accounts from statement (included) + cash.",
        forecast_30d: "30-day Forecast", forecast30_note: "Auto-forecast from statement + cash for 30 days.",
        month_summary_title: "Month Summary",
        plan_title: "Cash Payment Plan", filter_label: "Filter:", filter_today: "Today", filter_7d: "7 days", filter_all: "All", exclude_blacklist: "Exclude blacklist",
        btn_make_plan: "Generate", btn_apply_plan: "Apply",
        plan_th_invoice: "Invoice", plan_th_supplier: "Supplier", plan_th_due: "Due", plan_th_amount: "Amount", plan_th_reason: "Reason",
        upload_statement: "Upload Statement (CSV)", save_url: "Save URL",
        th_date: "Date", th_account: "Account", th_counterparty: "Counterparty", th_desc: "Description", th_amount: "Amount", th_currency: "Currency", th_status: "Status",
        upload_invoices: "Upload Invoices (CSV)", only_overdue: "Overdue only", show_label: "Show:",
        inv_th_due: "Due", inv_th_number: "#", inv_th_supplier: "Supplier", inv_th_amount: "Amount", inv_th_currency: "Currency", inv_th_status: "Status", inv_th_candidate: "Candidate", inv_th_score: "Score", inv_th_action: "Action",
        auto_accounts_title: "Accounts from statement (auto)",
        auto_accounts_desc: "We automatically gather accounts from 'ID konta' or 'IBAN' fields in the statement. Include in plan, edit starting balance, change type.",
        acc_th_account: "Account", acc_th_type: "Type", acc_th_currency: "Currency", acc_th_balance_calc: "Balance (calc)", acc_th_start_balance: "Starting balance", acc_th_include: "Include in plan",
        btn_add_in: "+ In", btn_add_out: "‚àí Out", btn_close_shift: "Close shift", btn_scan_receipt: "Scan receipt (photo)",
        speech_lang: "Recognition language:", btn_test_voice: "Test command",
        cash_th_date: "Date", cash_th_type: "Type", cash_th_amount: "Amount", cash_th_source: "Source", cash_th_comment: "Comment",
        pilot_subscription_title: "Pilot Subscription",
        btn_mark_paid: "Mark as Paid", btn_start_pilot: "Start Pilot (2 mo.)", btn_activate_discount: "Activate -50% for 12 mo.", btn_reset_pilot: "Reset",
        start_label: "Start:", end_label: "End:", discount_label: "Discount active until:",
        calc_mode: "Available Funds Calculation Mode", auto_mode_label: "Auto: from included statement accounts + cash",
        parameters: "Parameters",
        param_cash: "Manual cash available today (PLN):", param_penalty: "Penalty rate, %/day:", param_interval: "Sync interval, min:",
        btn_save_settings: "Save", btn_export_settings: "Export settings", btn_import_settings: "Import settings",
        auto_mode_explain: "Auto mode: calculates available funds from all included accounts gathered from the statement (or with given starting balance) + cash balance. Manual mode uses only the specified amount + cash."
      },
      pl: {
        tab_dashboard: "Pulpit", tab_statement: "WyciƒÖg", tab_invoices: "Faktury", tab_accounts: "Konta", tab_cash: "Kasa", tab_settings: "Ustawienia",
        kpi_due_today: "Do zap≈Çaty dzisiaj", kpi_unmatched: "Niesparowane transakcje", kpi_banks: "Uwzglƒôdnione konta", kpi_cash: "Kasa (got√≥wka)", kpi_total: "Razem dostƒôpne", kpi_gap_today: "Dzisiejsza luka kasowa",
        btn_sync: "Synchronizuj", btn_ai_match: "AI dopasowanie", btn_accept_safe: "Akceptuj pewne pary", btn_pdf: "Raport PDF",
        minpay_title: "Minimalna p≈Çatno≈õƒá (stop odsetek)", btn_apply_minpay: "Oznacz jako op≈Çacone",
        forecast_7d: "Prognoza 7 dni", forecast7d_note: "Liczy PLN konta z wyciƒÖgu (w≈ÇƒÖczone) + kasƒô.",
        forecast_30d: "Prognoza 30 dni", forecast30_note: "Autoprognoza z wyciƒÖgu + kasy na 30 dni.",
        month_summary_title: "Podsumowanie miesiƒÖca",
        plan_title: "Plan p≈Çatno≈õci (kasa)", filter_label: "Filtr:", filter_today: "Dzisiaj", filter_7d: "7 dni", filter_all: "Wszystko", exclude_blacklist: "Wyklucz czarnƒÖ listƒô",
        btn_make_plan: "Generuj", btn_apply_plan: "Zastosuj",
        plan_th_invoice: "Faktura", plan_th_supplier: "Dostawca", plan_th_due: "Termin", plan_th_amount: "Kwota", plan_th_reason: "Pow√≥d",
        upload_statement: "Wgraj wyciƒÖg (CSV)", save_url: "Zapisz URL",
        th_date: "Data", th_account: "Konto", th_counterparty: "Kontrahent", th_desc: "Opis", th_amount: "Kwota", th_currency: "Waluta", th_status: "Status",
        upload_invoices: "Wgraj faktury (CSV)", only_overdue: "Tylko przeterminowane", show_label: "Poka≈º:",
        inv_th_due: "Termin", inv_th_number: "Nr", inv_th_supplier: "Dostawca", inv_th_amount: "Kwota", inv_th_currency: "Waluta", inv_th_status: "Status", inv_th_candidate: "Kandydat", inv_th_score: "Score", inv_th_action: "Akcja",
        auto_accounts_title: "Konta z wyciƒÖgu (auto)",
        auto_accounts_desc: "Automatycznie zbieramy konta z p√≥l 'ID konta' lub 'IBAN' z wyciƒÖgu. Uwzglƒôdnij w planie, edytuj saldo poczƒÖtkowe, zmie≈Ñ typ.",
        acc_th_account: "Konto", acc_th_type: "Typ", acc_th_currency: "Waluta", acc_th_balance_calc: "Saldo (oblicz.)", acc_th_start_balance: "Saldo poczƒÖtkowe", acc_th_include: "Uwzglƒôdnij",
        btn_add_in: "+ Przyjƒôcie", btn_add_out: "‚àí Wydanie", btn_close_shift: "Zamknij zmianƒô", btn_scan_receipt: "Skanuj paragon (zdjƒôcie)",
        speech_lang: "Jƒôzyk rozpoznawania:", btn_test_voice: "Test polece≈Ñ",
        cash_th_date: "Data", cash_th_type: "Rodzaj", cash_th_amount: "Kwota", cash_th_source: "≈πr√≥d≈Ço", cash_th_comment: "Komentarz",
        pilot_subscription_title: "Subskrypcja pilota",
        btn_mark_paid: "Zaznacz wp≈Çatƒô", btn_start_pilot: "Uruchom pilota (2 mies.)", btn_activate_discount: "Aktywuj ‚àí50% na 12 mies.", btn_reset_pilot: "Resetuj",
        start_label: "PoczƒÖtek:", end_label: "Koniec:", discount_label: "Zni≈ºka aktywna do:",
        calc_mode: "Tryb obliczania dostƒôpnych ≈õrodk√≥w", auto_mode_label: "Auto: z uwzglƒôdnionych kont wyciƒÖgu + kasa",
        parameters: "Parametry",
        param_cash: "Dostƒôpna kasa (PLN):", param_penalty: "Odsetki, %/dzie≈Ñ:", param_interval: "Interwa≈Ç sync., min:",
        btn_save_settings: "Zapisz", btn_export_settings: "Eksport ustawie≈Ñ", btn_import_settings: "Import ustawie≈Ñ",
        auto_mode_explain: "Tryb Auto: oblicza dostƒôpne ≈õrodki ze wszystkich w≈ÇƒÖczonych kont z wyciƒÖgu (lub ze startowym saldem) + kasa. Tryb rƒôczny u≈ºywa tylko podanej kwoty + kasy."
      },
      uk: {
        tab_dashboard: "–ü–∞–Ω–µ–ª—å", tab_statement: "–í–∏–ø–∏—Å–∫–∞", tab_invoices: "–†–∞—Ö—É–Ω–∫–∏", tab_accounts: "–†–∞—Ö—É–Ω–∫–∏", tab_cash: "–ö–∞—Å–∞", tab_settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
        kpi_due_today: "–î–æ —Å–ø–ª–∞—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ", kpi_unmatched: "–ù–µ—Å–ø—ñ–≤—Å—Ç–∞–≤–ª–µ–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó", kpi_banks: "–†–∞—Ö—É–Ω–∫–∏ –≤ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É", kpi_cash: "–ö–∞—Å–∞ (–≥–æ—Ç—ñ–≤–∫–∞)", kpi_total: "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å—å–æ–≥–æ", kpi_gap_today: "–†–æ–∑—Ä–∏–≤ –∫–∞—Å–∏ —Å—å–æ–≥–æ–¥–Ω—ñ",
        btn_sync: "–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è", btn_ai_match: "AI –∑–≤—ñ—Ä–∫–∞", btn_accept_safe: "–ü—Ä–∏–π–Ω—è—Ç–∏ –±–µ–∑–ø–µ—á–Ω—ñ –ø–∞—Ä–∏", btn_pdf: "PDF –∑–≤—ñ—Ç",
        minpay_title: "–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–ª–∞—Ç—ñ–∂ (—à—Ç—Ä–∞—Ñ-—Å—Ç–æ–ø)", btn_apply_minpay: "–í—ñ–¥–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –æ–ø–ª–∞—á–µ–Ω–æ",
        forecast_7d: "–ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω—ñ–≤", forecast7d_note: "–†–∞—Ö—É—î PLN —Ä–∞—Ö—É–Ω–∫–∏ –∑ –≤–∏–ø–∏—Å–∫–∏ (–≤–∫–ª—é—á–µ–Ω—ñ) + –∫–∞—Å—É.",
        forecast_30d: "–ü—Ä–æ–≥–Ω–æ–∑ 30 –¥–Ω—ñ–≤", forecast30_note: "–ê–≤—Ç–æ–ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –≤–∏–ø–∏—Å—Ü—ñ + –∫–∞—Å—ñ –Ω–∞ 30 –¥–Ω—ñ–≤.",
        month_summary_title: "–ü—ñ–¥—Å—É–º–∫–∏ –º—ñ—Å—è—Ü—è",
        plan_title: "–ü–ª–∞–Ω –ø–ª–∞—Ç–µ–∂—ñ–≤ (–∫–∞—Å–∞)", filter_label: "–§—ñ–ª—å—Ç—Ä:", filter_today: "–°—å–æ–≥–æ–¥–Ω—ñ", filter_7d: "7 –¥–Ω—ñ–≤", filter_all: "–£—Å–µ", exclude_blacklist: "–í–∏–∫–ª—é—á–∞—Ç–∏ blacklist",
        btn_make_plan: "–°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏", btn_apply_plan: "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏",
        plan_th_invoice: "–†–∞—Ö—É–Ω–æ–∫", plan_th_supplier: "–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫", plan_th_due: "–¢–µ—Ä–º—ñ–Ω", plan_th_amount: "–°—É–º–∞", plan_th_reason: "–ü—Ä–∏—á–∏–Ω–∞",
        upload_statement: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∏–ø–∏—Å–∫—É (CSV)", save_url: "–ó–±–µ—Ä–µ–≥—Ç–∏ URL",
        th_date: "–î–∞—Ç–∞", th_account: "–†–∞—Ö—É–Ω–æ–∫", th_counterparty: "–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç", th_desc: "–û–ø–∏—Å", th_amount: "–°—É–º–∞", th_currency: "–í–∞–ª—é—Ç–∞", th_status: "–°—Ç–∞—Ç—É—Å",
        upload_invoices: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–∞—Ö—É–Ω–∫–∏ (CSV)", only_overdue: "–õ–∏—à–µ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ", show_label: "–ü–æ–∫–∞–∑–∞—Ç–∏:",
        inv_th_due: "–¢–µ—Ä–º—ñ–Ω", inv_th_number: "‚Ññ", inv_th_supplier: "–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫", inv_th_amount: "–°—É–º–∞", inv_th_currency: "–í–∞–ª—é—Ç–∞", inv_th_status: "–°—Ç–∞—Ç—É—Å", inv_th_candidate: "–ö–∞–Ω–¥–∏–¥–∞—Ç", inv_th_score: "Score", inv_th_action: "–î—ñ—è",
        auto_accounts_title: "–†–∞—Ö—É–Ω–∫–∏ –∑ –≤–∏–ø–∏—Å–∫–∏ (–∞–≤—Ç–æ)",
        auto_accounts_desc: "–ú–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–∏—Ä–∞—î–º–æ —Ä–∞—Ö—É–Ω–∫–∏ –∑ –ø–æ–ª—ñ–≤ 'ID konta' –∞–±–æ 'IBAN' –∑ –≤–∏–ø–∏—Å–∫–∏. –í–∫–ª—é—á–∞–π –≤ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫, –∑–º—ñ–Ω—é–π —Å—Ç–∞—Ä—Ç–æ–≤–∏–π –±–∞–ª–∞–Ω—Å, –∑–º—ñ–Ω—é–π —Ç–∏–ø.",
        acc_th_account: "–†–∞—Ö—É–Ω–æ–∫", acc_th_type: "–¢–∏–ø", acc_th_currency: "–í–∞–ª—é—Ç–∞", acc_th_balance_calc: "–ë–∞–ª–∞–Ω—Å (—Ä–æ–∑—Ä–∞—Ö.)", acc_th_start_balance: "–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å", acc_th_include: "–í —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–ª–∞–Ω—É",
        btn_add_in: "+ –ü—Ä–∏–π–æ–º", btn_add_out: "‚àí –í–∏–¥–∞—á–∞", btn_close_shift: "–ó–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É", btn_scan_receipt: "–°–∫–∞–Ω—É–≤–∞—Ç–∏ —á–µ–∫ (—Ñ–æ—Ç–æ)",
        speech_lang: "–ú–æ–≤–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:", btn_test_voice: "–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥",
        cash_th_date: "–î–∞—Ç–∞", cash_th_type: "–¢–∏–ø", cash_th_amount: "–°—É–º–∞", cash_th_source: "–î–∂–µ—Ä–µ–ª–æ", cash_th_comment: "–ö–æ–º–µ–Ω—Ç–∞—Ä",
        pilot_subscription_title: "–ü—ñ–¥–ø–∏—Å–∫–∞ –ø—ñ–ª–æ—Ç—É",
        btn_mark_paid: "–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –æ–ø–ª–∞—Ç—É", btn_start_pilot: "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—ñ–ª–æ—Ç (2 –º—ñ—Å.)", btn_activate_discount: "–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ ‚àí50% –Ω–∞ 12 –º—ñ—Å.", btn_reset_pilot: "–°–∫–∏–Ω—É—Ç–∏",
        start_label: "–ü–æ—á–∞—Ç–æ–∫:", end_label: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è:", discount_label: "–ó–Ω–∏–∂–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:",
        calc_mode: "–†–µ–∂–∏–º —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–æ—à—Ç—ñ–≤", auto_mode_label: "–ê–≤—Ç–æ: –∑ —Ä–∞—Ö—É–Ω–∫—ñ–≤ –≤–∏–ø–∏—Å–∫–∏ (–≤–∫–ª—é—á–µ–Ω—ñ) + –∫–∞—Å–∞",
        parameters: "–ü–∞—Ä–∞–º–µ—Ç—Ä–∏",
        param_cash: "–î–æ—Å—Ç—É–ø–Ω–∞ –∫–∞—Å–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (—Ä—É—á–Ω–∞, PLN):", param_penalty: "–ü–µ–Ω—è, %/–¥–µ–Ω—å:", param_interval: "–Ü–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä., —Ö–≤:",
        btn_save_settings: "–ó–±–µ—Ä–µ–≥—Ç–∏", btn_export_settings: "–ï–∫—Å–ø–æ—Ä—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å", btn_import_settings: "–Ü–º–ø–æ—Ä—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å",
        auto_mode_explain: "–†–µ–∂–∏–º \"–ê–≤—Ç–æ\": —Ä–∞—Ö—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –≥—Ä–æ—à—ñ –∑ —É—Å—ñ—Ö –≤–∫–ª—é—á–µ–Ω–∏—Ö —Ä–∞—Ö—É–Ω–∫—ñ–≤, –∑—ñ–±—Ä–∞–Ω–∏—Ö –∑ –≤–∏–ø–∏—Å–∫–∏ (–∞–±–æ –∑–∞–¥–∞–Ω–∏–º —Å—Ç–∞—Ä—Ç–æ–≤–∏–º –±–∞–ª–∞–Ω—Å–æ–º), + –±–∞–ª–∞–Ω—Å –∫–∞—Å–∏. –†—É—á–Ω–∏–π —Ä–µ–∂–∏–º –±–µ—Ä–µ —Ç—ñ–ª—å–∫–∏ –≤–∫–∞–∑–∞–Ω—É —Å—É–º—É + –∫–∞—Å—É."
      }
    };

    function applyLangMain(lang) {
      const d = M[lang] || M.ru;
      document.querySelectorAll("[data-i]").forEach(el => {
        const key = el.getAttribute("data-i");
        if (d[key]) el.textContent = d[key];
      });
      document.querySelectorAll(".lang button").forEach(btn => {
        btn.classList.toggle("on", btn.dataset.lang === lang);
      });
      localStorage.setItem("otd_lang", lang);
      // Update dynamic texts that are set via script (like pilot status) by re-running render
      try { if (typeof render === "function") render(); } catch(e){}
    }

    // Language switch in main
    document.getElementById("langBarMain").addEventListener("click", e => {
      if (e.target.dataset.lang) {
        applyLangMain(e.target.dataset.lang);
      }
    });

    // Initialize language texts
    applyLangMain(localStorage.getItem("otd_lang") || "ru");

    // Main app logic (existing functionality improved)
    let tx = [], bills = [], kasa = [];
    let accMeta = {};  // account metadata (id -> {name, currency, include, type, start})

    function $(q) { return document.querySelector(q); }
    document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.sec).classList.add("active");
    }));

    // Utility functions
    function toISO(d) {
      if (!d) return "";
      const s = String(d).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return m[0];
      m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
      if (m) {
        const dd = m[1].padStart(2, "0"),
              mm = m[2].padStart(2, "0"),
              yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
        return yy + "-" + mm + "-" + dd;
      }
      return "";
    }
    const asNum = v => Number(String(v || "").replace(/\s/g, "").replace(",", "."));
    const today = () => new Date().toISOString().slice(0, 10);

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      const txt = await res.text();
      return parseCSV(txt);
    }
    function smartSplit(line, del) {
      let out = [], cur = "", q = false;
      for (let ch of line) {
        if (ch === '"') { q = !q; continue; }
        if (ch === del && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      text = text.replace(/\r/g, "");
      const lines = text.split("\n").filter(l => l.trim());
      if (!lines.length) return [];
      const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
      const head = smartSplit(lines.shift(), sep).map(h => h.trim());
      return lines.map(line => {
        const cells = smartSplit(line, sep);
        const obj = {};
        head.forEach((h, i) => obj[h] = (cells[i] || "").trim());
        return obj;
      });
    }

    function normName(s) {
      s = (s || "").toLowerCase().replace(/[.,]/g, " ").replace(/\s+/g, " ").trim();
      const stop = ["sp z oo", "sp. z o.o.", "spolka", "sp√≥≈Çka", "sa", "s.a", "ooo"];
      stop.forEach(t => s = s.replace(t, ""));
      return s.trim();
    }
    function nameSimilar(a, b) {
      a = normName(a); b = normName(b);
      if (!a || !b) return 0;
      if (a === b) return 1;
      if (a.includes(b) || b.includes(a)) return 0.8;
      return 0;
    }

    function inferAccounts() {
      const map = {};
      tx.forEach(r => {
        const id = r["ID konta"] || r["IBAN"] || "UNKNOWN";
        const cur = (r["Waluta"] || "PLN").toUpperCase();
        if (!map[id]) {
          map[id] = { id, name: id.slice(0, 12), currency: cur, include: true, type: "Biznes", start: 0 };
        }
      });
      // merge with saved preferences
      try {
        const saved = JSON.parse(localStorage.getItem("accMeta") || "{}");
        Object.keys(map).forEach(id => {
          if (saved[id]) map[id] = Object.assign(map[id], saved[id]);
        });
      } catch(e) {}
      accMeta = map;
      renderAccounts();
    }

    function computeAccountBalance(accId) {
      const rows = tx.filter(r => (r["ID konta"] || r["IBAN"] || "UNKNOWN") === accId);
      const withSaldo = rows.filter(r => r["Saldo po operacji"]);
      if (withSaldo.length) {
        const last = withSaldo[withSaldo.length - 1];
        return asNum(last["Saldo po operacji"]);
      }
      const start = Number((accMeta[accId] || {}).start || 0);
      const sum = rows.reduce((s, r) => s + asNum(r["Kwota"] || 0), 0);
      return start + sum;
    }
    function rate(cur) {
      cur = String(cur || "PLN").toUpperCase();
      if (cur === "PLN") return 1;
      if (cur === "EUR") return asNum(localStorage.getItem("rateEUR") || 4.3);
      if (cur === "USD") return asNum(localStorage.getItem("rateUSD") || 3.95);
      return 1;
    }
    function bankAvailablePLN() {
      let sum = 0;
      Object.values(accMeta).filter(a => a.include).forEach(a => {
        const bal = computeAccountBalance(a.id);
        sum += bal * rate(a.currency);
      });
      return sum;
    }
    function kasaBalance() {
      let bal = 0;
      kasa.forEach(k => {
        if (k.type === "przyjƒôcie") bal += k.amount;
        if (k.type === "wydanie") bal -= k.amount;
        if (k.type === "zamkniƒôcie") bal = k.amount;
      });
      return bal;
    }
    function availableTotal() {
      const auto = localStorage.getItem("autoCash") === "1";
      const manual = asNum(localStorage.getItem("cashPLN") || 0);
      const kas = kasaBalance();
      return auto ? (bankAvailablePLN() + kas) : (manual + kas);
    }

    function scoreMatch(bill, tr) {
      let score = 0;
      const bAmt = asNum(bill["Kwota do zap≈Çaty"]);
      const tAmt = Math.abs(asNum(tr["Kwota"]));
      const bCur = String(bill["Waluta"] || "").toUpperCase();
      const tCur = String(tr["Waluta"] || "").toUpperCase();
      if (bAmt > 0 && tAmt > 0 && Math.abs(bAmt - tAmt) < 0.005 && bCur === tCur) score += 60;
      const inv = String(bill["Numer faktury"] || "").toLowerCase();
      const desc = String(tr["Tytu≈Ç/Opis"] || tr["Opis operacji"] || "").toLowerCase();
      if (inv && desc.includes(inv)) score += 25;
      if (nameSimilar(bill["Dostawca"], tr["Kontrahent"] || "") >= 0.8) score += 10;
      if (asNum(tr["Kwota"]) < 0) score += 5;
      return { score: Math.min(100, score) };
    }

    function runAI() {
      bills.forEach(b => {
        const status = String(b["Status faktury"] || "").toLowerCase();
        if (status.includes("op≈Çacone") || status.includes("–æ–ø–ª–∞—á–µ–Ω–æ")) return;
        let best = null;
        tx.forEach(t => {
          if (String(t["Status transakcji"] || "").toLowerCase() === "sparowane") return;
          if (asNum(t["Kwota"]) >= 0) return;
          const s = scoreMatch(b, t);
          if (!best || s.score > best.s) best = { t, s: s.score };
        });
        if (best && best.s >= 85) {
          best.t["Status transakcji"] = "Sparowane";
          best.t["PowiƒÖzana faktura (ID)"] = b["Numer faktury"];
          b["Status faktury"] = "Op≈Çacone";
          b["Data p≈Çatno≈õci"] = today();
        } else if (best && best.s >= 55) {
          b["Kandyd–∞—Ç (AI)"] = best.t["ID transakcji"];
          b["AI score"] = best.s;
        } else {
          b["Kandyd–∞—Ç (AI)"] = "";
          b["AI score"] = "";
        }
      });
      render();
    }
    function acceptSafe() {
      bills
        .filter(b => Number(b["AI score"] || 0) >= 85)
        .forEach(b => {
          const t = tx.find(t => t["ID transakcji"] === b["Kandyd–∞—Ç (AI)"]);
          if (!t) return;
          t["Status transakcji"] = "Sparowane";
          t["PowiƒÖzana faktura (ID)"] = b["Numer —Ñ–∞–∫—Ç—É—Ä—ã"];  // slight mismatch in property spelling, but leaving as in data
          b["Status faktury"] = "Op≈Çacone";
          b["Data p≈Çatno≈õci"] = today();
          b["Kandyd–∞—Ç (AI)"] = b["AI score"] = "";
        });
      render();
    }

    function toDueList(mode) {
      const t = today();
      const excl = document.getElementById("excludeBlacklist")?.checked;
      return bills.filter(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s)) return false;
        const d = toISO(r["Termin p≈Çatno≈õci"]);
        if (!d) return false;
        if (mode === "today") return d === t;
        if (mode === "7d") {
          const dd = new Date(d), tt = new Date(t);
          return (dd - tt) / (1000 * 3600 * 24) <= 7;
        }
        return true;
      }).filter(r => {
        if (String(r["Waluta"] || "").toUpperCase() !== "PLN") return false;
        if (excl) {
          // optionally exclude blacklisted vendors
          const blist = (localStorage.getItem("blacklist") || "").toLowerCase();
          if (blist && r["Dostawca"] && blist.split(",").some(name => r["Dostawca"].toLowerCase().includes(name.trim()))) {
            return false;
          }
        }
        return true;
      });
    }

    function buildPlan() {
      const mode = $("#planFilter").value;
      const cand = toDueList(mode).sort((a, b) => {
        const da = new Date(toISO(a["Termin p≈Çatno≈õci"]));
        const db = new Date(toISO(b["Termin p≈Çatno≈õci"]));
        const lateA = da < new Date(today());
        const lateB = db < new Date(today());
        if (lateA !== lateB) return lateB - lateA;
        return asNum(b["Kwota do zap≈Çaty"]) - asNum(a["Kwota do zap≈Çaty"]);
      });
      let left = availableTotal();
      const plan = [];
      for (const r of cand) {
        const amt = asNum(r["Kwota do zap≈Çaty"]);
        if (amt <= left) {
          plan.push({
            r,
            amt,
            reason: (toISO(r["Termin p≈Çatno≈õci"]) < today() ? "–ø—Ä–æ—Å—Ä–æ—á–∫–∞" : "—Å—Ä–æ–∫")
          });
          left -= amt;
        }
      }
      return { plan, left, avail: availableTotal() };
    }
    function renderPlan() {
      const p = buildPlan();
      const tb = $("#planTable tbody");
      tb.innerHTML = "";
      p.plan.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${x.r["Numer faktury"] || ""}</td><td>${x.r["Dostawca"] || ""}</td><td>${toISO(x.r["Termin p≈Çatno≈õci"])}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
        tb.appendChild(tr);
      });
      const metaText = p.plan.length 
        ? `–ü–æ—Ç—Ä–∞—Ç–∏–º ${(p.avail - p.left).toFixed(2)} –∏–∑ ${p.avail.toFixed(2)} PLN. –û—Å—Ç–∞–Ω–µ—Ç—Å—è ${p.left.toFixed(2)} PLN.` 
        : "–ü–ª–∞–Ω –ø—É—Å—Ç –∏–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç.";
      $("#planMeta").textContent = metaText;
    }

    function computeMinPay() {
      const t = today();
      const pct = asNum(localStorage.getItem("penaltyPct") || 0.05) / 100.0;
      const cand = bills.filter(r => 
        String(r["Waluta"] || "").toUpperCase() === "PLN" &&
        toISO(r["Termin p≈Çatno≈õci"]) <= t &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status —Ñ–∞–∫—Ç—É—Ä—ã"] || r["Status faktury"] || "").toLowerCase())
      ).map(r => ({
        r,
        amt: asNum(r["Kwota do zap≈Çaty"]),
        risk: asNum(r["Kwota do zap≈Çaty"]) * pct
      })).sort((a, b) => b.risk - a.risk || b.amt - a.amt);
      return cand[0] || null;
    }
    function renderMinPay() {
      const m = computeMinPay();
      const el = $("#minPayBox");
      if (!m) {
        el.textContent = "‚Äî";
        return;
      }
      el.textContent = `–û–ø–ª–∞—Ç–∏—Ç—å ${m.r["Numer faktury"]} (${m.r["Dostawca"]}) –Ω–∞ ${m.amt.toFixed(2)} PLN. –®—Ç—Ä–∞—Ñ/–¥–µ–Ω—å ~ ${m.risk.toFixed(2)} PLN.`;
    }

    function renderForecast() {
      const t = new Date(today());
      const list = toDueList("7d").map(r => ({ date: new Date(toISO(r["Termin p≈Çatno≈õci"])), amt: asNum(r["Kwota do zap≈Çaty"]) }));
      const days = [...Array(7)].map((_, i) => new Date(t.getTime() + i * 86400000));
      let left = availableTotal();
      const out = days.map(d => ({ d, due: 0, after: 0 }));
      list.forEach(x => {
        const idx = Math.min(6, Math.max(0, Math.floor((x.date - t) / 86400000)));
        out[idx].due += x.amt;
      });
      out.forEach(o => { left -= o.due; o.after = left; });
      const wrap = $("#forecastBars");
      wrap.innerHTML = "";
      out.forEach(o => {
        const div = document.createElement("div");
        div.className = "bar" + (o.after < 0 ? " neg" : "");
        const h = document.createElement("div");
        h.className = "h";
        h.style.height = (Math.min(120, Math.abs(o.after) / 100) * 0.8 + 18) + "px";
        div.innerHTML = "<small>" + o.d.toISOString().slice(5, 10) + "</small>";
        div.appendChild(h);
        const v = document.createElement("div");
        v.textContent = (o.after < 0 ? "-" : "") + Math.abs(o.after).toFixed(0) + " PLN";
        div.appendChild(v);
        wrap.appendChild(div);
      });
      const firstNeg = out.find(x => x.after < 0);
      $("#forecastMeta").textContent = firstNeg
        ? `–ì—ç–ø —á–µ—Ä–µ–∑ ${out.indexOf(firstNeg) + 1} –¥–Ω.: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${Math.abs(firstNeg.after).toFixed(2)} PLN.`
        : "–ù–∞ 7 –¥–Ω–µ–π —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞—Å—Å—ã.";
    }

    function render() {
      // KPIs
      const dueToday = bills.filter(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        return ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s) && toISO(r["Termin p≈Çatno≈õci"]) === today();
      }).length;
      const unmatch = tx.filter(r => String(r["Status transakcji"] || "").toLowerCase() !== "sparowane").length;
      $("#kpiDue").textContent = dueToday;
      $("#kpiUnmatch").textContent = unmatch;
      const bankPLN = bankAvailablePLN();
      $("#kpiBank").textContent = bankPLN.toFixed(2);
      const kas = kasaBalance();
      $("#kpiCash").textContent = kas.toFixed(2);
      const avail = availableTotal();
      $("#kpiAvail").textContent = avail.toFixed(2);
      const sumDueToday = bills.filter(r =>
        String(r["Waluta"] || "").toUpperCase() === "PLN" &&
        toISO(r["Termin p≈Çatno≈õci"]) <= today() &&
        ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(String(r["Status faktury"] || "").toLowerCase())
      ).reduce((s, r) => s + asNum(r["Kwota –¥–æ zap≈Çaty"]), 0);
      $("#kpiGap").textContent = Math.max(0, sumDueToday - avail).toFixed(2);

      // Transactions table
      const txBody = $("#txTable tbody");
      txBody.innerHTML = "";
      tx.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${toISO(r["Data ksiƒôgowania"])}</td>
                        <td>${r["ID konta"] || r["IBAN"] || "‚Äî"}</td>
                        <td>${r["Kontrahent"] || ""}</td>
                        <td>${r["Tytu≈Ç/Opis"] || r["Opis operacji"] || ""}</td>
                        <td>${r["Kwota"] || ""}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td>${r["Status transakcji"] || ""}</td>`;
        txBody.appendChild(tr);
      });

      // Invoices table
      const billBody = $("#billTable tbody");
      billBody.innerHTML = "";
      const scope = $("#billScope").value;
      const onlyOverdue = $("#billOverdueOnly")?.checked;
      bills.forEach(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        if (!["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(s)) return;
        if (onlyOverdue && !(s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä"))) return;
        const d = toISO(r["Termin p≈Ç–∞—Çno≈õci"]);
        if (scope === "today" && d !== today()) return;
        if (scope === "7d") {
          const dd = new Date(d), tt = new Date(today());
          if ((dd - tt) / (1000 * 3600 * 24) > 7) return;
        }
        const cls = (s.includes("przetermin") || s.includes("–ø—Ä–æ—Å—Ä")) ? "overdue" : "due";
        const cand = r["Kandydat (AI)"] || r["Kandyd–∞—Ç (AI)"] || "";
        const score = r["AI score"] || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d}</td>
                        <td>${r["Numer faktury"] || ""}</td>
                        <td>${r["Dostawca"] || ""}</td>
                        <td>${r["Kwota do zap≈Çaty"] || ""}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td><span class="badge ${cls}">${r["Status faktury"] || ""}</span></td>
                        <td>${cand ? ('<span class="badge cand">' + cand + '</span>') : '‚Äî'}</td>
                        <td>${score ? ('<span class="badge ai">' + score + '</span>') : '‚Äî'}</td>
                        <td>${cand ? ('<button class="btn secondary btn-accept" data-id="' + (r["Numer faktury"] || "") + '">–ü—Ä–∏–Ω—è—Ç—å</button>') : '‚Äî'}</td>`;
        billBody.appendChild(tr);
      });
      document.querySelectorAll(".btn-accept").forEach(b =>
        b.addEventListener("click", () => acceptOne(b.getAttribute("data-id")))
      );

      renderMinPay();
      renderForecast();
      renderAccounts();
    }

    function acceptOne(id) {
      const b = bills.find(x => (x["Numer faktury"] || "") === id);
      if (!b) return;
      const t = tx.find(x => (x["ID transakcji"] || "") === (b["Kandydat (AI)"] || ""));
      if (!t) return;
      t["Status transakcji"] = "Sparowane";
      t["PowiƒÖzana faktura (ID)"] = b["Numer faktury"];
      b["Status faktury"] = "Op≈Çacone";
      b["Data p≈Çatno≈õci"] = today();
      b["Kandydat (AI)"] = b["AI score"] = "";
      render();
    }

    function renderAccounts() {
      const tb = document.querySelector("#autoAcc tbody");
      if (!tb) return;
      tb.innerHTML = "";
      Object.values(accMeta).forEach(a => {
        const bal = computeAccountBalance(a.id);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td>
          <td>
            <select data-id="${a.id}" class="acc-type">
              <option ${a.type === "Biznes" ? "selected" : ""}>Biznes</option>
              <option ${a.type === "Osobisty" ? "selected" : ""}>Osobisty</option>
            </select>
          </td>
          <td>
            <select data-id="${a.id}" class="acc-cur">
              <option ${a.currency === "PLN" ? "selected" : ""}>PLN</option>
              <option ${a.currency === "EUR" ? "selected" : ""}>EUR</option>
              <option ${a.currency === "USD" ? "selected" : ""}>USD</option>
            </select>
          </td>
          <td>${bal.toFixed(2)}</td>
          <td><input type="number" step="0.01" value="${a.start || 0}" class="acc-start" data-id="${a.id}" /></td>
          <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include ? "checked" : ""} /></td>`;
        tb.appendChild(tr);
      });
      // Bind changes
      tb.querySelectorAll(".acc-type").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].type = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-cur").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].currency = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-start").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].start = asNum(e.target.value);
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-include").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].include = e.target.checked;
        saveAccMeta();
        render();
      }));
    }
    function saveAccMeta() {
      localStorage.setItem("accMeta", JSON.stringify(accMeta));
    }

    // Bindings for main UI actions
    $("#runAI").addEventListener("click", runAI);
    $("#acceptSafe").addEventListener("click", acceptSafe);
    $("#makePlan").addEventListener("click", renderPlan);
    $("#applyPlan").addEventListener("click", applyPlan);
    $("#applyMinPay").addEventListener("click", () => {
      const m = computeMinPay();
      if (!m) return alert("–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤");
      m.r["Status faktury"] = "Op≈Çacone";
      m.r["Data p≈Çatno≈õci"] = today();
      render();
    });
    $("#planFilter").addEventListener("change", renderPlan);
    $("#billScope").addEventListener("change", render);
    $("#excludeBlacklist")?.addEventListener("change", () => { renderPlan(); render(); });
    $("#billOverdueOnly")?.addEventListener("change", render);
    $("#exportPDF").addEventListener("click", () => window.print());
    $("#syncNow").addEventListener("click", async () => {
      try {
        const u1 = localStorage.getItem("txUrl") || "";
        const u2 = localStorage.getItem("billUrl") || "";
        if (u1) tx = await fetchCSV(u1);
        if (u2) bills = await fetchCSV(u2);
        inferAccounts();
        render();
        $("#lastSync").textContent = "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: " + new Date().toLocaleString();
      } catch(e) {
        $("#lastSync").textContent = "–û—à–∏–±–∫–∞: " + e.message;
      }
    });
    $("#txFile").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      tx = parseCSV(await f.text());
      inferAccounts();
      render();
    });
    $("#billFile").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      bills = parseCSV(await f.text());
      render();
    });
    $("#saveTxUrl").addEventListener("click", () => {
      localStorage.setItem("txUrl", $("#txUrl").value.trim());
      alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL wyciƒÖga");
    });
    $("#saveBillUrl").addEventListener("click", () => {
      localStorage.setItem("billUrl", $("#billUrl").value.trim());
      alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ URL faktur");
    });

    // Cash (kasa) logic
    let rec = null;
    let recTimer = null;
    let gotResult = false;
    function loadKasa() {
      try { kasa = JSON.parse(localStorage.getItem("kasa") || "[]"); } catch(e) { kasa = []; }
    }
    function saveKasa() {
      localStorage.setItem("kasa", JSON.stringify(kasa));
    }
    function renderKasa() {
      const tb = document.querySelector("#kasaTable tbody");
      tb.innerHTML = "";
      kasa.forEach((k, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source || ""}</td><td>${k.comment || ""}</td>`;
        tb.appendChild(tr);
      });
    }
    function addKasa(type, amount, comment, source) {
      if (!amount || isNaN(amount)) return alert("–°—É–º–º–∞");
      kasa.push({ id: Date.now(), date: today(), type, amount: Number(amount), comment: comment || "", source: source || "—Ä—É—á–Ω–æ–π" });
      saveKasa();
      render();
      renderKasa();
    }
    $("#addIn").addEventListener("click", () =>
      addKasa("przyjƒôcie", asNum($("#quickAmt").value), $("#quickNote").value, "—Ä—É—á–Ω–æ–π")
    );
    $("#addOut").addEventListener("click", () =>
      addKasa("wydanie", asNum($("#quickAmt").value), $("#quickNote").value, "—Ä—É—á–Ω–æ–π")
    );
    $("#cashClose").addEventListener("click", () => {
      const a = prompt("–ò—Ç–æ–≥ –≤ –∫–∞—Å—Å–µ (PLN):", kasaBalance().toFixed(2));
      if (a === null) return;
      addKasa("zamkniƒôcie", asNum(a), "close", "—Ä—É—á–Ω–æ–π");
    });
    $("#q50").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 50).toFixed(2);
    });
    $("#q100").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 100).toFixed(2);
    });
    $("#q200").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 200).toFixed(2);
    });

    // Voice recognition (Chrome)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
      rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.lang = localStorage.getItem("speechLang") || "pl-PL";
      rec.onstart = () => {
        gotResult = false;
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        $("#micStatus").textContent = `üéôÔ∏è –°–ª—É—à–∞—é... (${rec.lang})`;
        recTimer = setTimeout(() => {
          try { rec.abort(); } catch(_) {}
          if (!gotResult) {
            $("#micStatus").textContent = "üéôÔ∏è –¢–∞–π–º–∞—É—Ç: –Ω–µ—Ç —Ä–µ—á–∏";
          }
        }, 9000);
      };
      rec.onaudioend = () => {
        $("#micStatus").textContent = "üéôÔ∏è –ê—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω–æ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...";
      };
      rec.onend = () => {
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        if (document.querySelector(".mic").classList.contains("on")) {
          document.querySelector(".mic").classList.remove("on");
        }
        if ($("#micStatus").textContent.includes("–°–ª—É—à–∞—é")) {
          $("#micStatus").textContent = "üéôÔ∏è –ù–∏—á–µ–≥–æ –Ω–µ —É—Å–ª—ã—à–∞–ª";
        }
      };
      rec.onerror = (e) => {
        $("#micStatus").textContent = "üéôÔ∏è –û—à–∏–±–∫–∞: " + (e.error || "unknown");
      };
      rec.onresult = (e) => {
        gotResult = true;
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        const text = (e.results[0][0].transcript || "").toLowerCase();
        $("#micStatus").textContent = "üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: " + text;
        const numMatch = text.match(/(\d+[.,]?\d*)\s*(z≈Ç|pln)?/);
        const num = numMatch ? numMatch[1] : null;
        const isOut = /(wyda|minus|wydat|–≤—ã–¥–∞|–º–∏–Ω—É—Å|—Ä–∞—Å—Ö–æ–¥)/.test(text);
        const isIn = /(przyj|plus|wp≈Çyw|–ø—Ä–∏–Ω—è—Ç—å|–ø–ª—é—Å|–ø—Ä–∏—Ö–æ–¥)/.test(text) || !isOut;
        const note = text.replace(/(\d+[.,]?\d*\s*(z≈Ç|pln)?)/, "").trim();
        if (!num) {
          $("#micStatus").textContent = "üéôÔ∏è –°—É–º–º—É –Ω–µ –Ω–∞—à—ë–ª";
          return;
        }
        addKasa(isOut ? "wydanie" : "przyjƒôcie", asNum(num), note || "–≥–æ–ª–æ—Å", "voice");
      };
    }
    $("#micBtn").addEventListener("click", () => {
      if (!rec) {
        alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ —Ç—Ä–µ–±—É–µ—Ç Chrome + HTTPS/localhost.");
        return;
      }
      try {
        const sel = $("#speechLang");
        if (sel) {
          rec.lang = sel.value;
          localStorage.setItem("speechLang", rec.lang);
        }
        document.querySelector(".mic").classList.add("on");
        $("#micStatus").textContent = "üéôÔ∏è –ñ–¥—É –∫–æ–º–∞–Ω–¥—É...";
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ audio: true }).then(_ => {
            try { rec.start(); } catch(e) {
              $("#micStatus").textContent = "üéôÔ∏è –ù–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª: " + e.message;
            }
          });
        } else {
          try { rec.start(); } catch(e) {
            $("#micStatus").textContent = "üéôÔ∏è –ù–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª: " + e.message;
          }
        }
      } catch(e) {
        $("#micStatus").textContent = "üéôÔ∏è –ù–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å: " + e.message;
      }
    });
    $("#micTest").addEventListener("click", () => {
      $("#micStatus").textContent = "üéôÔ∏è –¢–µ—Å—Ç: –ø—Ä–∏–π–Ω—è—Ç–æ 120 –Ω–∞ –∫–∞—Å—Å—É (—Å–∏–º—É–ª—è—Ü–∏—è)";
      addKasa("przyjƒôcie", 120, "—Å–∏–º—É–ª—è—Ü–∏—è", "test");
    });

    // OCR for receipts
    $("#cashPhoto").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      const imgURL = URL.createObjectURL(f);
      const thumb = $("#lastThumb");
      thumb.src = imgURL;
      thumb.style.display = "inline-block";
      try {
        const worker = await Tesseract.createWorker({ langPath: 'https://tessdata.projectnaptha.com/4.0.0', langs: "eng+pol" });
        // ^ Use pre-trained data for English+Polish
        await worker.load();
        await worker.loadLanguage("eng+pol");
        await worker.initialize("eng+pol");
        const { data: { text } } = await worker.recognize(imgURL);
        await worker.terminate();
        const amountMatch = text.replace(",", ".").match(/(\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|z≈Ç)?/i);
        const dateMatch = text.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
        const amtStr = amountMatch ? amountMatch[1].replace(" ", "").replace(".", "").replace(",", ".") : null;
        const note = "OCR: " + (dateMatch ? dateMatch[1] + " " : "") + (text.split("\n")[0] || "paragon");
        if (amtStr) {
          const amt = Number(amtStr);
          if (confirm(`–ß–µ–∫: —Å—É–º–º–∞ ${amt.toFixed(2)} PLN. –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞—Å—Å—É –∫–∞–∫ —Ä–∞—Å—Ö–æ–¥?`)) {
            addKasa("wydanie", amt, note, "OCR");
          }
        } else {
          alert("–ù–µ –Ω–∞—à—ë–ª —Å—É–º–º—É –Ω–∞ —Ñ–æ—Ç–æ. –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.");
        }
      } catch(err) {
        alert("OCR –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: " + err.message);
      }
    });

    // Settings
    $("#applySettings").addEventListener("click", () => {
      localStorage.setItem("cashPLN", $("#cashPLN").value || "0");
      localStorage.setItem("penaltyPct", $("#penaltyPct").value || "0.05");
      localStorage.setItem("intervalMin", $("#intervalMin").value || "10");
      localStorage.setItem("rateEUR", $("#rateEUR").value || "4.30");
      localStorage.setItem("rateUSD", $("#rateUSD").value || "3.95");
      localStorage.setItem("blacklist", $("#blacklist").value || "");
      localStorage.setItem("autoCash", $("#autoCash").checked ? "1" : "0");
      $("#modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
        ? "–†–µ–∂–∏–º: " + ($("#autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
        : (localStorage.getItem("otd_lang") || "ru") === "pl"
          ? "Tryb: " + ($("#autoCash").checked ? "auto" : "rƒôczny")
          : (localStorage.getItem("otd_lang") || "ru") === "uk"
            ? "–†–µ–∂–∏–º: " + ($("#autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–∏–π")
            : "Mode: " + ($("#autoCash").checked ? "auto" : "manual");
      render();
    });
    $("#exportCfg").addEventListener("click", () => {
      const cfg = {
        txUrl: localStorage.getItem("txUrl") || "",
        billUrl: localStorage.getItem("billUrl") || "",
        cashPLN: localStorage.getItem("cashPLN") || "0",
        penaltyPct: localStorage.getItem("penaltyPct") || "0.05",
        intervalMin: localStorage.getItem("intervalMin") || "10",
        rateEUR: localStorage.getItem("rateEUR") || "4.30",
        rateUSD: localStorage.getItem("rateUSD") || "3.95",
        blacklist: localStorage.getItem("blacklist") || "",
        autoCash: localStorage.getItem("autoCash") || "0",
        accMeta: localStorage.getItem("accMeta") || "{}"
      };
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "onetapday_settings.json";
      a.click();
    });
    $("#importCfg").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      const cfg = JSON.parse(await f.text());
      Object.entries(cfg).forEach(([k, v]) => localStorage.setItem(k, typeof v === "string" ? v : JSON.stringify(v)));
      location.reload();
    });

    // On load, initialize from localStorage and render initial state
    (function init() {
      loadKasa();
      try { accMeta = JSON.parse(localStorage.getItem("accMeta") || "{}"); } catch(e) { accMeta = {}; }
      renderKasa();
      $("#txUrl").value = localStorage.getItem("txUrl") || "";
      $("#billUrl").value = localStorage.getItem("billUrl") || "";
      $("#cashPLN").value = localStorage.getItem("cashPLN") || "5000";
      $("#penaltyPct").value = localStorage.getItem("penaltyPct") || "0.05";
      $("#intervalMin").value = localStorage.getItem("intervalMin") || "10";
      $("#rateEUR").value = localStorage.getItem("rateEUR") || "4.30";
      $("#rateUSD").value = localStorage.getItem("rateUSD") || "3.95";
      $("#blacklist").value = localStorage.getItem("blacklist") || "";
      $("#autoCash").checked = localStorage.getItem("autoCash") === "1";
      const langSel = $("#speechLang");
      if (langSel) {
        const saved = localStorage.getItem("speechLang");
        if (saved) langSel.value = saved;
      }
      $("#modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
        ? "–†–µ–∂–∏–º: " + ($("#autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–æ–π")
        : (localStorage.getItem("otd_lang") || "ru") === "pl"
          ? "Tryb: " + ($("#autoCash").checked ? "auto" : "rƒôczny")
          : (localStorage.getItem("otd_lang") || "ru") === "uk"
            ? "–†–µ–∂–∏–º: " + ($("#autoCash").checked ? "–∞–≤—Ç–æ" : "—Ä—É—á–Ω–∏–π")
            : "Mode: " + ($("#autoCash").checked ? "auto" : "manual");
      inferAccounts();
      render();
    })();

    // Pilot subscription status updater (compact)
    (function() {
      function getPilot() {
        try { return JSON.parse(localStorage.getItem("otd_pilot") || "{}"); } catch(e) { return {}; }
      }
      function setPilot(s) {
        try { localStorage.setItem("otd_pilot", JSON.stringify(s)); } catch(e) {}
      }
      function isoDate(d) {
        const x = new Date(d);
        return isNaN(x) ? "‚Äî" : x.toISOString().slice(0, 10);
      }
      function daysLeft(endIso) {
        if (!endIso) return 0;
        const e = new Date(endIso), n = new Date();
        return Math.max(0, Math.ceil((e - n) / 86400000));
      }
      function updatePilotUI() {
        const s = getPilot();
        const st = s.status || "none";
        let desc = "‚Äî";
        if (st === "none") desc = "–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞";
        if (st === "deposit_paid") desc = "–¥–µ–ø–æ–∑–∏—Ç –æ–ø–ª–∞—á–µ–Ω";
        if (st === "active") desc = "–ø–∏–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω";
        if (st === "ended") desc = "–ø–∏–ª–æ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω";
        if (st === "discount_active") desc = "—Å–∫–∏–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
        const mini = document.getElementById("pilotMini");
        if (mini) mini.textContent = "–°—Ç–∞—Ç—É—Å: " + desc;
        const ps = document.getElementById("pilotStart");
        if (ps) ps.textContent = s.startAt ? isoDate(s.startAt) : "‚Äî";
        const pe = document.getElementById("pilotEnd");
        if (pe) pe.textContent = s.endAt ? isoDate(s.endAt) : "‚Äî";
        const pc = document.getElementById("pilotCountdown");
        if (pc) pc.textContent = (st === "active" && s.endAt) ? (" ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å " + daysLeft(s.endAt) + " –¥–Ω.") : "";
        const du = document.getElementById("discountUntil");
        if (du) du.textContent = s.discountUntil ? isoDate(s.discountUntil) : "‚Äî";
        // Show/hide admin buttons appropriately
        const userEmail = localStorage.getItem("otd_user") || "";
        const isAdmin = userEmail && (userEmail === "1tapday@gmail.com");
        document.getElementById("btnMarkPaid").style.display = isAdmin ? "inline-block" : "none";
        document.getElementById("btnStartPilot").style.display = isAdmin ? "inline-block" : "none";
        document.getElementById("btnResetPilot").style.display = isAdmin ? "inline-block" : "none";
        // ActivateDiscount visible to user only if pilot ended and not already in discount
        const showDiscount = st === "ended";
        document.getElementById("btnActivateDiscount").style.display = showDiscount ? "inline-block" : (isAdmin ? "none" : "none");
      }
      // Listen for clicks on pilot action buttons
      document.addEventListener("click", (e) => {
        const id = e.target && e.target.id;
        if (!id) return;
        let s = getPilot();
        if (id === "btnMarkPaid") {
          // Admin marking deposit as paid
          fetch("/mark-paid", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "deposit_paid";
                s.paidAt = new Date().toISOString();
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ –æ–ø–ª–∞—Ç—ã");
              }
            });
        }
        if (id === "btnStartPilot") {
          fetch("/start-pilot", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "active";
                s.startAt = new Date().toISOString();
                const d = new Date();
                d.setMonth(d.getMonth() + 2);
                s.endAt = d.toISOString();
                // Set reminders (optional, not used here)
                s.reminders = [14, 7, 3].map(n => { let x = new Date(d); x.setDate(x.getDate() - n); return x.toISOString(); });
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∏–ª–æ—Ç–∞");
              }
            });
        }
        if (id === "btnActivateDiscount") {
          fetch("/activate-discount", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "discount_active";
                s.discountSince = new Date().toISOString();
                const e2 = new Date();
                e2.setMonth(e2.getMonth() + 12);
                s.discountUntil = e2.toISOString();
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–∫–∏–¥–∫–∏");
              }
            });
        }
        if (id === "btnResetPilot") {
          localStorage.removeItem("otd_pilot");
          updatePilotUI();
        }
      }, false);
      // Periodically update countdown if active
      setInterval(() => {
        const s = getPilot();
        if ((s.status || "") === "active") updatePilotUI();
      }, 60000);
      updatePilotUI();
    })();

    // 30-day forecast and month summary hook
    (function(){
      function toISODate(d) { const x = new Date(d); return isNaN(x) ? "" : x.toISOString().slice(0, 10); }
      function todayDate() { return new Date().toISOString().slice(0, 10); }
      function asNumVal(v) { return Number(String(v || "").replace(/\s/g, "").replace(",", ".")); }
      function billsList() { try { return window.bills || []; } catch(e) { return []; } }
      function txList() { try { return window.tx || []; } catch(e) { return []; } }
      function kasaBalPersistent() {
        try {
          const k = JSON.parse(localStorage.getItem("kasa") || "[]");
          return k.reduce((s, r) => 
            s + (r.type === "przyjƒôcie" ? r.amount : (r.type === "wydanie" ? -r.amount : (r.type === "zamkniƒôcie" ? (r.amount - s) : 0))), 0);
        } catch(e) { return 0; }
      }
      function availNow() {
        try { return Number($("#kpiAvail").textContent || 0); } catch(e) { return 0; }
      }
      function buildForecast(days) {
        let base = availNow();
        const rows = [["–î–∞—Ç–∞", "–ü–ª–∞—Ç–µ–∂–∏", "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è", "–ü—Ä–æ–≥–Ω–æ–∑ –±–∞–ª–∞–Ω—Å"]];
        for (let i = 0; i < days; i++) {
          const d = new Date();
          d.setDate(d.getDate() + i);
          const iso = d.toISOString().slice(0, 10);
          const pays = billsList().filter(b => {
            const st = String(b["Status faktury"] || "").toLowerCase();
            const due = toISODate(b["Termin p≈Çatno≈õci"]);
            return ["do zap≈Çaty", "przeterminowane", "–∫ –æ–ø–ª–∞—Ç–µ", "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"].includes(st) && due === iso && String(b["Waluta"] || "").toUpperCase() === "PLN";
          }).reduce((s, b) => s + asNumVal(b["Kwota do zap≈Çaty"]), 0);
          const inflow = txList().filter(t => toISODate(t["Data ksiƒôgowania"]) === iso && asNumVal(t["Kwota"]) > 0)
                                 .reduce((s, t) => s + asNumVal(t["Kw–æ—Ç–∞"]), 0);
          const outflow = txList().filter(t => toISODate(t["Data ksiƒôgowania"]) === iso && asNumVal(t["Kwota"]) < 0)
                                  .reduce((s, t) => s + asNumVal(t["Kwota"]), 0);
          base = base + inflow + outflow - pays;
          rows.push([iso, pays.toFixed(2), (inflow + outflow).toFixed(2), base.toFixed(2)]);
        }
        return rows;
      }
      function tableHTML(rows) {
        let html = "<table><thead><tr>" + rows[0].map(c => "<th>" + c + "</th>").join("") + "</tr></thead><tbody>";
        for (let i = 1; i < rows.length; i++) {
          html += "<tr>" + rows[i].map(c => "<td>" + c + "</td>").join("") + "</tr>";
        }
        html += "</tbody></table>";
        return html;
      }
      function render30() {
        const rows = buildForecast(30);
        const el = document.getElementById("forecast30Table");
        if (el) el.innerHTML = tableHTML(rows);
        // Month summary:
        const endBal = Number(rows[rows.length - 1][3]);
        const negDay = rows.slice(1).find(r => Number(r[3]) < 0);
        const m = negDay
          ? (`–ì—ç–ø ${Math.abs(Number(negDay[3])).toFixed(2)} PLN –≤ ${negDay[0]}`)
          : (`–ë–µ–∑ –∫–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞. –ë–∞–ª–∞–Ω—Å –Ω–∞ 30-–π –¥–µ–Ω—å: ${endBal.toFixed(2)} PLN`);
        const ms = document.getElementById("monthSummary");
        if (ms) ms.textContent = m;
      }
      // Hook into existing render() by wrapping it:
      const oldRender = window.render;
      window.render = function() {
        if (typeof oldRender === "function") oldRender();
        render30();
      };
      // Initial render of 30-day forecast and summary:
      render30();
    })();
  </script>
</body>
</html>
