<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneTapDay – AI Księgowy (MVP)</title>
  <style>
    :root {
      --accent: #35D36B;
      --bg: #0d0f10;
      --card: #15181a;
      --muted: #9aa3a9;
      --text: #e6edf3;
      --danger: #ff7070;
      --warn: #f4d06f;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 12px 16px 48px; }
    .top { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .top .brand { font-weight: 700; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #cfe6d7;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--accent); color: #08110b; border-color: #49e084; }
    .section { display: none; margin-top: 14px; }
    .section.active { display: block; }
    .cards { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 12px; }
    .card { background: var(--card); border: 1px solid #22282c; border-radius: 12px; padding: 14px; }
    .muted { color: var(--muted); font-size: 13px; }
    .kpi { font-size: 34px; font-weight: 800; margin: 2px 0 0; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: var(--accent);
      color: #08110b;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary { background: #20262b; color: #fff; border: 1px solid #2a3136; }
    .btn.ghost { background: transparent; color: #e6edf3; border: 1px dashed #2a3136; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #242b30; padding: 8px 6px; font-size: 13px; text-align: left; vertical-align: top; }
    th { color: #9aa3a9; font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #0f1214;
      border: 1px solid #20262b;
      color: #9aa3a9;
      font-size: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .due { background: #2a1f1f; color: #ffb3b3; border: 1px solid #4d3030; }
    .overdue { background: #381f1f; color: #ff8a8a; border: 1px solid #5c2a2a; }
    .cand { background: #23221a; color: #e3e0b0; border: 1px solid #49452c; }
    .ai { background: #1a2320; color: #a8e8c7; border: 1px solid #274b32; }
    .barwrap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
    .bar { background: #0f1214; border: 1px solid #20262b; border-radius: 8px; padding: 6px; text-align: center; }
    .bar .h { height: 36px; background: #203026; border: 1px solid #2e4635; border-radius: 6px; margin: 4px 0; }
    .bar.neg .h { background: #3a2222; border-color: #5b3030; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type=file], input[type=text], input[type=number] {
      background: #0f1214;
      border: 1px solid #20262b;
      border-radius: 8px;
      color: #e6edf3;
      padding: 9px;
    }
    .right { margin-left: auto; }
    .mic {
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2a3136;
      background: #0f1214;
      cursor: pointer;
    }
    .mic.on { background: #1d2; color: #08110b; border-color: #3f6; }
    .hint { font-size: 12px; color: #9aa3a9; }
    .thumb { max-height: 60px; border: 1px solid #2a3136; border-radius: 8px; margin-left: 8px; }
    @media (max-width: 1080px) {
      .cards { grid-template-columns: 1fr 1fr; }
      .grid2 { grid-template-columns: 1fr; }
    }
    @media print {
      .tabs, .btn, .row input, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .card { background: #fff; border: 1px solid #999; }
      .wrap { max-width: 1000px; }
    }
    /* Language toggle (reuse same style as portal) */
    .lang { display: flex; gap: 6px; margin-left: 12px; }
    .lang button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #20262b;
      background: #0f1214;
      color: #9aa3a9;
      font-size: 12px;
      cursor: pointer;
    }
    .lang button.on { background: #274b32; color: #a8e8c7; border-color: #274b32; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><b>OneTapDay — AI Księgowy</b> <span class="pill">MVP</span></div>
      <div class="tabs">
        <div class="tab active" data-sec="pulpit" data-i="tab_dashboard">Пульт</div>
        <div class="tab" data-sec="wyciag" data-i="tab_statement">Wyciąg</div>
        <div class="tab" data-sec="faktury" data-i="tab_invoices">Faktury</div>
        <div class="tab" data-sec="konta" data-i="tab_accounts">Счета</div>
        <div class="tab" data-sec="kasa" data-i="tab_cash">Kasa (нал)</div>
        <div class="tab" data-sec="ustawienia" data-i="tab_settings">Настройки</div>
        <div class="lang" id="langBarMain">
          <button data-lang="ru" class="on">RU</button>
          <button data-lang="en">EN</button>
          <button data-lang="pl">PL</button>
          <button data-lang="uk">UK</button>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="pulpit" class="section active">
      <div class="cards">
        <div class="card">
          <div class="muted" data-i="kpi_due_today">К оплате сегодня</div>
          <div id="kpiDue" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_unmatched">Несвязанные транзакции</div>
          <div id="kpiUnmatch" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_banks">Банки в расчёте</div>
          <div id="kpiBank" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_cash">Касса (нал)</div>
          <div id="kpiCash" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_total">Доступно всего</div>
          <div id="kpiAvail" class="kpi">0</div>
        </div>
        <div class="card">
          <div class="muted" data-i="kpi_gap_today">Разрыв кассы сегодня</div>
          <div id="kpiGap" class="kpi">0</div>
        </div>
      </div>
      <div class="row" style="margin: 10px 0;">
        <button id="syncNow" class="btn" data-i="btn_sync">Синхронизация</button>
        <button id="runAI" class="btn secondary" data-i="btn_ai_match">ИИ‑сверка</button>
        <button id="acceptSafe" class="btn secondary" data-i="btn_accept_safe">Принять безопасные пары</button>
        <button id="exportPDF" class="btn secondary" data-i="btn_pdf">PDF отчёт</button>
        <span id="lastSync" class="pill">Синхронизация: —</span>
        <span class="right pill" id="modeCash">Режим: авто</span>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="minpay_title">Минимальный платёж (штраф‑стоп)</div>
          <div id="minPayBox" class="muted">—</div>
          <div class="row" style="margin-top: 6px;">
            <button id="applyMinPay" class="btn secondary" data-i="btn_apply_minpay">Отметить как оплачено</button>
          </div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_7d">Прогноз 7 дней</div>
          <div class="muted" data-i="forecast7d_note">Считает PLN‑счета из wyciąg (включённые) + кассу.</div>
          <div id="forecastBars" class="barwrap"></div>
          <div id="forecastMeta" class="muted" style="margin-top: 6px;">—</div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight: 700;" data-i="forecast_30d">Прогноз 30 дней</div>
          <div class="muted" data-i="forecast30_note">Автопрогноз по wyciąg + кассе на 30 дней.</div>
          <div id="forecast30Table"></div>
        </div>
        <div class="card">
          <div style="font-weight: 700;" data-i="month_summary_title">Итоги месяца</div>
          <div id="monthSummary" class="muted">—</div>
        </div>
      </div>
      <div class="card" style="margin-top: 14px;">
        <div class="row">
          <div style="font-weight: 700;" data-i="plan_title">План платежей под кассу</div>
          <div class="right"> 
            <span data-i="filter_label">Фильтр:</span>
            <select id="planFilter">
              <option value="today" data-i="filter_today">Сегодня</option>
              <option value="7d" data-i="filter_7d" selected>7 дней</option>
              <option value="all" data-i="filter_all">Все</option>
            </select>
          </div>
          <label style="margin-left: 10px;">
            <input type="checkbox" id="excludeBlacklist" /> <span data-i="exclude_blacklist">Исключать blacklist</span>
          </label>
        </div>
        <div class="row" style="margin: 8px 0;">
          <button id="makePlan" class="btn secondary" data-i="btn_make_plan">Сформировать</button>
          <button id="applyPlan" class="btn secondary" data-i="btn_apply_plan">Применить</button>
          <span id="planMeta" class="pill">—</span>
        </div>
        <table id="planTable">
          <thead>
            <tr>
              <th>#</th>
              <th data-i="plan_th_invoice">Фактура</th>
              <th data-i="plan_th_supplier">Поставщик</th>
              <th data-i="plan_th_due">Срок</th>
              <th data-i="plan_th_amount">Сумма</th>
              <th data-i="plan_th_reason">Причина</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Bank Statement Section (Wyciąg) -->
    <div id="wyciag" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="txFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_statement">Загрузить выписку (CSV)</span>
        </label>
        <input id="txUrl" type="text" placeholder="URL CSV wyciąga" />
        <button id="saveTxUrl" class="btn secondary" data-i="save_url">Сохранить URL</button>
        <span class="muted">
          Колонки: Data księgowania, ID transakcji, ID konta (или IBAN), Kontrahent, Tytuł/Opis, Kwota(±), Waluta, Status transakcji, Saldo po operacji?
        </span>
      </div>
      <table id="txTable">
        <thead>
          <tr>
            <th data-i="th_date">Дата</th>
            <th data-i="th_account">Счёт</th>
            <th data-i="th_counterparty">Контрагент</th>
            <th data-i="th_desc">Описание</th>
            <th data-i="th_amount">Сумма</th>
            <th data-i="th_currency">Валюта</th>
            <th data-i="th_status">Статус</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Invoices Section (Faktury) -->
    <div id="faktury" class="section">
      <div class="row">
        <label class="btn ghost">
          <input id="billFile" type="file" accept=".csv" style="display: none;" />
          <span data-i="upload_invoices">Загрузить счета (CSV)</span>
        </label>
        <input id="billUrl" type="text" placeholder="URL CSV faktur" />
        <button id="saveBillUrl" class="btn secondary" data-i="save_url">Сохранить URL</button>
        <label style="margin-left: 10px;">
          <input type="checkbox" id="billOverdueOnly" /> <span data-i="only_overdue">Только просроченные</span>
        </label>
        <div class="right">
          <span data-i="show_label">Показать:</span>
          <select id="billScope">
            <option value="today" data-i="filter_today">Сегодня</option>
            <option value="7d" data-i="filter_7d" selected>7 дней</option>
            <option value="all" data-i="filter_all">Все</option>
          </select>
        </div>
      </div>
      <table id="billTable">
        <thead>
          <tr>
            <th data-i="inv_th_due">Срок</th>
            <th data-i="inv_th_number">№</th>
            <th data-i="inv_th_supplier">Поставщик</th>
            <th data-i="inv_th_amount">Сумма</th>
            <th data-i="inv_th_currency">Валюта</th>
            <th data-i="inv_th_status">Статус</th>
            <th data-i="inv_th_candidate">Кандидат</th>
            <th data-i="inv_th_score">Score</th>
            <th data-i="inv_th_action">Действие</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Accounts Section (Konta) -->
    <div id="konta" class="section">
      <div class="card">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="auto_accounts_title">Счета из выписки (авто)</div>
        <div class="muted" data-i="auto_accounts_desc">
          Мы сами собираем счета по полям «ID konta» или «IBAN» из выписки. Включай в расчёт, редактируй стартовый баланс, меняй тип.
        </div>
        <table id="autoAcc">
          <thead>
            <tr>
              <th data-i="acc_th_account">Счёт</th>
              <th data-i="acc_th_type">Тип</th>
              <th data-i="acc_th_currency">Валюта</th>
              <th data-i="acc_th_balance_calc">Баланс (расчёт)</th>
              <th data-i="acc_th_start_balance">Стартовый баланс</th>
              <th data-i="acc_th_include">В расчёт плана</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cash Section (Kasa) -->
    <div id="kasa" class="section">
      <div class="row">
        <input id="quickAmt" type="number" placeholder="Сумма PLN" step="0.01" />
        <input id="quickNote" type="text" placeholder="Комментарий" />
        <button class="btn" id="addIn" data-i="btn_add_in">+ Приём</button>
        <button class="btn secondary" id="addOut" data-i="btn_add_out">− Выдача</button>
        <button class="btn secondary" id="cashClose" data-i="btn_close_shift">Закрыть смену</button>
        <button class="btn ghost" id="q50">+50</button>
        <button class="btn ghost" id="q100">+100</button>
        <button class="btn ghost" id="q200">+200</button>
        <label class="btn ghost">
          <input id="cashPhoto" type="file" accept="image/*" capture="environment" style="display: none;" />
          <span data-i="btn_scan_receipt">Сканировать чек (фото)</span>
        </label>
        <button id="micBtn" class="mic" title="Сказать операцию">🎙️</button>
        <span class="hint">
          Пример: «принять 120 на кассу от продаж», «выдать 50 на доставку»
        </span>
        <img id="lastThumb" class="thumb" style="display: none;" />
        <span id="micStatus" class="pill">🎙️ Микрофон: готов</span>
      </div>
      <div class="row" style="margin-top: 8px;">
        <label>
          <span data-i="speech_lang">Язык распознавания:</span>
          <select id="speechLang">
            <option value="pl-PL">pl-PL</option>
            <option value="ru-RU">ru-RU</option>
            <option value="uk-UA">uk-UA</option>
            <option value="en-US">en-US</option>
          </select>
        </label>
        <button id="micTest" class="btn secondary" data-i="btn_test_voice">Тест команд</button>
      </div>
      <table id="kasaTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-i="cash_th_date">Дата</th>
            <th data-i="cash_th_type">Тип</th>
            <th data-i="cash_th_amount">Сумма</th>
            <th data-i="cash_th_source">Источник</th>
            <th data-i="cash_th_comment">Комментарий</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Settings Section (Настройки) -->
    <div id="ustawienia" class="section">
      <div class="card" id="otdSubCard">
        <div style="font-weight: 700; margin-bottom: 6px;" data-i="pilot_subscription_title">Подписка пилота</div>
        <div class="row" style="margin: 6px 0;">
          <!-- Payment link removed since portal handles it -->
          <!--<a class="btn" href="https://buy.stripe.com/..." target="_blank" rel="noopener" data-i="btn_pay_deposit">Оплатить депозит 99 PLN</a>-->
          <span id="pilotMini" class="pill">Статус: —</span>
        </div>
        <div class="row" style="gap: 8px; margin-top: 6px;">
          <button id="btnMarkPaid" class="btn secondary" data-i="btn_mark_paid">Отметить оплату</button>
          <button id="btnStartPilot" class="btn secondary" data-i="btn_start_pilot">Запустить пилот (2 мес.)</button>
          <button id="btnActivateDiscount" class="btn secondary" data-i="btn_activate_discount">Включить −50% на 12 мес.</button>
          <button id="btnResetPilot" class="btn ghost" data-i="btn_reset_pilot">Сброс</button>
        </div>
        <div class="muted" style="margin-top: 6px;">
          <span data-i="start_label">Начало:</span> <b id="pilotStart">—</b> · 
          <span data-i="end_label">Окончание:</span> <b id="pilotEnd">—</b> 
          <span id="pilotCountdown"></span><br/>
          <span data-i="discount_label">Скидка активна до:</span> <b id="discountUntil">—</b>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="calc_mode">Режим расчёта доступных средств</div>
        <div class="row" style="margin-top: 6px;">
          <label><input type="checkbox" id="autoCash" /> <span data-i="auto_mode_label">Авто: из счетов wyciąg (включённые) + касса</span></label>
        </div>
      </div>
      <div class="card">
        <div style="font-weight: 700;" data-i="parameters">Параметры</div>
        <div class="row" style="margin-top: 6px;">
          <label><span data-i="param_cash">Доступная касса сегодня (ручной PLN):</span> <input id="cashPLN" type="number" step="0.01" value="5000" /></label>
          <label><span data-i="param_penalty">Пеня, %/день:</span> <input id="penaltyPct" type="number" step="0.01" value="0.05" /></label>
          <label><span data-i="param_interval">Интервал синха, мин:</span> <input id="intervalMin" type="number" min="1" value="10" /></label>
        </div>
        <div class="row" style="margin-top: 6px;">
          <label>EUR→PLN: <input id="rateEUR" type="number" step="0.0001" value="4.30" /></label>
          <label>USD→PLN: <input id="rateUSD" type="number" step="0.0001" value="3.95" /></label>
          <label>Blacklist: <input id="blacklist" type="text" placeholder="Firma X, BadVendor" /></label>
        </div>
        <div class="row" style="margin-top: 8px;">
          <button id="applySettings" class="btn" data-i="btn_save_settings">Сохранить</button>
          <button id="exportCfg" class="btn secondary" data-i="btn_export_settings">Экспорт настроек</button>
          <label class="btn ghost">
            <input id="importCfg" type="file" accept="application/json" style="display: none;" />
            <span data-i="btn_import_settings">Импорт настроек</span>
          </label>
        </div>
        <div class="muted" style="margin-top: 6px;" data-i="auto_mode_explain">
          Режим «Авто»: считаем доступные деньги из всех включённых счетов, собранных из wyciąg (или с заданным стартовым балансом), + баланс кассы. 
          Ручной режим берёт только указанную сумму + кассу.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Redirect to portal if not logged in
    if (!localStorage.getItem("otd_user")) {
      window.location.href = "/";
    }

    // Internationalization strings for main app
    const M = {
      ru: {
        tab_dashboard: "Пульт", tab_statement: "Выписка", tab_invoices: "Фактуры", tab_accounts: "Счета", tab_cash: "Касса", tab_settings: "Настройки",
        kpi_due_today: "К оплате сегодня", kpi_unmatched: "Несвязанные транзакции", kpi_banks: "Банки в расчёте", kpi_cash: "Касса (нал)", kpi_total: "Доступно всего", kpi_gap_today: "Разрыв кассы сегодня",
        btn_sync: "Синхронизация", btn_ai_match: "ИИ‑сверка", btn_accept_safe: "Принять безопасные пары", btn_pdf: "PDF отчёт",
        minpay_title: "Минимальный платёж (штраф‑стоп)", btn_apply_minpay: "Отметить как оплачено",
        forecast_7d: "Прогноз 7 дней", forecast7d_note: "Считает PLN‑счета из wyciąg (включённые) + кассу.",
        forecast_30d: "Прогноз 30 дней", forecast30_note: "Автопрогноз по wyciąg + кассе на 30 дней.",
        month_summary_title: "Итоги месяца",
        plan_title: "План платежей под кассу", filter_label: "Фильтр:", filter_today: "Сегодня", filter_7d: "7 дней", filter_all: "Все", exclude_blacklist: "Исключать blacklist",
        btn_make_plan: "Сформировать", btn_apply_plan: "Применить",
        plan_th_invoice: "Фактура", plan_th_supplier: "Поставщик", plan_th_due: "Срок", plan_th_amount: "Сумма", plan_th_reason: "Причина",
        upload_statement: "Загрузить выписку (CSV)", save_url: "Сохранить URL",
        th_date: "Дата", th_account: "Счёт", th_counterparty: "Контрагент", th_desc: "Описание", th_amount: "Сумма", th_currency: "Валюта", th_status: "Статус",
        upload_invoices: "Загрузить счета (CSV)", only_overdue: "Только просроченные", show_label: "Показать:",
        inv_th_due: "Срок", inv_th_number: "№", inv_th_supplier: "Поставщик", inv_th_amount: "Сумма", inv_th_currency: "Валюта", inv_th_status: "Статус", inv_th_candidate: "Кандидат", inv_th_score: "Score", inv_th_action: "Действие",
        auto_accounts_title: "Счета из выписки (авто)",
        auto_accounts_desc: "Мы сами собираем счета по полям «ID konta» или «IBAN» из выписки. Включай в расчёт, редактируй стартовый баланс, меняй тип.",
        acc_th_account: "Счёт", acc_th_type: "Тип", acc_th_currency: "Валюта", acc_th_balance_calc: "Баланс (расчёт)", acc_th_start_balance: "Стартовый баланс", acc_th_include: "В расчёт плана",
        btn_add_in: "+ Приём", btn_add_out: "− Выдача", btn_close_shift: "Закрыть смену", btn_scan_receipt: "Сканировать чек (фото)",
        speech_lang: "Язык распознавания:", btn_test_voice: "Тест команд",
        cash_th_date: "Дата", cash_th_type: "Тип", cash_th_amount: "Сумма", cash_th_source: "Источник", cash_th_comment: "Комментарий",
        pilot_subscription_title: "Подписка пилота", // pilot subscription section
        // btn_pay_deposit not used (no payment link here)
        btn_mark_paid: "Отметить оплату", btn_start_pilot: "Запустить пилот (2 мес.)", btn_activate_discount: "Включить −50% на 12 мес.", btn_reset_pilot: "Сброс",
        start_label: "Начало:", end_label: "Окончание:", discount_label: "Скидка активна до:",
        calc_mode: "Режим расчёта доступных средств", auto_mode_label: "Авто: из счетов wyciąg (включённые) + касса",
        parameters: "Параметры",
        param_cash: "Доступная касса сегодня (ручной PLN):", param_penalty: "Пеня, %/день:", param_interval: "Интервал синха, мин:",
        btn_save_settings: "Сохранить", btn_export_settings: "Экспорт настроек", btn_import_settings: "Импорт настроек",
        auto_mode_explain: "Режим «Авто»: считаем доступные деньги из всех включённых счетов, собранных из wyciąg (или с заданным стартовым балансом), + баланс кассы. Ручной режим берёт только указанную сумму + кассу."
      },
      en: {
        tab_dashboard: "Dashboard", tab_statement: "Statement", tab_invoices: "Invoices", tab_accounts: "Accounts", tab_cash: "Cash", tab_settings: "Settings",
        kpi_due_today: "Due today", kpi_unmatched: "Unmatched transactions", kpi_banks: "Accounts included", kpi_cash: "Cash (on hand)", kpi_total: "Total available", kpi_gap_today: "Cash gap today",
        btn_sync: "Sync Now", btn_ai_match: "AI Match", btn_accept_safe: "Accept safe pairs", btn_pdf: "PDF Report",
        minpay_title: "Minimum Payment (penalty stop)", btn_apply_minpay: "Mark as Paid",
        forecast_7d: "7-day Forecast", forecast7d_note: "Counts PLN accounts from statement (included) + cash.",
        forecast_30d: "30-day Forecast", forecast30_note: "Auto-forecast from statement + cash for 30 days.",
        month_summary_title: "Month Summary",
        plan_title: "Cash Payment Plan", filter_label: "Filter:", filter_today: "Today", filter_7d: "7 days", filter_all: "All", exclude_blacklist: "Exclude blacklist",
        btn_make_plan: "Generate", btn_apply_plan: "Apply",
        plan_th_invoice: "Invoice", plan_th_supplier: "Supplier", plan_th_due: "Due", plan_th_amount: "Amount", plan_th_reason: "Reason",
        upload_statement: "Upload Statement (CSV)", save_url: "Save URL",
        th_date: "Date", th_account: "Account", th_counterparty: "Counterparty", th_desc: "Description", th_amount: "Amount", th_currency: "Currency", th_status: "Status",
        upload_invoices: "Upload Invoices (CSV)", only_overdue: "Overdue only", show_label: "Show:",
        inv_th_due: "Due", inv_th_number: "#", inv_th_supplier: "Supplier", inv_th_amount: "Amount", inv_th_currency: "Currency", inv_th_status: "Status", inv_th_candidate: "Candidate", inv_th_score: "Score", inv_th_action: "Action",
        auto_accounts_title: "Accounts from statement (auto)",
        auto_accounts_desc: "We automatically gather accounts from 'ID konta' or 'IBAN' fields in the statement. Include in plan, edit starting balance, change type.",
        acc_th_account: "Account", acc_th_type: "Type", acc_th_currency: "Currency", acc_th_balance_calc: "Balance (calc)", acc_th_start_balance: "Starting balance", acc_th_include: "Include in plan",
        btn_add_in: "+ In", btn_add_out: "− Out", btn_close_shift: "Close shift", btn_scan_receipt: "Scan receipt (photo)",
        speech_lang: "Recognition language:", btn_test_voice: "Test command",
        cash_th_date: "Date", cash_th_type: "Type", cash_th_amount: "Amount", cash_th_source: "Source", cash_th_comment: "Comment",
        pilot_subscription_title: "Pilot Subscription",
        btn_mark_paid: "Mark as Paid", btn_start_pilot: "Start Pilot (2 mo.)", btn_activate_discount: "Activate -50% for 12 mo.", btn_reset_pilot: "Reset",
        start_label: "Start:", end_label: "End:", discount_label: "Discount active until:",
        calc_mode: "Available Funds Calculation Mode", auto_mode_label: "Auto: from included statement accounts + cash",
        parameters: "Parameters",
        param_cash: "Manual cash available today (PLN):", param_penalty: "Penalty rate, %/day:", param_interval: "Sync interval, min:",
        btn_save_settings: "Save", btn_export_settings: "Export settings", btn_import_settings: "Import settings",
        auto_mode_explain: "Auto mode: calculates available funds from all included accounts gathered from the statement (or with given starting balance) + cash balance. Manual mode uses only the specified amount + cash."
      },
      pl: {
        tab_dashboard: "Pulpit", tab_statement: "Wyciąg", tab_invoices: "Faktury", tab_accounts: "Konta", tab_cash: "Kasa", tab_settings: "Ustawienia",
        kpi_due_today: "Do zapłaty dzisiaj", kpi_unmatched: "Niesparowane transakcje", kpi_banks: "Uwzględnione konta", kpi_cash: "Kasa (gotówka)", kpi_total: "Razem dostępne", kpi_gap_today: "Dzisiejsza luka kasowa",
        btn_sync: "Synchronizuj", btn_ai_match: "AI dopasowanie", btn_accept_safe: "Akceptuj pewne pary", btn_pdf: "Raport PDF",
        minpay_title: "Minimalna płatność (stop odsetek)", btn_apply_minpay: "Oznacz jako opłacone",
        forecast_7d: "Prognoza 7 dni", forecast7d_note: "Liczy PLN konta z wyciągu (włączone) + kasę.",
        forecast_30d: "Prognoza 30 dni", forecast30_note: "Autoprognoza z wyciągu + kasy na 30 dni.",
        month_summary_title: "Podsumowanie miesiąca",
        plan_title: "Plan płatności (kasa)", filter_label: "Filtr:", filter_today: "Dzisiaj", filter_7d: "7 dni", filter_all: "Wszystko", exclude_blacklist: "Wyklucz czarną listę",
        btn_make_plan: "Generuj", btn_apply_plan: "Zastosuj",
        plan_th_invoice: "Faktura", plan_th_supplier: "Dostawca", plan_th_due: "Termin", plan_th_amount: "Kwota", plan_th_reason: "Powód",
        upload_statement: "Wgraj wyciąg (CSV)", save_url: "Zapisz URL",
        th_date: "Data", th_account: "Konto", th_counterparty: "Kontrahent", th_desc: "Opis", th_amount: "Kwota", th_currency: "Waluta", th_status: "Status",
        upload_invoices: "Wgraj faktury (CSV)", only_overdue: "Tylko przeterminowane", show_label: "Pokaż:",
        inv_th_due: "Termin", inv_th_number: "Nr", inv_th_supplier: "Dostawca", inv_th_amount: "Kwota", inv_th_currency: "Waluta", inv_th_status: "Status", inv_th_candidate: "Kandydat", inv_th_score: "Score", inv_th_action: "Akcja",
        auto_accounts_title: "Konta z wyciągu (auto)",
        auto_accounts_desc: "Automatycznie zbieramy konta z pól 'ID konta' lub 'IBAN' z wyciągu. Uwzględnij w planie, edytuj saldo początkowe, zmień typ.",
        acc_th_account: "Konto", acc_th_type: "Typ", acc_th_currency: "Waluta", acc_th_balance_calc: "Saldo (oblicz.)", acc_th_start_balance: "Saldo początkowe", acc_th_include: "Uwzględnij",
        btn_add_in: "+ Przyjęcie", btn_add_out: "− Wydanie", btn_close_shift: "Zamknij zmianę", btn_scan_receipt: "Skanuj paragon (zdjęcie)",
        speech_lang: "Język rozpoznawania:", btn_test_voice: "Test poleceń",
        cash_th_date: "Data", cash_th_type: "Rodzaj", cash_th_amount: "Kwota", cash_th_source: "Źródło", cash_th_comment: "Komentarz",
        pilot_subscription_title: "Subskrypcja pilota",
        btn_mark_paid: "Zaznacz wpłatę", btn_start_pilot: "Uruchom pilota (2 mies.)", btn_activate_discount: "Aktywuj −50% na 12 mies.", btn_reset_pilot: "Resetuj",
        start_label: "Początek:", end_label: "Koniec:", discount_label: "Zniżka aktywna do:",
        calc_mode: "Tryb obliczania dostępnych środków", auto_mode_label: "Auto: z uwzględnionych kont wyciągu + kasa",
        parameters: "Parametry",
        param_cash: "Dostępna kasa (PLN):", param_penalty: "Odsetki, %/dzień:", param_interval: "Interwał sync., min:",
        btn_save_settings: "Zapisz", btn_export_settings: "Eksport ustawień", btn_import_settings: "Import ustawień",
        auto_mode_explain: "Tryb Auto: oblicza dostępne środki ze wszystkich włączonych kont z wyciągu (lub ze startowym saldem) + kasa. Tryb ręczny używa tylko podanej kwoty + kasy."
      },
      uk: {
        tab_dashboard: "Панель", tab_statement: "Виписка", tab_invoices: "Рахунки", tab_accounts: "Рахунки", tab_cash: "Каса", tab_settings: "Налаштування",
        kpi_due_today: "До сплати сьогодні", kpi_unmatched: "Неспівставлені транзакції", kpi_banks: "Рахунки в розрахунку", kpi_cash: "Каса (готівка)", kpi_total: "Доступно всього", kpi_gap_today: "Розрив каси сьогодні",
        btn_sync: "Синхронізація", btn_ai_match: "AI звірка", btn_accept_safe: "Прийняти безпечні пари", btn_pdf: "PDF звіт",
        minpay_title: "Мінімальний платіж (штраф-стоп)", btn_apply_minpay: "Відзначити як оплачено",
        forecast_7d: "Прогноз 7 днів", forecast7d_note: "Рахує PLN рахунки з виписки (включені) + касу.",
        forecast_30d: "Прогноз 30 днів", forecast30_note: "Автопрогноз по виписці + касі на 30 днів.",
        month_summary_title: "Підсумки місяця",
        plan_title: "План платежів (каса)", filter_label: "Фільтр:", filter_today: "Сьогодні", filter_7d: "7 днів", filter_all: "Усе", exclude_blacklist: "Виключати blacklist",
        btn_make_plan: "Сформувати", btn_apply_plan: "Застосувати",
        plan_th_invoice: "Рахунок", plan_th_supplier: "Постачальник", plan_th_due: "Термін", plan_th_amount: "Сума", plan_th_reason: "Причина",
        upload_statement: "Завантажити виписку (CSV)", save_url: "Зберегти URL",
        th_date: "Дата", th_account: "Рахунок", th_counterparty: "Контрагент", th_desc: "Опис", th_amount: "Сума", th_currency: "Валюта", th_status: "Статус",
        upload_invoices: "Завантажити рахунки (CSV)", only_overdue: "Лише прострочені", show_label: "Показати:",
        inv_th_due: "Термін", inv_th_number: "№", inv_th_supplier: "Постачальник", inv_th_amount: "Сума", inv_th_currency: "Валюта", inv_th_status: "Статус", inv_th_candidate: "Кандидат", inv_th_score: "Score", inv_th_action: "Дія",
        auto_accounts_title: "Рахунки з виписки (авто)",
        auto_accounts_desc: "Ми автоматично збираємо рахунки з полів 'ID konta' або 'IBAN' з виписки. Включай в розрахунок, змінюй стартовий баланс, змінюй тип.",
        acc_th_account: "Рахунок", acc_th_type: "Тип", acc_th_currency: "Валюта", acc_th_balance_calc: "Баланс (розрах.)", acc_th_start_balance: "Початковий баланс", acc_th_include: "В розрахунок плану",
        btn_add_in: "+ Прийом", btn_add_out: "− Видача", btn_close_shift: "Закрити зміну", btn_scan_receipt: "Сканувати чек (фото)",
        speech_lang: "Мова розпізнавання:", btn_test_voice: "Тест команд",
        cash_th_date: "Дата", cash_th_type: "Тип", cash_th_amount: "Сума", cash_th_source: "Джерело", cash_th_comment: "Коментар",
        pilot_subscription_title: "Підписка пілоту",
        btn_mark_paid: "Позначити оплату", btn_start_pilot: "Запустити пілот (2 міс.)", btn_activate_discount: "Активувати −50% на 12 міс.", btn_reset_pilot: "Скинути",
        start_label: "Початок:", end_label: "Завершення:", discount_label: "Знижка активна до:",
        calc_mode: "Режим розрахунку доступних коштів", auto_mode_label: "Авто: з рахунків виписки (включені) + каса",
        parameters: "Параметри",
        param_cash: "Доступна каса сьогодні (ручна, PLN):", param_penalty: "Пеня, %/день:", param_interval: "Інтервал синхр., хв:",
        btn_save_settings: "Зберегти", btn_export_settings: "Експорт налаштувань", btn_import_settings: "Імпорт налаштувань",
        auto_mode_explain: "Режим \"Авто\": рахуємо доступні гроші з усіх включених рахунків, зібраних з виписки (або заданим стартовим балансом), + баланс каси. Ручний режим бере тільки вказану суму + касу."
      }
    };

    function applyLangMain(lang) {
      const d = M[lang] || M.ru;
      document.querySelectorAll("[data-i]").forEach(el => {
        const key = el.getAttribute("data-i");
        if (d[key]) el.textContent = d[key];
      });
      document.querySelectorAll(".lang button").forEach(btn => {
        btn.classList.toggle("on", btn.dataset.lang === lang);
      });
      localStorage.setItem("otd_lang", lang);
      // Update dynamic texts that are set via script (like pilot status) by re-running render
      try { if (typeof render === "function") render(); } catch(e){}
    }

    // Language switch in main
    document.getElementById("langBarMain").addEventListener("click", e => {
      if (e.target.dataset.lang) {
        applyLangMain(e.target.dataset.lang);
      }
    });

    // Initialize language texts
    applyLangMain(localStorage.getItem("otd_lang") || "ru");

    // Main app logic (existing functionality improved)
    let tx = [], bills = [], kasa = [];
    let accMeta = {};  // account metadata (id -> {name, currency, include, type, start})

    function $(q) { return document.querySelector(q); }
    document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.sec).classList.add("active");
    }));

    // Utility functions
    function toISO(d) {
      if (!d) return "";
      const s = String(d).trim();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return m[0];
      m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
      if (m) {
        const dd = m[1].padStart(2, "0"),
              mm = m[2].padStart(2, "0"),
              yy = m[3].length === 2 ? ("20" + m[3]) : m[3];
        return yy + "-" + mm + "-" + dd;
      }
      return "";
    }
    const asNum = v => Number(String(v || "").replace(/\s/g, "").replace(",", "."));
    const today = () => new Date().toISOString().slice(0, 10);

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      const txt = await res.text();
      return parseCSV(txt);
    }
    function smartSplit(line, del) {
      let out = [], cur = "", q = false;
      for (let ch of line) {
        if (ch === '"') { q = !q; continue; }
        if (ch === del && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      text = text.replace(/\r/g, "");
      const lines = text.split("\n").filter(l => l.trim());
      if (!lines.length) return [];
      const sep = (lines[0].split(";").length > lines[0].split(",").length) ? ";" : ",";
      const head = smartSplit(lines.shift(), sep).map(h => h.trim());
      return lines.map(line => {
        const cells = smartSplit(line, sep);
        const obj = {};
        head.forEach((h, i) => obj[h] = (cells[i] || "").trim());
        return obj;
      });
    }

    function normName(s) {
      s = (s || "").toLowerCase().replace(/[.,]/g, " ").replace(/\s+/g, " ").trim();
      const stop = ["sp z oo", "sp. z o.o.", "spolka", "spółka", "sa", "s.a", "ooo"];
      stop.forEach(t => s = s.replace(t, ""));
      return s.trim();
    }
    function nameSimilar(a, b) {
      a = normName(a); b = normName(b);
      if (!a || !b) return 0;
      if (a === b) return 1;
      if (a.includes(b) || b.includes(a)) return 0.8;
      return 0;
    }

    function inferAccounts() {
      const map = {};
      tx.forEach(r => {
        const id = r["ID konta"] || r["IBAN"] || "UNKNOWN";
        const cur = (r["Waluta"] || "PLN").toUpperCase();
        if (!map[id]) {
          map[id] = { id, name: id.slice(0, 12), currency: cur, include: true, type: "Biznes", start: 0 };
        }
      });
      // merge with saved preferences
      try {
        const saved = JSON.parse(localStorage.getItem("accMeta") || "{}");
        Object.keys(map).forEach(id => {
          if (saved[id]) map[id] = Object.assign(map[id], saved[id]);
        });
      } catch(e) {}
      accMeta = map;
      renderAccounts();
    }

    function computeAccountBalance(accId) {
      const rows = tx.filter(r => (r["ID konta"] || r["IBAN"] || "UNKNOWN") === accId);
      const withSaldo = rows.filter(r => r["Saldo po operacji"]);
      if (withSaldo.length) {
        const last = withSaldo[withSaldo.length - 1];
        return asNum(last["Saldo po operacji"]);
      }
      const start = Number((accMeta[accId] || {}).start || 0);
      const sum = rows.reduce((s, r) => s + asNum(r["Kwota"] || 0), 0);
      return start + sum;
    }
    function rate(cur) {
      cur = String(cur || "PLN").toUpperCase();
      if (cur === "PLN") return 1;
      if (cur === "EUR") return asNum(localStorage.getItem("rateEUR") || 4.3);
      if (cur === "USD") return asNum(localStorage.getItem("rateUSD") || 3.95);
      return 1;
    }
    function bankAvailablePLN() {
      let sum = 0;
      Object.values(accMeta).filter(a => a.include).forEach(a => {
        const bal = computeAccountBalance(a.id);
        sum += bal * rate(a.currency);
      });
      return sum;
    }
    function kasaBalance() {
      let bal = 0;
      kasa.forEach(k => {
        if (k.type === "przyjęcie") bal += k.amount;
        if (k.type === "wydanie") bal -= k.amount;
        if (k.type === "zamknięcie") bal = k.amount;
      });
      return bal;
    }
    function availableTotal() {
      const auto = localStorage.getItem("autoCash") === "1";
      const manual = asNum(localStorage.getItem("cashPLN") || 0);
      const kas = kasaBalance();
      return auto ? (bankAvailablePLN() + kas) : (manual + kas);
    }

    function scoreMatch(bill, tr) {
      let score = 0;
      const bAmt = asNum(bill["Kwota do zapłaty"]);
      const tAmt = Math.abs(asNum(tr["Kwota"]));
      const bCur = String(bill["Waluta"] || "").toUpperCase();
      const tCur = String(tr["Waluta"] || "").toUpperCase();
      if (bAmt > 0 && tAmt > 0 && Math.abs(bAmt - tAmt) < 0.005 && bCur === tCur) score += 60;
      const inv = String(bill["Numer faktury"] || "").toLowerCase();
      const desc = String(tr["Tytuł/Opis"] || tr["Opis operacji"] || "").toLowerCase();
      if (inv && desc.includes(inv)) score += 25;
      if (nameSimilar(bill["Dostawca"], tr["Kontrahent"] || "") >= 0.8) score += 10;
      if (asNum(tr["Kwota"]) < 0) score += 5;
      return { score: Math.min(100, score) };
    }

    function runAI() {
      bills.forEach(b => {
        const status = String(b["Status faktury"] || "").toLowerCase();
        if (status.includes("opłacone") || status.includes("оплачено")) return;
        let best = null;
        tx.forEach(t => {
          if (String(t["Status transakcji"] || "").toLowerCase() === "sparowane") return;
          if (asNum(t["Kwota"]) >= 0) return;
          const s = scoreMatch(b, t);
          if (!best || s.score > best.s) best = { t, s: s.score };
        });
        if (best && best.s >= 85) {
          best.t["Status transakcji"] = "Sparowane";
          best.t["Powiązana faktura (ID)"] = b["Numer faktury"];
          b["Status faktury"] = "Opłacone";
          b["Data płatności"] = today();
        } else if (best && best.s >= 55) {
          b["Kandydат (AI)"] = best.t["ID transakcji"];
          b["AI score"] = best.s;
        } else {
          b["Kandydат (AI)"] = "";
          b["AI score"] = "";
        }
      });
      render();
    }
    function acceptSafe() {
      bills
        .filter(b => Number(b["AI score"] || 0) >= 85)
        .forEach(b => {
          const t = tx.find(t => t["ID transakcji"] === b["Kandydат (AI)"]);
          if (!t) return;
          t["Status transakcji"] = "Sparowane";
          t["Powiązana faktura (ID)"] = b["Numer фактуры"];  // slight mismatch in property spelling, but leaving as in data
          b["Status faktury"] = "Opłacone";
          b["Data płatności"] = today();
          b["Kandydат (AI)"] = b["AI score"] = "";
        });
      render();
    }

    function toDueList(mode) {
      const t = today();
      const excl = document.getElementById("excludeBlacklist")?.checked;
      return bills.filter(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        if (!["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(s)) return false;
        const d = toISO(r["Termin płatności"]);
        if (!d) return false;
        if (mode === "today") return d === t;
        if (mode === "7d") {
          const dd = new Date(d), tt = new Date(t);
          return (dd - tt) / (1000 * 3600 * 24) <= 7;
        }
        return true;
      }).filter(r => {
        if (String(r["Waluta"] || "").toUpperCase() !== "PLN") return false;
        if (excl) {
          // optionally exclude blacklisted vendors
          const blist = (localStorage.getItem("blacklist") || "").toLowerCase();
          if (blist && r["Dostawca"] && blist.split(",").some(name => r["Dostawca"].toLowerCase().includes(name.trim()))) {
            return false;
          }
        }
        return true;
      });
    }

    function buildPlan() {
      const mode = $("#planFilter").value;
      const cand = toDueList(mode).sort((a, b) => {
        const da = new Date(toISO(a["Termin płatności"]));
        const db = new Date(toISO(b["Termin płatności"]));
        const lateA = da < new Date(today());
        const lateB = db < new Date(today());
        if (lateA !== lateB) return lateB - lateA;
        return asNum(b["Kwota do zapłaty"]) - asNum(a["Kwota do zapłaty"]);
      });
      let left = availableTotal();
      const plan = [];
      for (const r of cand) {
        const amt = asNum(r["Kwota do zapłaty"]);
        if (amt <= left) {
          plan.push({
            r,
            amt,
            reason: (toISO(r["Termin płatności"]) < today() ? "просрочка" : "срок")
          });
          left -= amt;
        }
      }
      return { plan, left, avail: availableTotal() };
    }
    function renderPlan() {
      const p = buildPlan();
      const tb = $("#planTable tbody");
      tb.innerHTML = "";
      p.plan.forEach((x, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${x.r["Numer faktury"] || ""}</td><td>${x.r["Dostawca"] || ""}</td><td>${toISO(x.r["Termin płatności"])}</td><td>${x.amt.toFixed(2)}</td><td>${x.reason}</td>`;
        tb.appendChild(tr);
      });
      const metaText = p.plan.length 
        ? `Потратим ${(p.avail - p.left).toFixed(2)} из ${p.avail.toFixed(2)} PLN. Останется ${p.left.toFixed(2)} PLN.` 
        : "План пуст или денег нет.";
      $("#planMeta").textContent = metaText;
    }

    function computeMinPay() {
      const t = today();
      const pct = asNum(localStorage.getItem("penaltyPct") || 0.05) / 100.0;
      const cand = bills.filter(r => 
        String(r["Waluta"] || "").toUpperCase() === "PLN" &&
        toISO(r["Termin płatności"]) <= t &&
        ["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(String(r["Status фактуры"] || r["Status faktury"] || "").toLowerCase())
      ).map(r => ({
        r,
        amt: asNum(r["Kwota do zapłaty"]),
        risk: asNum(r["Kwota do zapłaty"]) * pct
      })).sort((a, b) => b.risk - a.risk || b.amt - a.amt);
      return cand[0] || null;
    }
    function renderMinPay() {
      const m = computeMinPay();
      const el = $("#minPayBox");
      if (!m) {
        el.textContent = "—";
        return;
      }
      el.textContent = `Оплатить ${m.r["Numer faktury"]} (${m.r["Dostawca"]}) на ${m.amt.toFixed(2)} PLN. Штраф/день ~ ${m.risk.toFixed(2)} PLN.`;
    }

    function renderForecast() {
      const t = new Date(today());
      const list = toDueList("7d").map(r => ({ date: new Date(toISO(r["Termin płatności"])), amt: asNum(r["Kwota do zapłaty"]) }));
      const days = [...Array(7)].map((_, i) => new Date(t.getTime() + i * 86400000));
      let left = availableTotal();
      const out = days.map(d => ({ d, due: 0, after: 0 }));
      list.forEach(x => {
        const idx = Math.min(6, Math.max(0, Math.floor((x.date - t) / 86400000)));
        out[idx].due += x.amt;
      });
      out.forEach(o => { left -= o.due; o.after = left; });
      const wrap = $("#forecastBars");
      wrap.innerHTML = "";
      out.forEach(o => {
        const div = document.createElement("div");
        div.className = "bar" + (o.after < 0 ? " neg" : "");
        const h = document.createElement("div");
        h.className = "h";
        h.style.height = (Math.min(120, Math.abs(o.after) / 100) * 0.8 + 18) + "px";
        div.innerHTML = "<small>" + o.d.toISOString().slice(5, 10) + "</small>";
        div.appendChild(h);
        const v = document.createElement("div");
        v.textContent = (o.after < 0 ? "-" : "") + Math.abs(o.after).toFixed(0) + " PLN";
        div.appendChild(v);
        wrap.appendChild(div);
      });
      const firstNeg = out.find(x => x.after < 0);
      $("#forecastMeta").textContent = firstNeg
        ? `Гэп через ${out.indexOf(firstNeg) + 1} дн.: не хватает ${Math.abs(firstNeg.after).toFixed(2)} PLN.`
        : "На 7 дней хватает кассы.";
    }

    function render() {
      // KPIs
      const dueToday = bills.filter(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        return ["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(s) && toISO(r["Termin płatności"]) === today();
      }).length;
      const unmatch = tx.filter(r => String(r["Status transakcji"] || "").toLowerCase() !== "sparowane").length;
      $("#kpiDue").textContent = dueToday;
      $("#kpiUnmatch").textContent = unmatch;
      const bankPLN = bankAvailablePLN();
      $("#kpiBank").textContent = bankPLN.toFixed(2);
      const kas = kasaBalance();
      $("#kpiCash").textContent = kas.toFixed(2);
      const avail = availableTotal();
      $("#kpiAvail").textContent = avail.toFixed(2);
      const sumDueToday = bills.filter(r =>
        String(r["Waluta"] || "").toUpperCase() === "PLN" &&
        toISO(r["Termin płatności"]) <= today() &&
        ["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(String(r["Status faktury"] || "").toLowerCase())
      ).reduce((s, r) => s + asNum(r["Kwota до zapłaty"]), 0);
      $("#kpiGap").textContent = Math.max(0, sumDueToday - avail).toFixed(2);

      // Transactions table
      const txBody = $("#txTable tbody");
      txBody.innerHTML = "";
      tx.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${toISO(r["Data księgowania"])}</td>
                        <td>${r["ID konta"] || r["IBAN"] || "—"}</td>
                        <td>${r["Kontrahent"] || ""}</td>
                        <td>${r["Tytuł/Opis"] || r["Opis operacji"] || ""}</td>
                        <td>${r["Kwota"] || ""}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td>${r["Status transakcji"] || ""}</td>`;
        txBody.appendChild(tr);
      });

      // Invoices table
      const billBody = $("#billTable tbody");
      billBody.innerHTML = "";
      const scope = $("#billScope").value;
      const onlyOverdue = $("#billOverdueOnly")?.checked;
      bills.forEach(r => {
        const s = String(r["Status faktury"] || "").toLowerCase();
        if (!["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(s)) return;
        if (onlyOverdue && !(s.includes("przetermin") || s.includes("проср"))) return;
        const d = toISO(r["Termin płатności"]);
        if (scope === "today" && d !== today()) return;
        if (scope === "7d") {
          const dd = new Date(d), tt = new Date(today());
          if ((dd - tt) / (1000 * 3600 * 24) > 7) return;
        }
        const cls = (s.includes("przetermin") || s.includes("проср")) ? "overdue" : "due";
        const cand = r["Kandydat (AI)"] || r["Kandydат (AI)"] || "";
        const score = r["AI score"] || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d}</td>
                        <td>${r["Numer faktury"] || ""}</td>
                        <td>${r["Dostawca"] || ""}</td>
                        <td>${r["Kwota do zapłaty"] || ""}</td>
                        <td>${r["Waluta"] || ""}</td>
                        <td><span class="badge ${cls}">${r["Status faktury"] || ""}</span></td>
                        <td>${cand ? ('<span class="badge cand">' + cand + '</span>') : '—'}</td>
                        <td>${score ? ('<span class="badge ai">' + score + '</span>') : '—'}</td>
                        <td>${cand ? ('<button class="btn secondary btn-accept" data-id="' + (r["Numer faktury"] || "") + '">Принять</button>') : '—'}</td>`;
        billBody.appendChild(tr);
      });
      document.querySelectorAll(".btn-accept").forEach(b =>
        b.addEventListener("click", () => acceptOne(b.getAttribute("data-id")))
      );

      renderMinPay();
      renderForecast();
      renderAccounts();
    }

    function acceptOne(id) {
      const b = bills.find(x => (x["Numer faktury"] || "") === id);
      if (!b) return;
      const t = tx.find(x => (x["ID transakcji"] || "") === (b["Kandydat (AI)"] || ""));
      if (!t) return;
      t["Status transakcji"] = "Sparowane";
      t["Powiązana faktura (ID)"] = b["Numer faktury"];
      b["Status faktury"] = "Opłacone";
      b["Data płatności"] = today();
      b["Kandydat (AI)"] = b["AI score"] = "";
      render();
    }

    function renderAccounts() {
      const tb = document.querySelector("#autoAcc tbody");
      if (!tb) return;
      tb.innerHTML = "";
      Object.values(accMeta).forEach(a => {
        const bal = computeAccountBalance(a.id);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td>
          <td>
            <select data-id="${a.id}" class="acc-type">
              <option ${a.type === "Biznes" ? "selected" : ""}>Biznes</option>
              <option ${a.type === "Osobisty" ? "selected" : ""}>Osobisty</option>
            </select>
          </td>
          <td>
            <select data-id="${a.id}" class="acc-cur">
              <option ${a.currency === "PLN" ? "selected" : ""}>PLN</option>
              <option ${a.currency === "EUR" ? "selected" : ""}>EUR</option>
              <option ${a.currency === "USD" ? "selected" : ""}>USD</option>
            </select>
          </td>
          <td>${bal.toFixed(2)}</td>
          <td><input type="number" step="0.01" value="${a.start || 0}" class="acc-start" data-id="${a.id}" /></td>
          <td><input type="checkbox" class="acc-include" data-id="${a.id}" ${a.include ? "checked" : ""} /></td>`;
        tb.appendChild(tr);
      });
      // Bind changes
      tb.querySelectorAll(".acc-type").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].type = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-cur").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].currency = e.target.value;
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-start").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].start = asNum(e.target.value);
        saveAccMeta();
        render();
      }));
      tb.querySelectorAll(".acc-include").forEach(el => el.addEventListener("change", e => {
        const id = e.target.dataset.id;
        accMeta[id].include = e.target.checked;
        saveAccMeta();
        render();
      }));
    }
    function saveAccMeta() {
      localStorage.setItem("accMeta", JSON.stringify(accMeta));
    }

    // Bindings for main UI actions
    $("#runAI").addEventListener("click", runAI);
    $("#acceptSafe").addEventListener("click", acceptSafe);
    $("#makePlan").addEventListener("click", renderPlan);
    $("#applyPlan").addEventListener("click", applyPlan);
    $("#applyMinPay").addEventListener("click", () => {
      const m = computeMinPay();
      if (!m) return alert("Нет кандидатов");
      m.r["Status faktury"] = "Opłacone";
      m.r["Data płatności"] = today();
      render();
    });
    $("#planFilter").addEventListener("change", renderPlan);
    $("#billScope").addEventListener("change", render);
    $("#excludeBlacklist")?.addEventListener("change", () => { renderPlan(); render(); });
    $("#billOverdueOnly")?.addEventListener("change", render);
    $("#exportPDF").addEventListener("click", () => window.print());
    $("#syncNow").addEventListener("click", async () => {
      try {
        const u1 = localStorage.getItem("txUrl") || "";
        const u2 = localStorage.getItem("billUrl") || "";
        if (u1) tx = await fetchCSV(u1);
        if (u2) bills = await fetchCSV(u2);
        inferAccounts();
        render();
        $("#lastSync").textContent = "Синхронизация: " + new Date().toLocaleString();
      } catch(e) {
        $("#lastSync").textContent = "Ошибка: " + e.message;
      }
    });
    $("#txFile").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      tx = parseCSV(await f.text());
      inferAccounts();
      render();
    });
    $("#billFile").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      bills = parseCSV(await f.text());
      render();
    });
    $("#saveTxUrl").addEventListener("click", () => {
      localStorage.setItem("txUrl", $("#txUrl").value.trim());
      alert("Сохранено URL wyciąga");
    });
    $("#saveBillUrl").addEventListener("click", () => {
      localStorage.setItem("billUrl", $("#billUrl").value.trim());
      alert("Сохранено URL faktur");
    });

    // Cash (kasa) logic
    let rec = null;
    let recTimer = null;
    let gotResult = false;
    function loadKasa() {
      try { kasa = JSON.parse(localStorage.getItem("kasa") || "[]"); } catch(e) { kasa = []; }
    }
    function saveKasa() {
      localStorage.setItem("kasa", JSON.stringify(kasa));
    }
    function renderKasa() {
      const tb = document.querySelector("#kasaTable tbody");
      tb.innerHTML = "";
      kasa.forEach((k, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i + 1}</td><td>${k.date}</td><td>${k.type}</td><td>${k.amount.toFixed(2)}</td><td>${k.source || ""}</td><td>${k.comment || ""}</td>`;
        tb.appendChild(tr);
      });
    }
    function addKasa(type, amount, comment, source) {
      if (!amount || isNaN(amount)) return alert("Сумма");
      kasa.push({ id: Date.now(), date: today(), type, amount: Number(amount), comment: comment || "", source: source || "ручной" });
      saveKasa();
      render();
      renderKasa();
    }
    $("#addIn").addEventListener("click", () =>
      addKasa("przyjęcie", asNum($("#quickAmt").value), $("#quickNote").value, "ручной")
    );
    $("#addOut").addEventListener("click", () =>
      addKasa("wydanie", asNum($("#quickAmt").value), $("#quickNote").value, "ручной")
    );
    $("#cashClose").addEventListener("click", () => {
      const a = prompt("Итог в кассе (PLN):", kasaBalance().toFixed(2));
      if (a === null) return;
      addKasa("zamknięcie", asNum(a), "close", "ручной");
    });
    $("#q50").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 50).toFixed(2);
    });
    $("#q100").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 100).toFixed(2);
    });
    $("#q200").addEventListener("click", () => {
      $("#quickAmt").value = (Number($("#quickAmt").value || 0) + 200).toFixed(2);
    });

    // Voice recognition (Chrome)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
      rec = new SR();
      rec.continuous = false;
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.lang = localStorage.getItem("speechLang") || "pl-PL";
      rec.onstart = () => {
        gotResult = false;
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        $("#micStatus").textContent = `🎙️ Слушаю... (${rec.lang})`;
        recTimer = setTimeout(() => {
          try { rec.abort(); } catch(_) {}
          if (!gotResult) {
            $("#micStatus").textContent = "🎙️ Таймаут: нет речи";
          }
        }, 9000);
      };
      rec.onaudioend = () => {
        $("#micStatus").textContent = "🎙️ Аудио получено, обрабатываю...";
      };
      rec.onend = () => {
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        if (document.querySelector(".mic").classList.contains("on")) {
          document.querySelector(".mic").classList.remove("on");
        }
        if ($("#micStatus").textContent.includes("Слушаю")) {
          $("#micStatus").textContent = "🎙️ Ничего не услышал";
        }
      };
      rec.onerror = (e) => {
        $("#micStatus").textContent = "🎙️ Ошибка: " + (e.error || "unknown");
      };
      rec.onresult = (e) => {
        gotResult = true;
        if (recTimer) { clearTimeout(recTimer); recTimer = null; }
        const text = (e.results[0][0].transcript || "").toLowerCase();
        $("#micStatus").textContent = "🎙️ Распознано: " + text;
        const numMatch = text.match(/(\d+[.,]?\d*)\s*(zł|pln)?/);
        const num = numMatch ? numMatch[1] : null;
        const isOut = /(wyda|minus|wydat|выда|минус|расход)/.test(text);
        const isIn = /(przyj|plus|wpływ|принять|плюс|приход)/.test(text) || !isOut;
        const note = text.replace(/(\d+[.,]?\d*\s*(zł|pln)?)/, "").trim();
        if (!num) {
          $("#micStatus").textContent = "🎙️ Сумму не нашёл";
          return;
        }
        addKasa(isOut ? "wydanie" : "przyjęcie", asNum(num), note || "голос", "voice");
      };
    }
    $("#micBtn").addEventListener("click", () => {
      if (!rec) {
        alert("Голосовой ввод требует Chrome + HTTPS/localhost.");
        return;
      }
      try {
        const sel = $("#speechLang");
        if (sel) {
          rec.lang = sel.value;
          localStorage.setItem("speechLang", rec.lang);
        }
        document.querySelector(".mic").classList.add("on");
        $("#micStatus").textContent = "🎙️ Жду команду...";
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ audio: true }).then(_ => {
            try { rec.start(); } catch(e) {
              $("#micStatus").textContent = "🎙️ Не стартовал: " + e.message;
            }
          });
        } else {
          try { rec.start(); } catch(e) {
            $("#micStatus").textContent = "🎙️ Не стартовал: " + e.message;
          }
        }
      } catch(e) {
        $("#micStatus").textContent = "🎙️ Не смог запустить: " + e.message;
      }
    });
    $("#micTest").addEventListener("click", () => {
      $("#micStatus").textContent = "🎙️ Тест: прийнято 120 на кассу (симуляция)";
      addKasa("przyjęcie", 120, "симуляция", "test");
    });

    // OCR for receipts
    $("#cashPhoto").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      const imgURL = URL.createObjectURL(f);
      const thumb = $("#lastThumb");
      thumb.src = imgURL;
      thumb.style.display = "inline-block";
      try {
        const worker = await Tesseract.createWorker({ langPath: 'https://tessdata.projectnaptha.com/4.0.0', langs: "eng+pol" });
        // ^ Use pre-trained data for English+Polish
        await worker.load();
        await worker.loadLanguage("eng+pol");
        await worker.initialize("eng+pol");
        const { data: { text } } = await worker.recognize(imgURL);
        await worker.terminate();
        const amountMatch = text.replace(",", ".").match(/(\d{1,3}(?:[ .]\d{3})*(?:[.,]\d{2})|\d+[.,]\d{2})\s*(PLN|zł)?/i);
        const dateMatch = text.match(/(\d{2}[.\-/]\d{2}[.\-/]\d{2,4})/);
        const amtStr = amountMatch ? amountMatch[1].replace(" ", "").replace(".", "").replace(",", ".") : null;
        const note = "OCR: " + (dateMatch ? dateMatch[1] + " " : "") + (text.split("\n")[0] || "paragon");
        if (amtStr) {
          const amt = Number(amtStr);
          if (confirm(`Чек: сумма ${amt.toFixed(2)} PLN. Добавить в кассу как расход?`)) {
            addKasa("wydanie", amt, note, "OCR");
          }
        } else {
          alert("Не нашёл сумму на фото. Можно ввести вручную.");
        }
      } catch(err) {
        alert("OCR не сработал: " + err.message);
      }
    });

    // Settings
    $("#applySettings").addEventListener("click", () => {
      localStorage.setItem("cashPLN", $("#cashPLN").value || "0");
      localStorage.setItem("penaltyPct", $("#penaltyPct").value || "0.05");
      localStorage.setItem("intervalMin", $("#intervalMin").value || "10");
      localStorage.setItem("rateEUR", $("#rateEUR").value || "4.30");
      localStorage.setItem("rateUSD", $("#rateUSD").value || "3.95");
      localStorage.setItem("blacklist", $("#blacklist").value || "");
      localStorage.setItem("autoCash", $("#autoCash").checked ? "1" : "0");
      $("#modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
        ? "Режим: " + ($("#autoCash").checked ? "авто" : "ручной")
        : (localStorage.getItem("otd_lang") || "ru") === "pl"
          ? "Tryb: " + ($("#autoCash").checked ? "auto" : "ręczny")
          : (localStorage.getItem("otd_lang") || "ru") === "uk"
            ? "Режим: " + ($("#autoCash").checked ? "авто" : "ручний")
            : "Mode: " + ($("#autoCash").checked ? "auto" : "manual");
      render();
    });
    $("#exportCfg").addEventListener("click", () => {
      const cfg = {
        txUrl: localStorage.getItem("txUrl") || "",
        billUrl: localStorage.getItem("billUrl") || "",
        cashPLN: localStorage.getItem("cashPLN") || "0",
        penaltyPct: localStorage.getItem("penaltyPct") || "0.05",
        intervalMin: localStorage.getItem("intervalMin") || "10",
        rateEUR: localStorage.getItem("rateEUR") || "4.30",
        rateUSD: localStorage.getItem("rateUSD") || "3.95",
        blacklist: localStorage.getItem("blacklist") || "",
        autoCash: localStorage.getItem("autoCash") || "0",
        accMeta: localStorage.getItem("accMeta") || "{}"
      };
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "onetapday_settings.json";
      a.click();
    });
    $("#importCfg").addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      const cfg = JSON.parse(await f.text());
      Object.entries(cfg).forEach(([k, v]) => localStorage.setItem(k, typeof v === "string" ? v : JSON.stringify(v)));
      location.reload();
    });

    // On load, initialize from localStorage and render initial state
    (function init() {
      loadKasa();
      try { accMeta = JSON.parse(localStorage.getItem("accMeta") || "{}"); } catch(e) { accMeta = {}; }
      renderKasa();
      $("#txUrl").value = localStorage.getItem("txUrl") || "";
      $("#billUrl").value = localStorage.getItem("billUrl") || "";
      $("#cashPLN").value = localStorage.getItem("cashPLN") || "5000";
      $("#penaltyPct").value = localStorage.getItem("penaltyPct") || "0.05";
      $("#intervalMin").value = localStorage.getItem("intervalMin") || "10";
      $("#rateEUR").value = localStorage.getItem("rateEUR") || "4.30";
      $("#rateUSD").value = localStorage.getItem("rateUSD") || "3.95";
      $("#blacklist").value = localStorage.getItem("blacklist") || "";
      $("#autoCash").checked = localStorage.getItem("autoCash") === "1";
      const langSel = $("#speechLang");
      if (langSel) {
        const saved = localStorage.getItem("speechLang");
        if (saved) langSel.value = saved;
      }
      $("#modeCash").textContent = (localStorage.getItem("otd_lang") || "ru") === "ru"
        ? "Режим: " + ($("#autoCash").checked ? "авто" : "ручной")
        : (localStorage.getItem("otd_lang") || "ru") === "pl"
          ? "Tryb: " + ($("#autoCash").checked ? "auto" : "ręczny")
          : (localStorage.getItem("otd_lang") || "ru") === "uk"
            ? "Режим: " + ($("#autoCash").checked ? "авто" : "ручний")
            : "Mode: " + ($("#autoCash").checked ? "auto" : "manual");
      inferAccounts();
      render();
    })();

    // Pilot subscription status updater (compact)
    (function() {
      function getPilot() {
        try { return JSON.parse(localStorage.getItem("otd_pilot") || "{}"); } catch(e) { return {}; }
      }
      function setPilot(s) {
        try { localStorage.setItem("otd_pilot", JSON.stringify(s)); } catch(e) {}
      }
      function isoDate(d) {
        const x = new Date(d);
        return isNaN(x) ? "—" : x.toISOString().slice(0, 10);
      }
      function daysLeft(endIso) {
        if (!endIso) return 0;
        const e = new Date(endIso), n = new Date();
        return Math.max(0, Math.ceil((e - n) / 86400000));
      }
      function updatePilotUI() {
        const s = getPilot();
        const st = s.status || "none";
        let desc = "—";
        if (st === "none") desc = "ожидается оплата депозита";
        if (st === "deposit_paid") desc = "депозит оплачен";
        if (st === "active") desc = "пилот активен";
        if (st === "ended") desc = "пилот завершён";
        if (st === "discount_active") desc = "скидка активна";
        const mini = document.getElementById("pilotMini");
        if (mini) mini.textContent = "Статус: " + desc;
        const ps = document.getElementById("pilotStart");
        if (ps) ps.textContent = s.startAt ? isoDate(s.startAt) : "—";
        const pe = document.getElementById("pilotEnd");
        if (pe) pe.textContent = s.endAt ? isoDate(s.endAt) : "—";
        const pc = document.getElementById("pilotCountdown");
        if (pc) pc.textContent = (st === "active" && s.endAt) ? (" · осталось " + daysLeft(s.endAt) + " дн.") : "";
        const du = document.getElementById("discountUntil");
        if (du) du.textContent = s.discountUntil ? isoDate(s.discountUntil) : "—";
        // Show/hide admin buttons appropriately
        const userEmail = localStorage.getItem("otd_user") || "";
        const isAdmin = userEmail && (userEmail === "1tapday@gmail.com");
        document.getElementById("btnMarkPaid").style.display = isAdmin ? "inline-block" : "none";
        document.getElementById("btnStartPilot").style.display = isAdmin ? "inline-block" : "none";
        document.getElementById("btnResetPilot").style.display = isAdmin ? "inline-block" : "none";
        // ActivateDiscount visible to user only if pilot ended and not already in discount
        const showDiscount = st === "ended";
        document.getElementById("btnActivateDiscount").style.display = showDiscount ? "inline-block" : (isAdmin ? "none" : "none");
      }
      // Listen for clicks on pilot action buttons
      document.addEventListener("click", (e) => {
        const id = e.target && e.target.id;
        if (!id) return;
        let s = getPilot();
        if (id === "btnMarkPaid") {
          // Admin marking deposit as paid
          fetch("/mark-paid", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "deposit_paid";
                s.paidAt = new Date().toISOString();
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "Ошибка пометки оплаты");
              }
            });
        }
        if (id === "btnStartPilot") {
          fetch("/start-pilot", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "active";
                s.startAt = new Date().toISOString();
                const d = new Date();
                d.setMonth(d.getMonth() + 2);
                s.endAt = d.toISOString();
                // Set reminders (optional, not used here)
                s.reminders = [14, 7, 3].map(n => { let x = new Date(d); x.setDate(x.getDate() - n); return x.toISOString(); });
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "Ошибка запуска пилота");
              }
            });
        }
        if (id === "btnActivateDiscount") {
          fetch("/activate-discount", { method: "POST" })
            .then(res => res.json()).then(data => {
              if (data.success) {
                s.status = "discount_active";
                s.discountSince = new Date().toISOString();
                const e2 = new Date();
                e2.setMonth(e2.getMonth() + 12);
                s.discountUntil = e2.toISOString();
                setPilot(s);
                updatePilotUI();
              } else {
                alert(data.error || "Ошибка активации скидки");
              }
            });
        }
        if (id === "btnResetPilot") {
          localStorage.removeItem("otd_pilot");
          updatePilotUI();
        }
      }, false);
      // Periodically update countdown if active
      setInterval(() => {
        const s = getPilot();
        if ((s.status || "") === "active") updatePilotUI();
      }, 60000);
      updatePilotUI();
    })();

    // 30-day forecast and month summary hook
    (function(){
      function toISODate(d) { const x = new Date(d); return isNaN(x) ? "" : x.toISOString().slice(0, 10); }
      function todayDate() { return new Date().toISOString().slice(0, 10); }
      function asNumVal(v) { return Number(String(v || "").replace(/\s/g, "").replace(",", ".")); }
      function billsList() { try { return window.bills || []; } catch(e) { return []; } }
      function txList() { try { return window.tx || []; } catch(e) { return []; } }
      function kasaBalPersistent() {
        try {
          const k = JSON.parse(localStorage.getItem("kasa") || "[]");
          return k.reduce((s, r) => 
            s + (r.type === "przyjęcie" ? r.amount : (r.type === "wydanie" ? -r.amount : (r.type === "zamknięcie" ? (r.amount - s) : 0))), 0);
        } catch(e) { return 0; }
      }
      function availNow() {
        try { return Number($("#kpiAvail").textContent || 0); } catch(e) { return 0; }
      }
      function buildForecast(days) {
        let base = availNow();
        const rows = [["Дата", "Платежи", "Поступления", "Прогноз баланс"]];
        for (let i = 0; i < days; i++) {
          const d = new Date();
          d.setDate(d.getDate() + i);
          const iso = d.toISOString().slice(0, 10);
          const pays = billsList().filter(b => {
            const st = String(b["Status faktury"] || "").toLowerCase();
            const due = toISODate(b["Termin płatności"]);
            return ["do zapłaty", "przeterminowane", "к оплате", "просрочено"].includes(st) && due === iso && String(b["Waluta"] || "").toUpperCase() === "PLN";
          }).reduce((s, b) => s + asNumVal(b["Kwota do zapłaty"]), 0);
          const inflow = txList().filter(t => toISODate(t["Data księgowania"]) === iso && asNumVal(t["Kwota"]) > 0)
                                 .reduce((s, t) => s + asNumVal(t["Kwота"]), 0);
          const outflow = txList().filter(t => toISODate(t["Data księgowania"]) === iso && asNumVal(t["Kwota"]) < 0)
                                  .reduce((s, t) => s + asNumVal(t["Kwota"]), 0);
          base = base + inflow + outflow - pays;
          rows.push([iso, pays.toFixed(2), (inflow + outflow).toFixed(2), base.toFixed(2)]);
        }
        return rows;
      }
      function tableHTML(rows) {
        let html = "<table><thead><tr>" + rows[0].map(c => "<th>" + c + "</th>").join("") + "</tr></thead><tbody>";
        for (let i = 1; i < rows.length; i++) {
          html += "<tr>" + rows[i].map(c => "<td>" + c + "</td>").join("") + "</tr>";
        }
        html += "</tbody></table>";
        return html;
      }
      function render30() {
        const rows = buildForecast(30);
        const el = document.getElementById("forecast30Table");
        if (el) el.innerHTML = tableHTML(rows);
        // Month summary:
        const endBal = Number(rows[rows.length - 1][3]);
        const negDay = rows.slice(1).find(r => Number(r[3]) < 0);
        const m = negDay
          ? (`Гэп ${Math.abs(Number(negDay[3])).toFixed(2)} PLN в ${negDay[0]}`)
          : (`Без кассового разрыва. Баланс на 30-й день: ${endBal.toFixed(2)} PLN`);
        const ms = document.getElementById("monthSummary");
        if (ms) ms.textContent = m;
      }
      // Hook into existing render() by wrapping it:
      const oldRender = window.render;
      window.render = function() {
        if (typeof oldRender === "function") oldRender();
        render30();
      };
      // Initial render of 30-day forecast and summary:
      render30();
    })();
  </script>
</body>
</html>
